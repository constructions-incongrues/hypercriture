{"version":3,"sources":["store/stories/index.ts","components/tooltip/tooltip.tsx","components/control/icon-button.tsx","store/prefs/index.ts","store/story-formats/index.ts","components/container/button-bar/button-bar.tsx","components/container/button-bar/button-bar-separator.tsx","dialogs/index.ts","components/container/card/card-content.tsx","store/undoable-stories/index.ts","components/container/dialog-card/dialog-card.tsx","components/container/dialog-card/dialog-editor.tsx","util/geometry.ts","store/stories/defaults.ts","components/control/checkbox-button.tsx","util/is-electron.ts","electron/shared/index.ts","store/persistence/persistable-changes.ts","util/story-format/editor-extensions.ts","util/story-format/namespace.ts","components/control/text-select.tsx","util/app-info.ts","util/publish.ts","util/tag.ts","components/control/menu-button.tsx","components/control/prompt-button.tsx","store/prefs/defaults.ts","components/image/icon/empty.tsx","components/image/icon/loading.tsx","components/image/icon/twine.tsx","codemirror/prefix-trigger.ts","components/control/code-area/code-area.tsx","util/i18n.ts","store/persistence/electron-ipc/prefs/load.ts","store/persistence/electron-ipc/save-json.ts","store/persistence/electron-ipc/prefs/save-middleware.ts","store/persistence/electron-ipc/stories/load.ts","store/persistence/electron-ipc/stories/save-middleware.ts","store/persistence/electron-ipc/stories/save-story.ts","store/persistence/electron-ipc/story-formats/load.ts","store/persistence/electron-ipc/story-formats/save-middleware.ts","store/persistence/local-storage/prefs/load.ts","store/persistence/local-storage/prefs/save-middleware.ts","store/persistence/local-storage/prefs/save.ts","store/persistence/local-storage/stories/save-middleware.ts","store/persistence/local-storage/stories/load.ts","store/persistence/local-storage/comma-list.ts","store/persistence/local-storage/stories/save.ts","store/persistence/local-storage/story-formats/load.ts","store/persistence/local-storage/story-formats/save.ts","store/persistence/local-storage/story-formats/save-middleware.ts","store/persistence/use-persistence.ts","store/persistence/electron-ipc/use-electron-ipc-persistence.ts","store/persistence/local-storage/use-local-storage-persistence.ts","components/error/error-message.tsx","components/error/global-error-boundary.tsx","components/error/safari-warning-card.tsx","components/tag/add-tag-button.tsx","components/tag/tag-button.tsx","components/control/icon-link.tsx","components/codemirror/indent-buttons.tsx","components/codemirror/undo-redo-buttons.tsx","components/control/text-input.tsx","components/container/card/card.tsx","util/story-format/fetch-properties.ts","store/story-formats/defaults.ts","util/unused-name.ts","store/use-store-error-reporter.ts","util/codemirror-options.ts","components/control/card-button.tsx","util/color.ts","util/parse-links.ts","util/regexp.ts","store/stories/getters.ts","dialogs/context/dialogs.tsx","components/tag/tag-stripe.tsx","dialogs/context/reducer.ts","dialogs/context/dialogs-context.tsx","util/import.ts","components/container/button-card.tsx","components/passage/rename-passage-button.tsx","store/prefs/use-computed-theme.ts","components/tag/tag-editor.tsx","components/meter/meter.tsx","store/format-loader.tsx","store/prefs/action-creators.ts","store/prefs/getters.ts","electron/shared/story-filename.ts","store/story-formats/action-creators.ts","store/story-formats/getters.ts","dialogs/app-donation.tsx","dialogs/passage-tags.tsx","dialogs/story-javascript.tsx","dialogs/story-search.tsx","dialogs/story-stylesheet.tsx","dialogs/story-tags.tsx","store/stories/action-creators/create-newly-linked-passages.ts","store/stories/action-creators/create-story.ts","store/stories/action-creators/create-untitled-passage.ts","store/stories/action-creators/delete-passage.ts","store/stories/action-creators/delete-story.ts","store/stories/action-creators/duplicate-story.ts","store/stories/action-creators/update-passage.ts","store/stories/action-creators/find-replace.ts","store/stories/action-creators/highlight-passages.ts","store/stories/action-creators/import-stories.ts","store/stories/action-creators/move-passages.ts","store/stories/action-creators/rename-passage-tag.ts","store/stories/action-creators/rename-story-tag.ts","store/stories/action-creators/select-passage.ts","store/stories/action-creators/select-story.ts","store/stories/action-creators/tag-color.ts","store/stories/action-creators/tag-passage.ts","store/stories/action-creators/update-story.ts","store/stories/reducer/create-passage.ts","store/stories/reducer/delete-passage.ts","store/stories/reducer/repair/repair-passage.ts","store/stories/reducer/repair/repair-story.ts","store/stories/reducer/update-passage.ts","store/stories/reducer/index.ts","store/stories/reducer/create-passages.ts","store/stories/reducer/create-story.ts","store/stories/reducer/delete-passages.ts","store/stories/reducer/delete-story.ts","store/stories/reducer/init.ts","store/stories/reducer/repair/repair-state.ts","store/stories/reducer/update-passages.ts","store/stories/reducer/update-story.ts","store/stories/stories-context.tsx","dialogs/passage-edit/passage-text.tsx","store/use-codemirror-passage-hints.ts","store/use-format-codemirror-mode.ts","dialogs/passage-edit/passage-toolbar.tsx","dialogs/passage-edit/story-format-toolbar.tsx","store/use-format-codemirror-toolbar.ts","dialogs/passage-edit/tag-toolbar.tsx","dialogs/passage-edit/passage-edit.tsx","components/control/file-input.tsx","dialogs/story-import/file-chooser.tsx","dialogs/story-import/story-chooser.tsx","dialogs/story-import/story-import.tsx","store/undoable-stories/reverse-action.ts","store/undoable-stories/reverse-thunk.ts","store/undoable-stories/reducer.ts","store/undoable-stories/undoable-stories-context.tsx","components/story-format/story-format-select.tsx","dialogs/story-details/story-stats.tsx","dialogs/story-details/story-details.tsx","components/control/font-select.tsx","util/locales.ts","dialogs/app-prefs.tsx","store/prefs/prefs-context.tsx","store/prefs/reducer.ts","store/story-formats/story-formats-context.tsx","store/story-formats/reducer.ts","dialogs/about-twine/about-twine.tsx","components/loading-curtain/loading-curtain.tsx","store/locale-switcher.tsx","components/click-away-listener/click-away-listener.tsx","components/container/card-group.tsx","components/document-title/document-title.tsx","components/container/main-content.tsx","components/badge/badge.tsx","components/container/card/selectable-card.tsx","components/story-format/story-format-card/story-format-card-details.tsx","components/story-format/story-format-card/story-format-card.tsx","components/route-toolbar/back-button.tsx","components/route-toolbar/route-toolbar.tsx","store/use-publishing.ts","store/use-story-launch.ts","util/save-html.ts","route-actions/build-actions.tsx","route-actions/app-actions.tsx","routes/story-format-list/toolbar/formats/add-story-format-button.tsx","routes/story-format-list/toolbar/formats/default-story-format-button.tsx","routes/story-format-list/toolbar/formats/proofing-story-format-button.tsx","routes/story-format-list/toolbar/formats/remove-story-format-button.tsx","routes/story-format-list/toolbar/formats/story-format-extensions-button.tsx","routes/story-format-list/toolbar/formats/format-actions.tsx","routes/story-format-list/toolbar/view-actions.tsx","routes/story-format-list/toolbar/story-format-list-toolbar.tsx","routes/story-format-list/story-format-list-route.tsx","routes/story-edit/toolbar/passage/create-passage-button.tsx","routes/story-edit/toolbar/passage/delete-passages-button.tsx","routes/story-edit/toolbar/passage/edit-passages-buttons.tsx","routes/story-edit/toolbar/passage/select-all-passages-button.tsx","routes/story-edit/toolbar/passage/start-at-passage-button.tsx","routes/story-edit/toolbar/passage/test-passage-button.tsx","routes/story-edit/toolbar/passage/passage-actions.tsx","components/story/rename-story-button.tsx","routes/story-edit/toolbar/story/details-button.tsx","routes/story-edit/toolbar/story/find-replace-button.tsx","routes/story-edit/toolbar/story/javascript-button.tsx","routes/story-edit/toolbar/story/passage-tags-button.tsx","routes/story-edit/toolbar/story/stylesheet-button.tsx","routes/story-edit/toolbar/story/story-actions.tsx","routes/story-edit/toolbar/undo-redo-buttons.tsx","routes/story-edit/toolbar/story-edit-toolbar.tsx","routes/story-edit/zoom-buttons.tsx","routes/story-edit/use-zoom-transition.ts","components/marquee-selection/marquee-selection.tsx","components/passage/passage-connections/broken-connection.tsx","util/svg.ts","components/passage/passage-connections/passage-connection.tsx","components/passage/passage-connections/self-connection.tsx","components/passage/passage-connections/passage-connection-group.tsx","components/passage/passage-connections/link-markers.tsx","components/passage/passage-connections/start-connection.tsx","store/use-format-reference-parser.ts","components/passage/passage-connections/passage-connections.tsx","components/passage/passage-card.tsx","components/passage/passage-card-group.tsx","components/passage/passage-map/passage-map.tsx","routes/story-edit/marqueeable-passage-map.tsx","routes/story-edit/story-edit-route.tsx","routes/story-edit/use-zoom-shortcuts.ts","components/storage-quota/storage-quota.tsx","routes/story-list/toolbar/library/archive-button.tsx","routes/story-list/toolbar/library/import-story-button.tsx","routes/story-list/toolbar/library/story-tags-button.tsx","routes/story-list/toolbar/library/library-actions.tsx","routes/story-list/toolbar/story/create-story-button.tsx","components/control/confirm-button.tsx","routes/story-list/toolbar/story/delete-story-button.tsx","routes/story-list/toolbar/story/duplicate-story-button.tsx","routes/story-list/toolbar/story/edit-story-button.tsx","routes/story-list/toolbar/story/tag-story-button.tsx","routes/story-list/toolbar/story/story-actions.tsx","routes/story-list/toolbar/view/sort-by-button.tsx","routes/story-list/toolbar/view/tag-filter-button.tsx","routes/story-list/toolbar/view/view-actions.tsx","routes/story-list/toolbar/story-list-toolbar.tsx","util/hue-string.ts","components/story/story-preview.tsx","components/story/story-card.tsx","routes/story-list/story-cards.tsx","routes/story-list/story-list-route.tsx","store/prefs/use-donation-check.ts","util/replace-dom.ts","routes/story-play/story-play-route.tsx","routes/story-proof/story-proof-route.tsx","routes/story-test/story-test-route.tsx","components/welcome/welcome-card.tsx","routes/welcome/content.tsx","routes/welcome/welcome-route.tsx","routes/index.tsx","store/state-loader.tsx","store/theme-setter.tsx","app.tsx","index.tsx"],"names":["Tooltip","props","anchor","label","position","React","tooltipEl","setTooltipEl","arrowEl","setArrowEl","visible","setVisible","appearTimeout","setAppearTimeout","usePopper","modifiers","name","options","element","placement","strategy","styles","attributes","handleOnEnter","window","setTimeout","handleOnLeave","clearTimeout","addEventListener","removeEventListener","CSSTransition","classNames","in","mountOnEnter","timeout","unmountOnExit","aria-hidden","className","ref","role","style","popper","arrow","IconButton","disabled","icon","iconOnly","iconPosition","onClick","preventDefault","selectable","selected","tooltipPosition","variant","button","setButton","aria-label","undefined","aria-pressed","e","ButtonBar","orientation","children","ButtonBarSeparator","CardContent","DialogCard","collapsed","fixedSize","headerLabel","onChangeCollapsed","onClose","useErrorBoundary","didCatch","ErrorBoundary","error","t","useTranslation","console","calcdClassName","onKeyDown","event","key","floating","DialogEditor","lineAngle","p1","p2","Math","atan2","top","left","PI","lineDistance","hypot","rectCenter","rect","width","height","rectFromPoints","rectsIntersect","r1","r2","rectIntersectionWithLine","segmentStart","segmentEnd","result","NaN","segseg","boundingRect","rects","length","Error","right","bottom","i","rectRight","rectBottom","passageDefaults","highlighted","i18n","tags","text","storyDefaults","ifid","lastUpdate","Date","passages","script","snapToGrid","startPassage","storyFormat","storyFormatVersion","stylesheet","tagColors","zoom","CheckboxButton","checkedIcon","onChange","uncheckedIcon","value","otherProps","calculatedIcon","aria-disabled","aria-checked","isElectronRenderer","navigator","userAgent","indexOf","trivialPassageProps","trivialStoryProps","trivialStoryFormatProps","isPersistablePassageChange","Object","keys","some","includes","isPersistableStoryChange","isPersistableStoryFormatChange","formatEditorExtensions","format","twineVersion","loadState","properties","editorExtensions","twine","extensions","filter","semverSpec","satisfies","warn","version","info","namespaceForFormat","toLowerCase","replace","TextSelect","map","option","getAppInfo","process","archiveFilename","timestamp","toLocaleString","publishArchive","stories","appInfo","reduce","output","story","publishStory","startOptional","publishPassage","passage","localId","escape","toString","join","startLocalId","formatOptions","startId","find","p","id","passageData","forEach","index","tagData","tag","publishStoryWithFormat","formatSource","isValidTagName","test","MenuButton","items","other","buttonEl","setButtonEl","menuEl","setMenuEl","open","setOpen","closer","document","item","separator","checked","PromptButton","cancelIcon","cancelLabel","onSubmit","prompt","submitIcon","submitLabel","submitVariant","validate","mounted","validation","setValidation","a","current","valid","updateValidation","ariaLabel","onChangeOpen","message","buttonType","defaults","appTheme","codeEditorFontFamily","codeEditorFontScale","disabledStoryFormatEditorExtensions","donateShown","editorCursorBlinks","firstRunTime","getTime","lastUpdateSeen","lastUpdateCheckTime","locale","userLanguage","language","browserLanguage","systemLanguage","passageEditorFontFamily","passageEditorFontScale","proofingFormat","storyFormatListFilter","storyListSort","storyListTagFilter","storyTagColors","welcomeSeen","IconEmpty","viewBox","stroke","strokeWidth","fill","strokeLinecap","strokeLinejoin","IconLoading","IconTwine","xmlns","xmlnsXlink","offset","stopColor","stopOpacity","xlinkHref","x1","y1","x2","y2","gradientUnits","gradientTransform","d","transform","attachments","prefixTriggerOption","cm","prefixes","callback","checkTrigger","state","completionActive","curWord","findWordAt","getDoc","getCursor","ch","prevWordRange","prevWord","getRange","head","push","on","off","editor","inited","CodeMirror","defineOption","CodeArea","fontFamily","fontScale","fontSize","classnames","labelHidden","i18next","createInstance","use","HttpBackend","initReactI18next","init","debug","backend","loadPath","fallbackLng","interpolation","escapeValue","load","twineElectron","prefKeys","ipcRenderer","invoke","prefs","saveJson","filename","data","send","saveMiddleware","action","type","Array","isArray","file","importStories","htmlSource","mtime","lastState","saveStory","formats","formatWithNameAndVersion","source","fetchStoryFormatProperties","url","storyWithName","storyWithId","storyId","oldStory","newStory","once","passageUpdates","passageId","storyFormats","uuid","userAdded","serialized","localStorage","getItem","split","serializedPref","JSON","parse","previouslySerialized","removeItem","ids","setItem","stringify","save","serializedStories","serializedStory","serializedPassages","serializedPassage","trim","values","addUnique","list","RegExp","contains","remove","substring","doUpdateTransaction","updater","transaction","passageIds","storyIds","savePassage","deletePassageById","passageWithName","deleteStory","passageWithId","serializedFormat","loadError","usePersistence","electronIpcPersistence","localStoragePersistence","ErrorMessage","GlobalErrorBoundary","href","rel","target","stack","SafariWarningCard","browser","UAParser","getBrowser","parseInt","Number","isFinite","safariNavigator","standalone","canAddToHomeScreen","AddTagButton","assignedTags","existingTags","onAdd","creatingTag","setCreatingTag","newColor","setNewColor","newName","setNewName","validationMessage","canAdd","tagName","colors","color","TagButton","checkable","onChangeColor","onRemove","IconLink","IndentButtons","execCommand","command","focus","UndoRedoButtons","watch","canRedo","setCanRedo","canUndo","setCanUndo","history","historySize","redo","undo","TextInput","onInput","placeholder","Card","requestQueue","Promise","resolve","jsonpRequester","jsonp","reject","then","resolveQueue","err","builtins","unusedName","existing","suffix","useStoreErrorReporter","useSuspense","ready","reportError","messageKey","alert","codeMirrorOptionsFromPrefs","extraKeys","Insert","cursorBlinkRate","CardButton","focusSelector","cardEl","setCardEl","focusTrapOptions","clickOutsideDeactivates","onDeactivate","internalLinks","link","nonEmptyLinks","removeSetters","noSetter","getField","removeEnclosingBrackets","substr","fields","extractLink","tagContent","parseLinks","internalOnly","uniq","match","extractLinkTags","createRegExp","search","flags","useRegexes","escapeRegExp","matchCase","escapeRegExpReplace","passageName","passageConnections","connectionParser","parser","passageMap","Map","draggable","broken","Set","connections","self","fixed","targetName","add","targetPassage","get","has","set","passagesMatchingSearch","includePassageNames","matcher","storyPassageTags","from","sort","storyStats","links","brokenLinks","characters","count","words","storyTags","s","DialogTransition","Dialogs","useScrollbarSize","useDialogsContext","dispatch","dialogs","marginBottom","marginRight","component","dialog","managementProps","TagStripe","title","displayName","reducer","exists","editedState","stateDialog","isEqual","DialogsContext","DialogsContextProvider","useThunkReducer","Provider","selectors","float","stringValue","parseFloat","query","el","selector","querySelectorAll","parseDimensions","raw","bits","html","lastUpdateOverride","nodes","createElement","innerHTML","storyEl","importedStory","startPassagePid","getAttribute","startPassageId","textContent","passageEl","size","domToObject","ButtonCard","DisabledRenamePassageButton","EnabledRenamePassageButton","onRename","RenamePassageButton","useComputedTheme","usePrefsContext","matchMedia","mediaQuery","matches","systemTheme","setSystemTheme","listener","TagEditor","allTags","onChangeName","Meter","domId","percent","aria-labelledby","aria-valuemin","aria-valuemax","aria-valuenow","FormatLoader","block","seenFormats","setSeenFormats","useStoryFormatsContext","newFormats","newFormat","oldFormat","loadAllFormatProperties","loadingFormat","f","loadPercent","setPref","formatEditorExtensionsDisabled","storyFileName","createFromProperties","deleteFormat","deselectAllFormats","getFormats","deselectFormat","loadFormatThunk","hydrate","hydrateResult","Function","call","toLoad","allSettled","loadFormatProperties","selectFormat","exclusive","getState","filteredFormats","semverLt","formatImageUrl","image","isAbsoluteUrl","formatWithId","newestFormatNamed","gt","sortFormats","b","AppDonationDialog","PassageTagsDialog","useUndoableStoriesContext","setTagColor","handleChangeColor","renamePassageTag","handleChangeTagName","StoryJavaScriptDialog","cmEditor","setCmEditor","useStoriesContext","editorDidMount","onBeforeChange","updateStory","autofocus","lineWrapping","mode","ignoreTab","Tab","StorySearchDialog","setFlags","setReplace","setFind","debouncedDispatch","debounce","toggleFlag","highlightPassagesMatchingSearch","replaceInStory","StoryStylesheetDialog","StoryTagsDialog","storiesDispatch","prefsDispatch","renameStoryTag","createNewlyLinkedPassages","newText","oldText","oldLinks","toCreate","l","passageDefs","passageGap","newPassagesWidth","needsMoving","createStory","createUntitledPassage","centerX","centerY","defs","bounds","max","round","deletePassages","duplicateStory","updatePassage","oldName","dontCreateNewlyLinkedPassages","oldNameEscaped","newNameEscaped","simpleLinkRegexp","compoundLinkRegexp","reverseLinkRegexp","relinkedPassage","replaceText","searchFor","replaceWith","replacer","replaceInPassage","matchIds","oldHighlighted","newHighlighted","toImport","existingStories","importStory","otherStory","existingStory","movePassages","xChange","yChange","deselectPassage","selectAllPassages","selectPassage","selectPassagesInRect","ignoreIds","r","deselectStory","deselectAllStories","selectStory","addPassageTag","removePassageTag","createPassage","passageProps","storyExists","created","newState","newPassage","deletePassage","foundStory","deleted","logRepair","propName","repairedValue","detail","repairStory","allStories","allFormats","defaultFormat","storyDefs","repairs","newId","newIfid","entries","defKey","repairFormat","anyPassageRepaired","repairedPassages","repairedPassage","parentStory","pos","posKey","dim","dimKey","otherPassage","repairPassage","updated","createPassages","storyProps","toUpperCase","repairState","updatePassages","updatedStory","StoriesContext","StoriesContextProvider","storiesPersistence","persistedReducer","PassageText","onEditorChange","storyFormatExtensionsDisabled","changePending","setChangePending","localText","setLocalText","autocompletePassageNames","showHint","completeSingle","character","hint","doc","replaceRange","close","wordRange","word","comps","to","useCodeMirrorPassageHints","formatName","formatVersion","modeName","setModeName","extensionsDisabled","codeMirror","defineMode","useFormatCodeMirrorMode","debouncedOnChange","handleMount","refresh","handleChange","prefixTrigger","PassageToolbar","isStart","handleSetSize","StoryFormatToolbar","onExecCommand","containerRef","toolbarFactory","loaded","setLoaded","toolbarFunc","setToolbarFunc","namespace","commands","commandName","namespacedCommand","toolbar","environment","subitem","useFormatCodeMirrorToolbar","toolbarItems","setToolbarItems","tryToSetToolbar","getComputedStyle","foregroundColor","src","alt","TagToolbar","handleChangeTagColor","InnerPassageEditDialog","storyFormatExtensionsEnabled","setStoryFormatExtensionsEnabled","editorCrashed","setEditorCrashed","resetError","reset","handlePassageTextChange","selections","listSelections","setSelections","PassageEditDialog","FileInput","onError","changeEvent","files","reader","FileReader","loadEvent","readAsText","FileChooser","accept","StoryChooser","onImport","selectedStories","setSelectedStories","willReplaceExisting","StoryImportDialog","setFile","setStories","reverseAction","prop","passageResult","reverseThunk","thunk","actions","actionOrThunk","newChange","description","storiesState","newChanges","changes","slice","currentChange","min","change","UndoableStoriesContext","UndoableStoriesContextProvider","dispatchAndRecordStoryAction","redoLabel","undoLabel","StoryFormatSelect","selectedFormat","loadingFormats","loadingCount","dateFormatter","Intl","DateTimeFormat","dateStyle","timeStyle","StoryDetailsDialogStats","stats","date","StoryDetailsDialog","families","scales","FontSelect","familyLabel","onChangeFamily","onChangeScale","scaleLabel","customScaleVisible","setCustomScaleVisible","customFamilyVisible","setCustomFamilyVisible","customFamily","setCustomFamily","customScale","setCustomScale","scale","locales","code","closestAppLocale","roughCode","roughMatch","AppPrefsDialog","PrefsContext","PrefsContextProvider","prefKey","defaultBuiltins","StoryFormatsContext","StoryFormatsContextProvider","builtinFormats","keep","builtinFormat","AboutTwineDialog","dangerouslySetInnerHTML","__html","credits","c","localizations","LoadingCurtain","LocaleSwitcher","changeLanguage","ClickAwayListener","ignoreSelector","onClickAway","closest","CardGroup","gridTemplateColumns","columnWidth","columns","maxWidth","DocumentTitle","querySelector","Helmet","MainContent","grabbable","padded","dragScrollStart","dragMouseStart","container","moveListener","scrollLeft","clientX","scrollTop","clientY","upListener","releasePointerCapture","pointerId","cursor","downListener","setPointerCapture","ignoreContext","Badge","SelectableCard","onDoubleClick","onSelect","ctrlKey","shiftKey","tabIndex","StoryFormatCardDetails","errorMessage","author","license","StoryFormatCard","editorExtensionsDisabled","proofing","BackButton","useHistory","location","pathname","goBack","RouteToolbar","helpUrl","pinnedControls","tabs","selectedTabClassName","tabName","tabContent","usePublishing","storyFormatsDispatch","proofStory","formatProperties","publishOptions","publishStoryData","useStoryLaunch","playStory","testStory","saveHtml","Blob","saveAs","BuildActions","AppActions","isValidUrl","URL","AddStoryFormatButton","newFormatUrl","setNewFormatUrl","storyFormatName","DefaultStoryFormatButton","ProofingStoryFormatButton","RemoveStoryFormatButton","isDefault","isProofing","StoryFormatExtensionsButton","FormatActions","selectedFormats","ViewActions","setFilter","StoryFormatListToolbar","StoryFormatListRoute","formatsDispatch","visibleFormats","TransitionGroup","disabledFormat","handleSelect","CreatePassageButton","getCenter","handleClick","DeletePassagesButton","useHotkeys","EditPassagesButton","SelectAllPassagesButton","StartAtPassageButton","TestPassageButton","PassageActions","selectedPassages","soloSelectedPassage","handleRename","DisabledRenameStoryButton","EnabledRenameStoryButton","RenameStoryButton","DetailsButton","FindReplaceButton","JavaScriptButton","PassageTagsButton","StylesheetButton","StoryActions","StoryEditToolbar","ZoomButtons","handleZoomChange","useZoomTransition","scrollTarget","setCurrent","transition","step","requestAnimationFrame","lastTimestamp","elapsed","setter","start","time","quadOut","transitionStep","newLeft","scrollNormalizedCenter","scrollCenter","newTop","clientWidth","clientHeight","MarqueeSelection","ignoreEventsOnSelector","onSelectRect","onTemporarySelectRect","additive","setAdditive","dragging","setDragging","setStart","currentContainerRect","currentContainer","relativePointerPos","pointerType","getBoundingClientRect","lineOffset","sqrt","BrokenConnection","markerEnd","arc","end","radius","largeArc","sweep","rotation","PassageConnection","path","offsetStart","offsetEnd","startPoint","endPoint","distance","SelfConnection","PassageConnectionGroup","connection","LinkMarkers","refX","refY","markerWidth","markerHeight","orient","cx","cy","StartConnection","markerStart","emptyFunc","emptySet","noOffset","PassageConnections","referenceParser","setEditorExtensions","references","parsePassageText","useFormatReferenceParser","draggableLinks","fixedLinks","draggableReferences","fixedReferences","PassageCard","onDeselect","onDrag","onDragStart","onDragStop","onEdit","excerpt","deviceType","handleMouseDown","handleEdit","nodeRef","onMouseDown","onStart","onStop","PassageCardGroup","sortedPassages","dragReducer","dragX","x","dragY","y","startX","startY","PassageMap","onMiddleClick","visibleZoom","compactCards","setCompactCards","passageBounds","setProperty","handleDragStart","body","classList","handleDrag","handleDragStop","handleMouseUp","containerRect","onMouseUp","MarqueeablePassageMap","temporaryRect","setTemporaryRect","temporaryAdditive","setTemporaryAdditive","innerPassages","handleTemporarySelectRect","handleSelectRect","InnerStoryEditRoute","setInited","dialogsDispatch","mainContent","useParams","undoableStoriesDispatch","keydown","keyup","useZoomShortcuts","handleMiddleClick","handleDeselectPassage","handleDragPassages","abs","handleEditPassage","handleSelectPassage","logicalRect","center","StoryEditRoute","StorageQuota","lastWatch","setLastWatch","working","setWorking","percentFree","setPercentFree","hide","storage","estimate","quota","usage","toFixed","run","ArchiveButton","ImportStoryButton","StoryTagsButton","LibraryActions","CreateStoryButton","ConfirmButton","confirmIcon","confirmLabel","confirmVariant","onConfirm","DeleteStoryButton","storyName","setStoryName","DuplicateStoryButton","EditStoryButton","TagStoryButton","tagColor","selectedStory","SortByButton","TagFilterButton","StoryListToolbar","hueString","charCodeAt","StoryPreview","hues","minX","POSITIVE_INFINITY","minY","maxX","NEGATIVE_INFINITY","maxY","svg","circle","bgRadius","StoryCard","onChangeTagColor","onRemoveTag","StoryCards","onSelectStory","handleRemoveTag","InnerStoryListRoute","shouldShowDonationPrompt","now","useDonationCheck","visibleStories","filteredStories","sortBy","StoryListRoute","replaceDom","SVG","Store","StoryFormat","amdDefine","app","jQuery","write","StoryPlayRoute","StoryProofRoute","StoryTestRoute","WelcomeCard","nextLabel","onNext","onSkip","showSkip","content","WelcomeRoute","containerEl","shown","setShown","allCards","visibleCards","lastCard","scroll","documentElement","offsetTop","duration","finish","showNext","card","Routes","exact","render","StateLoader","initing","setIniting","prefsRepaired","setPrefsRepaired","formatsRepaired","setFormatsRepaired","storiesRepaired","setStoriesRepaired","prefsState","formatsState","safeFormat","ThemeSetter","computedTheme","dataset","App","fallback","ReactDOM","getElementById"],"mappings":"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","file":"static/js/main.32bd2de0.chunk.js","sourcesContent":["export * from './action-creators';\nexport * from './defaults';\nexport * from './getters';\nexport * from './stories-context';\nexport * from './stories.types';\nexport * from './zoom';\n","import * as React from 'react';\nimport {CSSTransition} from 'react-transition-group';\nimport {usePopper} from 'react-popper';\nimport {Placement} from '@popperjs/core';\nimport './tooltip.css';\n\nexport interface TooltipProps {\n\tanchor: HTMLElement | null;\n\tlabel: string;\n\tposition?: Placement;\n}\n\n// This component is intentionally limited in functionality. It should *only* be\n// used to duplicate content that is only perceivable by screen readers or other\n// assistive technology, e.g. through an `aria-label` attribute. The one use\n// case right now in the app are icon-only buttons.\n//\n// Content in these components is *not* accessible to screen readers and should\n// not be. That content should be placed in an `aria-label` attribute instead.\n\nexport const Tooltip: React.FC<TooltipProps> = props => {\n\tconst {anchor, label, position = 'top'} = props;\n\tconst [tooltipEl, setTooltipEl] = React.useState<HTMLDivElement | null>(null);\n\tconst [arrowEl, setArrowEl] = React.useState<HTMLDivElement | null>(null);\n\tconst [visible, setVisible] = React.useState(false);\n\tconst [appearTimeout, setAppearTimeout] = React.useState<number>();\n\tconst {styles, attributes} = usePopper(anchor, tooltipEl, {\n\t\tmodifiers: [{name: 'arrow', options: {element: arrowEl}}, {name: 'flip'}],\n\t\tplacement: position,\n\t\tstrategy: 'fixed'\n\t});\n\n\tReact.useEffect(() => {\n\t\tconst handleOnEnter = () =>\n\t\t\tsetAppearTimeout(window.setTimeout(() => setVisible(true), 500));\n\t\tconst handleOnLeave = () => {\n\t\t\tif (appearTimeout) {\n\t\t\t\twindow.clearTimeout(appearTimeout);\n\t\t\t}\n\n\t\t\tsetVisible(false);\n\t\t};\n\n\t\tif (anchor) {\n\t\t\tanchor.addEventListener('pointerenter', handleOnEnter);\n\t\t\tanchor.addEventListener('pointerleave', handleOnLeave);\n\t\t\treturn () => {\n\t\t\t\tanchor.removeEventListener('pointerenter', handleOnEnter);\n\t\t\t\tanchor.removeEventListener('pointerleave', handleOnLeave);\n\t\t\t};\n\t\t}\n\t}, [anchor, appearTimeout]);\n\n\treturn (\n\t\t<CSSTransition\n\t\t\tclassNames=\"fade-in-out\"\n\t\t\tin={visible}\n\t\t\tmountOnEnter\n\t\t\ttimeout={200}\n\t\t\tunmountOnExit\n\t\t>\n\t\t\t<div\n\t\t\t\taria-hidden\n\t\t\t\tclassName=\"tooltip\"\n\t\t\t\tref={setTooltipEl}\n\t\t\t\trole=\"tooltip\"\n\t\t\t\tstyle={styles.popper}\n\t\t\t\t{...attributes.popper}\n\t\t\t>\n\t\t\t\t<div className=\"tooltip-arrow\" ref={setArrowEl} style={styles.arrow} />\n\t\t\t\t<div className=\"tooltip-label\">{label}</div>\n\t\t\t</div>\n\t\t</CSSTransition>\n\t);\n};\n","import * as React from 'react';\nimport classNames from 'classnames';\nimport './icon-button-link.css';\nimport {Tooltip, TooltipProps} from '../tooltip';\n\nexport interface IconButtonProps {\n\tbuttonType?: 'button' | 'submit';\n\tdisabled?: boolean;\n\ticon: React.ReactNode;\n\ticonOnly?: boolean;\n\ticonPosition?: 'start' | 'end';\n\tlabel: string;\n\tonClick?: (e: React.MouseEvent) => void;\n\tpreventDefault?: boolean;\n\tselectable?: boolean;\n\tselected?: boolean;\n\ttooltipPosition?: TooltipProps['position'];\n\tvariant?: 'create' | 'danger' | 'primary' | 'secondary';\n}\n\nexport const IconButton = React.forwardRef<HTMLButtonElement, IconButtonProps>(\n\t(props, ref) => {\n\t\tconst {\n\t\t\tdisabled,\n\t\t\ticon,\n\t\t\ticonOnly,\n\t\t\ticonPosition = 'start',\n\t\t\tonClick,\n\t\t\tpreventDefault,\n\t\t\tselectable = false,\n\t\t\tselected = false,\n\t\t\ttooltipPosition,\n\t\t\tvariant = 'secondary'\n\t\t} = props;\n\t\tconst className = classNames(\n\t\t\t'icon-button',\n\t\t\t`icon-position-${iconPosition}`,\n\t\t\t{selected: selected},\n\t\t\t`variant-${variant}`,\n\t\t\t{'icon-only': iconOnly}\n\t\t);\n\t\tconst [button, setButton] = React.useState<HTMLButtonElement | null>(null);\n\t\tReact.useImperativeHandle(ref, () => button as HTMLButtonElement);\n\t\tconst handleOnClick = (e: React.MouseEvent) => {\n\t\t\tonClick && onClick(e);\n\n\t\t\tif (preventDefault) {\n\t\t\t\te.preventDefault();\n\t\t\t}\n\t\t};\n\n\t\treturn (\n\t\t\t<>\n\t\t\t\t<button\n\t\t\t\t\taria-label={iconOnly ? props.label : undefined}\n\t\t\t\t\taria-pressed={selectable ? selected : undefined}\n\t\t\t\t\tdisabled={disabled}\n\t\t\t\t\tclassName={className}\n\t\t\t\t\tonClick={handleOnClick}\n\t\t\t\t\tref={setButton}\n\t\t\t\t>\n\t\t\t\t\t<span className=\"icon\">{icon}</span>\n\t\t\t\t\t{!iconOnly && props.label}\n\t\t\t\t</button>\n\t\t\t\t{iconOnly && (\n\t\t\t\t\t<Tooltip\n\t\t\t\t\t\tanchor={button}\n\t\t\t\t\t\tlabel={props.label}\n\t\t\t\t\t\tposition={tooltipPosition}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\t\t\t</>\n\t\t);\n\t}\n);\n","export * from './action-creators';\nexport * from './defaults';\nexport * from './getters';\nexport * from './prefs-context';\nexport * from './prefs.types';\n","export * from './action-creators';\nexport * from './defaults';\nexport * from './getters';\nexport * from './story-formats-context';\nexport * from './story-formats.types';\n","import * as React from 'react';\nimport classNames from 'classnames';\nimport './button-bar.css';\n\nexport interface ButtonBarProps {\n\torientation?: 'horizontal' | 'vertical';\n}\n\nexport const ButtonBar: React.FC<ButtonBarProps> = props => (\n\t<div\n\t\tclassName={classNames(\n\t\t\t'button-bar',\n\t\t\t`orientation-${props.orientation ?? 'horizontal'}`\n\t\t)}\n\t>\n\t\t{props.children}\n\t</div>\n);\n","import * as React from 'react';\nimport './button-bar-separator.css';\n\nexport const ButtonBarSeparator: React.FC = () => (\n\t<div className=\"button-bar-separator\" />\n);\n","export * from './about-twine';\nexport * from './app-donation';\nexport * from './app-prefs';\nexport * from './context';\nexport * from './context/dialogs';\nexport * from './dialogs.types';\nexport * from './passage-edit';\nexport * from './passage-tags';\nexport * from './story-import';\nexport * from './story-javascript';\nexport * from './story-details';\nexport * from './story-search';\nexport * from './story-stylesheet';\nexport * from './story-tags';\n","import * as React from 'react';\nimport './card-content.css';\n\nexport const CardContent: React.FC = ({children}) => (\n\t<div className=\"card-content\">{children}</div>\n);\n","export * from './undoable-stories-context';\nexport * from './undoable-stories.types';\n","import * as React from 'react';\nimport classNames from 'classnames';\nimport {useTranslation} from 'react-i18next';\nimport {IconChevronDown, IconChevronUp, IconX} from '@tabler/icons';\nimport {Card} from '../card';\nimport {IconButton} from '../../control/icon-button';\nimport './dialog-card.css';\nimport useErrorBoundary from 'use-error-boundary';\nimport {ErrorMessage} from '../../error';\n\nexport interface DialogCardProps {\n\tclassName?: string;\n\tcollapsed: boolean;\n\tfixedSize?: boolean;\n\theaderLabel: string;\n\tonChangeCollapsed: (value: boolean) => void;\n\tonClose: () => void;\n}\n\nexport const DialogCard: React.FC<DialogCardProps> = props => {\n\tconst {\n\t\tchildren,\n\t\tclassName,\n\t\tcollapsed,\n\t\tfixedSize,\n\t\theaderLabel,\n\t\tonChangeCollapsed,\n\t\tonClose\n\t} = props;\n\tconst {didCatch, ErrorBoundary, error} = useErrorBoundary();\n\tconst {t} = useTranslation();\n\n\tReact.useEffect(() => {\n\t\tif (error) {\n\t\t\tconsole.error(error);\n\t\t}\n\t}, [error]);\n\n\tconst calcdClassName = classNames('dialog-card', className, {\n\t\tcollapsed,\n\t\t'fixed-size': fixedSize\n\t});\n\n\tfunction handleKeyDown(event: React.KeyboardEvent) {\n\t\tif (event.key === 'Escape') {\n\t\t\tonClose();\n\t\t}\n\t}\n\n\treturn (\n\t\t<div\n\t\t\taria-label={headerLabel}\n\t\t\trole=\"dialog\"\n\t\t\tclassName={calcdClassName}\n\t\t\tonKeyDown={handleKeyDown}\n\t\t>\n\t\t\t<Card floating>\n\t\t\t\t<h2>\n\t\t\t\t\t<div className=\"dialog-card-header\">\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\ticon={collapsed ? <IconChevronUp /> : <IconChevronDown />}\n\t\t\t\t\t\t\tlabel={headerLabel}\n\t\t\t\t\t\t\tonClick={() => onChangeCollapsed(!collapsed)}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div className=\"dialog-card-header-controls\">\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\ticon={<IconX />}\n\t\t\t\t\t\t\ticonOnly\n\t\t\t\t\t\t\tlabel={t('common.close')}\n\t\t\t\t\t\t\tonClick={onClose}\n\t\t\t\t\t\t\ttooltipPosition=\"left\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</h2>\n\t\t\t\t{didCatch ? (\n\t\t\t\t\t<ErrorMessage>\n\t\t\t\t\t\t{t('components.dialogCard.contentsCrashed')}\n\t\t\t\t\t</ErrorMessage>\n\t\t\t\t) : (\n\t\t\t\t\t<ErrorBoundary>{!collapsed && children}</ErrorBoundary>\n\t\t\t\t)}\n\t\t\t</Card>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport './dialog-editor.css';\n\nexport const DialogEditor: React.FC = props => (\n\t<div className=\"dialog-editor\">{props.children}</div>\n);\n","import segseg, {SegSegVector} from 'segseg';\n\nexport interface Point {\n\ttop: number;\n\tleft: number;\n}\n\nexport interface Rect extends Point {\n\theight: number;\n\twidth: number;\n}\n\n/**\n * Returns the angle between two points in degrees.\n * @see https://gist.github.com/conorbuck/2606166\n */\nexport function lineAngle(p1: Point, p2: Point) {\n\treturn (Math.atan2(p2.top - p1.top, p2.left - p1.left) * 180) / Math.PI;\n}\n\n/**\n * Returns the length of the line segment between two points.\n */\nexport function lineDistance(p1: Point, p2: Point) {\n\treturn Math.hypot(p1.left - p2.left, p1.top - p2.top);\n}\n\n/**\n * Returns the center of a rectangle.\n */\nexport function rectCenter(rect: Rect): Point {\n\treturn {left: rect.left + rect.width / 2, top: rect.top + rect.height / 2};\n}\n\n/**\n * Creates a rectangle from two points, regardless of their relative position.\n */\n\nexport function rectFromPoints(p1: Point, p2: Point): Rect {\n\tconst rect: Rect = {height: 0, left: 0, top: 0, width: 0};\n\n\tif (p1.left < p2.left) {\n\t\trect.left = p1.left;\n\t\trect.width = p2.left - p1.left;\n\t} else {\n\t\trect.left = p2.left;\n\t\trect.width = p1.left - p2.left;\n\t}\n\n\tif (p1.top < p2.top) {\n\t\trect.top = p1.top;\n\t\trect.height = p2.top - p1.top;\n\t} else {\n\t\trect.top = p2.top;\n\t\trect.height = p1.top - p2.top;\n\t}\n\n\treturn rect;\n}\n\n/**\n * Returns whether two rectangles intersect.\n * @see http://stackoverflow.com/questions/2752349/fast-rectangle-to-rectangle-intersection\n */\nexport function rectsIntersect(r1: Rect, r2: Rect) {\n\treturn !(\n\t\tr2.left > r1.left + r1.width ||\n\t\tr2.left + r2.width < r1.left ||\n\t\tr2.top > r1.top + r1.height ||\n\t\tr2.top + r2.height < r1.top\n\t);\n}\n\n/**\n * Returns the intersection point between a rectangle and a line segment. If\n * none exists, this returns null.\n */\nexport function rectIntersectionWithLine(\n\trect: Rect,\n\tsegmentStart: Point,\n\tsegmentEnd: Point\n): Point | null {\n\tlet result: SegSegVector = [NaN, NaN];\n\n\t// Left side.\n\n\tif (\n\t\tsegseg(\n\t\t\tresult,\n\t\t\t[rect.left, rect.top],\n\t\t\t[rect.left, rect.top + rect.height],\n\t\t\t[segmentStart.left, segmentStart.top],\n\t\t\t[segmentEnd.left, segmentEnd.top]\n\t\t)\n\t) {\n\t\treturn {\n\t\t\tleft: result[0],\n\t\t\ttop: result[1]\n\t\t};\n\t}\n\n\t// Right side.\n\n\tif (\n\t\tsegseg(\n\t\t\tresult,\n\t\t\t[rect.left + rect.width, rect.top],\n\t\t\t[rect.left + rect.width, rect.top + rect.height],\n\t\t\t[segmentStart.left, segmentStart.top],\n\t\t\t[segmentEnd.left, segmentEnd.top]\n\t\t)\n\t) {\n\t\treturn {\n\t\t\tleft: result[0],\n\t\t\ttop: result[1]\n\t\t};\n\t}\n\n\t// Top side.\n\n\tif (\n\t\tsegseg(\n\t\t\tresult,\n\t\t\t[rect.left, rect.top],\n\t\t\t[rect.left + rect.width, rect.top],\n\t\t\t[segmentStart.left, segmentStart.top],\n\t\t\t[segmentEnd.left, segmentEnd.top]\n\t\t)\n\t) {\n\t\treturn {\n\t\t\tleft: result[0],\n\t\t\ttop: result[1]\n\t\t};\n\t}\n\n\t// Bottom side.\n\n\tif (\n\t\tsegseg(\n\t\t\tresult,\n\t\t\t[rect.left, rect.top + rect.height],\n\t\t\t[rect.left + rect.width, rect.top + rect.height],\n\t\t\t[segmentStart.left, segmentStart.top],\n\t\t\t[segmentEnd.left, segmentEnd.top]\n\t\t)\n\t) {\n\t\treturn {\n\t\t\tleft: result[0],\n\t\t\ttop: result[1]\n\t\t};\n\t}\n\n\treturn null;\n}\n\n/**\n * Returns a rectangle enclosing a set of rectangles.\n */\nexport function boundingRect(rects: Rect[]) {\n\tif (rects.length === 0) {\n\t\tthrow new Error(\"Can't calculate bounding rect for 0 rects\");\n\t}\n\n\tlet left = rects[0].left;\n\tlet right = rects[0].left + rects[0].width;\n\tlet top = rects[0].top;\n\tlet bottom = rects[0].top + rects[0].height;\n\n\tfor (let i = 1; i < rects.length; i++) {\n\t\tconst rectRight = rects[i].left + rects[i].width;\n\t\tconst rectBottom = rects[i].top + rects[i].height;\n\n\t\tif (rects[i].left < left) {\n\t\t\tleft = rects[i].left;\n\t\t}\n\n\t\tif (rects[i].top < top) {\n\t\t\ttop = rects[i].top;\n\t\t}\n\n\t\tif (rectRight > right) {\n\t\t\tright = rectRight;\n\t\t}\n\n\t\tif (rectBottom > bottom) {\n\t\t\tbottom = rectBottom;\n\t\t}\n\t}\n\n\treturn {left, top, height: bottom - top, width: right - left};\n}\n","import {i18n} from '../../util/i18n';\nimport {Passage, Story} from './stories.types';\n\nexport const passageDefaults = (): Omit<Passage, 'id' | 'story'> => ({\n\theight: 100,\n\thighlighted: false,\n\tleft: 0,\n\tname: i18n.t('store.passageDefaults.name'),\n\tselected: false,\n\ttags: [],\n\ttext: '',\n\ttop: 0,\n\twidth: 100\n});\n\nexport const storyDefaults = (): Omit<Story, 'id'> => ({\n\tifid: '',\n\tlastUpdate: new Date(),\n\tpassages: [],\n\tname: i18n.t('store.storyDefaults.name'),\n\tscript: '',\n\tselected: false,\n\tsnapToGrid: true,\n\tstartPassage: '',\n\tstoryFormat: '',\n\tstoryFormatVersion: '',\n\tstylesheet: '',\n\ttags: [],\n\ttagColors: {},\n\tzoom: 1\n});\n","import * as React from 'react';\nimport {IconSquare, IconSquareCheck} from '@tabler/icons';\nimport {IconButton, IconButtonProps} from './icon-button';\n\nexport interface CheckboxButtonProps\n\textends Omit<IconButtonProps, 'icon' | 'onClick'> {\n\tcheckedIcon?: React.ReactNode;\n\ticon?: React.ReactNode;\n\tonChange: (value: boolean) => void;\n\tuncheckedIcon?: React.ReactNode;\n\tvalue: boolean;\n}\n\nexport const CheckboxButton: React.FC<CheckboxButtonProps> = props => {\n\tconst {\n\t\tcheckedIcon,\n\t\ticon,\n\t\tonChange,\n\t\tuncheckedIcon,\n\t\tvalue,\n\t\t...otherProps\n\t} = props;\n\tconst calculatedIcon = value\n\t\t? checkedIcon ?? <IconSquareCheck />\n\t\t: uncheckedIcon ?? <IconSquare />;\n\n\treturn (\n\t\t<span\n\t\t\taria-disabled={otherProps.disabled}\n\t\t\tclassName=\"checkbox-button\"\n\t\t\trole=\"checkbox\"\n\t\t\taria-checked={value}\n\t\t>\n\t\t\t<IconButton\n\t\t\t\ticon={icon ?? calculatedIcon}\n\t\t\t\tonClick={() => onChange(!value)}\n\t\t\t\t{...otherProps}\n\t\t\t/>\n\t\t</span>\n\t);\n};\n","/**\n * Is this code currently in an Electron renderer process? Returns false if\n * either this is running in the Electron main process, or Electron is not\n * involved at all.\n * @see https://github.com/electron/electron/issues/2288#issuecomment-337858978\n */\nexport const isElectronRenderer = () =>\n\twindow.navigator.userAgent.indexOf('Electron') !== -1;\n\n/**\n * Is this code currently running in an Electron main process? Returns false if\n * either this is running in an Electron renderer process, or Electron is not\n * involved at all.\n * @see https://github.com/electron/electron/issues/2288#issuecomment-611231970\n */\n\nexport const isElectronMain = () => process.versions.hasOwnProperty('electron');\n","export * from './electron-shared.types';\nexport * from './story-filename';\n","import {Passage, Story} from '../stories';\nimport {StoryFormat} from '../story-formats';\n\nconst trivialPassageProps: (keyof Passage)[] = ['highlighted', 'selected'];\nconst trivialStoryProps: (keyof Story)[] = ['lastUpdate', 'selected'];\n\n// Loosely typing this because of the different load states possible in the type.\nconst trivialStoryFormatProps: string[] = [\n\t'loadError',\n\t'loadState',\n\t'properties',\n\t'selected'\n];\n\n/**\n * Is a passage change persistable? e.g. is it nontrivial?\n */\nexport function isPersistablePassageChange(props: Partial<Passage>) {\n\treturn Object.keys(props).some(\n\t\tkey => !trivialPassageProps.includes(key as keyof Passage)\n\t);\n}\n\n/**\n * Is a story change persistable? e.g. is it nontrivial?\n */\nexport function isPersistableStoryChange(props: Partial<Story>) {\n\treturn Object.keys(props).some(\n\t\tkey => !trivialStoryProps.includes(key as keyof Story)\n\t);\n}\n\n/**\n * Is a story format persistable? e.g. is it nontrivial?\n */\nexport function isPersistableStoryFormatChange(props: Partial<StoryFormat>) {\n\treturn Object.keys(props).some(\n\t\tkey => !trivialStoryFormatProps.includes(key as keyof StoryFormat)\n\t);\n}","import {StoryFormat} from '../../store/story-formats';\nimport {satisfies} from 'semver';\n\n/**\n * Returns editor extensions in a format that fit the Twine version specified.\n * If none are available, then this returns undefined.\n */\nexport function formatEditorExtensions(\n\tformat: StoryFormat,\n\ttwineVersion: string\n) {\n\tif (format.loadState !== 'loaded') {\n\t\treturn;\n\t}\n\n\tif (!format.properties.editorExtensions?.twine) {\n\t\treturn;\n\t}\n\n\tconst extensions = Object.keys(\n\t\tformat.properties.editorExtensions.twine\n\t).filter(semverSpec => satisfies(twineVersion, semverSpec));\n\n\tif (extensions.length === 0) {\n\t\tconsole.info(\n\t\t\t`${format.name} ${format.version} has editor extensions, but none that ${twineVersion} satisfies`\n\t\t);\n\t\treturn;\n\t}\n\n\tif (extensions.length > 1) {\n\t\tconsole.warn(\n\t\t\t`More than one set of editor extensions for ${format.name} ${format.version} is satisfied by ${twineVersion}. Using the first.`\n\t\t);\n\t}\n\n\treturn format.properties.editorExtensions.twine[extensions[0]];\n}\n","import {StoryFormat} from '../../store/story-formats';\n\n/**\n * Returns a namespace prefix for a story format that is compatible with\n * CodeMirror names (modes and commands).\n */\nexport function namespaceForFormat(format: StoryFormat) {\n\treturn format.name.toLowerCase().replace(/\\s/g, '-') + '-' + format.version;\n}\n","import * as React from 'react';\nimport classNames from 'classnames';\nimport './text-select.css';\n\nexport interface SelectOption {\n\tdisabled?: boolean;\n\tlabel: string;\n\tvalue: string;\n}\n\nexport interface TextSelectProps {\n\tchildren: React.ReactNode;\n\tonChange?: React.ChangeEventHandler<HTMLSelectElement>;\n\toptions: SelectOption[];\n\torientation?: 'horizontal' | 'vertical';\n\tvalue: string;\n}\n\nexport const TextSelect: React.FC<TextSelectProps> = props => {\n\tconst {children, onChange, options, orientation, value} = props;\n\tconst className = classNames(\n\t\t'text-select',\n\t\t`orientation-${orientation ?? 'horizontal'}`\n\t);\n\n\treturn (\n\t\t<span className={className}>\n\t\t\t<label>\n\t\t\t\t<span className=\"text-select-label\">{children}</span>\n\t\t\t\t<span className=\"text-select-control\">\n\t\t\t\t\t<select onChange={onChange} value={value}>\n\t\t\t\t\t\t{options.map(option => (\n\t\t\t\t\t\t\t<option\n\t\t\t\t\t\t\t\tdisabled={option.disabled}\n\t\t\t\t\t\t\t\tkey={option.value}\n\t\t\t\t\t\t\t\tvalue={option.value}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{option.label}\n\t\t\t\t\t\t\t</option>\n\t\t\t\t\t\t))}\n\t\t\t\t\t</select>\n\t\t\t\t</span>\n\t\t\t</label>\n\t\t</span>\n\t);\n};\n","export interface AppInfo {\n\tname: string;\n\tversion: string;\n}\n\n/**\n * Retrieves information about the Twine app itself based on buildtime\n * environment\n */\nexport function getAppInfo(): AppInfo {\n\treturn {\n\t\tname: process.env.REACT_APP_NAME as string,\n\t\tversion: process.env.REACT_APP_VERSION as string\n\t};\n}\n","import escape from 'lodash/escape';\nimport {Passage, Story} from '../store/stories';\nimport {AppInfo} from './app-info';\nimport {i18n} from './i18n';\n\nexport interface PublishOptions {\n\t/**\n\t * Options that will be passed as-is to the format in the `options` attribute\n\t * of the published `<tw-storydata>` tag.\n\t */\n\tformatOptions?: string;\n\n\t/**\n\t * ID of the passage to start the story at. This overrides what is set at the\n\t * story level.\n\t */\n\tstartId?: string;\n\n\t/**\n\t * If true, publishing will proceed even if the story has no starting passage\n\t * set and one wasn't set manually.\n\t */\n\tstartOptional?: boolean;\n}\n\n/**\n * Returns a filename for an archive file.\n */\nexport function archiveFilename() {\n\tconst timestamp = new Date().toLocaleString().replace(/[/:\\\\]/g, '.');\n\n\treturn i18n.t('store.archiveFilename', {timestamp});\n}\n\n/**\n * Publishes an archive of stories, e.g. all stories in one file with no story\n * format binding.\n */\nexport function publishArchive(stories: Story[], appInfo: AppInfo) {\n\treturn stories.reduce((output, story) => {\n\t\t// Force publishing even if there is no start point set.\n\n\t\treturn (\n\t\t\toutput + publishStory(story, appInfo, {startOptional: true}) + '\\n\\n'\n\t\t);\n\t}, '');\n}\n\n/**\n * Publishes a passage to an HTML fragment. This takes a id argument because\n * passages are numbered sequentially in published stories, not with a UUID.\n */\nexport function publishPassage(passage: Passage, localId: number) {\n\treturn (\n\t\t`<tw-passagedata pid=\"${escape(localId.toString())}\" ` +\n\t\t`name=\"${escape(passage.name)}\" ` +\n\t\t`tags=\"${escape(passage.tags.join(' '))}\" ` +\n\t\t`position=\"${passage.left},${passage.top}\" ` +\n\t\t`size=\"${passage.width},${passage.height}\">` +\n\t\t`${escape(passage.text)}</tw-passagedata>`\n\t);\n}\n\n/**\n * Does a \"naked\" publish of a story -- creating an HTML representation of it,\n * but without any story format binding.\n */\nexport function publishStory(\n\tstory: Story,\n\tappInfo: AppInfo,\n\t{formatOptions, startId, startOptional}: PublishOptions = {}\n) {\n\tstartId = startId ?? story.startPassage;\n\n\t// Verify that the start passage exists.\n\n\tif (!startOptional) {\n\t\tif (!startId) {\n\t\t\tthrow new Error(\n\t\t\t\t'There is no starting point set for this story and none was set manually.'\n\t\t\t);\n\t\t}\n\n\t\tif (!story.passages.find(p => p.id === startId)) {\n\t\t\tthrow new Error(\n\t\t\t\t'The passage set as starting point for this story does not exist.'\n\t\t\t);\n\t\t}\n\t}\n\n\t// The id of the start passage as it is published (*not* a UUID).\n\n\tlet startLocalId;\n\tlet passageData = '';\n\n\tstory.passages.forEach((p, index) => {\n\t\tpassageData += publishPassage(p, index + 1);\n\n\t\tif (p.id === startId) {\n\t\t\tstartLocalId = index + 1;\n\t\t}\n\t});\n\n\tconst tagData = Object.keys(story.tagColors).reduce(\n\t\t(result, tag) =>\n\t\t\tresult +\n\t\t\t`<tw-tag name=\"${escape(tag)}\" color=\"${escape(\n\t\t\t\tstory.tagColors[tag]\n\t\t\t)}\"></tw-tag>`,\n\t\t''\n\t);\n\n\treturn (\n\t\t`<tw-storydata name=\"${escape(story.name)}\" ` +\n\t\t`startnode=\"${startLocalId || ''}\" ` +\n\t\t`creator=\"${escape(appInfo.name)}\" ` +\n\t\t`creator-version=\"${escape(appInfo.version)}\" ` +\n\t\t`format=\"${escape(story.storyFormat)}\" ` +\n\t\t`format-version=\"${escape(story.storyFormatVersion)}\" ` +\n\t\t`ifid=\"${escape(story.ifid)}\" ` +\n\t\t`options=\"${escape(formatOptions)}\" ` +\n\t\t`tags=\"${escape(story.tags.join(' '))}\" ` +\n\t\t`zoom=\"${escape(story.zoom.toString())}\" hidden>` +\n\t\t`<style role=\"stylesheet\" id=\"twine-user-stylesheet\" ` +\n\t\t`type=\"text/twine-css\">` +\n\t\tstory.stylesheet +\n\t\t`</style>` +\n\t\t`<script role=\"script\" id=\"twine-user-script\" ` +\n\t\t`type=\"text/twine-javascript\">` +\n\t\tstory.script +\n\t\t`</script>` +\n\t\ttagData +\n\t\tpassageData +\n\t\t`</tw-storydata>`\n\t);\n}\n\n/**\n * Publishes a story and binds it to the source of a story format.\n */\nexport function publishStoryWithFormat(\n\tstory: Story,\n\tformatSource: string,\n\tappInfo: AppInfo,\n\t{formatOptions, startId}: PublishOptions = {}\n) {\n\tif (!formatSource) {\n\t\tthrow new Error('Story format source cannot be empty.');\n\t}\n\n\tlet output = formatSource;\n\n\t// We use function replacements to protect the data from accidental\n\t// interactions with the special string replacement patterns.\n\n\toutput = output.replace(/{{STORY_NAME}}/g, () => escape(story.name));\n\toutput = output.replace(/{{STORY_DATA}}/g, () =>\n\t\tpublishStory(story, appInfo, {formatOptions, startId})\n\t);\n\n\treturn output;\n}\n","export function isValidTagName(value: string) {\n\treturn value.length > 0 && !/\\s/.test(value);\n}\n","import * as React from 'react';\nimport {usePopper} from 'react-popper';\nimport {CSSTransition} from 'react-transition-group';\nimport {ButtonBar, ButtonBarSeparator} from '../container/button-bar';\nimport {ButtonCard} from '../container/button-card';\nimport {IconEmpty} from '../image/icon';\nimport {IconButton, IconButtonProps} from './icon-button';\nimport './menu-button.css';\nimport {CheckboxButton} from './checkbox-button';\nimport {IconCheck} from '@tabler/icons';\n\nexport interface UncheckableLabeledMenuItem {\n\tdisabled?: boolean;\n\tlabel: string;\n\tonClick: () => void;\n\tseparator?: undefined;\n\tvariant?: IconButtonProps['variant'];\n}\n\nexport interface CheckableLabeledMenuItem extends UncheckableLabeledMenuItem {\n\tcheckable: true;\n\tchecked: boolean;\n}\n\nexport type LabeledMenuItem =\n\t| UncheckableLabeledMenuItem\n\t| CheckableLabeledMenuItem;\n\nexport interface MenuSeparator {\n\tseparator: true;\n}\n\nexport interface MenuButtonProps extends Omit<IconButtonProps, 'onClick'> {\n\titems: (LabeledMenuItem | MenuSeparator)[];\n}\n\nexport const MenuButton: React.FC<MenuButtonProps> = props => {\n\tconst {items, ...other} = props;\n\tconst [buttonEl, setButtonEl] = React.useState<HTMLButtonElement | null>(\n\t\tnull\n\t);\n\tconst [menuEl, setMenuEl] = React.useState<HTMLDivElement | null>(null);\n\tconst [open, setOpen] = React.useState(false);\n\tconst {styles, attributes} = usePopper(buttonEl, menuEl, {strategy: 'fixed'});\n\n\tReact.useEffect(() => {\n\t\tconst closer = () => setOpen(false);\n\n\t\tif (open) {\n\t\t\tdocument.addEventListener('click', closer);\n\t\t}\n\n\t\treturn () => document.removeEventListener('click', closer);\n\t}, [menuEl, open, setOpen]);\n\n\treturn (\n\t\t<span className=\"menu-button\">\n\t\t\t<IconButton\n\t\t\t\t{...other}\n\t\t\t\tonClick={() => setOpen(open => !open)}\n\t\t\t\tref={setButtonEl}\n\t\t\t/>\n\t\t\t<CSSTransition\n\t\t\t\tclassNames=\"fade-out\"\n\t\t\t\tin={open}\n\t\t\t\tmountOnEnter\n\t\t\t\ttimeout={200}\n\t\t\t\tunmountOnExit\n\t\t\t>\n\t\t\t\t<div\n\t\t\t\t\tclassName=\"menu-button-menu\"\n\t\t\t\t\tref={setMenuEl}\n\t\t\t\t\tstyle={styles.popper}\n\t\t\t\t\t{...attributes.popper}\n\t\t\t\t>\n\t\t\t\t\t<ButtonCard floating>\n\t\t\t\t\t\t<ButtonBar orientation=\"vertical\">\n\t\t\t\t\t\t\t{items.map((item, index) => {\n\t\t\t\t\t\t\t\tif (item.separator) {\n\t\t\t\t\t\t\t\t\treturn <ButtonBarSeparator key={index} />;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\treturn 'checkable' in item ? (\n\t\t\t\t\t\t\t\t\t<CheckboxButton\n\t\t\t\t\t\t\t\t\t\tcheckedIcon={<IconCheck />}\n\t\t\t\t\t\t\t\t\t\tdisabled={item.disabled}\n\t\t\t\t\t\t\t\t\t\tkey={index}\n\t\t\t\t\t\t\t\t\t\tlabel={item.label}\n\t\t\t\t\t\t\t\t\t\tonChange={item.onClick}\n\t\t\t\t\t\t\t\t\t\tuncheckedIcon={<IconEmpty />}\n\t\t\t\t\t\t\t\t\t\tvalue={item.checked}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\t\t\t\tdisabled={item.disabled}\n\t\t\t\t\t\t\t\t\t\ticon={<IconEmpty />}\n\t\t\t\t\t\t\t\t\t\tkey={index}\n\t\t\t\t\t\t\t\t\t\tlabel={item.label}\n\t\t\t\t\t\t\t\t\t\tonClick={item.onClick}\n\t\t\t\t\t\t\t\t\t\tvariant={item.variant}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t})}\n\t\t\t\t\t\t</ButtonBar>\n\t\t\t\t\t</ButtonCard>\n\t\t\t\t</div>\n\t\t\t</CSSTransition>\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconCheck, IconX} from '@tabler/icons';\nimport {ButtonBar} from '../container/button-bar';\nimport {CardContent} from '../container/card';\nimport {CardButton, CardButtonProps} from './card-button';\nimport {IconButton, IconButtonProps} from './icon-button';\nimport {TextInput} from './text-input';\n\nexport interface PromptValidationResponse {\n\tmessage?: string;\n\tvalid: boolean;\n}\n\nexport type PromptButtonValidator = (\n\tvalue: string\n) => PromptValidationResponse | Promise<PromptValidationResponse>;\n\nexport interface PromptButtonProps\n\textends Omit<CardButtonProps, 'ariaLabel' | 'onChangeOpen' | 'open'> {\n\tcancelIcon?: React.ReactNode;\n\tcancelLabel?: string;\n\tonChange: React.ChangeEventHandler<HTMLInputElement>;\n\tonSubmit: (value: string) => void;\n\tprompt: string;\n\tsubmitIcon?: React.ReactNode;\n\tsubmitLabel?: string;\n\tsubmitVariant?: IconButtonProps['variant'];\n\tvalidate?: PromptButtonValidator;\n\tvalue: string;\n}\n\nexport const PromptButton: React.FC<PromptButtonProps> = props => {\n\tconst {\n\t\tcancelIcon,\n\t\tcancelLabel,\n\t\tonChange,\n\t\tonSubmit,\n\t\tprompt,\n\t\tsubmitIcon,\n\t\tsubmitLabel,\n\t\tsubmitVariant,\n\t\tvalidate,\n\t\tvalue,\n\t\t...other\n\t} = props;\n\tconst mounted = React.useRef(true);\n\tconst [open, setOpen] = React.useState(false);\n\tconst [validation, setValidation] =\n\t\tReact.useState<PromptValidationResponse>();\n\tconst {t} = useTranslation();\n\n\tReact.useEffect(() => {\n\t\tasync function updateValidation() {\n\t\t\tif (validate) {\n\t\t\t\tconst validation = await validate(value);\n\n\t\t\t\tif (mounted.current) {\n\t\t\t\t\tsetValidation(validation);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (mounted.current) {\n\t\t\t\t\tsetValidation({valid: true});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tupdateValidation();\n\t}, [validate, value]);\n\n\tReact.useEffect(() => {\n\t\treturn () => {\n\t\t\tmounted.current = false;\n\t\t};\n\t}, []);\n\n\tfunction handleCancel(event: React.MouseEvent) {\n\t\tevent.preventDefault();\n\t\tsetOpen(false);\n\t}\n\n\tfunction handleSubmit(event: React.FormEvent) {\n\t\tevent.preventDefault();\n\n\t\t// It's possible to submit with the Enter key and bypass us disabling the\n\t\t// submit button, so we need to catch that here.\n\n\t\tif (validation?.valid) {\n\t\t\tonSubmit(value);\n\t\t\tsetOpen(false);\n\t\t}\n\t}\n\n\treturn (\n\t\t<span className=\"prompt-button\">\n\t\t\t<CardButton\n\t\t\t\tariaLabel={prompt}\n\t\t\t\tonChangeOpen={setOpen}\n\t\t\t\topen={open}\n\t\t\t\t{...other}\n\t\t\t>\n\t\t\t\t<form onSubmit={handleSubmit}>\n\t\t\t\t\t<CardContent>\n\t\t\t\t\t\t<TextInput onChange={onChange} orientation=\"vertical\" value={value}>\n\t\t\t\t\t\t\t{prompt}\n\t\t\t\t\t\t</TextInput>\n\t\t\t\t\t\t{validation?.message && <p>{validation.message}</p>}\n\t\t\t\t\t</CardContent>\n\t\t\t\t\t<ButtonBar>\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\tbuttonType=\"submit\"\n\t\t\t\t\t\t\tdisabled={!validation?.valid}\n\t\t\t\t\t\t\ticon={submitIcon ?? <IconCheck />}\n\t\t\t\t\t\t\tlabel={submitLabel ?? t('common.ok')}\n\t\t\t\t\t\t\tvariant={submitVariant ?? 'primary'}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\tbuttonType=\"button\"\n\t\t\t\t\t\t\ticon={cancelIcon ?? <IconX />}\n\t\t\t\t\t\t\tlabel={cancelLabel ?? t('common.cancel')}\n\t\t\t\t\t\t\tonClick={handleCancel}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</ButtonBar>\n\t\t\t\t</form>\n\t\t\t</CardButton>\n\t\t</span>\n\t);\n};\n","import {PrefsState} from './prefs.types';\n\nexport const defaults = (): PrefsState => ({\n\tappTheme: 'system',\n\tcodeEditorFontFamily: 'var(--font-monospaced)',\n\tcodeEditorFontScale: 1,\n\tdisabledStoryFormatEditorExtensions: [],\n\tdonateShown: false,\n\teditorCursorBlinks: true,\n\tfirstRunTime: new Date().getTime(),\n\tlastUpdateSeen: '',\n\tlastUpdateCheckTime: new Date().getTime(),\n\tlocale:\n\t\t(window.navigator as any).userLanguage ||\n\t\twindow.navigator.language ||\n\t\t(window.navigator as any).browserLanguage ||\n\t\t(window.navigator as any).systemLanguage ||\n\t\t'en-us',\n\tpassageEditorFontFamily: 'var(--font-system)',\n\tpassageEditorFontScale: 1,\n\tproofingFormat: {\n\t\tname: 'Paperthin',\n\t\tversion: '1.0.0'\n\t},\n\tstoryFormat: {\n\t\tname: 'Harlowe',\n\t\tversion: '3.3.1'\n\t},\n\tstoryFormatListFilter: 'current',\n\tstoryListSort: 'name',\n\tstoryListTagFilter: [],\n\tstoryTagColors: {},\n\twelcomeSeen: false\n});\n","import * as React from 'react';\n\nexport const IconEmpty: React.FC = () => (\n\t<svg\n\t\tviewBox=\"0 0 24 24\"\n\t\twidth=\"24\"\n\t\theight=\"24\"\n\t\tstroke=\"currentColor\"\n\t\tstrokeWidth=\"2\"\n\t\tfill=\"none\"\n\t\tstrokeLinecap=\"round\"\n\t\tstrokeLinejoin=\"round\"\n\t></svg>\n);\n","import * as React from 'react';\nimport {IconCircle} from '@tabler/icons';\nimport './loading.css';\n\nexport const IconLoading: React.FC = () => {\n\treturn (\n\t\t<span className=\"icon-loading\">\n\t\t\t<IconCircle />\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\n\nexport const IconTwine: React.FC = () => (\n\t<svg\n\t\txmlns=\"http://www.w3.org/2000/svg\"\n\t\txmlnsXlink=\"http://www.w3.org/1999/xlink\"\n\t\tviewBox=\"0 0 1200 1200\"\n\t\twidth=\"1200\"\n\t\theight=\"1200\"\n\t>\n\t\t<defs>\n\t\t\t<linearGradient id=\"b\">\n\t\t\t\t<stop offset=\"0\" stopColor=\"#127aee\" />\n\t\t\t\t<stop offset=\"1\" stopColor=\"#117aef\" stopOpacity=\".251\" />\n\t\t\t</linearGradient>\n\t\t\t<linearGradient id=\"a\">\n\t\t\t\t<stop offset=\"0\" stopColor=\"#10f05e\" stopOpacity=\".251\" />\n\t\t\t\t<stop offset=\"1\" stopColor=\"#10f05e\" />\n\t\t\t</linearGradient>\n\t\t\t<linearGradient\n\t\t\t\txlinkHref=\"#a\"\n\t\t\t\tid=\"d\"\n\t\t\t\tx1=\"52\"\n\t\t\t\ty1=\"604.362\"\n\t\t\t\tx2=\"972\"\n\t\t\t\ty2=\"604.362\"\n\t\t\t\tgradientUnits=\"userSpaceOnUse\"\n\t\t\t/>\n\t\t\t<linearGradient\n\t\t\t\txlinkHref=\"#b\"\n\t\t\t\tid=\"c\"\n\t\t\t\tx1=\"256\"\n\t\t\t\ty1=\"0\"\n\t\t\t\tx2=\"231.987\"\n\t\t\t\ty2=\"725.548\"\n\t\t\t\tgradientUnits=\"userSpaceOnUse\"\n\t\t\t\tgradientTransform=\"translate(0 28.362)\"\n\t\t\t/>\n\t\t</defs>\n\t\t<path\n\t\t\tfill=\"url(#c)\"\n\t\t\td=\"M64 28.362h384v1024H64z\"\n\t\t\ttransform=\"translate(88 59.638)\"\n\t\t/>\n\t\t<path\n\t\t\td=\"M64 860.362c0-704 896-704 896-704v384s-512 0-512 320v192H64z\"\n\t\t\tfill=\"url(#d)\"\n\t\t\ttransform=\"translate(88 59.638)\"\n\t\t/>\n\t</svg>\n);\n","// This automatically triggers a function when typing a word that is prefixed by\n// certain text. We use this to automatically pop open the autocomplete when the\n// user is probably typing a passage name.\n\nimport CodeMirror from 'codemirror';\nimport {Editor} from 'codemirror';\n\nlet attachments: Editor[] = [];\n\nexport interface CMPrefixTriggerOptions {\n\t/**\n\t * Called when the user types a prefix in.\n\t */\n\tcallback?: (editor: Editor) => void;\n\t/**\n\t * An array of strings that will trigger the callback, case-sensitive.\n\t */\n\tprefixes?: string[];\n}\n\nexport function prefixTriggerOption(\n\tcm: Editor,\n\toptions: CMPrefixTriggerOptions\n) {\n\tconst {prefixes, callback} = options;\n\n\tfunction checkTrigger(cm: Editor) {\n\t\tif (cm.state.completionActive || !prefixes || !callback) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Back up two words from the cursor.\n\n\t\tconst curWord = cm.findWordAt(cm.getDoc().getCursor());\n\n\t\tcurWord.anchor.ch--;\n\n\t\tconst prevWordRange = cm.findWordAt(curWord.anchor);\n\t\tconst prevWord = cm.getRange(prevWordRange.anchor, prevWordRange.head);\n\n\t\t// Do we have a match? Only trigger this once.\n\n\t\tfor (const prefix of prefixes) {\n\t\t\tif (prevWord === prefix) {\n\t\t\t\tcallback(cm);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (callback && prefixes && !attachments.includes(cm)) {\n\t\tattachments.push(cm);\n\t\tcm.on('inputRead', checkTrigger);\n\t} else if (attachments.includes(cm)) {\n\t\tcm.off('inputRead', checkTrigger);\n\t\tattachments = attachments.filter(editor => editor !== cm);\n\t}\n}\n\nlet inited = false;\n\nexport function initPrefixTriggerGlobally() {\n\tif (!inited) {\n\t\tCodeMirror.defineOption('prefixTrigger', [], prefixTriggerOption);\n\t\tinited = true;\n\t}\n}\n","import * as React from 'react';\nimport {\n\tControlled as CodeMirror,\n\tIControlledCodeMirror\n} from 'react-codemirror2';\nimport 'codemirror/addon/display/placeholder';\nimport 'codemirror/addon/hint/show-hint';\nimport 'codemirror/addon/hint/show-hint.css';\nimport 'codemirror/lib/codemirror.css';\nimport 'codemirror/mode/css/css';\nimport 'codemirror/mode/javascript/javascript';\nimport './code-area.css';\nimport './codemirror-theme.css';\nimport classnames from 'classnames';\nimport {initPrefixTriggerGlobally} from '../../../codemirror/prefix-trigger';\n\n// Not ideal by far to do this init here, outside of a component, but we have to\n// set up CodeMirror before the first render. Otherwise, CodeMirror doesn't pick\n// up on options properly.\n\ninitPrefixTriggerGlobally();\n\nexport interface CodeAreaProps extends IControlledCodeMirror {\n\tfontFamily?: string;\n\tfontScale?: number;\n\tlabel: string;\n\tlabelHidden?: boolean;\n\tvalue: string;\n}\n\nexport const CodeArea: React.FC<CodeAreaProps> = props => {\n\tconst {fontFamily, fontScale, label, ...otherProps} = props;\n\tconst style: React.CSSProperties = {};\n\n\tif (fontFamily) {\n\t\tstyle.fontFamily = fontFamily.includes(' ')\n\t\t\t? `\"${fontFamily}\"`\n\t\t\t: fontFamily;\n\t}\n\n\tif (fontScale) {\n\t\tstyle.fontSize = `${fontScale * 100}%`;\n\t}\n\n\treturn (\n\t\t<div className=\"code-area\" style={style}>\n\t\t\t<label>\n\t\t\t\t<span\n\t\t\t\t\tclassName={classnames('label', {\n\t\t\t\t\t\t'screen-reader-only': props.labelHidden\n\t\t\t\t\t})}\n\t\t\t\t>\n\t\t\t\t\t{label}\n\t\t\t\t</span>\n\t\t\t\t<CodeMirror {...otherProps} />\n\t\t\t</label>\n\t\t</div>\n\t);\n};\n","import i18next from 'i18next';\nimport HttpBackend from 'i18next-http-backend';\nimport {initReactI18next} from 'react-i18next';\n\nexport const i18n = i18next.createInstance();\n\ni18n\n\t.use(HttpBackend)\n\t.use(initReactI18next)\n\t.init({\n\t\tdebug: process.env.NODE_ENV === 'development',\n\t\tbackend: {\n\t\t\tloadPath: `${process.env.PUBLIC_URL}/locales/{{lng}}.json`\n\t\t},\n\t\tfallbackLng: 'en-us',\n\t\tinterpolation: {\n\t\t\tescapeValue: false\n\t\t},\n\t\tload: 'currentOnly'\n\t});\n","import {PrefsState} from '../../../prefs';\nimport {TwineElectronWindow} from '../../../../electron/shared';\nimport {defaults} from '../../../prefs/defaults';\n\nexport async function load(): Promise<Partial<PrefsState>> {\n\tconst {twineElectron} = window as TwineElectronWindow;\n\tconst result: Partial<PrefsState> = {};\n\tconst prefKeys = Object.keys(defaults());\n\n\tif (!twineElectron) {\n\t\tthrow new Error('Electron bridge is not present on window.');\n\t}\n\n\tconst prefs = await twineElectron?.ipcRenderer.invoke('load-prefs');\n\n\tif (prefs && typeof prefs === 'object') {\n\t\tfor (const key in prefs) {\n\t\t\tif (prefKeys.includes(key)) {\n\t\t\t\t(result as any)[key] = prefs[key];\n\t\t\t}\n\t\t}\n\t}\n\n\treturn result;\n}\n","import {TwineElectronWindow} from '../../../electron/shared';\n\nexport function saveJson(filename: string, data: any) {\n\tconst {twineElectron} = window as TwineElectronWindow;\n\n\tif (!twineElectron) {\n\t\tthrow new Error('Electron bridge is not present on window.');\n\t}\n\n\ttwineElectron.ipcRenderer.send('save-json', filename, data);\n}\n","import {PrefsAction, PrefsState} from '../../../prefs';\nimport {saveJson} from '../save-json';\n\n/**\n * A middleware function to save changes to disk. This should be called\n * *after* the main reducer runs.\n */\nexport function saveMiddleware(state: PrefsState, action: PrefsAction) {\n\tif (action.type === 'repair' || action.type === 'update') {\n\t\tsaveJson('prefs.json', state);\n\t}\n}\n","import {TwineElectronWindow} from '../../../../electron/shared';\nimport {Story} from '../../../stories/stories.types';\nimport {importStories} from '../../../../util/import';\n\nexport async function load(): Promise<Story[]> {\n\tconst {twineElectron} = window as TwineElectronWindow;\n\n\tif (!twineElectron) {\n\t\tthrow new Error('Electron bridge is not present on window.');\n\t}\n\n\tconst stories = await twineElectron?.ipcRenderer.invoke('load-stories');\n\n\tif (stories && Array.isArray(stories)) {\n\t\treturn stories.reduce((result, file) => {\n\t\t\tconst story = importStories(file.htmlSource, file.mtime);\n\n\t\t\tif (story[0]) {\n\t\t\t\treturn [...result, story[0]];\n\t\t\t}\n\n\t\t\tconsole.warn('Could not hydrate story: ', file.htmlSource);\n\t\t\treturn result;\n\t\t}, [] as Story[]);\n\t} else {\n\t\tconsole.warn('No stories to hydrate in Electron bridge');\n\t}\n\n\treturn [];\n}\n","import {TwineElectronWindow} from '../../../../electron/shared';\nimport {\n\tStoriesAction,\n\tStoriesState,\n\tstoryWithId,\n\tstoryWithName\n} from '../../../stories';\nimport {StoryFormatsState} from '../../../story-formats';\nimport {\n\tisPersistablePassageChange,\n\tisPersistableStoryChange\n} from '../../persistable-changes';\nimport {saveStory} from './save-story';\n\n// When a story is deleted, we need to be able to look up information about it\n// from the last state.\n\nlet lastState: StoriesState;\n\n/**\n * A middleware function to save changes to disk. This should be called *after*\n * the main reducer runs.\n *\n * This has an extra argument: functions to archive and publish a story. This is\n * because the Electron app saves stories in published format.\n */\nexport function saveMiddleware(\n\tstate: StoriesState,\n\taction: StoriesAction,\n\tformats: StoryFormatsState\n) {\n\tconst {twineElectron} = window as TwineElectronWindow;\n\n\tif (!twineElectron) {\n\t\tthrow new Error('Electron bridge is not present on window.');\n\t}\n\n\tswitch (action.type) {\n\t\tcase 'init':\n\t\tcase 'repair':\n\t\t\t// We take no action here on a repair action. This is to prevent messing up a\n\t\t\t// story's last modified date. If the user then edits the story, we'll save\n\t\t\t// their change and the repair then.\n\t\t\tbreak;\n\n\t\tcase 'createStory':\n\t\t\tif (!action.props.name) {\n\t\t\t\tthrow new Error('Passage was created but with no name specified');\n\t\t\t}\n\n\t\t\tsaveStory(storyWithName(state, action.props.name), formats);\n\t\t\tbreak;\n\n\t\tcase 'deleteStory': {\n\t\t\t// We have to look up the story in our saved last state to know what file\n\t\t\t// to delete.\n\n\t\t\ttwineElectron.ipcRenderer.send(\n\t\t\t\t'delete-story',\n\t\t\t\tstoryWithId(lastState, action.storyId)\n\t\t\t);\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'updateStory':\n\t\t\tif (isPersistableStoryChange(action.props)) {\n\t\t\t\tif (action.props.name) {\n\t\t\t\t\t// The story has been renamed, and we need to process it\n\t\t\t\t\t// specially. We rename the story file, then save it to catch\n\t\t\t\t\t// any other changes.\n\n\t\t\t\t\tconst oldStory = storyWithId(lastState, action.storyId);\n\t\t\t\t\tconst newStory = storyWithId(state, action.storyId);\n\n\t\t\t\t\t// It's crucial that we only respond to this event once. Otherwise,\n\t\t\t\t\t// multiple renames in one session will cause mayhem.\n\n\t\t\t\t\ttwineElectron.ipcRenderer.once('story-renamed', () =>\n\t\t\t\t\t\tsaveStory(newStory, formats)\n\t\t\t\t\t);\n\t\t\t\t\ttwineElectron.ipcRenderer.send('rename-story', oldStory, newStory);\n\t\t\t\t} else {\n\t\t\t\t\t// An ordinary update.\n\n\t\t\t\t\tsaveStory(storyWithId(state, action.storyId), formats);\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase 'createPassage':\n\t\tcase 'createPassages':\n\t\tcase 'deletePassage':\n\t\tcase 'deletePassages':\n\t\t\tsaveStory(storyWithId(state, action.storyId), formats);\n\t\t\tbreak;\n\n\t\tcase 'updatePassage':\n\t\t\t// Skip updates that wouldn't be saved.\n\t\t\tif (isPersistablePassageChange(action.props)) {\n\t\t\t\tsaveStory(storyWithId(state, action.storyId), formats);\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase 'updatePassages':\n\t\t\t// Skip updates that wouldn't be saved.\n\t\t\tif (\n\t\t\t\tObject.keys(action.passageUpdates).some(passageId =>\n\t\t\t\t\tisPersistablePassageChange(action.passageUpdates[passageId])\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\tsaveStory(storyWithId(state, action.storyId), formats);\n\t\t\t}\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tconsole.warn(\n\t\t\t\t`Story action ${\n\t\t\t\t\t(action as any).type\n\t\t\t\t} has no Electron persistence handler`\n\t\t\t);\n\t}\n\n\tlastState = [...state];\n}\n","import {TwineElectronWindow} from '../../../../electron/shared';\nimport {Story} from '../../../stories';\nimport {publishStory, publishStoryWithFormat} from '../../../../util/publish';\nimport {\n\tformatWithNameAndVersion,\n\tStoryFormatsState\n} from '../../../story-formats';\nimport {getAppInfo} from '../../../../util/app-info';\nimport {fetchStoryFormatProperties} from '../../../../util/story-format/fetch-properties';\n\n/**\n * Sends an IPC message to save a story to disk, ideally in published form.\n */\nexport async function saveStory(story: Story, formats: StoryFormatsState) {\n\tconst {twineElectron} = window as TwineElectronWindow;\n\n\tif (!twineElectron) {\n\t\tthrow new Error('Electron bridge is not present on window.');\n\t}\n\n\ttry {\n\t\tconst format = formatWithNameAndVersion(\n\t\t\tformats,\n\t\t\tstory.storyFormat,\n\t\t\tstory.storyFormatVersion\n\t\t);\n\n\t\tif (format.loadState === 'loaded') {\n\t\t\ttwineElectron.ipcRenderer.send(\n\t\t\t\t'save-story-html',\n\t\t\t\tstory,\n\t\t\t\tpublishStoryWithFormat(story, format.properties.source, getAppInfo(), {\n\t\t\t\t\tstartOptional: true\n\t\t\t\t})\n\t\t\t);\n\t\t} else {\n\t\t\tconst {source} = await fetchStoryFormatProperties(format.url);\n\n\t\t\ttwineElectron.ipcRenderer.send(\n\t\t\t\t'save-story-html',\n\t\t\t\tstory,\n\t\t\t\tpublishStoryWithFormat(story, source, getAppInfo(), {\n\t\t\t\t\tstartOptional: true\n\t\t\t\t})\n\t\t\t);\n\t\t}\n\t} catch (error) {\n\t\tconsole.warn(\n\t\t\t`Could not save full story (${error.message}). Trying to save story data only.`\n\t\t);\n\t\ttwineElectron.ipcRenderer.send(\n\t\t\t'save-story-html',\n\t\t\tstory,\n\t\t\tpublishStory(story, getAppInfo(), {startOptional: true})\n\t\t);\n\t}\n}\n","import uuid from 'tiny-uuid';\nimport {TwineElectronWindow} from '../../../../electron/shared';\nimport {StoryFormatsState} from '../../../story-formats/story-formats.types';\n\nexport async function load(): Promise<StoryFormatsState> {\n\tconst {twineElectron} = window as TwineElectronWindow;\n\n\tif (!twineElectron) {\n\t\tthrow new Error('Electron bridge is not present on window.');\n\t}\n\n\tconst storyFormats = await twineElectron?.ipcRenderer.invoke(\n\t\t'load-story-formats'\n\t);\n\n\tif (!storyFormats || !Array.isArray(storyFormats)) {\n\t\treturn [];\n\t}\n\n\treturn storyFormats.map(data => ({\n\t\tid: uuid(),\n\t\tloadState: 'unloaded',\n\t\tname: data.name,\n\t\tselected: false,\n\t\tversion: data.version,\n\t\turl: data.url,\n\t\tuserAdded: data.userAdded\n\t}));\n}\n","import {StoryFormatsAction, StoryFormatsState} from '../../../story-formats';\nimport {isPersistableStoryFormatChange} from '../../persistable-changes';\nimport {saveJson} from '../save-json';\n\n/**\n * A middleware function to save changes to disk. This should be called\n * *after* the main reducer runs.\n */\nexport function saveMiddleware(\n\tstate: StoryFormatsState,\n\taction: StoryFormatsAction\n) {\n\tconst shouldSave =\n\t\taction.type === 'create' ||\n\t\taction.type === 'delete' ||\n\t\taction.type === 'repair' ||\n\t\t(action.type === 'update' && isPersistableStoryFormatChange(action.props));\n\n\tif (shouldSave) {\n\t\tsaveJson(\n\t\t\t'story-formats.json',\n\t\t\tstate.map(format => ({\n\t\t\t\tid: format.id,\n\t\t\t\tname: format.name,\n\t\t\t\tselected: undefined,\n\t\t\t\tversion: format.version,\n\t\t\t\turl: format.url,\n\t\t\t\tuserAdded: format.userAdded\n\t\t\t}))\n\t\t);\n\t}\n}\n","import {PrefsState} from '../../../prefs';\n\nexport async function load(): Promise<Partial<PrefsState>> {\n\tconst serialized = window.localStorage.getItem('twine-prefs');\n\tconst result: Partial<PrefsState> = {};\n\n\tif (!serialized) {\n\t\treturn {};\n\t}\n\n\tserialized.split(',').forEach(id => {\n\t\ttry {\n\t\t\tconst serializedPref = window.localStorage.getItem(`twine-prefs-${id}`);\n\n\t\t\tif (!serializedPref) {\n\t\t\t\tconsole.warn(`No preference stored at twine-prefs-${id}`);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst item = JSON.parse(serializedPref);\n\n\t\t\t(result as any)[item.name] = item.value;\n\t\t} catch (e) {\n\t\t\tconsole.warn(\n\t\t\t\t`Preference ${id} had corrupt serialized value, skipping`,\n\t\t\t\twindow.localStorage.getItem(`twine-prefs-${id}`),\n\t\t\t\te\n\t\t\t);\n\t\t}\n\t});\n\n\treturn result;\n}\n","import {PrefsAction, PrefsState} from '../../../prefs';\nimport {save} from './save';\n\nexport function saveMiddleware(state: PrefsState, action: PrefsAction) {\n\tif (action.type === 'repair' || action.type === 'update') {\n\t\tsave(state);\n\t}\n}\n","import uuid from 'tiny-uuid';\nimport {PrefsState} from '../../../prefs';\n\nexport function save(state: PrefsState) {\n\t// Delete existing prefs in local storage, since we aren't bothering to\n\t// preserve IDs.\n\n\tconst previouslySerialized = window.localStorage.getItem('twine-prefs');\n\n\tif (previouslySerialized) {\n\t\tpreviouslySerialized.split(',').forEach(id => {\n\t\t\twindow.localStorage.removeItem(`twine-prefs-${id}`);\n\t\t});\n\t}\n\n\t/* Save new ones. */\n\n\tlet ids: string[] = [];\n\n\tfor (const name in state) {\n\t\tconst id = uuid();\n\n\t\tids.push(id);\n\t\twindow.localStorage.setItem(\n\t\t\t`twine-prefs-${id}`,\n\t\t\tJSON.stringify({\n\t\t\t\tid,\n\t\t\t\tname,\n\t\t\t\tvalue: state[name as keyof PrefsState]\n\t\t\t})\n\t\t);\n\t}\n\n\twindow.localStorage.setItem('twine-prefs', ids.join(','));\n}\n","import {\n\tpassageWithId,\n\tpassageWithName,\n\tStoriesAction,\n\tStoriesState,\n\tstoryWithId,\n\tstoryWithName\n} from '../../../stories';\nimport {isPersistablePassageChange} from '../../persistable-changes';\nimport {\n\tdeletePassageById,\n\tdeleteStory,\n\tdoUpdateTransaction,\n\tsavePassage,\n\tsaveStory\n} from './save';\n\nlet lastState: StoriesState;\n\n/**\n * A middleware function to save changes to local storage. This should be called\n * *after* the main reducer runs.\n */\nexport function saveMiddleware(state: StoriesState, action: StoriesAction) {\n\tswitch (action.type) {\n\t\tcase 'init':\n\t\tcase 'repair':\n\t\t\t// We take no action here on a repair action. This is to prevent messing up a\n\t\t\t// story's last modified date. If the user then edits the story, we'll save\n\t\t\t// their change and the repair then.\n\t\t\tbreak;\n\n\t\tcase 'createPassage': {\n\t\t\tif (!action.props.name) {\n\t\t\t\tthrow new Error('Passage was created but with no name specified');\n\t\t\t}\n\n\t\t\tconst story = storyWithId(state, action.storyId);\n\t\t\tconst passage = passageWithName(state, story.id, action.props.name);\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\tsaveStory(transaction, story);\n\t\t\t\tsavePassage(transaction, passage);\n\t\t\t});\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'createPassages': {\n\t\t\tconst story = storyWithId(state, action.storyId);\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\tsaveStory(transaction, story);\n\t\t\t\taction.props.forEach(props => {\n\t\t\t\t\tif (!props.name) {\n\t\t\t\t\t\tthrow new Error('Passage was created but with no name specified');\n\t\t\t\t\t}\n\n\t\t\t\t\tsavePassage(\n\t\t\t\t\t\ttransaction,\n\t\t\t\t\t\tpassageWithName(state, story.id, props.name)\n\t\t\t\t\t);\n\t\t\t\t});\n\t\t\t});\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'createStory':\n\t\t\tif (!action.props.name) {\n\t\t\t\tthrow new Error('Story was created but with no name specified');\n\t\t\t}\n\n\t\t\tconst story = storyWithName(state, action.props.name);\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\tsaveStory(transaction, story);\n\t\t\t\tstory.passages.forEach(passage => savePassage(transaction, passage));\n\t\t\t});\n\t\t\tbreak;\n\n\t\tcase 'deletePassage': {\n\t\t\tconst story = storyWithId(state, action.storyId);\n\n\t\t\t// We can't dig up the passage in question right now, because\n\t\t\t// previousStories is only a shallow copy, and it's gone there at\n\t\t\t// this point in time.\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\tsaveStory(transaction, story);\n\t\t\t\tdeletePassageById(transaction, action.passageId);\n\t\t\t});\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'deletePassages': {\n\t\t\tconst story = storyWithId(state, action.storyId);\n\n\t\t\t// See above comment about passages.\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\tsaveStory(transaction, story);\n\t\t\t\taction.passageIds.forEach(passageId =>\n\t\t\t\t\tdeletePassageById(transaction, passageId)\n\t\t\t\t);\n\t\t\t});\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'deleteStory': {\n\t\t\t// The story will be gone from state by the time we're called, so we\n\t\t\t// need a cached copy.\n\n\t\t\tconst story = storyWithId(lastState, action.storyId);\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\t// We have to delete all passages, then the story itself.\n\n\t\t\t\tstory.passages.forEach(passage =>\n\t\t\t\t\tdeletePassageById(transaction, passage.id)\n\t\t\t\t);\n\n\t\t\t\tdeleteStory(transaction, story);\n\t\t\t});\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'updatePassage':\n\t\t\tif (isPersistablePassageChange(action.props)) {\n\t\t\t\tconst story = storyWithId(state, action.storyId);\n\t\t\t\tconst passage = passageWithId(state, action.storyId, action.passageId);\n\n\t\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\t\tsaveStory(transaction, story);\n\t\t\t\t\tsavePassage(transaction, passage);\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase 'updatePassages': {\n\t\t\tconst story = storyWithId(state, action.storyId);\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\tsaveStory(transaction, story);\n\t\t\t\tObject.keys(action.passageUpdates)\n\t\t\t\t\t.filter(passageId =>\n\t\t\t\t\t\tisPersistablePassageChange(action.passageUpdates[passageId])\n\t\t\t\t\t)\n\t\t\t\t\t.forEach(passageId =>\n\t\t\t\t\t\tsavePassage(\n\t\t\t\t\t\t\ttransaction,\n\t\t\t\t\t\t\tpassageWithId(state, action.storyId, passageId)\n\t\t\t\t\t\t)\n\t\t\t\t\t);\n\t\t\t});\n\t\t\tbreak;\n\t\t}\n\n\t\tcase 'updateStory': {\n\t\t\tconst story = storyWithId(state, action.storyId);\n\n\t\t\tdoUpdateTransaction(transaction => {\n\t\t\t\tsaveStory(transaction, story);\n\t\t\t\tstory.passages.forEach(passage => savePassage(transaction, passage));\n\t\t\t});\n\t\t\tbreak;\n\t\t}\n\n\t\tdefault:\n\t\t\tconsole.warn(\n\t\t\t\t`Story action ${\n\t\t\t\t\t(action as any).type\n\t\t\t\t} has no local storage persistence handler`\n\t\t\t);\n\t}\n\n\tlastState = state;\n}\n","import {passageDefaults, storyDefaults} from '../../../stories/defaults';\nimport {Passage, Story} from '../../../stories/stories.types';\n\n/**\n * Parses initial state from local storage.\n */\nexport async function load(): Promise<Story[]> {\n\tconst stories: Record<string, Story> = {};\n\tconst serializedStories = window.localStorage.getItem('twine-stories');\n\n\tif (!serializedStories) {\n\t\treturn [];\n\t}\n\n\t// First, deserialize stories. We index them by ID so that we can quickly add\n\t// passages to them as they are deserialized.\n\n\tserializedStories.split(',').forEach(id => {\n\t\tconst serializedStory = window.localStorage.getItem(`twine-stories-${id}`);\n\n\t\tif (!serializedStory) {\n\t\t\tconsole.warn(\n\t\t\t\t`Story list contained ID ${id}, but twine-stories-${id} does not exist, skipping`\n\t\t\t);\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\tconst story: Story = JSON.parse(serializedStory);\n\n\t\t\tif (!story.id) {\n\t\t\t\tconsole.warn('Story in local storage had no ID, skipping', story);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tstories[story.id] = {\n\t\t\t\t...storyDefaults(),\n\t\t\t\t...story,\n\n\t\t\t\t// Coerce lastUpdate to a date.\n\t\t\t\tlastUpdate: story.lastUpdate\n\t\t\t\t\t? new Date(Date.parse(story.lastUpdate as unknown as string))\n\t\t\t\t\t: new Date(),\n\n\t\t\t\t// Force the passages property to be an empty array -- we'll populate it\n\t\t\t\t// when we load passages below.\n\t\t\t\tpassages: []\n\t\t\t};\n\t\t} catch (e) {\n\t\t\tconsole.warn(\n\t\t\t\t`Could not parse story as JSON, skipping: ${serializedStory}`\n\t\t\t);\n\t\t}\n\t});\n\n\t// Then create passages, adding them to their parent story.\n\n\tconst serializedPassages = window.localStorage.getItem('twine-passages');\n\n\tif (serializedPassages) {\n\t\tserializedPassages.split(',').forEach(id => {\n\t\t\tconst serializedPassage = window.localStorage.getItem(\n\t\t\t\t`twine-passages-${id}`\n\t\t\t);\n\n\t\t\tif (!serializedPassage) {\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`Passage list contained ID ${id}, but twine-passages-${id} does not exist, skipping`\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tconst passage: Passage = JSON.parse(serializedPassage);\n\n\t\t\t\tif (!passage || !passage.story) {\n\t\t\t\t\tconsole.warn(\n\t\t\t\t\t\t`Passage ${id} did not have parent story ID, skipping`,\n\t\t\t\t\t\tpassage\n\t\t\t\t\t);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (!stories[passage.story]) {\n\t\t\t\t\tconsole.warn(\n\t\t\t\t\t\t`Passage ${id} is orphaned (looking for story ID ${passage.story}), skipping`\n\t\t\t\t\t);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tstories[passage.story].passages.push({\n\t\t\t\t\t...passageDefaults,\n\t\t\t\t\t...passage,\n\n\t\t\t\t\t// Remove empty tags.\n\t\t\t\t\ttags: passage.tags ? passage.tags.filter(t => t.trim() !== '') : []\n\t\t\t\t});\n\t\t\t} catch (e) {\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`Could not parse passage as JSON, skipping: ${serializedPassage}`\n\t\t\t\t);\n\t\t\t}\n\t\t});\n\t}\n\n\t// Flatten the stories object.\n\treturn Object.values(stories);\n}\n","// Lightweight functions for dealing with comma-delimited strings (e.g. that don't\n// deal with all the intracacies of dealing with the actual CSV format, e.g.\n// quotation marks).\n\n/**\n * Returns whether a list contains a value.\n */\nexport function contains(list: string, value: string) {\n\treturn new RegExp('\\\\b' + value + '\\\\b').test(list);\n}\n\n/**\n * Adds a value to a list if it's not already present.\n */\nexport function addUnique(list: string, value: string) {\n\tif (list === '') {\n\t\treturn value;\n\t}\n\n\tif (contains(list, value)) {\n\t\treturn list;\n\t}\n\n\treturn list + ',' + value;\n}\n\n/**\n * Removes a value from a list.\n */\nexport function remove(list: string, value: string) {\n\tlist = list.replace(new RegExp(',?' + value), '');\n\n\t// We end up with a leading comma if we just removed the first value.\n\n\tif (list[0] === ',') {\n\t\treturn list.substring(1);\n\t}\n\n\treturn list;\n}\n","// Functions for moving stories into local storage. This module in particular\n// needs to remain well-optimized, as it has a direct effect on load time. As a\n// result, saving requires that you start and end a transaction manually. This\n// minimizes the number of writes to local storage.\n\nimport {Passage, Story} from '../../../stories/stories.types';\nimport {addUnique, remove} from '../comma-list';\n\nexport interface StorageTransaction {\n\tpassageIds: string;\n\tstoryIds: string;\n}\n\nexport type StorageUpdater = (transaction: StorageTransaction) => void;\n\n/**\n * A wrapper for a series of save/delete operations. This takes a function as\n * argument that will receive an object keeping track of the transaction. This\n * function should then make save and delete calls as necessary, passing the\n * provided transaction object as their first argument.\n */\nexport function doUpdateTransaction(updater: StorageUpdater) {\n\tconst transaction = {\n\t\tpassageIds: window.localStorage.getItem('twine-passages') ?? '',\n\t\tstoryIds: window.localStorage.getItem('twine-stories') ?? ''\n\t};\n\n\tupdater(transaction);\n\n\twindow.localStorage.setItem('twine-stories', transaction.storyIds);\n\twindow.localStorage.setItem('twine-passages', transaction.passageIds);\n}\n\n/**\n * Saves a story to local storage. This does *not* affect any child passages.\n **/\nexport function saveStory(transaction: StorageTransaction, story: Story) {\n\tif (!story.id) {\n\t\tthrow new Error('Story has no ID');\n\t}\n\n\ttransaction.storyIds = addUnique(transaction.storyIds, story.id);\n\n\t// We have to remove the passages property before serializing the story,\n\t// as those are serialized under separate keys.\n\n\twindow.localStorage.setItem(\n\t\t`twine-stories-${story.id}`,\n\t\tJSON.stringify({...story, passages: undefined})\n\t);\n}\n\n/**\n * Deletes a story from local storage. This does *not* affect any child\n * passages. You *must* delete child passages manually.\n */\nexport function deleteStory(transaction: StorageTransaction, story: Story) {\n\tif (!story.id) {\n\t\tthrow new Error('Story has no ID');\n\t}\n\n\ttransaction.storyIds = remove(transaction.storyIds, story.id);\n\twindow.localStorage.removeItem(`twine-stories-${story.id}`);\n}\n\n/**\n * Saves a passage to local storage.\n */\nexport function savePassage(transaction: StorageTransaction, passage: Passage) {\n\tif (!passage.id) {\n\t\tthrow new Error('Passage has no ID');\n\t}\n\n\ttransaction.passageIds = addUnique(transaction.passageIds, passage.id);\n\twindow.localStorage.setItem(\n\t\t`twine-passages-${passage.id}`,\n\t\tJSON.stringify(passage)\n\t);\n}\n\n/**\n * Deletes a passage from local storage.\n */\nexport function deletePassage(\n\ttransaction: StorageTransaction,\n\tpassage: Passage\n) {\n\tif (!passage.id) {\n\t\tthrow new Error('Passage has no ID');\n\t}\n\n\tdeletePassageById(transaction, passage.id);\n}\n\n/**\n * Deletes a passage from local storage by ID only.\n */\nexport function deletePassageById(\n\ttransaction: StorageTransaction,\n\tpassageId: string\n) {\n\ttransaction.passageIds = remove(transaction.passageIds, passageId);\n\twindow.localStorage.removeItem(`twine-passages-${passageId}`);\n}\n","import {StoryFormatsState} from '../../../story-formats/story-formats.types';\n\nexport async function load(): Promise<StoryFormatsState> {\n\tconst result: StoryFormatsState = [];\n\tconst serialized = window.localStorage.getItem('twine-storyformats');\n\n\tif (!serialized) {\n\t\treturn [];\n\t}\n\n\tserialized.split(',').forEach(id => {\n\t\ttry {\n\t\t\tconst serializedFormat = window.localStorage.getItem(\n\t\t\t\t`twine-storyformats-${id}`\n\t\t\t);\n\n\t\t\tif (!serializedFormat) {\n\t\t\t\tconsole.warn(\n\t\t\t\t\t`No story format stored at twine-storyformats-${id}, skipping`\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tresult.push({...JSON.parse(serializedFormat), loadState: 'unloaded'});\n\t\t} catch (e) {\n\t\t\tconsole.warn(\n\t\t\t\t`Story format ${id} had corrupt serialized value, skipping`,\n\t\t\t\twindow.localStorage.getItem(`twine-storyformats-${id}`)\n\t\t\t);\n\t\t}\n\t});\n\n\treturn result;\n}\n","import uuid from 'tiny-uuid';\nimport {StoryFormatsState} from '../../../story-formats/story-formats.types';\n\nexport function save(state: StoryFormatsState) {\n\t// Delete existing formats in local storage, since we aren't bothering to\n\t// preserve ids.\n\n\tconst previouslySerialized = window.localStorage.getItem(\n\t\t'twine-storyformats'\n\t);\n\n\tif (previouslySerialized) {\n\t\tpreviouslySerialized.split(',').forEach(id => {\n\t\t\twindow.localStorage.removeItem(`twine-storyformats-${id}`);\n\t\t});\n\t}\n\n\t// Save new ones.\n\n\tlet ids: string[] = [];\n\n\tstate.forEach(format => {\n\t\tconst id = uuid();\n\n\t\t// We have to remove the `properties` property if it exists, as that is\n\t\t// dynamically added when loading.\n\n\t\tids.push(id);\n\t\twindow.localStorage.setItem(\n\t\t\t`twine-storyformats-${id}`,\n\t\t\tJSON.stringify({\n\t\t\t\t...format,\n\t\t\t\tloadError: undefined,\n\t\t\t\tloadState: undefined,\n\t\t\t\tproperties: undefined,\n\t\t\t\tselected: undefined\n\t\t\t})\n\t\t);\n\t});\n\n\twindow.localStorage.setItem('twine-storyformats', ids.join(','));\n}\n","import {StoryFormatsAction, StoryFormatsState} from '../../../story-formats';\nimport {isPersistableStoryFormatChange} from '../../persistable-changes';\nimport {save} from './save';\n\n/**\n * A middleware function to save changes to local storage. This should be called\n * *after* the main reducer runs.\n */\nexport function saveMiddleware(\n\tstate: StoryFormatsState,\n\taction: StoryFormatsAction\n) {\n\tswitch (action.type) {\n\t\tcase 'create':\n\t\tcase 'delete':\n\t\tcase 'repair':\n\t\t\tsave(state);\n\t\t\tbreak;\n\n\t\tcase 'update':\n\t\t\t// Is this a significant update?\n\t\t\tif (isPersistableStoryFormatChange(action.props)) {\n\t\t\t\tsave(state);\n\t\t\t}\n\t\t\tbreak;\n\t}\n}\n","import * as React from 'react';\nimport {useElectronIpcPersistence} from './electron-ipc/use-electron-ipc-persistence';\nimport {useLocalStoragePersistence} from './local-storage/use-local-storage-persistence';\nimport {isElectronRenderer} from '../../util/is-electron';\nimport {StoriesAction, StoriesState} from '../stories';\nimport {StoryFormatsAction, StoryFormatsState} from '../story-formats';\nimport {PrefsAction, PrefsState} from '../prefs';\n\nexport interface PersistenceHooks {\n\tprefs: {\n\t\tload: () => Promise<Partial<PrefsState>>;\n\t\tsaveMiddleware: (state: PrefsState, action: PrefsAction) => void;\n\t};\n\tstories: {\n\t\tload: () => Promise<StoriesState>;\n\t\tsaveMiddleware: (\n\t\t\tstate: StoriesState,\n\t\t\taction: StoriesAction,\n\t\t\tformats: StoryFormatsState\n\t\t) => void;\n\t};\n\tstoryFormats: {\n\t\tload: () => Promise<StoryFormatsState>;\n\t\tsaveMiddleware: (\n\t\t\tstate: StoryFormatsState,\n\t\t\taction: StoryFormatsAction\n\t\t) => void;\n\t};\n}\n\nexport function usePersistence(): PersistenceHooks {\n\tconst electronIpcPersistence = useElectronIpcPersistence();\n\tconst localStoragePersistence = useLocalStoragePersistence();\n\n\treturn React.useMemo(\n\t\t() =>\n\t\t\tisElectronRenderer() ? electronIpcPersistence : localStoragePersistence,\n\t\t[electronIpcPersistence, localStoragePersistence]\n\t);\n}\n","import * as React from 'react';\nimport * as prefs from './prefs';\nimport * as stories from './stories';\nimport * as storyFormats from './story-formats';\n\nexport function useElectronIpcPersistence() {\n\treturn React.useMemo(\n\t\t() => ({\n\t\t\tprefs: {\n\t\t\t\tload: prefs.load,\n\t\t\t\tsaveMiddleware: prefs.saveMiddleware\n\t\t\t},\n\t\t\tstories: {\n\t\t\t\tload: stories.load,\n\t\t\t\tsaveMiddleware: stories.saveMiddleware\n\t\t\t},\n\t\t\tstoryFormats: {\n\t\t\t\tload: storyFormats.load,\n\t\t\t\tsaveMiddleware: storyFormats.saveMiddleware\n\t\t\t}\n\t\t}),\n\t\t[]\n\t);\n}\n","import * as React from 'react';\nimport * as prefs from './prefs';\nimport * as stories from './stories';\nimport * as storyFormats from './story-formats';\n\nexport function useLocalStoragePersistence() {\n\treturn React.useMemo(\n\t\t() => ({\n\t\t\tprefs: {\n\t\t\t\tload: prefs.load,\n\t\t\t\tsaveMiddleware: prefs.saveMiddleware\n\t\t\t},\n\t\t\tstories: {\n\t\t\t\tload: stories.load,\n\t\t\t\tsaveMiddleware: stories.saveMiddleware\n\t\t\t},\n\t\t\tstoryFormats: {\n\t\t\t\tload: storyFormats.load,\n\t\t\t\tsaveMiddleware: storyFormats.saveMiddleware\n\t\t\t}\n\t\t}),\n\t\t[]\n\t);\n}\n","import {IconAlertOctagon} from '@tabler/icons';\nimport * as React from 'react';\nimport './error-message.css';\n\nexport const ErrorMessage: React.FC = ({children}) => (\n\t<div className=\"error-message\">\n\t\t<IconAlertOctagon />\n\t\t<div className=\"message\">{children}</div>\n\t</div>\n);\n","import * as React from 'react';\nimport useErrorBoundary from 'use-error-boundary';\nimport {ErrorMessage} from './error-message';\nimport './global-error-boundary.css';\n\nexport const GlobalErrorBoundary: React.FC = ({children}) => {\n\tconst {ErrorBoundary, didCatch, error} = useErrorBoundary();\n\n\t// Non-localized because our localization might be broken.\n\n\treturn didCatch ? (\n\t\t<div className=\"global-error-boundary\">\n\t\t\t<div>\n\t\t\t\t<ErrorMessage>\n\t\t\t\t\t<p>Something went wrong and Twine can't continue.</p>\n\t\t\t\t\t<p>Please try restarting Twine or reloading the page.</p>\n\t\t\t\t\t<p>\n\t\t\t\t\t\tIf you see this message repeatedly, please{' '}\n\t\t\t\t\t\t<a\n\t\t\t\t\t\t\thref=\"https://twinery.org/2bugs\"\n\t\t\t\t\t\t\trel=\"noreferrer\"\n\t\t\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\treport a bug\n\t\t\t\t\t\t</a>\n\t\t\t\t\t\t.\n\t\t\t\t\t</p>\n\t\t\t\t</ErrorMessage>\n\t\t\t\t<p>Details:</p>\n\t\t\t\t<pre>{error.stack}</pre>\n\t\t\t</div>\n\t\t</div>\n\t) : (\n\t\t<ErrorBoundary>{children}</ErrorBoundary>\n\t);\n};","import {IconInfoCircle} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport UAParser from 'ua-parser-js';\nimport {ButtonBar} from '../container/button-bar';\nimport {Card} from '../container/card';\nimport {IconLink} from '../control/icon-link';\nimport {ErrorMessage} from '../error';\nimport './safari-warning-card.css';\n\nexport interface SafariNavigator extends Navigator {\n\tstandalone?: boolean;\n}\n\nexport const SafariWarningCard: React.FC = props => {\n\tconst {t} = useTranslation();\n\tconst browser = new UAParser().getBrowser();\n\n\tif (browser.name !== 'Safari') {\n\t\treturn null;\n\t}\n\n\tif (browser.version) {\n\t\tconst version = parseInt(browser.version.replace(/\\..*/, ''));\n\n\t\tif (Number.isFinite(version) && version < 13) {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tconst safariNavigator = window.navigator as SafariNavigator;\n\n\tif (safariNavigator.standalone) {\n\t\t// We are in \"standalone\" or full-screen mode. This is supposed to have\n\t\t// its own localStorage which is not subject to the seven-day limit.\n\t\t// https://developer.apple.com/library/archive/documentation/AppleApplications/Reference/SafariHTMLRef/Articles/MetaTags.html\n\t\treturn null;\n\t}\n\n\tconst canAddToHomeScreen = safariNavigator.standalone !== undefined;\n\n\treturn (\n\t\t<div className=\"safari-warning-card\">\n\t\t\t<Card>\n\t\t\t\t<ErrorMessage>\n\t\t\t\t\t<p>{t('components.safariWarningCard.message')}</p>\n\t\t\t\t\t{canAddToHomeScreen && (\n\t\t\t\t\t\t<p>{t('components.safariWarningCard.addToHomeScreen')}</p>\n\t\t\t\t\t)}\n\t\t\t\t\t<p>{t('components.safariWarningCard.archiveAndUseAnotherBrowser')}</p>\n\t\t\t\t</ErrorMessage>\n\t\t\t\t<ButtonBar>\n\t\t\t\t\t<IconLink\n\t\t\t\t\t\thref=\"https://twinery.org/2ioslocalstorage\"\n\t\t\t\t\t\ticon={<IconInfoCircle />}\n\t\t\t\t\t\tlabel={t('components.safariWarningCard.learnMore')}\n\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t/>\n\t\t\t\t\t{canAddToHomeScreen && (\n\t\t\t\t\t\t<IconLink\n\t\t\t\t\t\t\thref=\"https://twinery.org/2ioshomescreen\"\n\t\t\t\t\t\t\ticon={<IconInfoCircle />}\n\t\t\t\t\t\t\tlabel={t('components.safariWarningCard.howToAddToHomeScreen')}\n\t\t\t\t\t\t/>\n\t\t\t\t\t)}\n\t\t\t\t</ButtonBar>\n\t\t\t</Card>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {colors, Color} from '../../util/color';\nimport {IconPlus, IconX} from '@tabler/icons';\nimport {ButtonBar} from '../container/button-bar';\nimport {CardContent} from '../container/card';\nimport {CardButton} from '../control/card-button';\nimport {IconButton} from '../control/icon-button';\nimport {TextInput} from '../control/text-input';\nimport {TextSelect} from '../control/text-select';\nimport {isValidTagName} from '../../util/tag';\nimport './add-tag-button.css';\n\nexport interface AddTagButtonProps {\n\t/**\n\t * Tags that have been assigned to this object.\n\t */\n\tassignedTags: string[];\n\t/**\n\t * Is the button disabled?\n\t */\n\tdisabled?: boolean;\n\t/**\n\t * Other tags that have been assigned to this type of object.\n\t */\n\texistingTags: string[];\n\t/**\n\t * Icon for the button.\n\t */\n\ticon?: React.ReactNode;\n\t/**\n\t * Label for the button.\n\t */\n\tlabel?: string;\n\t/**\n\t * Called when the user chooses to add a tag. If they are adding a\n\t * pre-existing tag, it will only send a name.\n\t */\n\tonAdd: (name: string, color?: Color) => void;\n}\n\nexport const AddTagButton: React.FC<AddTagButtonProps> = props => {\n\tconst {assignedTags, disabled, existingTags, icon, label, onAdd} = props;\n\tconst [creatingTag, setCreatingTag] = React.useState(true);\n\tconst [newColor, setNewColor] = React.useState<Color>('none');\n\tconst [newName, setNewName] = React.useState('');\n\tconst [open, setOpen] = React.useState(false);\n\tconst {t} = useTranslation();\n\n\tlet validationMessage: string | undefined = undefined;\n\tlet canAdd = isValidTagName(newName);\n\n\tif (!canAdd && newName !== '') {\n\t\tvalidationMessage = t('components.addTagButton.invalidName');\n\t}\n\n\tif (canAdd && creatingTag) {\n\t\tcanAdd = !existingTags.includes(newName);\n\n\t\tif (!canAdd) {\n\t\t\tvalidationMessage = t('components.addTagButton.alreadyAdded');\n\t\t}\n\t}\n\n\tfunction handleAdd() {\n\t\tif (creatingTag) {\n\t\t\tonAdd(newName, newColor);\n\t\t} else {\n\t\t\tonAdd(newName);\n\t\t}\n\n\t\tsetOpen(false);\n\t}\n\n\tfunction handleSelectChange(event: React.ChangeEvent<HTMLSelectElement>) {\n\t\tconst tagName = event.target.value;\n\n\t\tsetNewName(tagName);\n\t\tsetCreatingTag(tagName === '');\n\t}\n\n\treturn (\n\t\t<span className=\"add-tag-button\">\n\t\t\t<CardButton\n\t\t\t\tariaLabel={t('components.addTagButton.addLabel')}\n\t\t\t\tdisabled={disabled}\n\t\t\t\ticon={icon ?? <IconPlus />}\n\t\t\t\tlabel={label ?? t('common.tag')}\n\t\t\t\tonChangeOpen={setOpen}\n\t\t\t\topen={open}\n\t\t\t>\n\t\t\t\t<CardContent>\n\t\t\t\t\t<TextSelect\n\t\t\t\t\t\tonChange={handleSelectChange}\n\t\t\t\t\t\toptions={[\n\t\t\t\t\t\t\t{label: t('components.addTagButton.newTag'), value: ''},\n\t\t\t\t\t\t\t...existingTags.map(tag => ({\n\t\t\t\t\t\t\t\tdisabled: assignedTags.includes(tag),\n\t\t\t\t\t\t\t\tlabel: tag,\n\t\t\t\t\t\t\t\tvalue: tag\n\t\t\t\t\t\t\t}))\n\t\t\t\t\t\t]}\n\t\t\t\t\t\tvalue={creatingTag ? '' : newName}\n\t\t\t\t\t>\n\t\t\t\t\t\t{t('components.addTagButton.addLabel')}\n\t\t\t\t\t</TextSelect>\n\t\t\t\t\t{creatingTag && (\n\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t<TextInput\n\t\t\t\t\t\t\t\tonChange={e => setNewName(e.target.value.replace(/\\s/g, '-'))}\n\t\t\t\t\t\t\t\tvalue={newName}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{t('components.addTagButton.tagNameLabel')}\n\t\t\t\t\t\t\t</TextInput>\n\t\t\t\t\t\t\t<TextSelect\n\t\t\t\t\t\t\t\tonChange={e => setNewColor(e.target.value)}\n\t\t\t\t\t\t\t\toptions={colors.map(color => ({\n\t\t\t\t\t\t\t\t\tlabel: t(`colors.${color}`),\n\t\t\t\t\t\t\t\t\tvalue: color\n\t\t\t\t\t\t\t\t}))}\n\t\t\t\t\t\t\t\tvalue={newColor}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{t('components.addTagButton.tagColorLabel')}\n\t\t\t\t\t\t\t</TextSelect>\n\t\t\t\t\t\t</>\n\t\t\t\t\t)}\n\t\t\t\t\t{creatingTag && !!validationMessage && <p>{validationMessage}</p>}\n\t\t\t\t</CardContent>\n\t\t\t\t<ButtonBar>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\tdisabled={!canAdd}\n\t\t\t\t\t\ticon={<IconPlus />}\n\t\t\t\t\t\tlabel={t('common.add')}\n\t\t\t\t\t\tonClick={handleAdd}\n\t\t\t\t\t\tvariant=\"create\"\n\t\t\t\t\t/>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon={<IconX />}\n\t\t\t\t\t\tlabel={t('common.cancel')}\n\t\t\t\t\t\tonClick={() => setOpen(false)}\n\t\t\t\t\t/>\n\t\t\t\t</ButtonBar>\n\t\t\t</CardButton>\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\nimport classNames from 'classnames';\nimport {useTranslation} from 'react-i18next';\nimport {IconChevronDown} from '@tabler/icons';\nimport {MenuButton} from '../control/menu-button';\nimport {colors, Color} from '../../util/color';\nimport './tag-button.css';\n\nexport interface TagButtonProps {\n\tcolor?: Color;\n\tname: string;\n\tonChangeColor: (color: Color) => void;\n\tonRemove: () => void;\n}\n\nexport const TagButton: React.FC<TagButtonProps> = props => {\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<span className={classNames('tag-button', `color-${props.color}`)}>\n\t\t\t<MenuButton\n\t\t\t\ticon={<IconChevronDown />}\n\t\t\t\ticonPosition=\"end\"\n\t\t\t\titems={[\n\t\t\t\t\t...colors.map(color => ({\n\t\t\t\t\t\tcheckable: true,\n\t\t\t\t\t\tchecked: color === 'none' ? !props.color : color === props.color,\n\t\t\t\t\t\tlabel: t(`colors.${color}`),\n\t\t\t\t\t\tonClick: () => props.onChangeColor(color)\n\t\t\t\t\t})),\n\t\t\t\t\t{\n\t\t\t\t\t\tseparator: true\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: t('common.remove'),\n\t\t\t\t\t\tonClick: props.onRemove\n\t\t\t\t\t}\n\t\t\t\t]}\n\t\t\t\tlabel={props.name}\n\t\t\t/>\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\nimport classNames from 'classnames';\nimport './icon-button-link.css';\n\nexport interface IconLinkProps {\n\thref: string;\n\ticon: React.ReactNode;\n\tlabel: string;\n\tvariant?: 'create' | 'danger' | 'primary' | 'secondary';\n\ttarget?: string;\n}\n\nexport const IconLink: React.FC<IconLinkProps> = props => {\n\tconst {href, icon, label, target, variant} = props;\n\tconst className = classNames('icon-link', `variant-${variant}`);\n\n\treturn (\n\t\t<a href={href} className={className} target={target ?? '_blank'}>\n\t\t\t<span className=\"icon\">{icon}</span>\n\t\t\t{label}\n\t\t</a>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconIndentDecrease, IconIndentIncrease} from '@tabler/icons';\nimport {IconButton} from '../control/icon-button';\n\nexport interface IndentButtonsProps {\n\t/**\n\t * CodeMirror instance to interact with.\n\t */\n\teditor?: CodeMirror.Editor;\n}\n\nexport const IndentButtons: React.FC<IndentButtonsProps> = props => {\n\tconst {editor} = props;\n\tconst {t} = useTranslation();\n\n\tfunction execCommand(command: string) {\n\t\teditor?.execCommand(command);\n\t\teditor?.focus();\n\t}\n\n\treturn (\n\t\t<>\n\t\t\t<IconButton\n\t\t\t\tdisabled={!editor}\n\t\t\t\ticon={<IconIndentIncrease />}\n\t\t\t\tlabel={t('components.indentButtons.indent')}\n\t\t\t\tonClick={() => execCommand('indentMore')}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\tdisabled={!editor}\n\t\t\t\ticon={<IconIndentDecrease />}\n\t\t\t\tlabel={t('components.indentButtons.unindent')}\n\t\t\t\tonClick={() => execCommand('indentLess')}\n\t\t\t/>\n\t\t</>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconArrowBack, IconArrowForward} from '@tabler/icons';\nimport {IconButton} from '../control/icon-button';\n\nexport interface UndoRedoButtonsProps {\n\t/**\n\t * CodeMirror instance to interact with.\n\t */\n\teditor?: CodeMirror.Editor;\n\t/**\n\t * A change in this prop triggers a render (probably, put the editor value\n\t * here). This is necessary because the editor instance itself is mutable, so\n\t * we need some way of knowing when to re-check whether undo/redo is availble.\n\t */\n\twatch: string;\n}\n\nexport const UndoRedoButtons: React.FC<UndoRedoButtonsProps> = props => {\n\tconst {editor, watch} = props;\n\tconst {t} = useTranslation();\n\tconst [canRedo, setCanRedo] = React.useState(false);\n\tconst [canUndo, setCanUndo] = React.useState(false);\n\n\tReact.useEffect(() => {\n\t\tif (editor) {\n\t\t\tconst history = editor.historySize();\n\n\t\t\tsetCanRedo(history.redo > 0);\n\t\t\tsetCanUndo(history.undo > 0);\n\t\t} else {\n\t\t\tsetCanRedo(false);\n\t\t\tsetCanUndo(false);\n\t\t}\n\t}, [editor, watch]);\n\n\tfunction execCommand(command: string) {\n\t\teditor?.execCommand(command);\n\t\teditor?.focus();\n\t}\n\n\treturn (\n\t\t<>\n\t\t\t<IconButton\n\t\t\t\tdisabled={!canUndo}\n\t\t\t\ticon={<IconArrowBack />}\n\t\t\t\tlabel={t('common.undo')}\n\t\t\t\tonClick={() => execCommand('undo')}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\tdisabled={!canRedo}\n\t\t\t\ticon={<IconArrowForward />}\n\t\t\t\tlabel={t('common.redo')}\n\t\t\t\tonClick={() => execCommand('redo')}\n\t\t\t/>\n\t\t</>\n\t);\n};\n","import classNames from 'classnames';\nimport * as React from 'react';\nimport './text-input.css';\n\nexport interface TextInputProps {\n\tonChange?: (event: React.ChangeEvent<HTMLInputElement>) => void;\n\tonInput?: (event: React.FormEvent<HTMLInputElement>) => void;\n\torientation?: 'horizontal' | 'vertical';\n\tplaceholder?: string;\n\ttype?: 'search' | 'text';\n\tvalue: string;\n}\n\nexport const TextInput: React.FC<TextInputProps> = props => {\n\tconst className = classNames(\n\t\t'text-input',\n\t\t`orientation-${props.orientation}`,\n\t\t`type-${props.type}`\n\t);\n\n\treturn (\n\t\t<span className={className}>\n\t\t\t<label>\n\t\t\t\t<span className=\"text-input-label\">{props.children}</span>\n\t\t\t\t<input\n\t\t\t\t\tonChange={props.onChange}\n\t\t\t\t\tonInput={props.onInput}\n\t\t\t\t\tplaceholder={props.placeholder}\n\t\t\t\t\ttype={props.type ?? 'text'}\n\t\t\t\t\tvalue={props.value}\n\t\t\t\t/>\n\t\t\t</label>\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\nimport classNames from 'classnames';\nimport './card.css';\n\nexport interface CardProps {\n\tfloating?: boolean;\n\thighlighted?: boolean;\n}\n\nexport const Card: React.FC<CardProps> = props => {\n\tconst {children, floating, highlighted} = props;\n\n\tconst className = classNames('card', {\n\t\tfloating,\n\t\thighlighted\n\t});\n\n\treturn <div className={className}>{children}</div>;\n};\n","// Manages requesting a story format via URL. There are two aspects that add\n// complexity:\n//\n// - The difference between web and Electron contexts. In a web context, the app is\n//   able to make JSON requests freely. In Electron contexts, however, it is\n//   restricted to HTTP/HTTPS only. To allow users to add story formats via\n//   file:/// URL, the main process will make JSONP requests on behalf of a web\n//   process.\n//\n//   This is only needed for requests outside the app bundle (e.g. loading a locale\n//   or an external story format).\n//\n// - Throttling requests. Because all story formats load via the same global\n//   callback, we can only load one at a time safely--otherwise they will compete\n//   for the same callback.\n\nimport jsonp from 'jsonp';\nimport {TwineElectronWindow} from '../../electron/shared';\nimport {StoryFormatProperties} from '../../store/story-formats';\nimport {isElectronRenderer} from '../is-electron';\n\nlet requestQueue = Promise.resolve();\n\n/**\n * Fetches a story format's properties via JSONP. If multiple requests are made\n * at once, they will be queued by this function.\n */\nexport async function fetchStoryFormatProperties(\n\turl: string,\n\ttimeout = 2000\n): Promise<StoryFormatProperties> {\n\tconst {twineElectron} = window as TwineElectronWindow;\n\tconst jsonpRequester =\n\t\tisElectronRenderer() && twineElectron?.jsonp ? twineElectron.jsonp : jsonp;\n\n\treturn new Promise(\n\t\t(resolve, reject) =>\n\t\t\t(requestQueue = requestQueue.then(\n\t\t\t\t() =>\n\t\t\t\t\tnew Promise(resolveQueue => {\n\t\t\t\t\t\tjsonpRequester(url, {timeout, name: 'storyFormat'}, (err, data) => {\n\t\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\t\treject(err);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tresolve(data);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tresolveQueue();\n\t\t\t\t\t\t});\n\t\t\t\t\t})\n\t\t\t))\n\t);\n}\n","export const builtins = () => [\n\t{\n\t\tname: 'Chapbook',\n\t\turl: 'story-formats/chapbook-1.2.2/format.js',\n\t\tversion: '1.2.2'\n\t},\n\t{\n\t\tname: 'Harlowe',\n\t\turl: 'story-formats/harlowe-1.2.4/format.js',\n\t\tversion: '1.2.4'\n\t},\n\t{\n\t\tname: 'Harlowe',\n\t\turl: 'story-formats/harlowe-2.1.0/format.js',\n\t\tversion: '2.1.0'\n\t},\n\t{\n\t\tname: 'Harlowe',\n\t\turl: 'story-formats/harlowe-3.3.1/format.js',\n\t\tversion: '3.3.1'\n\t},\n\t{\n\t\tname: 'Paperthin',\n\t\turl: 'story-formats/paperthin-1.0.0/format.js',\n\t\tversion: '1.0.0'\n\t},\n\t{\n\t\tname: 'Snowman',\n\t\turl: 'story-formats/snowman-1.4.0/format.js',\n\t\tversion: '1.4.0'\n\t},\n\t{\n\t\tname: 'Snowman',\n\t\turl: 'story-formats/snowman-2.0.2/format.js',\n\t\tversion: '2.0.2',\n\t\tuserAdded: false\n\t},\n\t{\n\t\tname: 'SugarCube',\n\t\turl: 'story-formats/sugarcube-1.0.35/format.js',\n\t\tversion: '1.0.35'\n\t},\n\t{\n\t\tname: 'SugarCube',\n\t\turl: 'story-formats/sugarcube-2.36.1/format.js',\n\t\tversion: '2.36.1'\n\t}\n];\n","/**\n * Returns an unique name among an array of existing, making it unique if need\n * be by adding a number at the end.\n */\nexport function unusedName(name: string, existing: string[]): string {\n\tif (existing.includes(name)) {\n\t\tlet suffix = 1;\n\n\t\twhile (existing.includes(`${name} ${suffix}`)) {\n\t\t\tsuffix++;\n\t\t}\n\n\t\treturn `${name} ${suffix}`;\n\t}\n\n\treturn name;\n}\n","import {useTranslation} from 'react-i18next';\nimport {isElectronRenderer} from '../util/is-electron';\n\nexport function useStoreErrorReporter() {\n\t// We can't use suspense here because we're too high in the component tree--we\n\t// need to report errors as soon as possible, and if prefs fail, we might not\n\t// have i18n initialized.\n\n\tconst {t, ready} = useTranslation('', {useSuspense: false});\n\n\treturn {\n\t\treportError(error: Error, messageKey: string) {\n\t\t\tconsole.error('Twine store error', error);\n\n\t\t\tif (ready) {\n\t\t\t\twindow.alert(\n\t\t\t\t\tt(messageKey, {error: error.message}) +\n\t\t\t\t\t\t' ' +\n\t\t\t\t\t\tt(\n\t\t\t\t\t\t\t`store.errors.${\n\t\t\t\t\t\t\t\tisElectronRenderer() ? 'electron' : 'web'\n\t\t\t\t\t\t\t}Remediation`\n\t\t\t\t\t\t)\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\twindow.alert(\n\t\t\t\t\t`An error occurred while saving (${error.message}). Reloading or restarting the application may help.`\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t};\n}\n","import {EditorConfiguration} from 'codemirror';\nimport {PrefsState} from '../store/prefs';\n\n/**\n * Returns baseline CodeMirror options based on user preferences.\n */\nexport function codeMirrorOptionsFromPrefs(\n\tprefs: PrefsState\n): EditorConfiguration {\n\t// Disable overstrike mode.\n\n\tlet result: EditorConfiguration = {\n\t\textraKeys: {\n\t\t\tInsert() {}\n\t\t}\n\t};\n\n\tif (!prefs.editorCursorBlinks) {\n\t\tresult.cursorBlinkRate = 0;\n\t}\n\n\treturn result;\n}\n","import * as React from 'react';\nimport {usePopper} from 'react-popper';\nimport {CSSTransition} from 'react-transition-group';\nimport {Card} from '../container/card';\nimport {IconButton, IconButtonProps} from './icon-button';\nimport './card-button.css';\nimport FocusTrap from 'focus-trap-react';\n\nexport interface CardButtonProps extends Omit<IconButtonProps, 'onClick'> {\n\t/**\n\t * ARIA label for the card that opens.\n\t */\n\tariaLabel: string;\n\t/**\n\t * CSS selector for the element inside the card that should be focused when it\n\t * is opened. Otherwise, the first text input or button in source order will\n\t * be focused.\n\t */\n\tfocusSelector?: string;\n\t/**\n\t * Callback for when the open status of the card should change.\n\t */\n\tonChangeOpen: (value: boolean) => void;\n\t/**\n\t * Is the card currently open?\n\t */\n\topen?: boolean;\n}\n\nexport const CardButton: React.FC<CardButtonProps> = props => {\n\tconst {ariaLabel, children, focusSelector, onChangeOpen, open, ...other} =\n\t\tprops;\n\tconst [buttonEl, setButtonEl] = React.useState<HTMLButtonElement | null>(\n\t\tnull\n\t);\n\tconst [cardEl, setCardEl] = React.useState<HTMLDivElement | null>(null);\n\tconst {styles, attributes} = usePopper(buttonEl, cardEl, {strategy: 'fixed'});\n\n\treturn (\n\t\t<span className=\"card-button\">\n\t\t\t<IconButton\n\t\t\t\t{...other}\n\t\t\t\tonClick={() => onChangeOpen(!open)}\n\t\t\t\tref={setButtonEl}\n\t\t\t/>\n\t\t\t<CSSTransition\n\t\t\t\tclassNames=\"fade-out\"\n\t\t\t\tin={open}\n\t\t\t\tmountOnEnter\n\t\t\t\ttimeout={200}\n\t\t\t\tunmountOnExit\n\t\t\t>\n\t\t\t\t<FocusTrap\n\t\t\t\t\tfocusTrapOptions={{\n\t\t\t\t\t\tclickOutsideDeactivates: true,\n\t\t\t\t\t\tonDeactivate: () => onChangeOpen(false)\n\t\t\t\t\t}}\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\taria-label={ariaLabel}\n\t\t\t\t\t\tclassName=\"card-button-card\"\n\t\t\t\t\t\tref={setCardEl}\n\t\t\t\t\t\trole=\"dialog\"\n\t\t\t\t\t\tstyle={styles.popper}\n\t\t\t\t\t\t{...attributes.popper}\n\t\t\t\t\t>\n\t\t\t\t\t\t<Card floating>{children}</Card>\n\t\t\t\t\t</div>\n\t\t\t\t</FocusTrap>\n\t\t\t</CSSTransition>\n\t\t</span>\n\t);\n};\n","// See https://stackoverflow.com/a/64174790\n\nexport const colors = [\n\t'none',\n\t'red',\n\t'orange',\n\t'yellow',\n\t'green',\n\t'blue',\n\t'purple'\n];\n\nexport type Color = typeof colors[number];\n","/*\nParses passage text for links. Optionally, it returns internal links only --\ne.g. those pointing to other passages in a story, not to an external web site.\n*/\n\nimport uniq from 'lodash/uniq';\n\n// The top level regular expression to catch links -- i.e. [[link]].\nconst extractLinkTags = (text: string) => text.match(/\\[\\[.*?\\]\\]/g) || [];\n\n// Links _not_ starting with a protocol, e.g. abcd://.\nconst internalLinks = (link: string) => !/^\\w+:\\/\\/\\/?\\w/i.test(link);\n\n// Links with some text in them.\nconst nonEmptyLinks = (link: string) => link !== '';\n\n// Setter is the second [] block if exists.\nconst removeSetters = (link: string) => {\n\tconst noSetter = getField(link, '][', 0);\n\n\treturn noSetter ?? link;\n};\n\nconst removeEnclosingBrackets = (link: string) =>\n\tlink.substr(2, link.length - 4);\n\n/**\n * Split the link by the separator and return the field in the given index.\n * Negative indices start from the end of the array.\n */\nconst getField = (link: string, separator: string, index: number) => {\n\tconst fields = link.split(separator);\n\n\tif (fields.length === 1) {\n\t\t/* Separator not present. */\n\t\treturn undefined;\n\t}\n\n\treturn index < 0 ? fields[fields.length + index] : fields[index];\n};\n\n// Arrow links:\n// [[display text->link]] format\n// [[link<-display text]] format\n// Interpret the rightmost '->' and the leftmost '<-' as the divider.\n\nconst extractLink = (tagContent: string) => {\n\treturn (\n\t\tgetField(tagContent, '->', -1) ||\n\t\tgetField(tagContent, '<-', 0) ||\n\t\t//  TiddlyWiki links:\n\t\t//  [[display text|link]] format\n\n\t\tgetField(tagContent, '|', -1) ||\n\t\t// [[link]] format\n\t\ttagContent\n\t);\n};\n\n/**\n * Returns a list of unique links in passage source code.\n */\nexport function parseLinks(text: string, internalOnly?: boolean) {\n\t// Link matching regexps ignore setter components, should they exist.\n\n\tlet result = uniq(\n\t\textractLinkTags(text)\n\t\t\t.map(removeEnclosingBrackets)\n\t\t\t.map(removeSetters)\n\t\t\t.map(extractLink)\n\t\t\t.filter(nonEmptyLinks)\n\t);\n\n\tif (internalOnly) {\n\t\tresult = result.filter(internalLinks);\n\t}\n\n\treturn result;\n}\n","import escapeRegExp from 'lodash/escapeRegExp';\nimport {StorySearchFlags} from '../store/stories/stories.types';\n\n/**\n * Creates RegExps using UI-visible settings.\n */\nexport function createRegExp(\n\tsearch: string,\n\tflags: Omit<StorySearchFlags, 'includePassages'>\n) {\n\treturn new RegExp(\n\t\tflags.useRegexes ? search : escapeRegExp(search),\n\t\tflags.matchCase ? 'g' : 'gi'\n\t);\n}\n\n/**\n * Escapes replacement strings if the user didn't intend them to be regexps.\n * @see https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/replace#Specifying_a_string_as_a_parameter\n */\nexport function escapeRegExpReplace(source: string) {\n\t// This implementation is a little tricky in that it needs to escape the $s\n\t// itself in the replacement.\n\n\treturn source.replace(/\\$/g, '$$$$');\n}\n","import escape from 'lodash/escape';\nimport uniq from 'lodash/uniq';\nimport {Passage, StorySearchFlags, Story} from './stories.types';\nimport {createRegExp} from '../../util/regexp';\nimport {parseLinks} from '../../util/parse-links';\n\n/**\n * Returns a passage name and text with matches for a search highlighted with\n * `<mark>` tags. The result should be displayed as HTML with no escaping.\n */\nexport function markPassageMatches(\n\tpassage: Passage,\n\tsearch: string,\n\tflags: StorySearchFlags\n) {\n\tconst {includePassageNames, matchCase, useRegexes} = flags;\n\tconst matcher = createRegExp(search, {matchCase, useRegexes});\n\tconst highlight = (value: string) => `\\ue000${value}\\ue001`;\n\tconst markHighlights = (value: string) =>\n\t\tvalue.replace(/\\ue000/g, '<mark>').replace(/\\ue001/g, '</mark>');\n\n\tlet nameHighlightedHtml = escape(passage.name);\n\tlet textHighlightedHtml = escape(passage.text);\n\n\tif (includePassageNames) {\n\t\tnameHighlightedHtml = markHighlights(\n\t\t\tescape(passage.name.replace(matcher, highlight))\n\t\t);\n\t}\n\n\ttextHighlightedHtml = markHighlights(\n\t\tescape(passage.text.replace(matcher, highlight))\n\t);\n\n\treturn {\n\t\tnameHighlightedHtml,\n\t\ttextHighlightedHtml\n\t};\n}\n\nexport function passageWithId(\n\tstories: Story[],\n\tstoryId: string,\n\tpassageId: string\n) {\n\tconst story = storyWithId(stories, storyId);\n\tconst result = story.passages.find(p => p.id === passageId);\n\n\tif (result) {\n\t\treturn result;\n\t}\n\n\tthrow new Error(\n\t\t`There is no passage with ID \"${passageId}\" in a story with ID \"${storyId}\".`\n\t);\n}\n\nexport function passageWithName(\n\tstories: Story[],\n\tstoryId: string,\n\tpassageName: string\n) {\n\tconst story = storyWithId(stories, storyId);\n\tconst result = story.passages.find(p => p.name === passageName);\n\n\tif (result) {\n\t\treturn result;\n\t}\n\n\tthrow new Error(\n\t\t`There is no passage with name \"${passageName}\" in a story with ID \"${storyId}\".`\n\t);\n}\n\n/**\n * Returns connections between passages in a structure optimized for rendering.\n * Connections are divided between draggable and fixed, depending on whether\n * either of their passages are selected (and could be dragged by the user).\n */\nexport function passageConnections(\n\tpassages: Passage[],\n\tconnectionParser?: (text: string) => string[]\n) {\n\tconst parser = connectionParser ?? ((text: string) => parseLinks(text, true));\n\tconst passageMap = new Map(passages.map(p => [p.name, p]));\n\tconst result = {\n\t\tdraggable: {\n\t\t\tbroken: new Set<Passage>(),\n\t\t\tconnections: new Map<Passage, Set<Passage>>(),\n\t\t\tself: new Set<Passage>()\n\t\t},\n\t\tfixed: {\n\t\t\tbroken: new Set<Passage>(),\n\t\t\tconnections: new Map<Passage, Set<Passage>>(),\n\t\t\tself: new Set<Passage>()\n\t\t}\n\t};\n\n\tpassages.forEach(passage =>\n\t\tparser(passage.text).forEach(targetName => {\n\t\t\tif (targetName === passage.name) {\n\t\t\t\t(passage.selected ? result.draggable : result.fixed).self.add(passage);\n\t\t\t} else {\n\t\t\t\tconst targetPassage = passageMap.get(targetName);\n\n\t\t\t\tif (targetPassage) {\n\t\t\t\t\tconst target =\n\t\t\t\t\t\tpassage.selected || targetPassage.selected\n\t\t\t\t\t\t\t? result.draggable\n\t\t\t\t\t\t\t: result.fixed;\n\n\t\t\t\t\tif (target.connections.has(passage)) {\n\t\t\t\t\t\ttarget.connections.get(passage)!.add(targetPassage);\n\t\t\t\t\t} else {\n\t\t\t\t\t\ttarget.connections.set(passage, new Set([targetPassage]));\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t(passage.selected ? result.draggable : result.fixed).broken.add(\n\t\t\t\t\t\tpassage\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\t);\n\n\treturn result;\n}\n\n/**\n * Returns all passages matching a search criteria. Use\n * `highlightPassageMatches()` to highlight exactly what matched.\n */\nexport function passagesMatchingSearch(\n\tpassages: Passage[],\n\tsearch: string,\n\tflags: StorySearchFlags\n): Passage[] {\n\tif (search === '') {\n\t\treturn [];\n\t}\n\n\tconst {includePassageNames, matchCase, useRegexes} = flags;\n\tconst matcher = createRegExp(search, {matchCase, useRegexes});\n\n\treturn passages.reduce((result, passage) => {\n\t\tif (\n\t\t\tmatcher.test(passage.text) ||\n\t\t\t(includePassageNames && matcher.test(passage.name))\n\t\t) {\n\t\t\treturn [...result, passage];\n\t\t}\n\n\t\treturn result;\n\t}, [] as Passage[]);\n}\n\nexport function storyPassageTags(story: Story) {\n\treturn Array.from(\n\t\tstory.passages.reduce((result, passage) => {\n\t\t\tpassage.tags && passage.tags.forEach(tag => result.add(tag));\n\t\t\treturn result;\n\t\t}, new Set<string>())\n\t).sort();\n}\n\nexport function storyStats(story: Story) {\n\tconst links = story.passages.reduce<string[]>(\n\t\t(links, passage) => [\n\t\t\t...links,\n\t\t\t...parseLinks(passage.text).filter(link => links.indexOf(link) === -1)\n\t\t],\n\t\t[]\n\t);\n\n\tconst brokenLinks = uniq(links).filter(\n\t\tlink => !story.passages.some(passage => passage.name === link)\n\t);\n\n\treturn {\n\t\tbrokenLinks,\n\t\tlinks,\n\t\tcharacters: story.passages.reduce(\n\t\t\t(count, passage) => count + passage.text.length,\n\t\t\t0\n\t\t),\n\t\tpassages: story.passages.length,\n\t\twords: story.passages.reduce(\n\t\t\t(count, passage) => count + passage.text.split(/\\s+/).length,\n\t\t\t0\n\t\t)\n\t};\n}\n\nexport function storyTags(stories: Story[]) {\n\treturn Array.from(\n\t\tstories.reduce((result, story) => {\n\t\t\tstory.tags && story.tags.forEach(tag => result.add(tag));\n\t\t\treturn result;\n\t\t}, new Set<string>())\n\t).sort();\n}\n\nexport function storyWithId(stories: Story[], storyId: string) {\n\tconst result = stories.find(s => s.id === storyId);\n\n\tif (result) {\n\t\treturn result;\n\t}\n\n\tthrow new Error(`There is no story with ID \"${storyId}\".`);\n}\n\nexport function storyWithName(stories: Story[], name: string) {\n\tconst result = stories.find(s => s.name === name);\n\n\tif (result) {\n\t\treturn result;\n\t}\n\n\tthrow new Error(`There is no story with name \"${name}\".`);\n}\n","import * as React from 'react';\nimport {useScrollbarSize} from 'react-scrollbar-size';\nimport {CSSTransition, TransitionGroup} from 'react-transition-group';\nimport {useDialogsContext} from '.';\nimport './dialogs.css';\n\nconst DialogTransition: React.FC = props => (\n\t<CSSTransition classNames=\"pop\" timeout={200} {...props}>\n\t\t{props.children}\n\t</CSSTransition>\n);\n\nexport const Dialogs: React.FC = () => {\n\tconst {height, width} = useScrollbarSize();\n\tconst {dispatch, dialogs} = useDialogsContext();\n\n\tconst style: React.CSSProperties = {\n\t\tmarginBottom: height,\n\t\tmarginRight: width\n\t};\n\n\treturn (\n\t\t<div className=\"dialogs\" style={style}>\n\t\t\t<TransitionGroup component={null}>\n\t\t\t\t{dialogs.map((dialog, index) => {\n\t\t\t\t\tconst managementProps = {\n\t\t\t\t\t\tcollapsed: dialog.collapsed,\n\t\t\t\t\t\tonChangeCollapsed: (collapsed: boolean) =>\n\t\t\t\t\t\t\tdispatch({type: 'setDialogCollapsed', collapsed, index}),\n\t\t\t\t\t\tonClose: () => dispatch({type: 'removeDialog', index})\n\t\t\t\t\t};\n\n\t\t\t\t\treturn (\n\t\t\t\t\t\t<DialogTransition key={index}>\n\t\t\t\t\t\t\t<dialog.component {...dialog.props} {...managementProps} />\n\t\t\t\t\t\t</DialogTransition>\n\t\t\t\t\t);\n\t\t\t\t})}\n\t\t\t</TransitionGroup>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {TagColors} from '../../store/stories';\nimport './tag-stripe.css';\n\nexport interface TagStripeProps {\n\ttagColors: TagColors;\n\ttags: string[];\n}\n\nexport const TagStripe: React.FC<TagStripeProps> = React.memo(props => {\n\treturn (\n\t\t<div className=\"tag-stripe\">\n\t\t\t{props.tags.map(tag => (\n\t\t\t\t<span\n\t\t\t\t\tclassName={`color-${props.tagColors[tag]}`}\n\t\t\t\t\tkey={tag}\n\t\t\t\t\ttitle={tag}\n\t\t\t\t/>\n\t\t\t))}\n\t\t</div>\n\t);\n});\n\nTagStripe.displayName = 'TagStripe';\n","import * as React from 'react';\nimport isEqual from 'lodash/isEqual';\nimport {DialogsAction, DialogsState} from '../dialogs.types';\n\nexport const reducer: React.Reducer<DialogsState, DialogsAction> = (\n\tstate,\n\taction\n) => {\n\tswitch (action.type) {\n\t\tcase 'addDialog':\n\t\t\t// If the dialog has been previously added, expand it. Otherwise, add it\n\t\t\t// to the end.\n\n\t\t\tlet exists = false;\n\t\t\tconst editedState = state.map(stateDialog => {\n\t\t\t\tif (\n\t\t\t\t\tisEqual(stateDialog, {\n\t\t\t\t\t\t// Ignore collapsed property for comparison\n\t\t\t\t\t\tcollapsed: stateDialog.collapsed,\n\t\t\t\t\t\tcomponent: action.component,\n\t\t\t\t\t\tprops: action.props\n\t\t\t\t\t})\n\t\t\t\t) {\n\t\t\t\t\texists = true;\n\t\t\t\t\treturn {...stateDialog, collapsed: false};\n\t\t\t\t}\n\n\t\t\t\treturn stateDialog;\n\t\t\t});\n\n\t\t\tif (exists) {\n\t\t\t\treturn editedState;\n\t\t\t}\n\n\t\t\treturn [\n\t\t\t\t...state,\n\t\t\t\t{component: action.component, collapsed: false, props: action.props}\n\t\t\t];\n\n\t\tcase 'removeDialog':\n\t\t\treturn state.filter((dialog, index) => index !== action.index);\n\n\t\tcase 'setDialogCollapsed':\n\t\t\treturn state.map((dialog, index) =>\n\t\t\t\tindex === action.index\n\t\t\t\t\t? {...dialog, collapsed: action.collapsed}\n\t\t\t\t\t: dialog\n\t\t\t);\n\t}\n};\n","import * as React from 'react';\nimport useThunkReducer, {Thunk} from 'react-hook-thunk-reducer';\nimport {reducer} from './reducer';\nimport {Dialogs} from './dialogs';\nimport {DialogsAction, DialogsState} from '../dialogs.types';\n\nexport interface DialogsContextProps {\n\tdispatch: React.Dispatch<DialogsAction | Thunk<DialogsState, DialogsAction>>;\n\tdialogs: DialogsState;\n}\n\nexport const DialogsContext = React.createContext<DialogsContextProps>({\n\tdispatch: () => {},\n\tdialogs: []\n});\n\nDialogsContext.displayName = 'Dialogs';\n\nexport const useDialogsContext = () => React.useContext(DialogsContext);\n\nexport const DialogsContextProvider: React.FC = props => {\n\tconst [dialogs, dispatch] = useThunkReducer(reducer, []);\n\n\treturn (\n\t\t<DialogsContext.Provider value={{dispatch, dialogs}}>\n\t\t\t{props.children}\n\t\t\t<Dialogs />\n\t\t</DialogsContext.Provider>\n\t);\n};\n","// Handles importing HTML source code into story objects ready to be saved to\n// the store. This works on both published story files and archives.\n//\n// It's important that this code be as efficient as possible, as it directly\n// affects startup time in the Twine desktop app. This module moves data from\n// the filesystem into local storage, and the app can't begin until it's done.\n\nimport defaults from 'lodash/defaults';\nimport uuid from 'tiny-uuid';\nimport {passageDefaults, storyDefaults, Passage, Story} from '../store/stories';\n\n/**\n * An imported story, which may contain incomplete or malformed data.\n */\nexport interface ImportedStory extends Omit<Partial<Story>, 'passages'> {\n\tpassages: Partial<Passage>[];\n}\n\n/**\n * HTML selectors used to find data in HTML format.\n */\nconst selectors = {\n\tpassage: 'tw-passage',\n\tstory: 'tw-story',\n\tscript: '[role=script]',\n\tstylesheet: '[role=stylesheet]',\n\tstoryData: 'tw-storydata',\n\ttagColors: 'tw-tag',\n\tpassageData: 'tw-passagedata'\n};\n\n/**\n * Convenience function to convert a string value to an float.\n */\nfunction float(stringValue: string) {\n\treturn parseFloat(stringValue);\n}\n\n/**\n * Convenience function to query an element by a selector.\n */\nfunction query(el: Element, selector: string) {\n\treturn Array.from(el.querySelectorAll(selector));\n}\n\n/**\n * Convenience function to parse a string like \"100,50\".\n */\nfunction parseDimensions(raw: any): [string, string] | undefined {\n\tif (typeof raw !== 'string') {\n\t\treturn undefined;\n\t}\n\n\tconst bits = raw.split(',');\n\n\tif (bits.length === 2) {\n\t\treturn [bits[0], bits[1]];\n\t}\n\n\treturn undefined;\n}\n\n/**\n * Converts a DOM <tw-storydata> element to a story object matching the format\n * in the store. This *may* be missing data, or data it returns may be\n * malformed. This function does its best to reflect the contents of the\n * element.\n */\nfunction domToObject(storyEl: Element): ImportedStory {\n\tconst startPassagePid = storyEl.getAttribute('startnode');\n\tlet startPassageId: string | undefined = undefined;\n\tconst story: ImportedStory = {\n\t\tifid: storyEl.getAttribute('ifid') ?? uuid(),\n\t\tid: uuid(),\n\t\tlastUpdate: undefined,\n\t\tname: storyEl.getAttribute('name') ?? undefined,\n\t\tstoryFormat: storyEl.getAttribute('format') ?? undefined,\n\t\tstoryFormatVersion: storyEl.getAttribute('format-version') ?? undefined,\n\t\tscript: query(storyEl, selectors.script)\n\t\t\t.map(el => el.textContent)\n\t\t\t.join('\\n'),\n\t\tstylesheet: query(storyEl, selectors.stylesheet)\n\t\t\t.map(el => el.textContent)\n\t\t\t.join('\\n'),\n\t\ttags: storyEl.getAttribute('tags')\n\t\t\t? storyEl.getAttribute('tags')!.split(/\\s+/)\n\t\t\t: [],\n\t\tzoom: parseFloat(storyEl.getAttribute('zoom') ?? '1'),\n\t\ttagColors: query(storyEl, selectors.tagColors).reduce((result, el) => {\n\t\t\tconst tagName = el.getAttribute('name');\n\n\t\t\tif (typeof tagName !== 'string') {\n\t\t\t\treturn result;\n\t\t\t}\n\n\t\t\treturn {...result, [tagName]: el.getAttribute('color')};\n\t\t}, {}),\n\t\tpassages: query(storyEl, selectors.passageData).map(passageEl => {\n\t\t\tconst id = uuid();\n\t\t\tconst position = parseDimensions(passageEl.getAttribute('position'));\n\t\t\tconst size = parseDimensions(passageEl.getAttribute('size'));\n\n\t\t\tif (passageEl.getAttribute('pid') === startPassagePid) {\n\t\t\t\tstartPassageId = id;\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tid,\n\t\t\t\tleft: position ? float(position[0]) : undefined,\n\t\t\t\ttop: position ? float(position[1]) : undefined,\n\t\t\t\twidth: size ? float(size[0]) : undefined,\n\t\t\t\theight: size ? float(size[1]) : undefined,\n\t\t\t\ttags: passageEl.getAttribute('tags')\n\t\t\t\t\t? passageEl.getAttribute('tags')!.split(/\\s+/)\n\t\t\t\t\t: [],\n\t\t\t\tname: passageEl.getAttribute('name') ?? undefined,\n\t\t\t\ttext: passageEl.textContent ?? undefined\n\t\t\t};\n\t\t})\n\t};\n\n\tstory.startPassage = startPassageId;\n\treturn story;\n}\n\n/**\n * Imports stories from HTML. If there are any missing attributes in the HTML,\n * defaults will be applied.\n */\nexport function importStories(\n\thtml: string,\n\tlastUpdateOverride?: Date\n): Story[] {\n\tconst nodes = document.createElement('div');\n\n\tnodes.innerHTML = html;\n\n\treturn query(nodes, selectors.storyData).map(storyEl => {\n\t\tconst importedStory = domToObject(storyEl);\n\n\t\t// Merge in defaults. We can't use object spreads here because undefined\n\t\t// values would override defaults.\n\n\t\tconst story: Story = defaults(importedStory, {id: uuid()}, storyDefaults());\n\n\t\t// Override the last update as requested.\n\n\t\tif (lastUpdateOverride) {\n\t\t\tstory.lastUpdate = lastUpdateOverride;\n\t\t}\n\n\t\t// Merge in passage defaults. We don't need to set ID here--domToObject did\n\t\t// this for us.\n\n\t\tstory.passages = story.passages.map(passage =>\n\t\t\tdefaults(passage, passageDefaults(), {story: story.id})\n\t\t);\n\n\t\treturn story;\n\t});\n}\n","import * as React from 'react';\nimport {Card, CardProps} from './card/card';\nimport './button-card.css';\n\nexport const ButtonCard: React.FC<CardProps> = props => (\n\t<div className=\"button-card\">\n\t\t<Card {...props} />\n\t</div>\n);\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconWriting} from '@tabler/icons';\nimport {PromptButton} from '../control/prompt-button';\nimport {Passage, Story} from '../../store/stories';\nimport {IconButton} from '../control/icon-button';\n\nconst DisabledRenamePassageButton: React.FC = () => {\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton disabled icon={<IconWriting />} label={t('common.rename')} />\n\t);\n};\n\nexport interface EnabledRenamePassageButtonProps {\n\tonRename: (value: string) => void;\n\tpassage: Passage;\n\tstory: Story;\n}\n\nexport const EnabledRenamePassageButton: React.FC<EnabledRenamePassageButtonProps> = props => {\n\tconst {onRename, passage, story} = props;\n\tconst [newName, setNewName] = React.useState(passage.name);\n\tconst {t} = useTranslation();\n\n\tfunction validate(name: string) {\n\t\tif (name.trim() === '') {\n\t\t\treturn {\n\t\t\t\tmessage: t('components.renamePassageButton.emptyName'),\n\t\t\t\tvalid: false\n\t\t\t};\n\t\t}\n\n\t\tif (story.passages.some(p => p.id !== passage.id && p.name === name)) {\n\t\t\treturn {\n\t\t\t\tmessage: t('components.renamePassageButton.nameAlreadyUsed'),\n\t\t\t\tvalid: false\n\t\t\t};\n\t\t}\n\n\t\treturn {valid: true};\n\t}\n\n\treturn (\n\t\t<PromptButton\n\t\t\ticon={<IconWriting />}\n\t\t\tlabel={t('common.rename')}\n\t\t\tonChange={event => setNewName(event.target.value)}\n\t\t\tonSubmit={onRename}\n\t\t\tprompt={t('common.renamePrompt', {name: passage.name})}\n\t\t\tvalidate={validate}\n\t\t\tvalue={newName}\n\t\t/>\n\t);\n};\n\nexport interface RenamePassageButtonProps\n\textends Omit<EnabledRenamePassageButtonProps, 'passage'> {\n\tpassage?: Passage;\n}\n\nexport const RenamePassageButton: React.FC<RenamePassageButtonProps> = props => {\n\tif (props.passage) {\n\t\treturn (\n\t\t\t<EnabledRenamePassageButton\n\t\t\t\t{...(props as EnabledRenamePassageButtonProps)}\n\t\t\t/>\n\t\t);\n\t}\n\n\treturn <DisabledRenamePassageButton />;\n};","import * as React from 'react';\nimport {usePrefsContext} from '.';\n\nexport function useComputedTheme() {\n\t// See https://developer.mozilla.org/en-US/docs/Web/API/Window/matchMedia\n\n\tconst {prefs} = usePrefsContext();\n\tconst [mediaQuery] = React.useState(\n\t\twindow.matchMedia('(prefers-color-scheme: dark)')\n\t);\n\tconst [systemTheme, setSystemTheme] = React.useState<'dark' | 'light'>(\n\t\tmediaQuery.matches ? 'dark' : 'light'\n\t);\n\n\tReact.useEffect(() => {\n\t\tconst listener = (event: MediaQueryListEvent) =>\n\t\t\tsetSystemTheme(event.matches ? 'dark' : 'light');\n\n\t\tmediaQuery.addEventListener('change', listener);\n\t\treturn () => mediaQuery.removeEventListener('change', listener);\n\t}, [mediaQuery]);\n\n\treturn prefs.appTheme === 'system' ? systemTheme : prefs.appTheme;\n}\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport classNames from 'classnames';\nimport {IconWriting} from '@tabler/icons';\nimport {colors, Color} from '../../util/color';\nimport {PromptButton, PromptValidationResponse} from '../control/prompt-button';\nimport {TextSelect} from '../control/text-select';\nimport './tag-editor.css';\n\nexport interface TagEditorProps {\n\tallTags: string[];\n\tcolor?: Color;\n\tname: string;\n\tonChangeColor: (color: Color) => void;\n\tonChangeName: (name: string) => void;\n}\n\nexport const TagEditor: React.FC<TagEditorProps> = props => {\n\tconst {allTags, color, name, onChangeColor, onChangeName} = props;\n\tconst [newName, setNewName] = React.useState(name);\n\tconst {t} = useTranslation();\n\n\tfunction validate(value: string): PromptValidationResponse {\n\t\tif (value !== name && allTags.includes(value)) {\n\t\t\treturn {message: t('components.tagEditor.alreadyExists'), valid: false};\n\t\t}\n\n\t\treturn {valid: true};\n\t}\n\n\treturn (\n\t\t<div className=\"tag-editor\">\n\t\t\t<span className={classNames('tag-name', `color-${props.color}`)}>\n\t\t\t\t{props.name}\n\t\t\t</span>\n\t\t\t<PromptButton\n\t\t\t\ticon={<IconWriting />}\n\t\t\t\tlabel={t('common.rename')}\n\t\t\t\tonChange={e => setNewName(e.target.value.replace(/\\s/g, '-'))}\n\t\t\t\tonSubmit={() => onChangeName(newName)}\n\t\t\t\tprompt={t('common.renamePrompt', {name})}\n\t\t\t\tvalue={newName}\n\t\t\t\tvalidate={validate}\n\t\t\t/>\n\t\t\t<TextSelect\n\t\t\t\tonChange={e => onChangeColor(e.target.value)}\n\t\t\t\toptions={colors.map(color => ({\n\t\t\t\t\tlabel: t(`colors.${color}`),\n\t\t\t\t\tvalue: color\n\t\t\t\t}))}\n\t\t\t\tvalue={color ?? ''}\n\t\t\t>\n\t\t\t\t{t('common.color')}\n\t\t\t</TextSelect>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport './meter.css';\n\nexport interface MeterProps {\n\tdomId: string;\n\tpercent: number;\n}\n\nexport const Meter: React.FC<MeterProps> = ({children, domId, percent}) => {\n\treturn (\n\t\t<div\n\t\t\tclassName=\"meter\"\n\t\t\tid={domId}\n\t\t\trole=\"meter\"\n\t\t\taria-labelledby={`${domId}-label`}\n\t\t\taria-valuemin={0}\n\t\t\taria-valuemax={100}\n\t\t\taria-valuenow={percent * 100}\n\t\t>\n\t\t\t<div className=\"meter-bar\">\n\t\t\t\t<span className=\"filled\" style={{width: percent * 100 + '%'}}></span>\n\t\t\t</div>\n\t\t\t<div className=\"meter-label\" id={`${domId}-label`}>\n\t\t\t\t{children}\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n","// Initiates story format loading, optionally showing a progress meter while it works.\n\nimport * as React from 'react';\nimport {Meter} from '../components/meter';\nimport {\n\tloadAllFormatProperties,\n\tuseStoryFormatsContext,\n\tStoryFormat\n} from './story-formats';\n\nexport interface FormatLoaderProps {\n\tblock?: boolean;\n}\n\nexport const FormatLoader: React.FC<FormatLoaderProps> = ({\n\tblock,\n\tchildren\n}) => {\n\tconst [seenFormats, setSeenFormats] = React.useState<StoryFormat[]>([]);\n\tconst {dispatch, formats} = useStoryFormatsContext();\n\n\t// We can't directly use formats in an effect because it will change as\n\t// loading takes place. Instead, we need to maintain a list of formats to load\n\t// that only ever changes if new formats appear in state.\n\n\tReact.useEffect(() => {\n\t\tconst newFormats = formats.filter(\n\t\t\tnewFormat =>\n\t\t\t\t!seenFormats.find(\n\t\t\t\t\toldFormat =>\n\t\t\t\t\t\toldFormat.name === newFormat.name &&\n\t\t\t\t\t\toldFormat.version === newFormat.version\n\t\t\t\t)\n\t\t);\n\n\t\tif (newFormats.length > 0) {\n\t\t\tdispatch(loadAllFormatProperties(newFormats));\n\t\t\tsetSeenFormats([...seenFormats, ...newFormats]);\n\t\t}\n\t}, [dispatch, formats, seenFormats]);\n\n\tconst loadingFormat = formats.find(f => f.loadState === 'loading');\n\tconst loadPercent =\n\t\tformats.filter(f => f.loadState === 'loaded').length / formats.length;\n\n\tif (block && loadPercent < 1) {\n\t\treturn (\n\t\t\t<Meter domId=\"story-format-loader\" percent={loadPercent}>\n\t\t\t\t{loadingFormat && (\n\t\t\t\t\t<>\n\t\t\t\t\t\tLoading {loadingFormat.name} {loadingFormat.version}\n\t\t\t\t\t</>\n\t\t\t\t)}\n\t\t\t</Meter>\n\t\t);\n\t}\n\n\treturn <>{children}</>;\n};\n","import {PrefsAction, PrefsState} from './prefs.types';\nimport {Color} from '../../util/color';\n\nexport function setPref(\n\tname: keyof PrefsState,\n\tvalue:\n\t\t| boolean\n\t\t| number\n\t\t| string\n\t\t| {name: string; version: string}\n\t\t| {name: string; version: string}[]\n\t\t| Record<string, Color>\n): PrefsAction {\n\treturn {type: 'update', name, value};\n}\n","import {PrefsState} from './prefs.types';\n\n/**\n * Returns whether the user has disabled editor extensions for a story format.\n */\nexport function formatEditorExtensionsDisabled(\n\tprefs: PrefsState,\n\tname: string,\n\tversion: string\n) {\n\treturn prefs.disabledStoryFormatEditorExtensions.some(\n\t\tf => f.name === name && f.version === version\n\t);\n}\n","import {Story} from '../../store/stories/stories.types';\n\n/**\n * Returns a filename for a story object that's guaranteed to be safe across all\n * platforms. For this, we use POSIX's definition\n * (http://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap03.html#tag_03_276)\n * with the addition of spaces, for legibility.\n */\nexport function storyFileName(story: Story) {\n\treturn story.name.replace(/[^\\w. -]/g, '_') + '.html';\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {StoryFormatsState} from '.';\nimport {fetchStoryFormatProperties} from '../../util/story-format/fetch-properties';\nimport {\n\tStoryFormat,\n\tStoryFormatProperties,\n\tStoryFormatsAction,\n\tStoryFormatsDispatch\n} from './story-formats.types';\n\n/**\n * Creates a new story format based on properties (probably loaded externally).\n */\nexport function createFromProperties(\n\turl: string,\n\tproperties: StoryFormatProperties\n): StoryFormatsAction {\n\tif (!properties.name || !properties.version) {\n\t\tthrow new Error('Missing required properties for a new story format');\n\t}\n\n\treturn {\n\t\ttype: 'create',\n\t\tprops: {\n\t\t\turl,\n\t\t\tname: properties.name,\n\t\t\tselected: false,\n\t\t\tuserAdded: true,\n\t\t\tversion: properties.version\n\t\t}\n\t};\n}\n\n/**\n * Deletes a story format.\n */\nexport function deleteFormat(format: StoryFormat): StoryFormatsAction {\n\treturn {type: 'delete', id: format.id};\n}\n\n/**\n * Deselects all formats.\n */\nexport function deselectAllFormats(): Thunk<StoryFormat[], StoryFormatsAction> {\n\treturn (dispatch, getFormats) => {\n\t\tfor (const format of getFormats()) {\n\t\t\tif (format.selected) {\n\t\t\t\tdispatch({type: 'update', id: format.id, props: {selected: false}});\n\t\t\t}\n\t\t}\n\t};\n}\n\n/**\n * Deselects a single format.\n */\nexport function deselectFormat(format: StoryFormat): StoryFormatsAction {\n\treturn {type: 'update', id: format.id, props: {selected: false}};\n}\n\nasync function loadFormatThunk(\n\tformat: StoryFormat,\n\tdispatch: StoryFormatsDispatch\n) {\n\tdispatch({\n\t\ttype: 'update',\n\t\tid: format.id,\n\t\tprops: {loadState: 'loading'}\n\t});\n\n\ttry {\n\t\tlet properties = await fetchStoryFormatProperties(format.url);\n\n\t\t// If the format contains a `hydrate` property, try running it and merge in\n\t\t// properties that function creates by modifiying what's bound to its\n\t\t// `this`. This allows creation of properties that can't be serialized to\n\t\t// JSON on the format. The hydrate function cannot override properties\n\t\t// already present in the format properties, e.g. to change its source.\n\n\t\tif (properties.hydrate) {\n\t\t\ttry {\n\t\t\t\tconst hydrateResult: Partial<StoryFormatProperties> = {};\n\n\t\t\t\t// eslint-disable-next-line no-new-func\n\t\t\t\tconst hydrateFunc = new Function(properties.hydrate);\n\n\t\t\t\thydrateFunc.call(hydrateResult);\n\t\t\t\tproperties = {...hydrateResult, ...properties};\n\t\t\t} catch (e) {\n\t\t\t\tconsole.error(\n\t\t\t\t\t`Format ${format.id} has a hydrate property but it threw an error when called`,\n\t\t\t\t\te\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\tdispatch({\n\t\t\ttype: 'update',\n\t\t\tid: format.id,\n\t\t\tprops: {properties, loadState: 'loaded'}\n\t\t});\n\n\t\treturn properties;\n\t} catch (loadError) {\n\t\tdispatch({\n\t\t\ttype: 'update',\n\t\t\tid: format.id,\n\t\t\tprops: {loadError: (loadError as unknown) as Error, loadState: 'error'}\n\t\t});\n\t}\n}\n\n/**\n * Loads all format properties. If loading previously failed, this will try\n * again.\n */\nexport function loadAllFormatProperties(\n\tformats: StoryFormat[]\n): Thunk<StoryFormat[], StoryFormatsAction> {\n\tconst toLoad = formats.filter(\n\t\tf => f.loadState !== 'loaded' && f.loadState !== 'loading'\n\t);\n\n\tif (!toLoad) {\n\t\treturn () => {};\n\t}\n\n\treturn async (dispatch: StoryFormatsDispatch) => {\n\t\tawait Promise.allSettled(\n\t\t\ttoLoad.map(format => loadFormatThunk(format, dispatch))\n\t\t);\n\t};\n}\n\n/**\n * Loads a format's properties. If loading previously failed, this function will\n * try again. This returns a thunk which in turns returns a promise resolving to\n * the format properties, which can be useful if you need them immediately.\n */\nexport function loadFormatProperties(format: StoryFormat) {\n\tif (format.loadState === 'loaded') {\n\t\treturn () => format.properties;\n\t}\n\n\treturn async (dispatch: StoryFormatsDispatch) =>\n\t\tawait loadFormatThunk(format, dispatch);\n}\n\n/**\n * Selects a single format.\n */\nexport function selectFormat(\n\tformat: StoryFormat,\n\texclusive?: boolean\n): Thunk<StoryFormatsState, StoryFormatsAction> {\n\treturn (dispatch, getState) => {\n\t\tif (!format.selected) {\n\t\t\tdispatch({\n\t\t\t\ttype: 'update',\n\t\t\t\tid: format.id,\n\t\t\t\tprops: {selected: true}\n\t\t\t});\n\t\t}\n\n\t\tif (exclusive) {\n\t\t\tfor (const other of getState()) {\n\t\t\t\tif (other.id !== format.id && other.selected) {\n\t\t\t\t\tdispatch({\n\t\t\t\t\t\ttype: 'update',\n\t\t\t\t\t\tid: other.id,\n\t\t\t\t\t\tprops: {selected: false}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n}","import isAbsoluteUrl from 'is-absolute-url';\nimport semverLt from 'semver/functions/lt';\nimport {StoryFormat} from './story-formats.types';\nimport {PrefsState} from '../prefs';\nimport {gt} from 'semver';\n\nexport function filteredFormats(\n\tformats: StoryFormat[],\n\tfilter: PrefsState['storyFormatListFilter']\n): StoryFormat[] {\n\tswitch (filter) {\n\t\tcase 'all':\n\t\t\treturn formats;\n\n\t\tcase 'current':\n\t\t\treturn Object.values(\n\t\t\t\tformats.reduce<Record<string, StoryFormat>>((result, format) => {\n\t\t\t\t\tif (\n\t\t\t\t\t\t!result[format.name] ||\n\t\t\t\t\t\tsemverLt(result[format.name].version, format.version)\n\t\t\t\t\t) {\n\t\t\t\t\t\treturn {...result, [format.name]: format};\n\t\t\t\t\t}\n\n\t\t\t\t\treturn result;\n\t\t\t\t}, {})\n\t\t\t);\n\n\t\tcase 'user':\n\t\t\treturn formats.filter(format => format.userAdded);\n\t}\n}\n\nexport function formatImageUrl(format: StoryFormat) {\n\tif (format.loadState !== 'loaded' || !format.properties.image) {\n\t\tthrow new Error('Format has no image property');\n\t}\n\n\tif (isAbsoluteUrl(format.properties.image)) {\n\t\treturn format.properties.image;\n\t}\n\n\treturn format.url.replace(/\\/[^/]*?$/, '/') + format.properties.image;\n}\n\nexport function formatWithId(formats: StoryFormat[], id: string) {\n\tconst result = formats.find(f => f.id === id);\n\n\tif (result) {\n\t\treturn result;\n\t}\n\n\tthrow new Error(`There is no story format with ID \"${id}\".`);\n}\n\nexport function formatWithNameAndVersion(\n\tformats: StoryFormat[],\n\tname: string,\n\tversion: string\n) {\n\tconst result = formats.find(f => f.name === name && f.version === version);\n\n\tif (result) {\n\t\treturn result;\n\t}\n\n\tthrow new Error(\n\t\t`There is no story format with name \"${name}\" and version \"${version}\".`\n\t);\n}\n\nexport function newestFormatNamed(formats: StoryFormat[], name: string) {\n\treturn formats.reduce<StoryFormat | undefined>((result, format) => {\n\t\tif (format.name !== name) {\n\t\t\treturn result;\n\t\t}\n\n\t\tif (!result || gt(format.version, result.version)) {\n\t\t\treturn format;\n\t\t}\n\n\t\treturn result;\n\t}, undefined);\n}\n\nexport function sortFormats(formats: StoryFormat[]) {\n\treturn formats.sort((a, b) => {\n\t\t// First sort by name ascending...\n\n\t\tif (a.name < b.name) {\n\t\t\treturn -1;\n\t\t}\n\n\t\tif (a.name > b.name) {\n\t\t\treturn 1;\n\t\t}\n\n\t\t// ... then by version, in descending order.\n\n\t\tif (a.version === b.version) {\n\t\t\treturn 0;\n\t\t}\n\n\t\tif (semverLt(b.version, a.version)) {\n\t\t\treturn -1;\n\t\t}\n\n\t\treturn 1;\n\t});\n}\n","import {IconHeart, IconX} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {ButtonBar} from '../components/container/button-bar';\nimport {CardContent} from '../components/container/card';\nimport {DialogCard} from '../components/container/dialog-card';\nimport {IconButton} from '../components/control/icon-button';\nimport {IconLink} from '../components/control/icon-link';\nimport {setPref, usePrefsContext} from '../store/prefs';\nimport {DialogComponentProps} from './dialogs.types';\n\nexport const AppDonationDialog: React.FC<DialogComponentProps> = props => {\n\tconst {dispatch} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tReact.useEffect(() => dispatch(setPref('donateShown', true)), [dispatch]);\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...props}\n\t\t\tclassName=\"app-donation-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={t('dialogs.appDonation.title')}\n\t\t>\n\t\t\t<CardContent>\n\t\t\t\t<div className=\"text\">\n\t\t\t\t\t<p>{t('dialogs.appDonation.supportMessage')}</p>\n\t\t\t\t\t<p>{t('dialogs.appDonation.onlyOnce')}</p>\n\t\t\t\t</div>\n\t\t\t</CardContent>\n\t\t\t<ButtonBar>\n\t\t\t\t<IconLink\n\t\t\t\t\thref=\"https://twinery.org/donate\"\n\t\t\t\t\ticon={<IconHeart />}\n\t\t\t\t\tlabel={t('dialogs.appDonation.donate')}\n\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t/>\n\t\t\t\t<IconButton\n\t\t\t\t\ticon={<IconX />}\n\t\t\t\t\tlabel={t('dialogs.appDonation.noThanks')}\n\t\t\t\t\tonClick={props.onClose}\n\t\t\t\t/>\n\t\t\t</ButtonBar>\n\t\t</DialogCard>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {DialogCard} from '../components/container/dialog-card';\nimport {CardContent} from '../components/container/card';\nimport {DialogComponentProps} from './dialogs.types';\nimport {\n\tsetTagColor,\n\tstoryWithId,\n\trenamePassageTag,\n\tstoryPassageTags\n} from '../store/stories';\nimport {useUndoableStoriesContext} from '../store/undoable-stories';\nimport {Color} from '../util/color';\nimport {TagEditor} from '../components/tag/tag-editor';\n\nexport interface PassageTagsDialogProps extends DialogComponentProps {\n\tstoryId: string;\n}\n\nexport const PassageTagsDialog: React.FC<PassageTagsDialogProps> = props => {\n\tconst {storyId, ...other} = props;\n\tconst {dispatch, stories} = useUndoableStoriesContext();\n\tconst {t} = useTranslation();\n\n\tconst story = storyWithId(stories, storyId);\n\tconst tags = storyPassageTags(story);\n\n\tfunction handleChangeColor(tagName: string, color: Color) {\n\t\tdispatch(\n\t\t\tsetTagColor(story, tagName, color),\n\t\t\tt('undoChange.changeTagColor')\n\t\t);\n\t}\n\n\tfunction handleChangeTagName(tagName: string, newName: string) {\n\t\tdispatch(\n\t\t\trenamePassageTag(story, tagName, newName),\n\t\t\tt('undoChange.renameTag')\n\t\t);\n\t}\n\n\treturn (\n\t\t<DialogCard\n\t\t\tclassName=\"passage-tags-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={t('dialogs.passageTags.title')}\n\t\t\t{...other}\n\t\t>\n\t\t\t<CardContent>\n\t\t\t\t{tags.length > 0 ? (\n\t\t\t\t\ttags.map(tag => (\n\t\t\t\t\t\t<TagEditor\n\t\t\t\t\t\t\tallTags={tags}\n\t\t\t\t\t\t\tcolor={story.tagColors[tag]}\n\t\t\t\t\t\t\tkey={tag}\n\t\t\t\t\t\t\tname={tag}\n\t\t\t\t\t\t\tonChangeColor={color => handleChangeColor(tag, color)}\n\t\t\t\t\t\t\tonChangeName={newName => handleChangeTagName(tag, newName)}\n\t\t\t\t\t\t/>\n\t\t\t\t\t))\n\t\t\t\t) : (\n\t\t\t\t\t<p>{t('dialogs.passageTags.noTags')}</p>\n\t\t\t\t)}\n\t\t\t</CardContent>\n\t\t</DialogCard>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IndentButtons, UndoRedoButtons} from '../components/codemirror';\nimport {ButtonBar} from '../components/container/button-bar';\nimport {DialogCard, DialogEditor} from '../components/container/dialog-card';\nimport {CodeArea} from '../components/control/code-area';\nimport {usePrefsContext} from '../store/prefs';\nimport {storyWithId, updateStory, useStoriesContext} from '../store/stories';\nimport {codeMirrorOptionsFromPrefs} from '../util/codemirror-options';\nimport {DialogComponentProps} from './dialogs.types';\nimport './story-javascript.css';\n\nexport interface StoryJavaScriptDialogProps extends DialogComponentProps {\n\tstoryId: string;\n}\n\nexport const StoryJavaScriptDialog: React.FC<StoryJavaScriptDialogProps> = props => {\n\tconst {storyId, ...other} = props;\n\tconst [cmEditor, setCmEditor] = React.useState<CodeMirror.Editor>();\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst {prefs} = usePrefsContext();\n\tconst story = storyWithId(stories, storyId);\n\tconst {t} = useTranslation();\n\n\tconst handleChange = (\n\t\teditor: CodeMirror.Editor,\n\t\tdata: CodeMirror.EditorChange,\n\t\ttext: string\n\t) => {\n\t\tsetCmEditor(editor);\n\t\tdispatch(updateStory(stories, story, {script: text}));\n\t};\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...other}\n\t\t\tclassName=\"story-javascript-dialog\"\n\t\t\theaderLabel={t('dialogs.storyJavaScript.title')}\n\t\t>\n\t\t\t<ButtonBar>\n\t\t\t\t<UndoRedoButtons editor={cmEditor} watch={story.script} />\n\t\t\t\t<IndentButtons editor={cmEditor} />\n\t\t\t</ButtonBar>\n\t\t\t<DialogEditor>\n\t\t\t\t<CodeArea\n\t\t\t\t\teditorDidMount={setCmEditor}\n\t\t\t\t\tfontFamily={prefs.codeEditorFontFamily}\n\t\t\t\t\tfontScale={prefs.codeEditorFontScale}\n\t\t\t\t\tlabel={t('dialogs.storyJavaScript.editorLabel')}\n\t\t\t\t\tlabelHidden\n\t\t\t\t\tonBeforeChange={handleChange}\n\t\t\t\t\toptions={{\n\t\t\t\t\t\t...codeMirrorOptionsFromPrefs(prefs),\n\t\t\t\t\t\tautofocus: true,\n\t\t\t\t\t\tlineWrapping: true,\n\t\t\t\t\t\tmode: 'javascript',\n\t\t\t\t\t\tplaceholder: t('dialogs.storyJavaScript.explanation')\n\t\t\t\t\t}}\n\t\t\t\t\tvalue={story.script}\n\t\t\t\t/>\n\t\t\t</DialogEditor>\n\t\t</DialogCard>\n\t);\n};\n","import {debounce} from 'lodash';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconReplace} from '@tabler/icons';\nimport {DialogCard} from '../components/container/dialog-card';\nimport {CheckboxButton} from '../components/control/checkbox-button';\nimport {CodeArea} from '../components/control/code-area';\nimport {IconButton} from '../components/control/icon-button';\nimport {\n\thighlightPassagesMatchingSearch,\n\tpassagesMatchingSearch,\n\treplaceInStory,\n\tstoryWithId,\n\tStorySearchFlags\n} from '../store/stories';\nimport {useUndoableStoriesContext} from '../store/undoable-stories';\nimport {DialogComponentProps} from './dialogs.types';\nimport './story-search.css';\n\n// See https://github.com/codemirror/CodeMirror/issues/5444\n\nconst ignoreTab: any = {\n\tTab: false,\n\t'Shift-Tab': false\n};\n\nexport interface StorySearchDialogProps extends DialogComponentProps {\n\tstoryId: string;\n}\n\nexport const StorySearchDialog: React.FC<StorySearchDialogProps> = props => {\n\tconst {storyId, ...other} = props;\n\tconst [flags, setFlags] = React.useState<StorySearchFlags>({\n\t\tincludePassageNames: true,\n\t\tmatchCase: false,\n\t\tuseRegexes: false\n\t});\n\tconst [replace, setReplace] = React.useState('');\n\tconst [find, setFind] = React.useState('');\n\tconst {dispatch, stories} = useUndoableStoriesContext();\n\tconst debouncedDispatch = React.useMemo(\n\t\t() => debounce(dispatch, 250),\n\t\t[dispatch]\n\t);\n\tconst {t} = useTranslation();\n\n\tconst story = storyWithId(stories, storyId);\n\tconst matches = passagesMatchingSearch(story.passages, find, flags);\n\n\tReact.useEffect(() => {\n\t\tdebouncedDispatch(highlightPassagesMatchingSearch(story, find, flags));\n\n\t\treturn () =>\n\t\t\tdebouncedDispatch(highlightPassagesMatchingSearch(story, '', {}));\n\t}, [debouncedDispatch, find, flags, story]);\n\n\tfunction handleReplaceWithChange(\n\t\teditor: CodeMirror.Editor,\n\t\tdata: CodeMirror.EditorChange,\n\t\ttext: string\n\t) {\n\t\tsetReplace(text);\n\t}\n\n\tfunction handleSearchForChange(\n\t\teditor: CodeMirror.Editor,\n\t\tdata: CodeMirror.EditorChange,\n\t\ttext: string\n\t) {\n\t\tsetFind(text);\n\t}\n\n\tfunction handleReplace() {\n\t\tdispatch(\n\t\t\treplaceInStory(story, find, replace, flags),\n\t\t\t'undoChange.replaceAllText'\n\t\t);\n\t}\n\n\tfunction toggleFlag(name: keyof StorySearchFlags) {\n\t\tsetFlags(flags => ({...flags, [name]: !flags[name]}));\n\t}\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...other}\n\t\t\tclassName=\"story-search-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={t('dialogs.storySearch.title')}\n\t\t>\n\t\t\t<div className=\"search-fields\">\n\t\t\t\t<CodeArea\n\t\t\t\t\tlabel={t('dialogs.storySearch.find')}\n\t\t\t\t\tonBeforeChange={handleSearchForChange}\n\t\t\t\t\toptions={{\n\t\t\t\t\t\textraKeys: ignoreTab,\n\t\t\t\t\t\tmode: 'text'\n\t\t\t\t\t}}\n\t\t\t\t\tvalue={find}\n\t\t\t\t/>\n\t\t\t\t<CodeArea\n\t\t\t\t\tlabel={t('dialogs.storySearch.replaceWith')}\n\t\t\t\t\tonBeforeChange={handleReplaceWithChange}\n\t\t\t\t\toptions={{extraKeys: ignoreTab, mode: 'text'}}\n\t\t\t\t\tvalue={replace}\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<div className=\"search-flags\">\n\t\t\t\t<CheckboxButton\n\t\t\t\t\tlabel={t('dialogs.storySearch.includePassageNames')}\n\t\t\t\t\tonChange={() => toggleFlag('includePassageNames')}\n\t\t\t\t\tvalue={flags.includePassageNames ?? false}\n\t\t\t\t/>\n\t\t\t\t<CheckboxButton\n\t\t\t\t\tlabel={t('dialogs.storySearch.matchCase')}\n\t\t\t\t\tonChange={() => toggleFlag('matchCase')}\n\t\t\t\t\tvalue={flags.matchCase ?? false}\n\t\t\t\t/>\n\t\t\t\t<CheckboxButton\n\t\t\t\t\tlabel={t('dialogs.storySearch.useRegexes')}\n\t\t\t\t\tonChange={() => toggleFlag('useRegexes')}\n\t\t\t\t\tvalue={flags.useRegexes ?? false}\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<div className=\"search-results\">\n\t\t\t\t<IconButton\n\t\t\t\t\tdisabled={matches.length === 0}\n\t\t\t\t\ticon={<IconReplace />}\n\t\t\t\t\tlabel={t('dialogs.storySearch.replaceAll')}\n\t\t\t\t\tonClick={handleReplace}\n\t\t\t\t\tvariant=\"danger\"\n\t\t\t\t/>\n\t\t\t\t<span>\n\t\t\t\t\t{find &&\n\t\t\t\t\t\t(matches.length > 0\n\t\t\t\t\t\t\t? t('dialogs.storySearch.matchCount', {count: matches.length})\n\t\t\t\t\t\t\t: t('dialogs.storySearch.noMatches'))}\n\t\t\t\t</span>\n\t\t\t</div>\n\t\t</DialogCard>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IndentButtons, UndoRedoButtons} from '../components/codemirror';\nimport {ButtonBar} from '../components/container/button-bar';\nimport {DialogCard, DialogEditor} from '../components/container/dialog-card';\nimport {CodeArea} from '../components/control/code-area';\nimport {usePrefsContext} from '../store/prefs';\nimport {storyWithId, updateStory, useStoriesContext} from '../store/stories';\nimport {codeMirrorOptionsFromPrefs} from '../util/codemirror-options';\nimport {DialogComponentProps} from './dialogs.types';\nimport './story-stylesheet.css';\n\nexport interface StoryStylesheetDialogProps extends DialogComponentProps {\n\tstoryId: string;\n}\n\nexport const StoryStylesheetDialog: React.FC<StoryStylesheetDialogProps> = props => {\n\tconst {storyId, ...other} = props;\n\tconst [cmEditor, setCmEditor] = React.useState<CodeMirror.Editor>();\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst {prefs} = usePrefsContext();\n\tconst story = storyWithId(stories, storyId);\n\tconst {t} = useTranslation();\n\n\tconst handleChange = (\n\t\teditor: CodeMirror.Editor,\n\t\tdata: CodeMirror.EditorChange,\n\t\ttext: string\n\t) => {\n\t\tsetCmEditor(editor);\n\t\tdispatch(updateStory(stories, story, {stylesheet: text}));\n\t};\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...other}\n\t\t\tclassName=\"story-stylesheet-dialog\"\n\t\t\theaderLabel={t('dialogs.storyStylesheet.title')}\n\t\t>\n\t\t\t<ButtonBar>\n\t\t\t\t<UndoRedoButtons editor={cmEditor} watch={story.script} />\n\t\t\t\t<IndentButtons editor={cmEditor} />\n\t\t\t</ButtonBar>\n\t\t\t<DialogEditor>\n\t\t\t\t<CodeArea\n\t\t\t\t\teditorDidMount={setCmEditor}\n\t\t\t\t\tfontFamily={prefs.codeEditorFontFamily}\n\t\t\t\t\tfontScale={prefs.codeEditorFontScale}\n\t\t\t\t\tlabel={t('dialogs.storyStylesheet.editorLabel')}\n\t\t\t\t\tlabelHidden\n\t\t\t\t\tonBeforeChange={handleChange}\n\t\t\t\t\toptions={{\n\t\t\t\t\t\t...codeMirrorOptionsFromPrefs(prefs),\n\t\t\t\t\t\tautofocus: true,\n\t\t\t\t\t\tlineWrapping: true,\n\t\t\t\t\t\tmode: 'css',\n\t\t\t\t\t\tplaceholder: t('dialogs.storyStylesheet.explanation')\n\t\t\t\t\t}}\n\t\t\t\t\tvalue={story.stylesheet}\n\t\t\t\t/>\n\t\t\t</DialogEditor>\n\t\t</DialogCard>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {DialogCard} from '../components/container/dialog-card';\nimport {CardContent} from '../components/container/card';\nimport {DialogComponentProps} from './dialogs.types';\nimport {renameStoryTag, storyTags} from '../store/stories';\nimport {setPref, usePrefsContext} from '../store/prefs';\nimport {useUndoableStoriesContext} from '../store/undoable-stories';\nimport {Color} from '../util/color';\nimport {TagEditor} from '../components/tag/tag-editor';\n\nexport type StoryTagsDialogProps = DialogComponentProps;\n\nexport const StoryTagsDialog: React.FC<StoryTagsDialogProps> = props => {\n\tconst {dispatch: storiesDispatch, stories} = useUndoableStoriesContext();\n\tconst {dispatch: prefsDispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tconst tags = storyTags(stories);\n\n\tfunction handleChangeColor(tagName: string, color: Color) {\n\t\tprefsDispatch(\n\t\t\tsetPref('storyTagColors', {...prefs.storyTagColors, [tagName]: color})\n\t\t);\n\t}\n\n\tfunction handleChangeTagName(tagName: string, newName: string) {\n\t\tstoriesDispatch(renameStoryTag(stories, tagName, newName));\n\t}\n\n\treturn (\n\t\t<DialogCard\n\t\t\tclassName=\"story-tags-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={t('dialogs.storyTags.title')}\n\t\t\t{...props}\n\t\t>\n\t\t\t<CardContent>\n\t\t\t\t{tags.length > 0 ? (\n\t\t\t\t\ttags.map(tag => (\n\t\t\t\t\t\t<TagEditor\n\t\t\t\t\t\t\tallTags={tags}\n\t\t\t\t\t\t\tcolor={prefs.storyTagColors[tag]}\n\t\t\t\t\t\t\tkey={tag}\n\t\t\t\t\t\t\tname={tag}\n\t\t\t\t\t\t\tonChangeColor={color => handleChangeColor(tag, color)}\n\t\t\t\t\t\t\tonChangeName={newName => handleChangeTagName(tag, newName)}\n\t\t\t\t\t\t/>\n\t\t\t\t\t))\n\t\t\t\t) : (\n\t\t\t\t\t<p>{t('dialogs.storyTags.noTags')}</p>\n\t\t\t\t)}\n\t\t\t</CardContent>\n\t\t</DialogCard>\n\t);\n};\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {\n\tCreatePassagesAction,\n\tPassage,\n\tStoriesState,\n\tStory\n} from '../stories.types';\nimport {passageDefaults} from '../defaults';\nimport {rectsIntersect} from '../../../util/geometry';\nimport {parseLinks} from '../../../util/parse-links';\n\n/**\n * Creates newly linked passages from a passage. You shouldn't need to call this\n * directly--it will be invoked automatically by updatePassage() if you change\n * the passage text.\n */\nexport function createNewlyLinkedPassages(\n\tstory: Story,\n\tpassage: Passage,\n\tnewText: string,\n\toldText: string\n): Thunk<StoriesState, CreatePassagesAction> {\n\tif (!story.passages.some(p => p.id === passage.id)) {\n\t\tthrow new Error('This passage does not belong to this story.');\n\t}\n\n\treturn dispatch => {\n\t\tconst oldLinks = parseLinks(oldText);\n\t\tconst toCreate = parseLinks(newText).filter(\n\t\t\tl => !oldLinks.includes(l) && !story.passages.some(p => p.name === l)\n\t\t);\n\n\t\tif (toCreate.length === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst passageDefs = passageDefaults();\n\t\tconst passageGap = 25;\n\n\t\tlet top = passage.top + passage.height + passageGap;\n\t\tconst newPassagesWidth =\n\t\t\ttoCreate.length * passageDefs.width + (toCreate.length - 1) * passageGap;\n\n\t\t// Horizontally center the passages.\n\n\t\tlet left = passage.left + (passage.width - newPassagesWidth) / 2;\n\n\t\t// Move them to avoid overlaps.\n\n\t\tconst needsMoving = () =>\n\t\t\tstory.passages.some(passage =>\n\t\t\t\trectsIntersect(passage, {\n\t\t\t\t\tleft,\n\t\t\t\t\ttop,\n\t\t\t\t\theight: passageDefs.height,\n\t\t\t\t\twidth: newPassagesWidth\n\t\t\t\t})\n\t\t\t);\n\n\t\twhile (needsMoving()) {\n\t\t\t// Try rightward.\n\n\t\t\tleft += passageDefs.width + passageGap;\n\n\t\t\tif (!needsMoving()) {\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t// Try leftward.\n\n\t\t\tleft -= 2 * (passageDefs.width + passageGap);\n\n\t\t\tif (!needsMoving()) {\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t// Move downward and try again.\n\n\t\t\tleft += passageDefs.width + passageGap;\n\t\t\ttop += passageDefs.height + passageGap;\n\t\t}\n\n\t\t// Actually create them.\n\n\t\tdispatch({\n\t\t\ttype: 'createPassages',\n\t\t\tstoryId: story.id,\n\t\t\tprops: toCreate.map(name => {\n\t\t\t\tconst result = {left, name, top};\n\n\t\t\t\tleft += passageDefs.width + passageGap;\n\t\t\t\treturn result;\n\t\t\t})\n\t\t});\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport uuid from 'tiny-uuid';\nimport {PrefsState} from '../../prefs';\nimport {StoriesAction, StoriesState, Story} from '../stories.types';\n\n/**\n * Creates a new story with the default story format.\n */\nexport function createStory(\n\tstories: Story[],\n\tprefs: PrefsState,\n\tprops: Partial<Omit<Story, 'id'>> & Pick<Story, 'name'>\n): Thunk<StoriesState, StoriesAction> {\n\tconst id = uuid();\n\n\tif (props.name.trim() === '') {\n\t\tthrow new Error('Story name cannot be empty');\n\t}\n\n\tif (\n\t\tstories.some(story => story.name.toLowerCase() === props.name.toLowerCase())\n\t) {\n\t\tthrow new Error(`There is already a story named \"${props.name}\"`);\n\t}\n\n\treturn dispatch => {\n\t\tdispatch({\n\t\t\ttype: 'createStory',\n\t\t\tprops: {\n\t\t\t\tid,\n\t\t\t\tstoryFormat: prefs.storyFormat.name,\n\t\t\t\tstoryFormatVersion: prefs.storyFormat.version,\n\t\t\t\t...props\n\t\t\t}\n\t\t});\n\n\t\treturn id;\n\t};\n}\n","import {passageDefaults} from '../defaults';\nimport {CreatePassageAction, Story} from '../stories.types';\nimport {rectsIntersect} from '../../../util/geometry';\nimport {unusedName} from '../../../util/unused-name';\n\n/**\n * Creates a new, untitled passage centered at a point in the story. This\n * automatically increments a number at the end of the passage name to ensure\n * it's unique.\n */\nexport function createUntitledPassage(\n\tstory: Story,\n\tcenterX: number,\n\tcenterY: number\n): CreatePassageAction {\n\tif (!Number.isFinite(centerX) || !Number.isFinite(centerY)) {\n\t\tthrow new Error('Center must be a finite coordinate pair');\n\t}\n\n\tconst defs = passageDefaults();\n\tconst passageName = unusedName(\n\t\tdefs.name,\n\t\tstory.passages.map(passage => passage.name)\n\t);\n\n\t// Center it at the position requested, but move it outward until no overlaps are found.\n\n\tconst passageGap = 25;\n\tconst bounds = {\n\t\theight: defs.height,\n\t\tleft: Math.max(centerX - defs.width / 2, 0),\n\t\ttop: Math.max(centerY - defs.height / 2, 0),\n\t\twidth: defs.width\n\t};\n\n\tif (story.snapToGrid) {\n\t\tbounds.left = Math.round(bounds.left / passageGap) * passageGap;\n\t\tbounds.top = Math.round(bounds.top / passageGap) * passageGap;\n\t}\n\n\tconst needsMoving = () =>\n\t\tstory.passages.some(passage => rectsIntersect(passage, bounds));\n\n\twhile (needsMoving()) {\n\t\t// Try rightward.\n\n\t\tbounds.left += bounds.width + passageGap;\n\n\t\tif (!needsMoving()) {\n\t\t\tbreak;\n\t\t}\n\n\t\t// Try downward.\n\n\t\tbounds.left -= bounds.width + passageGap;\n\t\tbounds.top += bounds.height + passageGap;\n\n\t\tif (!needsMoving()) {\n\t\t\tbreak;\n\t\t}\n\n\t\t// Try leftward.\n\n\t\tif (bounds.left >= bounds.width + passageGap) {\n\t\t\tbounds.left -= bounds.width + passageGap;\n\n\t\t\tif (!needsMoving()) {\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tbounds.left += bounds.width + passageGap;\n\t\t}\n\n\t\t// Move downward permanently and repeat.\n\n\t\tbounds.top += bounds.height + passageGap;\n\t}\n\n\treturn {\n\t\ttype: 'createPassage',\n\t\tstoryId: story.id,\n\t\tprops: {\n\t\t\t...bounds,\n\t\t\tstory: story.id,\n\t\t\tname: passageName\n\t\t}\n\t};\n}\n","import {\n\tPassage,\n\tStory,\n\tDeletePassageAction,\n\tDeletePassagesAction\n} from '../stories.types';\n\n/**\n * Deletes a passage.\n */\nexport function deletePassage(\n\tstory: Story,\n\tpassage: Passage\n): DeletePassageAction {\n\tif (!story.passages.some(p => p.id === passage.id)) {\n\t\tthrow new Error('This passage does not belong to this story.');\n\t}\n\n\treturn {type: 'deletePassage', storyId: story.id, passageId: passage.id};\n}\n\n/**\n * Deletes multiple passages.\n */\nexport function deletePassages(\n\tstory: Story,\n\tpassages: Passage[]\n): DeletePassagesAction {\n\treturn {\n\t\ttype: 'deletePassages',\n\t\tstoryId: story.id,\n\t\tpassageIds: passages.map(passage => passage.id)\n\t};\n}\n","import {StoriesAction, Story} from '../stories.types';\n\nexport function deleteStory(story: Story): StoriesAction {\n\treturn {type: 'deleteStory', storyId: story.id};\n}\n","import uuid from 'tiny-uuid';\nimport {CreateStoryAction, Story} from '../stories.types';\nimport {unusedName} from '../../../util/unused-name';\n\n/**\n * Creates a duplicate of an existing story.\n */\nexport function duplicateStory(\n\tstory: Story,\n\tstories: Story[]\n): CreateStoryAction {\n\treturn {\n\t\ttype: 'createStory',\n\t\tprops: {\n\t\t\t...story,\n\t\t\tid: uuid(),\n\t\t\tifid: uuid(),\n\t\t\tname: unusedName(\n\t\t\t\tstory.name,\n\t\t\t\tstories.map(story => story.name)\n\t\t\t)\n\t\t}\n\t};\n}\n","import escapeRegExp from 'lodash/escapeRegExp';\nimport {Thunk} from 'react-hook-thunk-reducer';\nimport {Passage, StoriesAction, StoriesState, Story} from '../stories.types';\nimport {createNewlyLinkedPassages} from './create-newly-linked-passages';\n\nexport interface UpdatePassageOptions {\n\tdontCreateNewlyLinkedPassages?: boolean;\n}\n\n/**\n * General update of a passage.\n */\nexport function updatePassage(\n\tstory: Story,\n\tpassage: Passage,\n\tprops: Partial<Passage>,\n\toptions: UpdatePassageOptions = {}\n): Thunk<StoriesState, StoriesAction> {\n\tif (!story.passages.some(p => p.id === passage.id)) {\n\t\tthrow new Error('This passage does not belong to this story.');\n\t}\n\n\tif (\n\t\t'name' in props &&\n\t\tstory.passages\n\t\t\t.filter(p => p.name === props.name)\n\t\t\t.some(p => p.id !== passage.id)\n\t) {\n\t\tthrow new Error(`There is already a passage named \"${props.name}\".`);\n\t}\n\n\treturn (dispatch, getState) => {\n\t\t// Do the passage update itself.\n\n\t\tconst oldName = passage.name;\n\t\tconst oldText = passage.text;\n\n\t\tdispatch({\n\t\t\tprops,\n\t\t\ttype: 'updatePassage',\n\t\t\tpassageId: passage.id,\n\t\t\tstoryId: story.id\n\t\t});\n\n\t\t// Side effects from changes.\n\n\t\tif (!options.dontCreateNewlyLinkedPassages && props.text) {\n\t\t\tdispatch(createNewlyLinkedPassages(story, passage, props.text, oldText));\n\t\t}\n\n\t\tif (props.name) {\n\t\t\tconst oldNameEscaped = escapeRegExp(oldName);\n\n\t\t\t// We only need to escape $ stuff in the new name, because it will be the\n\t\t\t// second argument to replace(). This is a little mindbending, but the\n\t\t\t// purpose of this is to replace $ with $$.\n\n\t\t\tconst newNameEscaped = props.name.replace(/\\$/g, '$$$$');\n\n\t\t\tconst simpleLinkRegexp = new RegExp(\n\t\t\t\t'\\\\[\\\\[' + oldNameEscaped + '(\\\\]\\\\[.*?)?\\\\]\\\\]',\n\t\t\t\t'g'\n\t\t\t);\n\t\t\tconst compoundLinkRegexp = new RegExp(\n\t\t\t\t'\\\\[\\\\[(.*?)(\\\\||->)' + oldNameEscaped + '(\\\\]\\\\[.*?)?\\\\]\\\\]',\n\t\t\t\t'g'\n\t\t\t);\n\t\t\tconst reverseLinkRegexp = new RegExp(\n\t\t\t\t'\\\\[\\\\[' + oldNameEscaped + '(<-.*?)(\\\\]\\\\[.*?)?\\\\]\\\\]',\n\t\t\t\t'g'\n\t\t\t);\n\n\t\t\tstory.passages.forEach(relinkedPassage => {\n\t\t\t\tif (\n\t\t\t\t\tsimpleLinkRegexp.test(relinkedPassage.text) ||\n\t\t\t\t\tcompoundLinkRegexp.test(relinkedPassage.text) ||\n\t\t\t\t\treverseLinkRegexp.test(relinkedPassage.text)\n\t\t\t\t) {\n\t\t\t\t\tlet newText = relinkedPassage.text;\n\n\t\t\t\t\tnewText = newText.replace(\n\t\t\t\t\t\tsimpleLinkRegexp,\n\t\t\t\t\t\t'[[' + newNameEscaped + '$1]]'\n\t\t\t\t\t);\n\t\t\t\t\tnewText = newText.replace(\n\t\t\t\t\t\tcompoundLinkRegexp,\n\t\t\t\t\t\t'[[$1$2' + newNameEscaped + '$3]]'\n\t\t\t\t\t);\n\t\t\t\t\tnewText = newText.replace(\n\t\t\t\t\t\treverseLinkRegexp,\n\t\t\t\t\t\t'[[' + newNameEscaped + '$1$2]]'\n\t\t\t\t\t);\n\n\t\t\t\t\tupdatePassage(\n\t\t\t\t\t\tstory,\n\t\t\t\t\t\trelinkedPassage,\n\t\t\t\t\t\t{text: newText},\n\t\t\t\t\t\toptions\n\t\t\t\t\t)(dispatch, getState);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {createRegExp, escapeRegExpReplace} from '../../../util/regexp';\nimport {updatePassage} from './update-passage';\nimport {\n\tPassage,\n\tStoriesAction,\n\tStoriesState,\n\tStory,\n\tStorySearchFlags\n} from '../stories.types';\n\n/**\n * Core logic for replacing text using flags.\n */\nfunction replaceText(source: string, searchFor: string, replaceWith: string, flags: StorySearchFlags) {\n\tconst {matchCase, useRegexes} = flags;\n\tconst matcher = createRegExp(searchFor, {matchCase, useRegexes});\n\tconst replacer = useRegexes\n\t? replaceWith\n\t: escapeRegExpReplace(replaceWith);\n\n\treturn source.replace(matcher, replacer);\n}\n\nexport function replaceInPassage(\n\tstory: Story,\n\tpassage: Passage,\n\tsearchFor: string,\n\treplaceWith: string,\n\tflags: StorySearchFlags\n): Thunk<StoriesState, StoriesAction> {\n\treturn (dispatch, getState) => {\n\t\tif (searchFor === '') {\n\t\t\tthrow new Error(\"Can't replace an empty string\");\n\t\t}\n\n\t\tif (passage.story !== story.id) {\n\t\t\tthrow new Error('Passage does not belong to story');\n\t\t}\n\n\t\tconst {includePassageNames} = flags;\n\t\tconst props: Partial<Passage> = {};\n\n\t\tconst newText = replaceText(passage.text, searchFor, replaceWith, flags);\n\n\t\tif (newText !== passage.text) {\n\t\t\tprops.text = newText;\n\t\t}\n\n\t\tif (includePassageNames) {\n\t\t\tconst newName = replaceText(passage.name, searchFor, replaceWith, flags);\n\n\t\t\tif (newName !== passage.name) {\n\t\t\t\tprops.name = newName;\n\t\t\t}\n\t\t}\n\n\t\tif (Object.keys(props).length > 0) {\n\t\t\tupdatePassage(story, passage, props)(dispatch, getState);\n\t\t}\n\t};\n}\n\nexport function replaceInStory(\n\tstory: Story,\n\tsearchFor: string,\n\treplaceWith: string,\n\tflags: StorySearchFlags\n): Thunk<StoriesState, StoriesAction> {\n\treturn (dispatch, getState) => {\n\t\tif (searchFor === '') {\n\t\t\tthrow new Error(\"Can't replace an empty string\");\n\t\t}\n\n\t\tif (flags.includePassageNames) {\n\t\t\t// Do replaces in passage names first, so that if a replace will change\n\t\t\t// both a link and a passage name, the updatePassage action will see that\n\t\t\t// the passage exists when the link is changed, and not create a new\n\t\t\t// passage that will conflict with the existing one.\n\t\t\t\n\t\t\tfor (const passage of story.passages) {\n\t\t\t\tconst name = replaceText(passage.name, searchFor, replaceWith, flags);\n\n\t\t\t\tif (name !== passage.name) {\n\t\t\t\t\tupdatePassage(story, passage, {name})(dispatch, getState);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfor (const passage of story.passages) {\n\t\t\t\tconst text = replaceText(passage.text, searchFor, replaceWith, flags);\n\n\t\t\t\tif (text !== passage.text) {\n\t\t\t\t\tupdatePassage(story, passage, {text})(dispatch, getState);\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\t// We're only updating passage text, so we can do it the easy way.\n\n\t\t\tfor (const passage of story.passages) {\n\t\t\t\treplaceInPassage(\n\t\t\t\t\tstory,\n\t\t\t\t\tpassage,\n\t\t\t\t\tsearchFor,\n\t\t\t\t\treplaceWith,\n\t\t\t\t\tflags\n\t\t\t\t)(dispatch, getState);\n\t\t\t}\n\t\t}\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {\n\tPassage,\n\tStoriesState,\n\tStory,\n\tStorySearchFlags,\n\tUpdatePassagesAction\n} from '../stories.types';\nimport {passagesMatchingSearch} from '../getters';\n\nexport function highlightPassagesMatchingSearch(\n\tstory: Story,\n\tsearch: string,\n\tflags: StorySearchFlags\n): Thunk<StoriesState, UpdatePassagesAction> {\n\treturn dispatch => {\n\t\tlet passageUpdates: Record<string, Partial<Passage>> = {};\n\n\t\tif (search === '') {\n\t\t\t// Remove all highlights.\n\t\t\tpassageUpdates = story.passages.reduce((result, passage) => {\n\t\t\t\tif (passage.highlighted) {\n\t\t\t\t\treturn {...result, [passage.id]: {highlighted: false}};\n\t\t\t\t}\n\n\t\t\t\treturn result;\n\t\t\t}, {});\n\t\t} else {\n\t\t\tconst matchIds = passagesMatchingSearch(\n\t\t\t\tstory.passages,\n\t\t\t\tsearch,\n\t\t\t\tflags\n\t\t\t).map(passage => passage.id);\n\n\t\t\tstory.passages.forEach(passage => {\n\t\t\t\tconst oldHighlighted = passage.highlighted;\n\t\t\t\tconst newHighlighted = matchIds.includes(passage.id);\n\n\t\t\t\tif (newHighlighted !== oldHighlighted) {\n\t\t\t\t\tpassageUpdates[passage.id] = {highlighted: newHighlighted};\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\tif (Object.keys(passageUpdates).length > 0) {\n\t\t\tdispatch({\n\t\t\t\tpassageUpdates,\n\t\t\t\ttype: 'updatePassages',\n\t\t\t\tstoryId: story.id\n\t\t\t});\n\t\t}\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {\n\tCreateStoryAction,\n\tStoriesState,\n\tStory,\n\tUpdateStoryAction\n} from '../stories.types';\nimport {storyFileName} from '../../../electron/shared';\n\n/**\n * Imports stories, overwriting any stories with the same name.\n */\nexport function importStories(\n\ttoImport: Story[],\n\texistingStories: Story[]\n): Thunk<StoriesState, CreateStoryAction | UpdateStoryAction> {\n\ttoImport.forEach(importStory => {\n\t\tif (\n\t\t\ttoImport.some(\n\t\t\t\totherStory =>\n\t\t\t\t\totherStory !== importStory &&\n\t\t\t\t\tstoryFileName(otherStory) === storyFileName(importStory)\n\t\t\t)\n\t\t) {\n\t\t\tthrow new Error(\n\t\t\t\t`Stories to import cannot have the same name: \"${importStory.name}\"`\n\t\t\t);\n\t\t}\n\t});\n\n\treturn dispatch => {\n\t\ttoImport.forEach(importStory => {\n\t\t\t// Remove the temp ID that was assigned to the new story.\n\n\t\t\tconst props: Partial<Story> = {...importStory};\n\n\t\t\tdelete props.id;\n\n\t\t\tconst existingStory = existingStories.find(\n\t\t\t\ts => storyFileName(s) === storyFileName(importStory)\n\t\t\t);\n\n\t\t\t// Do an update so that if something goes awry, we won't have deleted the\n\t\t\t// story.\n\n\t\t\tif (existingStory) {\n\t\t\t\tdispatch({props, type: 'updateStory', storyId: existingStory.id});\n\t\t\t} else {\n\t\t\t\tdispatch({props, type: 'createStory'});\n\t\t\t}\n\t\t});\n\t};\n}\n","import {Passage, Story, UpdatePassagesAction} from '../stories.types';\n\n/**\n * Moves passages by an offset, e.g. after dragging.\n */\nexport function movePassages(\n\tstory: Story,\n\tpassageIds: string[],\n\txChange: number,\n\tyChange: number\n): UpdatePassagesAction {\n\tconst passageUpdates: Record<string, Partial<Passage>> = {};\n\n\tif (!Number.isFinite(xChange) || !Number.isFinite(yChange)) {\n\t\tthrow new Error('Offset must be a finite number.');\n\t}\n\n\tpassageIds.forEach(passageId => {\n\t\tconst passage = story.passages.find(p => p.id === passageId);\n\n\t\tif (!passage) {\n\t\t\tthrow new Error(\n\t\t\t\t`There is no passage in this story with ID \"${passageId}\".`\n\t\t\t);\n\t\t}\n\n\t\tlet left = Math.max(passage.left + xChange, 0);\n\t\tlet top = Math.max(passage.top + yChange, 0);\n\n\t\tif (story.snapToGrid) {\n\t\t\tleft = Math.round(left / 25) * 25;\n\t\t\ttop = Math.round(top / 25) * 25;\n\t\t}\n\n\t\tpassageUpdates[passage.id] = {left, top};\n\t});\n\n\treturn {type: 'updatePassages', passageUpdates, storyId: story.id};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {\n\tPassage,\n\tStoriesState,\n\tStory,\n\tUpdatePassagesAction,\n\tUpdateStoryAction\n} from '../stories.types';\nimport {isValidTagName} from '../../../util/tag';\n\nexport function renamePassageTag(\n\tstory: Story,\n\toldName: string,\n\tnewName: string\n): Thunk<StoriesState, UpdatePassagesAction | UpdateStoryAction> {\n\tif (!isValidTagName(newName)) {\n\t\tthrow new Error(`\"${newName}\" is not a valid tag name.`);\n\t}\n\n\treturn dispatch => {\n\t\t// Change tags in passages.\n\n\t\tconst passageUpdates: Record<string, Partial<Passage>> = {};\n\n\t\tstory.passages.forEach(passage => {\n\t\t\tif (passage.tags.includes(oldName)) {\n\t\t\t\tpassageUpdates[passage.id] = {\n\t\t\t\t\ttags: passage.tags.map(tag => (tag === oldName ? newName : tag))\n\t\t\t\t};\n\t\t\t}\n\t\t});\n\n\t\tif (Object.keys(passageUpdates).length > 0) {\n\t\t\tdispatch({type: 'updatePassages', passageUpdates, storyId: story.id});\n\n\t\t\t// Move the tag color to the new one.\n\n\t\t\tconst tagColors = {...story.tagColors};\n\n\t\t\tdelete tagColors[oldName];\n\t\t\ttagColors[newName] = story.tagColors[oldName];\n\t\t\tdispatch({\n\t\t\t\ttype: 'updateStory',\n\t\t\t\tprops: {tagColors},\n\t\t\t\tstoryId: story.id\n\t\t\t});\n\t\t}\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {StoriesAction, StoriesState, Story} from '../stories.types';\nimport {isValidTagName} from '../../../util/tag';\n\nexport function renameStoryTag(\n\tstories: Story[],\n\toldName: string,\n\tnewName: string\n): Thunk<StoriesState, StoriesAction> {\n\tif (!isValidTagName(newName)) {\n\t\tthrow new Error(`\"${newName}\" is not a valid tag name.`);\n\t}\n\n\treturn dispatch => {\n\t\tstories.forEach(story => {\n\t\t\tif (story.tags.includes(oldName)) {\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'updateStory',\n\t\t\t\t\tstoryId: story.id,\n\t\t\t\t\tprops: {\n\t\t\t\t\t\ttags: story.tags.map(tag => (tag === oldName ? newName : tag))\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {Rect, rectsIntersect} from '../../../util/geometry';\nimport {\n\tPassage,\n\tStoriesState,\n\tStory,\n\tUpdatePassageAction,\n\tUpdatePassagesAction\n} from '../stories.types';\n\n/**\n * Deselects all passages.\n */\nexport function deselectAllPassages(\n\tstory: Story\n): Thunk<StoriesState, UpdatePassagesAction> {\n\treturn dispatch => {\n\t\tconst passageUpdates: Record<string, Partial<Passage>> = {};\n\n\t\tstory.passages.forEach(passage => {\n\t\t\tif (passage.selected) {\n\t\t\t\tpassageUpdates[passage.id] = {selected: false};\n\t\t\t}\n\t\t});\n\n\t\tif (Object.keys(passageUpdates).length > 0) {\n\t\t\tdispatch({\n\t\t\t\tpassageUpdates,\n\t\t\t\ttype: 'updatePassages',\n\t\t\t\tstoryId: story.id\n\t\t\t});\n\t\t}\n\t};\n}\n\n/**\n * Deselects a single passage.\n */\nexport function deselectPassage(\n\tstory: Story,\n\tpassage: Passage\n): Thunk<StoriesState, UpdatePassageAction> {\n\tif (passage.story !== story.id) {\n\t\tthrow new Error('This passage does not belong to this story');\n\t}\n\n\treturn dispatch => {\n\t\tif (passage.selected) {\n\t\t\tdispatch({\n\t\t\t\ttype: 'updatePassage',\n\t\t\t\tpassageId: passage.id,\n\t\t\t\tprops: {selected: false},\n\t\t\t\tstoryId: story.id\n\t\t\t});\n\t\t}\n\t};\n}\n\n/**\n * Selects all passages.\n */\nexport function selectAllPassages(\n\tstory: Story\n): Thunk<StoriesState, UpdatePassagesAction> {\n\treturn dispatch => {\n\t\tconst passageUpdates: Record<string, Partial<Passage>> = {};\n\n\t\tstory.passages.forEach(passage => {\n\t\t\tif (!passage.selected) {\n\t\t\t\tpassageUpdates[passage.id] = {selected: true};\n\t\t\t}\n\t\t});\n\n\t\tif (Object.keys(passageUpdates).length > 0) {\n\t\t\tdispatch({\n\t\t\t\tpassageUpdates,\n\t\t\t\ttype: 'updatePassages',\n\t\t\t\tstoryId: story.id\n\t\t\t});\n\t\t}\n\t};\n}\n\n/**\n * Selects a single passage.\n */\nexport function selectPassage(\n\tstory: Story,\n\tpassage: Passage,\n\texclusive: boolean\n): Thunk<StoriesState, UpdatePassagesAction> {\n\tif (passage.story !== story.id) {\n\t\tthrow new Error('This passage does not belong to this story');\n\t}\n\n\treturn dispatch => {\n\t\tconst passageUpdates: Record<string, Partial<Passage>> = {};\n\n\t\tif (!passage.selected) {\n\t\t\tpassageUpdates[passage.id] = {selected: true};\n\t\t}\n\n\t\tif (exclusive) {\n\t\t\tstory.passages.forEach(p => {\n\t\t\t\tif (p.id !== passage.id && p.selected) {\n\t\t\t\t\tpassageUpdates[p.id] = {selected: false};\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tif (Object.keys(passageUpdates).length > 0) {\n\t\t\tdispatch({type: 'updatePassages', passageUpdates, storyId: story.id});\n\t\t}\n\t};\n}\n\nexport function selectPassagesInRect(\n\tstory: Story,\n\trect: Rect,\n\tignoreIds: string[] = []\n): Thunk<StoriesState, UpdatePassagesAction> {\n\treturn dispatch => {\n\t\tconst passageUpdates: Record<string, Partial<Passage>> = {};\n\n\t\tstory.passages.forEach(passage => {\n\t\t\tif (ignoreIds.find(r => r === passage.id)) {\n\t\t\t\t// We are ignoring this passage, e.g. this is an additive selection and it\n\t\t\t\t// was already selected.\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst selected = rectsIntersect(rect, passage);\n\n\t\t\tif (passage.selected !== selected) {\n\t\t\t\tpassageUpdates[passage.id] = {selected};\n\t\t\t}\n\t\t});\n\n\t\tif (Object.keys(passageUpdates).length > 0) {\n\t\t\tdispatch({type: 'updatePassages', passageUpdates, storyId: story.id});\n\t\t}\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {StoriesState, Story, UpdateStoryAction} from '../stories.types';\n\n/**\n * Deselects a single story.\n */\nexport function deselectStory(\n\tstory: Story\n): Thunk<StoriesState, UpdateStoryAction> {\n\treturn (dispatch, getState) => {\n\t\tif (!story.selected) {\n\t\t\tdispatch({\n\t\t\t\ttype: 'updateStory',\n\t\t\t\tstoryId: story.id,\n\t\t\t\tprops: {selected: false}\n\t\t\t});\n\t\t}\n\t};\n}\n\n/**\n * Deselects all stories.\n */\nexport function deselectAllStories(): Thunk<StoriesState, UpdateStoryAction> {\n\treturn (dispatch, getState) => {\n\t\tfor (const story of getState()) {\n\t\t\tif (story.selected) {\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'updateStory',\n\t\t\t\t\tstoryId: story.id,\n\t\t\t\t\tprops: {selected: false}\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t};\n}\n\n/**\n * Selects a single story.\n */\nexport function selectStory(\n\tstory: Story,\n\texclusive: boolean\n): Thunk<StoriesState, UpdateStoryAction> {\n\treturn (dispatch, getState) => {\n\t\tif (!story.selected) {\n\t\t\tdispatch({\n\t\t\t\ttype: 'updateStory',\n\t\t\t\tstoryId: story.id,\n\t\t\t\tprops: {selected: true}\n\t\t\t});\n\t\t}\n\n\t\tif (exclusive) {\n\t\t\tfor (const other of getState()) {\n\t\t\t\tif (other.id !== story.id && other.selected) {\n\t\t\t\t\tdispatch({\n\t\t\t\t\t\ttype: 'updateStory',\n\t\t\t\t\t\tstoryId: other.id,\n\t\t\t\t\t\tprops: {selected: false}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t};\n}\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {Color} from '../../../util/color';\nimport {isValidTagName} from '../../../util/tag';\nimport {StoriesState, Story, UpdateStoryAction} from '../stories.types';\n\nexport function setTagColor(\n\tstory: Story,\n\tname: string,\n\tcolor: Color\n): Thunk<StoriesState, UpdateStoryAction> {\n\tif (!isValidTagName(name)) {\n\t\tthrow new Error(`\"${name}\" is not a valid tag name.`);\n\t}\n\n\treturn dispatch => {\n\t\t// Special handling: if the color is set to none, just delete it.\n\n\t\tif (color === 'none') {\n\t\t\tif (name in story.tagColors) {\n\t\t\t\tconst tagColors = {...story.tagColors};\n\n\t\t\t\tdelete tagColors[name];\n\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'updateStory',\n\t\t\t\t\tprops: {tagColors},\n\t\t\t\t\tstoryId: story.id\n\t\t\t\t});\n\t\t\t}\n\t\t} else {\n\t\t\tdispatch({\n\t\t\t\ttype: 'updateStory',\n\t\t\t\tprops: {tagColors: {...story.tagColors, [name]: color}},\n\t\t\t\tstoryId: story.id\n\t\t\t});\n\t\t}\n\t};\n}\n","import {Passage, Story, UpdatePassageAction} from '../stories.types';\nimport {isValidTagName} from '../../../util/tag';\n\n/**\n * Adds a tag to a passage.\n */\nexport function addPassageTag(\n\tstory: Story,\n\tpassage: Passage,\n\ttagName: string\n): UpdatePassageAction {\n\tif (passage.story !== story.id) {\n\t\tthrow new Error('This passage does not belong to this story.');\n\t}\n\n\tif (!isValidTagName(tagName)) {\n\t\tthrow new Error(`\"${tagName}\" is not a valid tag name.`);\n\t}\n\n\tif (passage.tags.includes(tagName)) {\n\t\tthrow new Error(`This passage already has the tag \"${tagName}\".`);\n\t}\n\n\treturn {\n\t\ttype: 'updatePassage',\n\t\tpassageId: passage.id,\n\t\tstoryId: story.id,\n\t\tprops: {tags: [...passage.tags, tagName]}\n\t};\n}\n\n/**\n * Removes a tag from a passage.\n */\nexport function removePassageTag(\n\tstory: Story,\n\tpassage: Passage,\n\ttagName: string\n): UpdatePassageAction {\n\tif (passage.story !== story.id) {\n\t\tthrow new Error('This passage does not belong to this story.');\n\t}\n\n\tif (!isValidTagName(tagName)) {\n\t\tthrow new Error(`\"${tagName}\" is not a valid tag name.`);\n\t}\n\n\tif (!passage.tags.includes(tagName)) {\n\t\tthrow new Error(`This passage does not have the tag \"${tagName}\".`);\n\t}\n\n\treturn {\n\t\ttype: 'updatePassage',\n\t\tpassageId: passage.id,\n\t\tstoryId: story.id,\n\t\tprops: {tags: passage.tags.filter(t => t !== tagName)}\n\t};\n}\n","import {Story, UpdateStoryAction} from '../stories.types';\nimport {storyFileName} from '../../../electron/shared';\n\n/**\n * General update of a story.\n */\nexport function updateStory(\n\tstories: Story[],\n\tstory: Story,\n\tprops: Partial<Story>\n): UpdateStoryAction {\n\tif (\n\t\tprops.name &&\n\t\tstories\n\t\t\t.filter(s => storyFileName(s) === storyFileName({...s, ...props}))\n\t\t\t.some(s => s.id !== story.id)\n\t) {\n\t\tthrow new Error(`There is already a story named \"${props.name}\".`);\n\t}\n\n\treturn {\n\t\tprops,\n\t\tstoryId: story.id,\n\t\ttype: 'updateStory'\n\t};\n}\n","import uuid from 'tiny-uuid';\nimport {passageDefaults} from '../defaults';\nimport {Passage, Story, StoriesState} from '../stories.types';\n\nexport function createPassage(\n\tstate: StoriesState,\n\tstoryId: string,\n\tpassageProps: Partial<Passage>\n) {\n\tlet storyExists = false;\n\tlet created = false;\n\tconst newState = state.map(story => {\n\t\tif (story.id !== storyId) {\n\t\t\treturn story;\n\t\t}\n\n\t\tstoryExists = true;\n\n\t\tif (story.passages.some(passage => passage.id === passageProps.id)) {\n\t\t\tconsole.warn(\n\t\t\t\t`There is already a passage in this story with ID \"${passageProps.id}\", taking no action`\n\t\t\t);\n\t\t\treturn story;\n\t\t}\n\n\t\tif (\n\t\t\t'name' in passageProps &&\n\t\t\tstory.passages.some(passage => passage.name === passageProps.name)\n\t\t) {\n\t\t\tconsole.warn(\n\t\t\t\t`There is already a passage in this story with name \"${passageProps.name}\", taking no action`\n\t\t\t);\n\t\t\treturn story;\n\t\t}\n\n\t\tconst newPassage: Passage = {\n\t\t\t...passageDefaults(),\n\t\t\tid: uuid(),\n\t\t\t...passageProps,\n\t\t\tstory: story.id\n\t\t};\n\t\tconst newStory: Story = {\n\t\t\t...story,\n\t\t\tlastUpdate: new Date(),\n\t\t\tpassages: [...story.passages, newPassage]\n\t\t};\n\n\t\tif (newStory.passages.length === 1) {\n\t\t\tnewStory.startPassage = newPassage.id;\n\t\t}\n\n\t\tcreated = true;\n\t\treturn newStory;\n\t});\n\n\tif (!storyExists) {\n\t\tconsole.warn(`No story in state with ID \"${storyId}\", taking no action`);\n\t\treturn state;\n\t}\n\n\tif (!created) {\n\t\t// Should have warned above.\n\t\treturn state;\n\t}\n\n\treturn newState;\n}\n","import {StoriesState} from '../stories.types';\n\nexport function deletePassage(\n\tstate: StoriesState,\n\tstoryId: string,\n\tpassageId: string\n) {\n\tlet foundStory = false;\n\tlet deleted = false;\n\n\tconst newState = state.map(story => {\n\t\tif (story.id !== storyId) {\n\t\t\treturn story;\n\t\t}\n\n\t\tfoundStory = true;\n\n\t\tconst newStory = {\n\t\t\t...story,\n\t\t\tpassages: story.passages.filter(passage => {\n\t\t\t\tif (passage.id === passageId) {\n\t\t\t\t\tdeleted = true;\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\treturn true;\n\t\t\t})\n\t\t};\n\n\t\tif (deleted) {\n\t\t\tnewStory.lastUpdate = new Date();\n\t\t\treturn newStory;\n\t\t}\n\n\t\treturn story;\n\t});\n\n\tif (!foundStory) {\n\t\tconsole.warn(`No story in state with ID \"${storyId}\", taking no action`);\n\t\treturn state;\n\t}\n\n\tif (!deleted) {\n\t\tconsole.warn(\n\t\t\t`Asked to delete a passage with ID \"${passageId}\", but it does not exist in story ID ${storyId}, taking no action`\n\t\t);\n\t\treturn state;\n\t}\n\n\treturn newState;\n}\n","import uuid from 'tiny-uuid';\nimport {passageDefaults} from '../../defaults';\nimport {Passage, Story} from '../../stories.types';\n\nfunction logRepair(\n\tpassage: Passage,\n\tpropName: keyof Passage,\n\trepairedValue: any,\n\tdetail?: string\n) {\n\tlet message =\n\t\t`Repairing passage (name: \"${passage.name}\", id: ${passage.id}): ` +\n\t\t`setting ${propName} to ${repairedValue}, was ${passage[propName]}`;\n\n\tif (detail) {\n\t\tmessage += ` (${detail})`;\n\t}\n\n\tconsole.info(message);\n}\n\nexport function repairPassage(passage: Passage, parentStory: Story): Passage {\n\tconst passageDefs = passageDefaults();\n\tconst repairs: Partial<Passage> = {};\n\n\t// Give the passage an ID if it has none.\n\n\tif (typeof passage.id !== 'string' || passage.id === '') {\n\t\tconst newId = uuid();\n\n\t\tlogRepair(passage, 'id', newId, 'was undefined or empty string');\n\t\trepairs.id = uuid();\n\t}\n\n\t// Apply default properties to the passage.\n\n\tObject.entries(passageDefs).forEach(([key, value]) => {\n\t\tconst defKey = key as keyof typeof passageDefs;\n\n\t\tif (\n\t\t\t(typeof value === 'number' && !Number.isFinite(passage[defKey])) ||\n\t\t\ttypeof value !== typeof passage[defKey]\n\t\t) {\n\t\t\tlogRepair(passage, defKey, passageDefs[defKey]);\n\t\t\t(repairs[defKey] as Passage[typeof defKey]) = passageDefs[defKey];\n\t\t}\n\t});\n\n\t// Make passage coordinates 0 or greater.\n\n\t['left', 'top'].forEach(pos => {\n\t\tconst posKey = pos as keyof Passage;\n\n\t\tif (passage[posKey] < 0) {\n\t\t\tlogRepair(passage, posKey, 0, 'was negative');\n\t\t\t(repairs[posKey] as Passage[typeof posKey]) = 0;\n\t\t}\n\t});\n\n\t// Make passage dimensions 5 or greater.\n\n\t['height', 'width'].forEach(dim => {\n\t\tconst dimKey = dim as keyof Passage;\n\n\t\tif (passage[dimKey] < 5) {\n\t\t\tlogRepair(passage, dimKey, 0, 'was less than 5');\n\t\t\t(repairs[dimKey] as Passage[typeof dimKey]) = 5;\n\t\t}\n\t});\n\n\t// Repair story property if it doesn't point to the parent story.\n\n\tif (passage.story !== parentStory.id) {\n\t\tlogRepair(passage, 'story', parentStory.id, \"didn't match parent story\");\n\t\trepairs.story = parentStory.id;\n\t}\n\n\t// Repair ID conflicts with any other passage in the story.\n\n\tif (\n\t\tparentStory.passages.some(otherPassage => {\n\t\t\tif (otherPassage === passage) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn otherPassage.id === passage.id;\n\t\t})\n\t) {\n\t\tconst newId = uuid();\n\n\t\tlogRepair(\n\t\t\tpassage,\n\t\t\t'id',\n\t\t\tnewId,\n\t\t\t'conflicted with another passage in the story'\n\t\t);\n\t\trepairs.id = newId;\n\t}\n\n\tif (Object.keys(repairs).length > 0) {\n\t\treturn {...passage, ...repairs};\n\t}\n\n\treturn passage;\n}\n","import {satisfies} from 'semver';\nimport uuid from 'tiny-uuid';\nimport {Story} from '../../stories.types';\nimport {storyDefaults} from '../../defaults';\nimport {StoryFormat} from '../../../story-formats';\nimport {repairPassage} from './repair-passage';\n\nfunction logRepair(\n\tstory: Story,\n\tpropName: keyof Story,\n\trepairedValue: any,\n\tdetail?: string\n) {\n\tlet message =\n\t\t`Repairing story (name: \"${story.name}\", id: ${story.id}) by ` +\n\t\t`setting ${propName} to ${repairedValue}, was ${story[propName]}`;\n\n\tif (detail) {\n\t\tmessage += ` (${detail})`;\n\t}\n\n\tconsole.info(message);\n}\n\nexport function repairStory(\n\tstory: Story,\n\tallStories: Story[],\n\tallFormats: StoryFormat[],\n\tdefaultFormat: StoryFormat\n): Story {\n\tconst storyDefs = storyDefaults();\n\tconst repairs: Partial<Story> = {};\n\n\t// Give the story an ID if it has none.\n\n\tif (typeof story.id !== 'string' || story.id === '') {\n\t\tconst newId = uuid();\n\n\t\tlogRepair(story, 'id', newId, 'was bad type or empty string');\n\t\trepairs.id = newId;\n\t}\n\n\t// Give the story an IFID if it has none.\n\n\tif (typeof story.ifid !== 'string' || story.id === '') {\n\t\tconst newIfid = uuid();\n\n\t\tlogRepair(story, 'ifid', newIfid, 'was bad type or empty string');\n\t\trepairs.ifid = newIfid;\n\t}\n\n\t// Apply default properties to the story.\n\n\tObject.entries(storyDefs).forEach(([key, value]) => {\n\t\tconst defKey = key as keyof typeof storyDefs;\n\n\t\tif (\n\t\t\t(typeof value === 'number' && !Number.isFinite(story[defKey])) ||\n\t\t\ttypeof value !== typeof story[defKey]\n\t\t) {\n\t\t\tlogRepair(story, defKey, storyDefs[defKey]);\n\t\t\t(repairs[defKey] as Story[typeof defKey]) = storyDefs[defKey];\n\t\t}\n\t});\n\n\tif (\n\t\ttypeof story.storyFormat !== 'string' ||\n\t\tstory.storyFormat === '' ||\n\t\ttypeof story.storyFormatVersion !== 'string' ||\n\t\tstory.storyFormatVersion === ''\n\t) {\n\t\t// Assign the story the default story format if it has none.\n\n\t\tlogRepair(\n\t\t\tstory,\n\t\t\t'storyFormat',\n\t\t\tdefaultFormat.name,\n\t\t\t'was bad type or unset'\n\t\t);\n\t\tlogRepair(\n\t\t\tstory,\n\t\t\t'storyFormatVersion',\n\t\t\tdefaultFormat.version,\n\t\t\t'was bad type or unset'\n\t\t);\n\t\trepairs.storyFormat = defaultFormat.name;\n\t\trepairs.storyFormatVersion = defaultFormat.version;\n\t} else if (\n\t\t!allFormats.some(\n\t\t\tformat =>\n\t\t\t\tformat.name === story.storyFormat &&\n\t\t\t\tformat.version === story.storyFormatVersion\n\t\t)\n\t) {\n\t\t// If the story has a nonexistent story format, try to match it to one that\n\t\t// does, using semver as a guide.\n\n\t\tconst repairFormat = allFormats.find(\n\t\t\tformat =>\n\t\t\t\tformat.name === story.storyFormat &&\n\t\t\t\tsatisfies(format.version, '^' + story.storyFormatVersion)\n\t\t);\n\n\t\tif (repairFormat) {\n\t\t\tlogRepair(\n\t\t\t\tstory,\n\t\t\t\t'storyFormat',\n\t\t\t\trepairFormat.name,\n\t\t\t\t'no match in existing formats but found one that satisfies semver'\n\t\t\t);\n\t\t\tlogRepair(\n\t\t\t\tstory,\n\t\t\t\t'storyFormatVersion',\n\t\t\t\trepairFormat.version,\n\t\t\t\t'no match in existing formats but found one that satisfies semver'\n\t\t\t);\n\t\t\trepairs.storyFormat = repairFormat.name;\n\t\t\trepairs.storyFormatVersion = repairFormat.version;\n\t\t} else {\n\t\t\tlogRepair(\n\t\t\t\tstory,\n\t\t\t\t'storyFormat',\n\t\t\t\tdefaultFormat.name,\n\t\t\t\t'no match in existing formats and could not find one that satisfies semver'\n\t\t\t);\n\t\t\tlogRepair(\n\t\t\t\tstory,\n\t\t\t\t'storyFormatVersion',\n\t\t\t\tdefaultFormat.version,\n\t\t\t\t'no match in existing formats and could not find one that satisfies semver'\n\t\t\t);\n\t\t\trepairs.storyFormat = defaultFormat.name;\n\t\t\trepairs.storyFormatVersion = defaultFormat.version;\n\t\t}\n\t}\n\n\t// Repair ID conflicts with other stories.\n\n\tif (\n\t\tallStories.some(otherStory => {\n\t\t\tif (otherStory === story) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn otherStory.id === story.id;\n\t\t})\n\t) {\n\t\tconst newId = uuid();\n\n\t\tlogRepair(story, 'id', newId, \"conflicted with another story's ID\");\n\t\trepairs.id = newId;\n\t}\n\n\t// Repair all passages. All story ID changes must be before this to prevent\n\t// mismatches. We merge in repairs temporarily here so that passages see the\n\t// most correct ID.\n\n\tlet anyPassageRepaired = false;\n\tconst repairedPassages = story.passages.map(passage => {\n\t\tconst repairedPassage = repairPassage(passage, {...story, ...repairs});\n\n\t\tif (repairedPassage !== passage) {\n\t\t\tanyPassageRepaired = true;\n\t\t\treturn repairedPassage;\n\t\t}\n\n\t\treturn passage;\n\t});\n\n\tif (anyPassageRepaired) {\n\t\trepairs.passages = repairedPassages;\n\t}\n\n\tif (Object.keys(repairs).length > 0) {\n\t\treturn {...story, ...repairs};\n\t}\n\n\treturn story;\n}\n","import {Passage, Story, StoriesState} from '../stories.types';\nimport {isPersistablePassageChange} from '../../persistence/persistable-changes';\n\nexport function updatePassage(\n\tstate: StoriesState,\n\tstoryId: string,\n\tpassageId: string,\n\tpassageProps: Omit<Partial<Passage>, 'id' | 'story'>\n) {\n\tlet storyExists = false;\n\tlet updated = false;\n\tconst newState = state.map(story => {\n\t\tif (story.id !== storyId) {\n\t\t\treturn story;\n\t\t}\n\n\t\tstoryExists = true;\n\n\t\tif (\n\t\t\t'name' in passageProps &&\n\t\t\tstory.passages.some(\n\t\t\t\tpassage =>\n\t\t\t\t\tpassage.name === passageProps.name && passage.id !== passageId\n\t\t\t)\n\t\t) {\n\t\t\tconsole.warn(\n\t\t\t\t`There is already a passage in this story with name \"${passageProps.name}\", taking no action`\n\t\t\t);\n\t\t\treturn story;\n\t\t}\n\n\t\tconst newStory: Story = {\n\t\t\t...story,\n\t\t\tpassages: story.passages.map(passage => {\n\t\t\t\tif (passage.id !== passageId) {\n\t\t\t\t\treturn passage;\n\t\t\t\t}\n\n\t\t\t\tupdated = true;\n\t\t\t\treturn {...passage, ...passageProps};\n\t\t\t})\n\t\t};\n\n\t\tif (updated) {\n\t\t\tif (isPersistablePassageChange(passageProps)) {\n\t\t\t\tnewStory.lastUpdate = new Date();\n\t\t\t}\n\n\t\t\treturn newStory;\n\t\t}\n\n\t\tconsole.warn(\n\t\t\t`Asked to update a passage with ID \"${passageId}\", but it does not exist in story ID ${storyId}, taking no action`\n\t\t);\n\t\treturn story;\n\t});\n\n\tif (!storyExists) {\n\t\tconsole.warn(`No story in state with ID \"${storyId}\", taking no action`);\n\t\treturn state;\n\t}\n\n\tif (!updated) {\n\t\t// Should have warned above.\n\t\treturn state;\n\t}\n\n\treturn newState;\n}\n","import {createPassage} from './create-passage';\nimport {createPassages} from './create-passages';\nimport {createStory} from './create-story';\nimport {deletePassage} from './delete-passage';\nimport {deletePassages} from './delete-passages';\nimport {deleteStory} from './delete-story';\nimport {initState} from './init';\nimport {repairState} from './repair';\nimport {updatePassage} from './update-passage';\nimport {updatePassages} from './update-passages';\nimport {updateStory} from './update-story';\nimport {StoriesAction, StoriesState} from '../stories.types';\n\nexport const reducer: React.Reducer<StoriesState, StoriesAction> = (\n\tstate,\n\taction\n) => {\n\tswitch (action.type) {\n\t\tcase 'createPassage':\n\t\t\treturn createPassage(state, action.storyId, action.props);\n\n\t\tcase 'createPassages':\n\t\t\treturn createPassages(state, action.storyId, action.props);\n\n\t\tcase 'createStory':\n\t\t\treturn createStory(state, action.props);\n\n\t\tcase 'deletePassage':\n\t\t\treturn deletePassage(state, action.storyId, action.passageId);\n\n\t\tcase 'deletePassages':\n\t\t\treturn deletePassages(state, action.storyId, action.passageIds);\n\n\t\tcase 'deleteStory':\n\t\t\treturn deleteStory(state, action.storyId);\n\n\t\tcase 'init':\n\t\t\treturn initState(state, action.state);\n\n\t\tcase 'repair':\n\t\t\treturn repairState(state, action.allFormats, action.defaultFormat);\n\n\t\tcase 'updatePassage':\n\t\t\treturn updatePassage(\n\t\t\t\tstate,\n\t\t\t\taction.storyId,\n\t\t\t\taction.passageId,\n\t\t\t\taction.props\n\t\t\t);\n\n\t\tcase 'updatePassages':\n\t\t\treturn updatePassages(state, action.storyId, action.passageUpdates);\n\n\t\tcase 'updateStory':\n\t\t\treturn updateStory(state, action.storyId, action.props);\n\n\t\tdefault:\n\t\t\tconsole.warn(`${(action as any).type} not implemented yet`);\n\t}\n\n\treturn state;\n};\n","import {Passage, StoriesState} from '../stories.types';\nimport {createPassage} from './create-passage';\n\nexport function createPassages(\n\tstate: StoriesState,\n\tstoryId: string,\n\tpassageProps: Partial<Passage>[]\n) {\n\treturn passageProps.reduce(\n\t\t(state, props) => createPassage(state, storyId, props),\n\t\tstate\n\t);\n}\n","import uuid from 'tiny-uuid';\nimport {passageDefaults, storyDefaults} from '../defaults';\nimport {Story, StoriesState} from '../stories.types';\n\nexport function createStory(state: StoriesState, storyProps: Partial<Story>) {\n\tif ('id' in storyProps && state.some(story => story.id === storyProps.id)) {\n\t\tconsole.warn(\n\t\t\t`There is already a story in state with ID \"${storyProps.id}\", taking no action`\n\t\t);\n\t\treturn state;\n\t}\n\n\tif (\n\t\t'name' in storyProps &&\n\t\tstate.some(story => story.name === storyProps.name)\n\t) {\n\t\tconsole.warn(\n\t\t\t`There is already a story in state with name \"${storyProps.name}\", taking no action`\n\t\t);\n\t\treturn state;\n\t}\n\n\tlet story: Story = {\n\t\tid: uuid(),\n\t\t...storyDefaults(),\n\t\tifid: uuid().toUpperCase(),\n\t\tlastUpdate: new Date(),\n\t\tpassages: [],\n\t\ttags: [],\n\t\ttagColors: {},\n\t\t...storyProps\n\t};\n\n\t// If we are prepopulating the story with passages, make sure they have the\n\t// correct ID linkage, and at least make sure basic properties are set.\n\n\tstory.passages = story.passages.map(passage => ({\n\t\t...passageDefaults,\n\t\t...passage,\n\t\tstory: story.id\n\t}));\n\n\treturn [...state, story];\n}\n","import {StoriesState} from '../stories.types';\nimport {deletePassage} from './delete-passage';\n\nexport function deletePassages(\n\tstate: StoriesState,\n\tstoryId: string,\n\tpassageIds: string[]\n) {\n\treturn passageIds.reduce(\n\t\t(state, passageId) => deletePassage(state, storyId, passageId),\n\t\tstate\n\t);\n}\n","import {StoriesState} from '../stories.types';\n\nexport function deleteStory(state: StoriesState, storyId: string) {\n\tlet deleted = false;\n\tconst newState = state.filter(story => {\n\t\tif (story.id === storyId) {\n\t\t\tdeleted = true;\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t});\n\n\tif (!deleted) {\n\t\tconsole.warn(\n\t\t\t`Asked to delete a story with ID \"${storyId}\", but it does not exist in state`\n\t\t);\n\t\treturn state;\n\t}\n\n\treturn newState;\n}\n","import {Story, StoriesState} from '../stories.types';\n\nexport function initState(state: StoriesState, init: Story[]) {\n\treturn [...init];\n}\n","import {repairStory} from './repair-story';\nimport {StoryFormat} from '../../../story-formats';\nimport {StoriesState} from '../../stories.types';\n\nexport function repairState(\n\tstate: StoriesState,\n\tallFormats: StoryFormat[],\n\tdefaultFormat: StoryFormat\n): StoriesState {\n\treturn state.map(story =>\n\t\trepairStory(story, state, allFormats, defaultFormat)\n\t);\n}\n","import {Passage, StoriesState} from '../stories.types';\nimport {updatePassage} from './update-passage';\n\nexport function updatePassages(\n\tstate: StoriesState,\n\tstoryId: string,\n\tpassageUpdates: Record<string, Partial<Passage>>\n) {\n\treturn Object.keys(passageUpdates).reduce(\n\t\t(state, passageId) =>\n\t\t\tupdatePassage(state, storyId, passageId, passageUpdates[passageId]),\n\t\tstate\n\t);\n}\n","import {Story, StoriesState} from '../stories.types';\nimport {isPersistableStoryChange} from '../../persistence/persistable-changes';\n\nexport function updateStory(\n\tstate: StoriesState,\n\tstoryId: string,\n\tstoryProps: Partial<Omit<Story, 'id'>>\n) {\n\tif (\n\t\t'name' in storyProps &&\n\t\tstate.some(story => story.name === storyProps.name && story.id !== storyId)\n\t) {\n\t\tconsole.warn(\n\t\t\t`There is another story in state with name \"${storyProps.name}\", taking no action`\n\t\t);\n\t\treturn state;\n\t}\n\n\tlet updated = false;\n\tconst newState = state.map(story => {\n\t\tif (story.id !== storyId) {\n\t\t\treturn story;\n\t\t}\n\n\t\tupdated = true;\n\n\t\tconst updatedStory = {...story, ...storyProps};\n\n\t\tif (isPersistableStoryChange(storyProps)) {\n\t\t\tupdatedStory.lastUpdate = new Date();\n\t\t}\n\n\t\treturn updatedStory;\n\t});\n\n\tif (!updated) {\n\t\tconsole.warn(\n\t\t\t`Asked to update a story with ID \"${storyId}\", but it does not exist in state`\n\t\t);\n\t\treturn state;\n\t}\n\n\treturn newState;\n}\n","import * as React from 'react';\nimport useThunkReducer from 'react-hook-thunk-reducer';\nimport {usePersistence} from '../persistence/use-persistence';\nimport {reducer} from './reducer';\nimport {\n\tStoriesContextProps,\n\tStoriesAction,\n\tStoriesState\n} from './stories.types';\nimport {useStoryFormatsContext} from '../story-formats';\nimport {useStoreErrorReporter} from '../use-store-error-reporter';\n\nexport const StoriesContext = React.createContext<StoriesContextProps>({\n\tdispatch: () => {},\n\tstories: []\n});\n\nStoriesContext.displayName = 'Stories';\n\nexport const useStoriesContext = () => React.useContext(StoriesContext);\n\nexport const StoriesContextProvider: React.FC = props => {\n\tconst {stories: storiesPersistence} = usePersistence();\n\tconst {formats} = useStoryFormatsContext();\n\tconst {reportError} = useStoreErrorReporter();\n\tconst persistedReducer: React.Reducer<\n\t\tStoriesState,\n\t\tStoriesAction\n\t> = React.useMemo(\n\t\t() => (state, action) => {\n\t\t\tconst newState = reducer(state, action);\n\n\t\t\ttry {\n\t\t\t\tstoriesPersistence.saveMiddleware(newState, action, formats);\n\t\t\t} catch (error) {\n\t\t\t\treportError(error, 'store.errors.cantPersistStories');\n\t\t\t}\n\n\t\t\treturn newState;\n\t\t},\n\t\t[formats, reportError, storiesPersistence]\n\t);\n\tconst [stories, dispatch] = useThunkReducer(persistedReducer, []);\n\n\treturn (\n\t\t<StoriesContext.Provider value={{dispatch, stories}}>\n\t\t\t{props.children}\n\t\t</StoriesContext.Provider>\n\t);\n};\n","import {debounce} from 'lodash';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {DialogEditor} from '../../components/container/dialog-card';\nimport {CodeArea} from '../../components/control/code-area';\nimport {usePrefsContext} from '../../store/prefs';\nimport {Passage, Story} from '../../store/stories';\nimport {StoryFormat} from '../../store/story-formats';\nimport {useCodeMirrorPassageHints} from '../../store/use-codemirror-passage-hints';\nimport {useFormatCodeMirrorMode} from '../../store/use-format-codemirror-mode';\nimport {codeMirrorOptionsFromPrefs} from '../../util/codemirror-options';\n\nexport interface PassageTextProps {\n\tonChange: (value: string) => void;\n\tonEditorChange: (value: CodeMirror.Editor) => void;\n\tpassage: Passage;\n\tstory: Story;\n\tstoryFormat: StoryFormat;\n\tstoryFormatExtensionsDisabled?: boolean;\n}\n\nexport const PassageText: React.FC<PassageTextProps> = props => {\n\tconst {\n\t\tonChange,\n\t\tonEditorChange,\n\t\tpassage,\n\t\tstory,\n\t\tstoryFormat,\n\t\tstoryFormatExtensionsDisabled\n\t} = props;\n\tconst [changePending, setChangePending] = React.useState(false);\n\tconst [localText, setLocalText] = React.useState(passage.text);\n\tconst {prefs} = usePrefsContext();\n\tconst autocompletePassageNames = useCodeMirrorPassageHints(story);\n\tconst mode =\n\t\tuseFormatCodeMirrorMode(storyFormat.name, storyFormat.version) ?? 'text';\n\tconst {t} = useTranslation();\n\n\t// Effects to handle debouncing updates upward. The idea here is that the\n\t// component maintains a local state so that the CodeMirror instance always is\n\t// up-to-date with what the user has typed, but the global context may not be.\n\t// This is because updating global context causes re-rendering in the story\n\t// map, which can be time-intensive.\n\n\tReact.useEffect(() => {\n\t\t// A change to passage text has occurred externally, e.g. through a find and\n\t\t// replace. We ignore this if a change is pending so that users don't see\n\t\t// things they've typed in disappear or be replaced.\n\n\t\tif (!changePending && localText !== passage.text) {\n\t\t\tsetLocalText(passage.text);\n\t\t}\n\t}, [changePending, localText, passage.text]);\n\n\t// The code below handles user changes in the text field. 1 second is a\n\t// guesstimate.\n\n\tconst debouncedOnChange = React.useMemo(\n\t\t() =>\n\t\t\tdebounce((value: string) => {\n\t\t\t\tonChange(value);\n\t\t\t\tsetChangePending(false);\n\t\t\t}, 1000),\n\t\t[onChange]\n\t);\n\n\tconst handleMount = React.useCallback(\n\t\t(editor: CodeMirror.Editor) => {\n\t\t\tonEditorChange(editor);\n\n\t\t\t// The potential combination of loading a mode and the dialog entrance\n\t\t\t// animation seems to mess up CodeMirror's cursor rendering. The delay below\n\t\t\t// is intended to run after the animation completes.\n\n\t\t\twindow.setTimeout(() => {\n\t\t\t\teditor.focus();\n\t\t\t\teditor.refresh();\n\t\t\t}, 400);\n\t\t},\n\t\t[onEditorChange]\n\t);\n\n\tconst handleChange = React.useCallback(\n\t\t(\n\t\t\teditor: CodeMirror.Editor,\n\t\t\tdata: CodeMirror.EditorChange,\n\t\t\ttext: string\n\t\t) => {\n\t\t\tonEditorChange(editor);\n\t\t\tsetChangePending(true);\n\t\t\tdebouncedOnChange(text);\n\t\t\tsetLocalText(text);\n\t\t},\n\t\t[debouncedOnChange, onEditorChange]\n\t);\n\n\tconst options = React.useMemo(\n\t\t() => ({\n\t\t\t...codeMirrorOptionsFromPrefs(prefs),\n\t\t\tmode: storyFormatExtensionsDisabled ? 'text' : mode,\n\t\t\tlineWrapping: true,\n\t\t\tplaceholder: t('dialogs.passageEdit.passageTextPlaceholder'),\n\t\t\tprefixTrigger: {\n\t\t\t\tcallback: autocompletePassageNames,\n\t\t\t\tprefixes: ['[[', '->']\n\t\t\t}\n\t\t}),\n\t\t[autocompletePassageNames, mode, prefs, storyFormatExtensionsDisabled, t]\n\t);\n\n\treturn (\n\t\t<DialogEditor>\n\t\t\t<CodeArea\n\t\t\t\teditorDidMount={handleMount}\n\t\t\t\tfontFamily={prefs.passageEditorFontFamily}\n\t\t\t\tfontScale={prefs.passageEditorFontScale}\n\t\t\t\tlabel={t('dialogs.passageEdit.passageTextEditorLabel')}\n\t\t\t\tlabelHidden\n\t\t\t\tonBeforeChange={handleChange}\n\t\t\t\tonChange={onEditorChange}\n\t\t\t\toptions={options}\n\t\t\t\tvalue={localText}\n\t\t\t/>\n\t\t</DialogEditor>\n\t);\n};\n","import CodeMirror, {Editor, Handle} from 'codemirror';\nimport * as React from 'react';\nimport {Story} from './stories';\n\ntype HintExtraKeyHandler = (editor: Editor, hint: Handle) => void;\n\nexport function useCodeMirrorPassageHints(story: Story) {\n\treturn React.useCallback(\n\t\t(editor: Editor) => {\n\t\t\teditor.showHint({\n\t\t\t\tcompleteSingle: false,\n\t\t\t\textraKeys:\n\t\t\t\t\t// Any of the characters below are an indication the user is finished\n\t\t\t\t\t// typing a passage name in a link and the hint should close. We need\n\t\t\t\t\t// to 'type' this character for the user since our handler consumes\n\t\t\t\t\t// the event.\n\t\t\t\t\t[']', '-', '|'].reduce<Record<string, HintExtraKeyHandler>>(\n\t\t\t\t\t\t(result, character) => {\n\t\t\t\t\t\t\tresult[character] = (editor, hint) => {\n\t\t\t\t\t\t\t\tconst doc = editor.getDoc();\n\n\t\t\t\t\t\t\t\tdoc.replaceRange(character, doc.getCursor());\n\t\t\t\t\t\t\t\thint.close();\n\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\treturn result;\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{}\n\t\t\t\t\t),\n\t\t\t\thint() {\n\t\t\t\t\tconst wordRange = editor.findWordAt(editor.getCursor());\n\t\t\t\t\tconst word = editor\n\t\t\t\t\t\t.getRange(wordRange.anchor, wordRange.head)\n\t\t\t\t\t\t.toLowerCase();\n\n\t\t\t\t\tconst comps = {\n\t\t\t\t\t\tlist: story.passages.reduce<string[]>((result, passage) => {\n\t\t\t\t\t\t\tif (passage.name.toLowerCase().includes(word)) {\n\t\t\t\t\t\t\t\treturn [...result, passage.name];\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\treturn result;\n\t\t\t\t\t\t}, []),\n\t\t\t\t\t\tfrom: wordRange.anchor,\n\t\t\t\t\t\tto: wordRange.head\n\t\t\t\t\t};\n\n\t\t\t\t\tCodeMirror.on(comps, 'pick', () => {\n\t\t\t\t\t\tconst doc = editor.getDoc();\n\n\t\t\t\t\t\tdoc.replaceRange(']] ', doc.getCursor());\n\t\t\t\t\t});\n\n\t\t\t\t\treturn comps;\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\t[story.passages]\n\t);\n}\n","import {version as twineVersion} from '../../package.json';\nimport CodeMirror from 'codemirror';\nimport * as React from 'react';\nimport {\n\tformatWithNameAndVersion,\n\tloadFormatProperties,\n\tuseStoryFormatsContext\n} from './story-formats';\nimport {formatEditorExtensions, namespaceForFormat} from '../util/story-format';\nimport {formatEditorExtensionsDisabled, usePrefsContext} from './prefs';\n\n/**\n * Sets up a CodeMirror mode for a format, if the format has defined one via\n * properties.codeMirror.mode. Once one is fully set up, this returns the name\n * of that mode. If the mode is being set up or the format hasn't defined one,\n * this returns undefined.\n */\nexport function useFormatCodeMirrorMode(\n\tformatName: string,\n\tformatVersion: string\n) {\n\tconst {dispatch, formats} = useStoryFormatsContext();\n\tconst format = formatWithNameAndVersion(formats, formatName, formatVersion);\n\tconst {prefs} = usePrefsContext();\n\tconst [modeName, setModeName] = React.useState<string>();\n\tconst extensionsDisabled = formatEditorExtensionsDisabled(\n\t\tprefs,\n\t\tformatName,\n\t\tformatVersion\n\t);\n\n\tReact.useEffect(() => {\n\t\tif (extensionsDisabled) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (format.loadState === 'unloaded') {\n\t\t\tdispatch(loadFormatProperties(format));\n\t\t} else if (format.loadState === 'loaded') {\n\t\t\tconst editorExtensions = formatEditorExtensions(format, twineVersion);\n\n\t\t\tif (editorExtensions?.codeMirror?.mode) {\n\t\t\t\tCodeMirror.defineMode(\n\t\t\t\t\tnamespaceForFormat(format),\n\t\t\t\t\teditorExtensions.codeMirror.mode\n\t\t\t\t);\n\t\t\t\tsetModeName(namespaceForFormat(format));\n\t\t\t}\n\t\t}\n\t}, [dispatch, extensionsDisabled, format]);\n\n\treturn modeName;\n}\n","import {IconResize} from '@tabler/icons';\nimport {Editor} from 'codemirror';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {UndoRedoButtons} from '../../components/codemirror';\nimport {ButtonBar} from '../../components/container/button-bar';\nimport {CheckboxButton} from '../../components/control/checkbox-button';\nimport {MenuButton} from '../../components/control/menu-button';\nimport {RenamePassageButton} from '../../components/passage/rename-passage-button';\nimport {AddTagButton} from '../../components/tag';\nimport {\n\taddPassageTag,\n\tPassage,\n\tsetTagColor,\n\tStory,\n\tstoryPassageTags,\n\tupdatePassage,\n\tupdateStory\n} from '../../store/stories';\nimport {useUndoableStoriesContext} from '../../store/undoable-stories';\nimport {Color} from '../../util/color';\n\nexport interface PassageToolbarProps {\n\teditor?: Editor;\n\tpassage: Passage;\n\tstory: Story;\n}\n\nexport const PassageToolbar: React.FC<PassageToolbarProps> = props => {\n\tconst {editor, passage, story} = props;\n\tconst {dispatch, stories} = useUndoableStoriesContext();\n\tconst {t} = useTranslation();\n\tconst isStart = story.startPassage === passage.id;\n\n\tfunction handleAddTag(name: string, color?: Color) {\n\t\t// Kind of tricky. We make adding the tag to the passage undoable, but not\n\t\t// any color change associated with this. This is because we only set a\n\t\t// color here when creating an entirely new tag. If the user is adding an\n\t\t// existing tag, then we would only receive the name here, since it's\n\t\t// currently impossible to add an existing tag and change its color\n\t\t// simultaneously.\n\t\t//\n\t\t// If this changes, then this should change too.\n\n\t\tdispatch(addPassageTag(story, passage, name), t('undoChange.addTag'));\n\n\t\tif (color) {\n\t\t\tdispatch(setTagColor(story, name, color));\n\t\t}\n\t}\n\n\tfunction handleRename(name: string) {\n\t\t// Don't create newly linked passages here because the update action will\n\t\t// try to recreate the passage as it's been renamed--it sees new links in\n\t\t// existing passages, updates them, but does not see that the passage name\n\t\t// has been updated since that hasn't happened yet.\n\n\t\tdispatch(\n\t\t\tupdatePassage(\n\t\t\t\tstory,\n\t\t\t\tpassage,\n\t\t\t\t{name},\n\t\t\t\t{dontCreateNewlyLinkedPassages: true}\n\t\t\t)\n\t\t);\n\t}\n\n\tfunction handleSetAsStart() {\n\t\tdispatch(updateStory(stories, story, {startPassage: passage.id}));\n\t}\n\n\tfunction handleSetSize({height, width}: {height: number; width: number}) {\n\t\tdispatch(updatePassage(story, passage, {height, width}));\n\t}\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t<UndoRedoButtons editor={editor} watch={passage.text} />\n\t\t\t<AddTagButton\n\t\t\t\tassignedTags={passage.tags}\n\t\t\t\texistingTags={storyPassageTags(story)}\n\t\t\t\tonAdd={handleAddTag}\n\t\t\t/>\n\t\t\t<MenuButton\n\t\t\t\ticon={<IconResize />}\n\t\t\t\titems={[\n\t\t\t\t\t{\n\t\t\t\t\t\tcheckable: true,\n\t\t\t\t\t\tchecked: passage.height === 100 && passage.width === 100,\n\t\t\t\t\t\tlabel: t('dialogs.passageEdit.sizeSmall'),\n\t\t\t\t\t\tonClick: () => handleSetSize({height: 100, width: 100})\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tcheckable: true,\n\t\t\t\t\t\tchecked: passage.height === 200 && passage.width === 200,\n\t\t\t\t\t\tlabel: t('dialogs.passageEdit.sizeLarge'),\n\t\t\t\t\t\tonClick: () => handleSetSize({height: 200, width: 200})\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tcheckable: true,\n\t\t\t\t\t\tchecked: passage.height === 200 && passage.width === 100,\n\t\t\t\t\t\tlabel: t('dialogs.passageEdit.sizeTall'),\n\t\t\t\t\t\tonClick: () => handleSetSize({height: 200, width: 100})\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tcheckable: true,\n\t\t\t\t\t\tchecked: passage.height === 100 && passage.width === 200,\n\t\t\t\t\t\tlabel: t('dialogs.passageEdit.sizeWide'),\n\t\t\t\t\t\tonClick: () => handleSetSize({height: 100, width: 200})\n\t\t\t\t\t}\n\t\t\t\t]}\n\t\t\t\tlabel={t('dialogs.passageEdit.size')}\n\t\t\t/>\n\t\t\t<RenamePassageButton\n\t\t\t\tonRename={handleRename}\n\t\t\t\tpassage={passage}\n\t\t\t\tstory={story}\n\t\t\t/>\n\t\t\t<CheckboxButton\n\t\t\t\tdisabled={isStart}\n\t\t\t\tlabel={t('dialogs.passageEdit.setAsStart')}\n\t\t\t\tonChange={handleSetAsStart}\n\t\t\t\tvalue={isStart}\n\t\t\t/>\n\t\t</ButtonBar>\n\t);\n};\n","import * as React from 'react';\nimport CodeMirror from 'codemirror';\nimport {usePrefsContext} from '../../store/prefs';\nimport {StoryFormat, StoryFormatToolbarItem} from '../../store/story-formats';\nimport {useComputedTheme} from '../../store/prefs/use-computed-theme';\nimport {useFormatCodeMirrorToolbar} from '../../store/use-format-codemirror-toolbar';\nimport {ButtonBar} from '../../components/container/button-bar';\nimport {IconButton} from '../../components/control/icon-button';\nimport {MenuButton} from '../../components/control/menu-button';\nimport './story-format-toolbar.css';\n\nexport interface StoryFormatToolbarProps {\n\teditor?: CodeMirror.Editor;\n\tonExecCommand: (name: string) => void;\n\tstoryFormat: StoryFormat;\n}\n\nexport const StoryFormatToolbar: React.FC<StoryFormatToolbarProps> = props => {\n\tconst {editor, onExecCommand, storyFormat} = props;\n\tconst containerRef = React.useRef<HTMLDivElement>(null);\n\tconst appTheme = useComputedTheme();\n\tconst {prefs} = usePrefsContext();\n\tconst toolbarFactory = useFormatCodeMirrorToolbar(\n\t\tstoryFormat.name,\n\t\tstoryFormat.version\n\t);\n\tconst [toolbarItems, setToolbarItems] = React.useState<\n\t\tStoryFormatToolbarItem[]\n\t>([]);\n\n\tconst tryToSetToolbar = React.useCallback(() => {\n\t\tif (toolbarFactory && containerRef.current && editor) {\n\t\t\ttry {\n\t\t\t\tconst style = window.getComputedStyle(containerRef.current);\n\n\t\t\t\tsetToolbarItems(\n\t\t\t\t\ttoolbarFactory(editor, {\n\t\t\t\t\t\tappTheme,\n\t\t\t\t\t\tforegroundColor: style.color,\n\t\t\t\t\t\tlocale: prefs.locale\n\t\t\t\t\t})\n\t\t\t\t);\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error(\n\t\t\t\t\t`Toolbar function for ${storyFormat.name} ${storyFormat.version} threw an error, skipping update`,\n\t\t\t\t\terror\n\t\t\t\t);\n\t\t\t}\n\t\t} else {\n\t\t\tsetToolbarItems([]);\n\t\t}\n\t}, [\n\t\tappTheme,\n\t\teditor,\n\t\tprefs.locale,\n\t\tstoryFormat.name,\n\t\tstoryFormat.version,\n\t\ttoolbarFactory\n\t]);\n\n\tReact.useEffect(() => {\n\t\tif (editor) {\n\t\t\t// Run the toolbar factory initially.\n\n\t\t\ttryToSetToolbar();\n\n\t\t\t// React to both content changes and the selection and cursor moving,\n\t\t\t// since the toolbar factory might want to do different things based on\n\t\t\t// the cursor position or selection.\n\n\t\t\teditor.on('cursorActivity', tryToSetToolbar);\n\t\t\treturn () => editor.off('cursorActivity', tryToSetToolbar);\n\t\t}\n\t}, [editor, tryToSetToolbar]);\n\n\tfunction execCommand(name: string) {\n\t\t// Run the command, then update the toolbar after the current execution\n\t\t// context finishes.\n\n\t\tonExecCommand(name);\n\t\tPromise.resolve().then(tryToSetToolbar);\n\t}\n\n\treturn (\n\t\t<div className=\"story-format-toolbar\" ref={containerRef}>\n\t\t\t<ButtonBar>\n\t\t\t\t{toolbarItems.map((item, index) => {\n\t\t\t\t\tswitch (item.type) {\n\t\t\t\t\t\tcase 'button':\n\t\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\t\t\tdisabled={item.disabled}\n\t\t\t\t\t\t\t\t\ticon={<img src={item.icon} alt=\"\" />}\n\t\t\t\t\t\t\t\t\ticonOnly={item.iconOnly}\n\t\t\t\t\t\t\t\t\tkey={index}\n\t\t\t\t\t\t\t\t\tlabel={item.label}\n\t\t\t\t\t\t\t\t\tonClick={() => execCommand(item.command)}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\tcase 'menu': {\n\t\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t\t<MenuButton\n\t\t\t\t\t\t\t\t\tdisabled={item.disabled}\n\t\t\t\t\t\t\t\t\ticon={<img src={item.icon} alt=\"\" />}\n\t\t\t\t\t\t\t\t\ticonOnly={item.iconOnly}\n\t\t\t\t\t\t\t\t\titems={item.items\n\t\t\t\t\t\t\t\t\t\t.filter(subitem =>\n\t\t\t\t\t\t\t\t\t\t\t['button', 'separator'].includes(subitem.type)\n\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\t.map(subitem => {\n\t\t\t\t\t\t\t\t\t\t\tif (subitem.type === 'button') {\n\t\t\t\t\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t\t\t\t\ttype: 'button',\n\t\t\t\t\t\t\t\t\t\t\t\t\tdisabled: subitem.disabled,\n\t\t\t\t\t\t\t\t\t\t\t\t\tlabel: subitem.label,\n\t\t\t\t\t\t\t\t\t\t\t\t\tonClick: () => execCommand(subitem.command)\n\t\t\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t\treturn {separator: true};\n\t\t\t\t\t\t\t\t\t\t})}\n\t\t\t\t\t\t\t\t\tkey={index}\n\t\t\t\t\t\t\t\t\tlabel={item.label}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\treturn null;\n\t\t\t\t})}\n\t\t\t</ButtonBar>\n\t\t</div>\n\t);\n};\n","import CodeMirror from 'codemirror';\nimport * as React from 'react';\nimport {version as twineVersion} from '../../package.json';\nimport {formatEditorExtensions, namespaceForFormat} from '../util/story-format';\nimport {formatEditorExtensionsDisabled, usePrefsContext} from './prefs';\nimport {\n\tformatWithNameAndVersion,\n\tloadFormatProperties,\n\tStoryFormatToolbarFactory,\n\tStoryFormatToolbarFactoryEnvironment,\n\tStoryFormatToolbarItem,\n\tuseStoryFormatsContext\n} from './story-formats';\n\n/**\n * Manages working with a CodeMirror toolbar for a story format, which consists\n * of:\n *\n * - (optionally, but usually) a set of CodeMirror commands\n * - A function that returns an array of objects describing the toolbar, which\n *   uses those commands for functionality\n *\n * This loads the story format if it hasn't already been loaded, and installs\n * CodeMirror commands it provides. It returns the toolbar factory function if\n * everything succeeds. Otherwise, it will return undefined.\n */\nexport function useFormatCodeMirrorToolbar(\n\tformatName: string,\n\tformatVersion: string\n) {\n\tconst {dispatch, formats} = useStoryFormatsContext();\n\tconst [loaded, setLoaded] = React.useState<Record<string, boolean>>({});\n\tconst [\n\t\ttoolbarFunc,\n\t\tsetToolbarFunc\n\t] = React.useState<StoryFormatToolbarFactory>();\n\tconst format = formatWithNameAndVersion(formats, formatName, formatVersion);\n\tconst {prefs} = usePrefsContext();\n\tconst extensionsDisabled = formatEditorExtensionsDisabled(\n\t\tprefs,\n\t\tformatName,\n\t\tformatVersion\n\t);\n\n\tReact.useEffect(() => {\n\t\tif (extensionsDisabled) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (format.loadState === 'unloaded') {\n\t\t\tdispatch(loadFormatProperties(format));\n\t\t} else if (\n\t\t\tformat.loadState === 'loaded' &&\n\t\t\t!loaded[namespaceForFormat(format)]\n\t\t) {\n\t\t\tconst namespace = namespaceForFormat(format);\n\t\t\tconst editorExtensions = formatEditorExtensions(format, twineVersion);\n\n\t\t\tif (editorExtensions?.codeMirror?.commands) {\n\t\t\t\tfor (const commandName in editorExtensions.codeMirror.commands) {\n\t\t\t\t\tconst namespacedCommand = namespace + commandName;\n\n\t\t\t\t\tif (namespacedCommand in CodeMirror.commands) {\n\t\t\t\t\t\tconsole.warn(\n\t\t\t\t\t\t\t`CodeMirror already has a \"${namespacedCommand}\" command defined, skipping`\n\t\t\t\t\t\t);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// Using any here because the type is defined with factory\n\t\t\t\t\t\t// commands only.\n\n\t\t\t\t\t\t(CodeMirror.commands as any)[\n\t\t\t\t\t\t\tnamespacedCommand\n\t\t\t\t\t\t] = editorExtensions.codeMirror!.commands![commandName];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (editorExtensions?.codeMirror?.toolbar) {\n\t\t\t\tsetToolbarFunc(\n\t\t\t\t\t() => (\n\t\t\t\t\t\teditor: CodeMirror.Editor,\n\t\t\t\t\t\tenvironment: StoryFormatToolbarFactoryEnvironment\n\t\t\t\t\t) => {\n\t\t\t\t\t\t// If somehow we lost our format's toolbar function, exit early.\n\n\t\t\t\t\t\tif (!editorExtensions?.codeMirror?.toolbar) {\n\t\t\t\t\t\t\treturn [];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst items = editorExtensions.codeMirror.toolbar(\n\t\t\t\t\t\t\teditor,\n\t\t\t\t\t\t\tenvironment\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\t// If we didn't get an array from the function, coerce it to an\n\t\t\t\t\t\t// empty one.\n\n\t\t\t\t\t\tif (!Array.isArray(items)) {\n\t\t\t\t\t\t\treturn [];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// Namespace command properties and filter out any types that aren't\n\t\t\t\t\t\t// buttons or menus.\n\n\t\t\t\t\t\treturn items.reduce((result, item) => {\n\t\t\t\t\t\t\tswitch (item.type) {\n\t\t\t\t\t\t\t\tcase 'button':\n\t\t\t\t\t\t\t\t\treturn [\n\t\t\t\t\t\t\t\t\t\t...result,\n\t\t\t\t\t\t\t\t\t\t{...item, command: namespace + item.command}\n\t\t\t\t\t\t\t\t\t];\n\n\t\t\t\t\t\t\t\tcase 'menu':\n\t\t\t\t\t\t\t\t\tif (Array.isArray(item.items)) {\n\t\t\t\t\t\t\t\t\t\treturn [\n\t\t\t\t\t\t\t\t\t\t\t...result,\n\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\t...item,\n\t\t\t\t\t\t\t\t\t\t\t\titems: item.items\n\t\t\t\t\t\t\t\t\t\t\t\t\t.filter(subitem =>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t['button', 'separator'].includes(subitem.type)\n\t\t\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\t\t\t\t.map(subitem =>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tsubitem.type === 'separator'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t? subitem\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t: {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t...subitem,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tcommand: namespace + subitem.command\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  }\n\t\t\t\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t];\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\treturn result;\n\t\t\t\t\t\t}, [] as StoryFormatToolbarItem[]);\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tsetLoaded(loaded => ({...loaded, [namespaceForFormat(format)]: true}));\n\t\t}\n\t}, [dispatch, extensionsDisabled, format, loaded]);\n\n\treturn toolbarFunc;\n}\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {ButtonBar} from '../../components/container/button-bar';\nimport {TagButton} from '../../components/tag';\nimport {\n\tPassage,\n\tremovePassageTag,\n\tStory,\n\tupdateStory\n} from '../../store/stories';\nimport {useUndoableStoriesContext} from '../../store/undoable-stories';\nimport {Color} from '../../util/color';\n\nexport interface TagToolbarProps {\n\tpassage: Passage;\n\tstory: Story;\n}\n\nexport const TagToolbar: React.FC<TagToolbarProps> = props => {\n\tconst {passage, story} = props;\n\tconst {dispatch, stories} = useUndoableStoriesContext();\n\tconst {t} = useTranslation();\n\n\tfunction handleChangeTagColor(name: string, color: Color) {\n\t\tdispatch(\n\t\t\tupdateStory(stories, story, {\n\t\t\t\ttagColors: {...story.tagColors, [name]: color}\n\t\t\t})\n\t\t);\n\t}\n\n\tfunction handleRemoveTag(name: string) {\n\t\tdispatch(removePassageTag(story, passage, name), t('undoChange.removeTag'));\n\t}\n\n\tif (passage.tags.length === 0) {\n\t\treturn null;\n\t}\n\n\treturn (\n\t\t<div className=\"tags\">\n\t\t\t<ButtonBar>\n\t\t\t\t{passage.tags.map(tag => (\n\t\t\t\t\t<TagButton\n\t\t\t\t\t\tcolor={story.tagColors[tag]}\n\t\t\t\t\t\tkey={tag}\n\t\t\t\t\t\tname={tag}\n\t\t\t\t\t\tonChangeColor={color => handleChangeTagColor(tag, color)}\n\t\t\t\t\t\tonRemove={() => handleRemoveTag(tag)}\n\t\t\t\t\t/>\n\t\t\t\t))}\n\t\t\t</ButtonBar>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport useErrorBoundary from 'use-error-boundary';\nimport {\n\tDialogCard,\n\tDialogCardProps\n} from '../../components/container/dialog-card';\nimport {ErrorMessage} from '../../components/error';\nimport {passageWithId, storyWithId, updatePassage} from '../../store/stories';\nimport {\n\tformatWithNameAndVersion,\n\tuseStoryFormatsContext\n} from '../../store/story-formats';\nimport {useUndoableStoriesContext} from '../../store/undoable-stories';\nimport './passage-edit.css';\nimport {PassageText} from './passage-text';\nimport {PassageToolbar} from './passage-toolbar';\nimport {StoryFormatToolbar} from './story-format-toolbar';\nimport {TagToolbar} from './tag-toolbar';\n\nexport interface PassageEditDialogProps\n\textends Omit<DialogCardProps, 'headerLabel'> {\n\tpassageId: string;\n\tstoryId: string;\n}\n\nexport const InnerPassageEditDialog: React.FC<\n\tPassageEditDialogProps\n> = props => {\n\tconst {passageId, storyId, ...other} = props;\n\tconst [storyFormatExtensionsEnabled, setStoryFormatExtensionsEnabled] =\n\t\tReact.useState(true);\n\tconst [editorCrashed, setEditorCrashed] = React.useState(false);\n\tconst [cmEditor, setCmEditor] = React.useState<CodeMirror.Editor>();\n\tconst {ErrorBoundary, error, reset: resetError} = useErrorBoundary();\n\tconst {dispatch, stories} = useUndoableStoriesContext();\n\tconst {formats} = useStoryFormatsContext();\n\tconst passage = passageWithId(stories, storyId, passageId);\n\tconst story = storyWithId(stories, storyId);\n\tconst storyFormat = formatWithNameAndVersion(\n\t\tformats,\n\t\tstory.storyFormat,\n\t\tstory.storyFormatVersion\n\t);\n\tconst {t} = useTranslation();\n\n\tReact.useEffect(() => {\n\t\tif (error) {\n\t\t\tif (storyFormatExtensionsEnabled) {\n\t\t\t\tconsole.error(\n\t\t\t\t\t'Passage editor crashed, trying without format extensions',\n\t\t\t\t\terror\n\t\t\t\t);\n\t\t\t\tsetStoryFormatExtensionsEnabled(false);\n\t\t\t} else {\n\t\t\t\tsetEditorCrashed(true);\n\t\t\t}\n\n\t\t\tresetError();\n\t\t}\n\t}, [error, resetError, storyFormatExtensionsEnabled]);\n\n\tconst handlePassageTextChange = React.useCallback(\n\t\t(text: string) => {\n\t\t\tdispatch(updatePassage(story, passage, {text}));\n\t\t},\n\t\t[dispatch, passage, story]\n\t);\n\n\tfunction handleExecCommand(name: string) {\n\t\t// A format toolbar command probably will affect the editor content. It\n\t\t// appears that react-codemirror2 can't maintain the selection properly in\n\t\t// all cases when this happens (particularly when using\n\t\t// `replaceSelection('something', 'around')`), so we take a snapshot\n\t\t// immediately after the command runs, let react-codemirror2 work, then\n\t\t// reapply the selection ASAP.\n\n\t\tif (!cmEditor) {\n\t\t\tthrow new Error('No editor set');\n\t\t}\n\n\t\tcmEditor.execCommand(name);\n\n\t\tconst selections = cmEditor.listSelections();\n\n\t\tPromise.resolve().then(() => cmEditor.setSelections(selections));\n\t}\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...other}\n\t\t\tclassName=\"passage-edit-dialog\"\n\t\t\theaderLabel={passage.name}\n\t\t>\n\t\t\t{editorCrashed ? (\n\t\t\t\t<ErrorMessage>{t('dialogs.passageEdit.editorCrashed')}</ErrorMessage>\n\t\t\t) : (\n\t\t\t\t<>\n\t\t\t\t\t<PassageToolbar editor={cmEditor} passage={passage} story={story} />\n\t\t\t\t\t{storyFormatExtensionsEnabled && (\n\t\t\t\t\t\t<StoryFormatToolbar\n\t\t\t\t\t\t\teditor={cmEditor}\n\t\t\t\t\t\t\tonExecCommand={handleExecCommand}\n\t\t\t\t\t\t\tstoryFormat={storyFormat}\n\t\t\t\t\t\t/>\n\t\t\t\t\t)}\n\t\t\t\t\t<TagToolbar passage={passage} story={story} />\n\t\t\t\t\t<ErrorBoundary>\n\t\t\t\t\t\t<PassageText\n\t\t\t\t\t\t\tonChange={handlePassageTextChange}\n\t\t\t\t\t\t\tonEditorChange={setCmEditor}\n\t\t\t\t\t\t\tpassage={passage}\n\t\t\t\t\t\t\tstory={story}\n\t\t\t\t\t\t\tstoryFormat={storyFormat}\n\t\t\t\t\t\t\tstoryFormatExtensionsDisabled={!storyFormatExtensionsEnabled}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</ErrorBoundary>\n\t\t\t\t</>\n\t\t\t)}\n\t\t</DialogCard>\n\t);\n};\n\nexport const PassageEditDialog: React.FC<PassageEditDialogProps> = props => {\n\t// Check for the existence of the passage. If it doesn't (e.g. it was deleted\n\t// after the dialog was opened), render nothing and call onClose.\n\n\tconst {stories} = useUndoableStoriesContext();\n\n\ttry {\n\t\tpassageWithId(stories, props.storyId, props.passageId);\n\t} catch (err) {\n\t\tprops.onClose();\n\t\treturn null;\n\t}\n\n\treturn <InnerPassageEditDialog {...props} />;\n};\n","import classNames from 'classnames';\nimport * as React from 'react';\nimport './file-input.css';\n\n// See https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/file\n\nexport interface FileInputProps {\n\taccept?: string;\n\tchildren: React.ReactNode;\n\tonChange: (file: File, data: string) => void;\n\tonError?: (error: Error) => void;\n\torientation?: 'horizontal' | 'vertical';\n}\n\nexport const FileInput: React.FC<FileInputProps> = props => {\n\tconst {children, onChange, onError, orientation, ...otherProps} = props;\n\tconst className = classNames(\n\t\t'file-input',\n\t\t`orientation-${orientation ?? 'horizontal'}`\n\t);\n\n\tfunction handleChange(changeEvent: React.ChangeEvent<HTMLInputElement>) {\n\t\tif (!changeEvent.target.files) {\n\t\t\tthrow new Error('Change event occurred but no files present');\n\t\t}\n\n\t\tconst file = changeEvent.target.files[0];\n\t\tconst reader = new FileReader();\n\n\t\treader.addEventListener('loadend', loadEvent => {\n\t\t\tif (reader.error) {\n\t\t\t\tconsole.warn(reader.error);\n\n\t\t\t\tif (onError) {\n\t\t\t\t\tonError(reader.error);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tonChange(file, reader.result as string);\n\t\t\t}\n\t\t});\n\n\t\treader.readAsText(file);\n\t}\n\n\treturn (\n\t\t<span className={className}>\n\t\t\t<label>\n\t\t\t\t<span className=\"file-input-label\">{children}</span>\n\t\t\t\t<span className=\"file-input-control\">\n\t\t\t\t\t<input {...otherProps} onChange={handleChange} type=\"file\" />\n\t\t\t\t</span>\n\t\t\t</label>\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {FileInput} from '../../components/control/file-input';\nimport {Story} from '../../store/stories';\nimport {importStories} from '../../util/import';\n\nexport interface FileChooserProps {\n\tonChange: (file: File, stories: Story[]) => void;\n}\n\nexport const FileChooser: React.FC<FileChooserProps> = props => {\n\tconst {onChange} = props;\n\tconst {t} = useTranslation();\n\n\tfunction handleChange(file: File, data: string) {\n\t\tonChange(file, importStories(data));\n\t}\n\n\treturn (\n\t\t<div className=\"file-chooser\">\n\t\t\t<p>\n\t\t\t\t<FileInput\n\t\t\t\t\taccept=\".html\"\n\t\t\t\t\tonChange={handleChange}\n\t\t\t\t\torientation=\"vertical\"\n\t\t\t\t>\n\t\t\t\t\t{t('dialogs.storyImport.filePrompt')}\n\t\t\t\t</FileInput>\n\t\t\t</p>\n\t\t</div>\n\t);\n};\n","import {IconFileImport} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {CheckboxButton} from '../../components/control/checkbox-button';\nimport {IconButton} from '../../components/control/icon-button';\nimport {storyFileName} from '../../electron/shared';\nimport {Story} from '../../store/stories';\nimport './story-chooser.css';\n\nexport interface StoryChooserProps {\n\texistingStories: Story[];\n\tonImport: (stories: Story[]) => void;\n\tstories: Story[];\n}\n\nexport const StoryChooser: React.FC<StoryChooserProps> = props => {\n\tconst {existingStories, onImport, stories} = props;\n\tconst [selectedStories, setSelectedStories] = React.useState<Story[]>([]);\n\tconst {t} = useTranslation();\n\n\tfunction willReplaceExisting(story: Story) {\n\t\treturn existingStories.some(\n\t\t\tother => storyFileName(other) === storyFileName(story)\n\t\t);\n\t}\n\n\tfunction handleChange(story: Story, selected: boolean) {\n\t\tif (selected) {\n\t\t\tsetSelectedStories(current => [...current, story]);\n\t\t} else {\n\t\t\tsetSelectedStories(current =>\n\t\t\t\tcurrent.filter(other => other.id !== story.id)\n\t\t\t);\n\t\t}\n\t}\n\n\treturn (\n\t\t<div className=\"story-chooser\">\n\t\t\t<p>{t('dialogs.storyImport.storiesPrompt')}</p>\n\t\t\t<ul>\n\t\t\t\t{stories.map(story => (\n\t\t\t\t\t<li>\n\t\t\t\t\t\t<CheckboxButton\n\t\t\t\t\t\t\tkey={story.id}\n\t\t\t\t\t\t\tlabel={story.name}\n\t\t\t\t\t\t\tonChange={selected => handleChange(story, selected)}\n\t\t\t\t\t\t\tvalue={selectedStories.includes(story)}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t{selectedStories.includes(story) && willReplaceExisting(story) && (\n\t\t\t\t\t\t\t<span className=\"replace-warning\">\n\t\t\t\t\t\t\t\t{t('dialogs.storyImport.willReplaceExisting')}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</li>\n\t\t\t\t))}\n\t\t\t</ul>\n\t\t\t<IconButton\n\t\t\t\tdisabled={selectedStories.length === 0}\n\t\t\t\ticon={<IconFileImport />}\n\t\t\t\tlabel={t('dialogs.storyImport.importSelected')}\n\t\t\t\tonClick={() => onImport(selectedStories)}\n\t\t\t/>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {CardContent} from '../../components/container/card';\nimport {\n\tDialogCard,\n\tDialogCardProps\n} from '../../components/container/dialog-card';\nimport {importStories, Story, useStoriesContext} from '../../store/stories';\nimport {FileChooser} from './file-chooser';\nimport {StoryChooser} from './story-chooser';\nimport './story-import.css';\n\nexport type StoryImportDialogProps = DialogCardProps;\n\nexport const StoryImportDialog: React.FC<StoryImportDialogProps> = props => {\n\tconst {onClose} = props;\n\tconst {t} = useTranslation();\n\tconst {dispatch, stories: existingStories} = useStoriesContext();\n\tconst [file, setFile] = React.useState<File>();\n\tconst [stories, setStories] = React.useState<Story[]>([]);\n\n\tfunction handleFileChange(file: File, stories: Story[]) {\n\t\tsetFile(file);\n\t\tsetStories(stories);\n\t}\n\n\tfunction handleImport(stories: Story[]) {\n\t\tdispatch(importStories(stories, existingStories));\n\t\tonClose();\n\t}\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...props}\n\t\t\tclassName=\"story-import-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={t('dialogs.storyImport.title')}\n\t\t>\n\t\t\t<CardContent>\n\t\t\t\t<FileChooser onChange={handleFileChange} />\n\t\t\t\t{file && stories.length > 0 && (\n\t\t\t\t\t<StoryChooser\n\t\t\t\t\t\texistingStories={existingStories}\n\t\t\t\t\t\tonImport={handleImport}\n\t\t\t\t\t\tstories={stories}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\t\t\t\t{file && stories.length === 0 && (\n\t\t\t\t\t<p>{t('dialogs.storyImport.noStoriesInFile')}</p>\n\t\t\t\t)}\n\t\t\t</CardContent>\n\t\t</DialogCard>\n\t);\n};\n","import {Thunk} from 'react-hook-thunk-reducer';\nimport {\n\tpassageWithId,\n\tpassageWithName,\n\tstoryWithId,\n\tPassage,\n\tStoriesAction,\n\tStoriesState,\n\tStory\n} from '../stories';\nimport {StoriesActionOrThunk} from './undoable-stories.types';\n\n/**\n * Returns an action or thunk to reverse a single action.\n */\nexport function reverseAction(\n\taction: StoriesAction,\n\tstate: StoriesState\n): StoriesActionOrThunk {\n\tswitch (action.type) {\n\t\tcase 'createPassage':\n\t\t\tif (action.props.id) {\n\t\t\t\treturn {\n\t\t\t\t\ttype: 'deletePassage',\n\t\t\t\t\tpassageId: action.props.id,\n\t\t\t\t\tstoryId: action.storyId\n\t\t\t\t};\n\t\t\t} else if (action.props.name) {\n\t\t\t\t// This is dependant on the fact that we will only undo this action\n\t\t\t\t// immediately--otherwise this could create havoc if the passage has\n\t\t\t\t// been renamed in the meantime.\n\t\t\t\t//\n\t\t\t\t// This also assumes that the create action will succeed--e.g. there are\n\t\t\t\t// no conflicts.\n\t\t\t\tconst reverseThunk: Thunk<StoriesState, StoriesAction> = (\n\t\t\t\t\tdispatch,\n\t\t\t\t\tgetState\n\t\t\t\t) => {\n\t\t\t\t\tdispatch({\n\t\t\t\t\t\ttype: 'deletePassage',\n\t\t\t\t\t\tpassageId: passageWithName(\n\t\t\t\t\t\t\tgetState(),\n\t\t\t\t\t\t\taction.storyId,\n\t\t\t\t\t\t\taction.props.name!\n\t\t\t\t\t\t).id,\n\t\t\t\t\t\tstoryId: action.storyId\n\t\t\t\t\t});\n\t\t\t\t};\n\n\t\t\t\treturn reverseThunk;\n\t\t\t} else {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t\"Can't reverse a createPassage action without either name or ID\"\n\t\t\t\t);\n\t\t\t}\n\n\t\t// TODO: crashes on a replace all that affects a passage name, unclear why\n\n\t\tcase 'createPassages':\n\t\t\tif (action.props.some(prop => !prop.id && !prop.name)) {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t\"Can't reverse a createPassages action where a prop set doesn't have either name or ID\"\n\t\t\t\t);\n\t\t\t}\n\n\t\t\treturn (dispatch, getState) => {\n\t\t\t\taction.props.forEach(props => {\n\t\t\t\t\tif (props.id) {\n\t\t\t\t\t\tdispatch({\n\t\t\t\t\t\t\ttype: 'deletePassage',\n\t\t\t\t\t\t\tpassageId: props.id,\n\t\t\t\t\t\t\tstoryId: action.storyId\n\t\t\t\t\t\t});\n\t\t\t\t\t} else if (props.name) {\n\t\t\t\t\t\t// This is dependent on the fact that we will only undo this action\n\t\t\t\t\t\t// immediately--see comment about the createPassage action.\n\n\t\t\t\t\t\tdispatch({\n\t\t\t\t\t\t\ttype: 'deletePassage',\n\t\t\t\t\t\t\tpassageId: passageWithName(getState(), action.storyId, props.name)\n\t\t\t\t\t\t\t\t.id,\n\t\t\t\t\t\t\tstoryId: action.storyId\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t};\n\n\t\tcase 'deletePassage':\n\t\t\treturn {\n\t\t\t\ttype: 'createPassage',\n\t\t\t\tprops: passageWithId(state, action.storyId, action.passageId),\n\t\t\t\tstoryId: action.storyId\n\t\t\t};\n\n\t\tcase 'deletePassages':\n\t\t\treturn {\n\t\t\t\ttype: 'createPassages',\n\t\t\t\tprops: action.passageIds.map(passageId =>\n\t\t\t\t\tpassageWithId(state, action.storyId, passageId)\n\t\t\t\t),\n\t\t\t\tstoryId: action.storyId\n\t\t\t};\n\n\t\tcase 'updatePassage': {\n\t\t\tconst passage = passageWithId(state, action.storyId, action.passageId);\n\t\t\tconst props = Object.keys(action.props).reduce(\n\t\t\t\t(result, propName) => ({\n\t\t\t\t\t...result,\n\t\t\t\t\t[propName]: passage[propName as keyof Passage]\n\t\t\t\t}),\n\t\t\t\t{} as Passage\n\t\t\t);\n\n\t\t\treturn {\n\t\t\t\ttype: 'updatePassage',\n\t\t\t\tprops,\n\t\t\t\tpassageId: action.passageId,\n\t\t\t\tstoryId: action.storyId\n\t\t\t};\n\t\t}\n\n\t\tcase 'updatePassages':\n\t\t\treturn {\n\t\t\t\ttype: 'updatePassages',\n\t\t\t\tpassageUpdates: Object.keys(action.passageUpdates).reduce(\n\t\t\t\t\t(result, passageId) => {\n\t\t\t\t\t\tconst passage = passageWithId(state, action.storyId, passageId);\n\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t...result,\n\t\t\t\t\t\t\t[passageId]: Object.keys(action.passageUpdates[passageId]).reduce(\n\t\t\t\t\t\t\t\t(passageResult, propName) => ({\n\t\t\t\t\t\t\t\t\t...passageResult,\n\t\t\t\t\t\t\t\t\t[propName]: passage[propName as keyof Passage]\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\t{} as Passage\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t};\n\t\t\t\t\t},\n\t\t\t\t\t{} as Record<string, Partial<Passage>>\n\t\t\t\t),\n\t\t\t\tstoryId: action.storyId\n\t\t\t};\n\n\t\tcase 'updateStory': {\n\t\t\tconst story = storyWithId(state, action.storyId);\n\t\t\tconst props = Object.keys(action.props).reduce(\n\t\t\t\t(result, propName) => ({\n\t\t\t\t\t...result,\n\t\t\t\t\t[propName]: story[propName as keyof Story]\n\t\t\t\t}),\n\t\t\t\t{} as Story\n\t\t\t);\n\n\t\t\treturn {\n\t\t\t\ttype: 'updateStory',\n\t\t\t\tprops,\n\t\t\t\tstoryId: action.storyId\n\t\t\t};\n\t\t}\n\t}\n\n\tthrow new Error(`Don't know how to reverse action type \"${action.type}\"`);\n}\n","import * as React from 'react';\nimport {Thunk} from 'react-hook-thunk-reducer';\nimport {StoriesAction, StoriesState} from '../stories';\nimport {reverseAction} from './reverse-action';\nimport {StoriesActionOrThunk} from './undoable-stories.types';\n\n/**\n * Returns a thunk to reverse a thunk's actions. **This only works with thunks\n * that dispatch all actions synchronously.**\n */\nexport function reverseThunk(\n\tthunk: Thunk<StoriesState, StoriesAction>,\n\tstate: StoriesState\n): Thunk<StoriesState, StoriesAction> {\n\tconst actions: StoriesActionOrThunk[] = [];\n\tconst dispatch: React.Dispatch<StoriesActionOrThunk> = (\n\t\tactionOrThunk: StoriesActionOrThunk\n\t) => {\n\t\tif (typeof actionOrThunk === 'function') {\n\t\t\tactions.push(reverseThunk(actionOrThunk, state));\n\t\t} else {\n\t\t\tactions.push(reverseAction(actionOrThunk, state));\n\t\t}\n\t};\n\n\tthunk(dispatch, () => state);\n\treturn dispatch => actions.forEach(dispatch);\n}\n","// This reducer manages tracking undo states only. It does not actually perform\n// the undo/redos itself--that is instead done by\n// <UndoableStoriesContextProvider>, which orchestrates things between this\n// reducer and the main stories reducer.\n\nimport * as React from 'react';\nimport {reverseAction} from './reverse-action';\nimport {reverseThunk} from './reverse-thunk';\nimport {\n\tStoryChange,\n\tUndoableStoriesAction,\n\tUndoableStoriesState\n} from './undoable-stories.types';\n\nexport const reducer: React.Reducer<\n\tUndoableStoriesState,\n\tUndoableStoriesAction\n> = (state, action) => {\n\tswitch (action.type) {\n\t\tcase 'addChange':\n\t\t\tconst newChange: StoryChange = {\n\t\t\t\tdescription: action.description,\n\t\t\t\tredo: action.action,\n\t\t\t\tundo:\n\t\t\t\t\ttypeof action.action === 'function'\n\t\t\t\t\t\t? reverseThunk(action.action, action.storiesState)\n\t\t\t\t\t\t: reverseAction(action.action, action.storiesState)\n\t\t\t};\n\n\t\t\t// Slice off any changes after the current one.\n\n\t\t\tconst newChanges = [\n\t\t\t\t...state.changes.slice(0, state.currentChange + 1),\n\t\t\t\tnewChange\n\t\t\t];\n\n\t\t\treturn {\n\t\t\t\tchanges: newChanges,\n\t\t\t\tcurrentChange: newChanges.length - 1\n\t\t\t};\n\n\t\tcase 'updateCurrent':\n\t\t\treturn {\n\t\t\t\t...state,\n\t\t\t\tcurrentChange: Math.min(\n\t\t\t\t\tMath.max(state.currentChange + action.change, -1),\n\t\t\t\t\tstate.changes.length - 1\n\t\t\t\t)\n\t\t\t};\n\t}\n};\n","// This context wraps access to a StoriesContext so that changes made can be\n// undone. To properly use this, a change should be dispatched via either a\n// single action object or a thunk. This context assumes that each dispatch call\n// should be treated as a discrete change. If this context is being used, all\n// changes should go through this context--the StoriesContext shouldn't be\n// accessed directly.\n\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {\n\tStoriesActionOrThunk,\n\tUndoableStoriesContextProps\n} from './undoable-stories.types';\nimport {reducer} from './reducer';\nimport {useStoriesContext} from '../stories';\n\nexport const UndoableStoriesContext = React.createContext<UndoableStoriesContextProps>(\n\t{\n\t\tdispatch: () => {},\n\t\tstories: []\n\t}\n);\n\nUndoableStoriesContext.displayName = 'UndoableStories';\n\nexport const useUndoableStoriesContext = () =>\n\tReact.useContext(UndoableStoriesContext);\n\nexport const UndoableStoriesContextProvider: React.FC = props => {\n\tconst {dispatch: storiesDispatch, stories} = useStoriesContext();\n\tconst [state, dispatch] = React.useReducer(reducer, {\n\t\tchanges: [],\n\t\tcurrentChange: -1\n\t});\n\tconst dispatchAndRecordStoryAction = React.useCallback(\n\t\t(action: StoriesActionOrThunk, description?: string) => {\n\t\t\tif (description) {\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'addChange',\n\t\t\t\t\taction,\n\t\t\t\t\tdescription: description,\n\t\t\t\t\tstoriesState: stories\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn storiesDispatch(action);\n\t\t},\n\t\t[stories, storiesDispatch]\n\t);\n\tconst {t} = useTranslation();\n\n\tlet redo: (() => void) | undefined = undefined;\n\tlet redoLabel: string | undefined = undefined;\n\tlet undo: (() => void) | undefined = undefined;\n\tlet undoLabel: string | undefined = undefined;\n\n\tif (state.changes.length > 0) {\n\t\tif (state.currentChange >= 0) {\n\t\t\tundo = () => {\n\t\t\t\tstoriesDispatch(state.changes[state.currentChange].undo);\n\t\t\t\tdispatch({type: 'updateCurrent', change: -1});\n\t\t\t};\n\t\t\tundoLabel = t('common.undoChange', {\n\t\t\t\tchange: t(state.changes[state.currentChange].description)\n\t\t\t});\n\t\t}\n\n\t\tif (state.currentChange < state.changes.length - 1) {\n\t\t\tredo = () => {\n\t\t\t\tstoriesDispatch(state.changes[state.currentChange + 1].redo);\n\t\t\t\tdispatch({type: 'updateCurrent', change: 1});\n\t\t\t};\n\t\t\tredoLabel = t('common.redoChange', {\n\t\t\t\tchange: t(state.changes[state.currentChange + 1].description)\n\t\t\t});\n\t\t}\n\t}\n\n\treturn (\n\t\t<UndoableStoriesContext.Provider\n\t\t\tvalue={{\n\t\t\t\tdispatch: dispatchAndRecordStoryAction,\n\t\t\t\tredo,\n\t\t\t\tredoLabel,\n\t\t\t\tstories,\n\t\t\t\tundo,\n\t\t\t\tundoLabel\n\t\t\t}}\n\t\t>\n\t\t\t{props.children}\n\t\t</UndoableStoriesContext.Provider>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {StoryFormat, sortFormats} from '../../store/story-formats';\nimport {TextSelect, TextSelectProps} from '../control/text-select';\n\nexport interface StoryFormatSelectProps\n\textends Omit<TextSelectProps, 'options' | 'value'> {\n\tformats: StoryFormat[];\n\tselectedFormat: StoryFormat;\n}\n\nexport const StoryFormatSelect: React.FC<StoryFormatSelectProps> = props => {\n\tconst {formats, selectedFormat, ...other} = props;\n\tconst {t} = useTranslation();\n\tconst loadingFormats = formats.filter(\n\t\tformat => format.loadState === 'loading'\n\t);\n\tconst visibleFormats = sortFormats(\n\t\tformats.filter(\n\t\t\tformat => format.loadState === 'loaded' || format.id === selectedFormat.id\n\t\t)\n\t);\n\tconst options = visibleFormats.map(format => ({\n\t\tdisabled: false,\n\t\tlabel: `${format.name} ${format.version}`,\n\t\tvalue: format.id\n\t}));\n\n\tif (loadingFormats.length !== 0) {\n\t\toptions.push({\n\t\t\tdisabled: true,\n\t\t\tlabel: t('components.storyFormatSelect.loadingCount', {\n\t\t\t\tloadingCount: loadingFormats.length\n\t\t\t}),\n\t\t\tvalue: ''\n\t\t});\n\t}\n\n\treturn <TextSelect {...other} options={options} value={selectedFormat.id} />;\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {storyStats, Story} from '../../store/stories';\nimport './story-stats.css';\n\nconst dateFormatter = new Intl.DateTimeFormat([], {\n\tdateStyle: 'full',\n\ttimeStyle: 'long'\n});\n\nexport interface StoryDetailsDialogStatsProps {\n\tstory: Story;\n}\n\nexport const StoryDetailsDialogStats: React.FC<StoryDetailsDialogStatsProps> = props => {\n\tconst {story} = props;\n\tconst stats = storyStats(story);\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<div className=\"story-stats\">\n\t\t\t<table className=\"counts\">\n\t\t\t\t<tbody>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>{stats.characters}</td>\n\t\t\t\t\t\t<td>{t('dialogs.storyDetails.stats.characters')}</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>{stats.words}</td>\n\t\t\t\t\t\t<td>{t('dialogs.storyDetails.stats.words')}</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>{stats.passages}</td>\n\t\t\t\t\t\t<td>{t('dialogs.storyDetails.stats.passages')}</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>{stats.links.length}</td>\n\t\t\t\t\t\t<td>{t('dialogs.storyDetails.stats.links')}</td>\n\t\t\t\t\t</tr>\n\t\t\t\t\t<tr>\n\t\t\t\t\t\t<td>{stats.brokenLinks.length}</td>\n\t\t\t\t\t\t<td>{t('dialogs.storyDetails.stats.brokenLinks')}</td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody>\n\t\t\t</table>\n\t\t\t<div className=\"update-and-ifid\">\n\t\t\t\t<p>\n\t\t\t\t\t{t('dialogs.storyDetails.stats.lastUpdate', {\n\t\t\t\t\t\tdate: dateFormatter.format(story.lastUpdate)\n\t\t\t\t\t})}\n\t\t\t\t</p>\n\t\t\t\t<p>\n\t\t\t\t\t{t('dialogs.storyDetails.stats.ifid', {ifid: story.ifid})}&nbsp;\n\t\t\t\t\t<a href=\"https://ifdb.org/help-ifid\" target=\"_blank\" rel=\"noreferrer\">\n\t\t\t\t\t\t{t('dialogs.storyDetails.stats.ifidExplanation')}\n\t\t\t\t\t</a>\n\t\t\t\t</p>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {CheckboxButton} from '../../components/control/checkbox-button';\nimport {ButtonBar} from '../../components/container/button-bar';\nimport {CardContent} from '../../components/container/card';\nimport {DialogCard} from '../../components/container/dialog-card';\nimport {StoryFormatSelect} from '../../components/story-format/story-format-select';\nimport {storyWithId, updateStory, useStoriesContext} from '../../store/stories';\nimport {\n\tformatWithId,\n\tformatWithNameAndVersion,\n\tuseStoryFormatsContext\n} from '../../store/story-formats';\nimport {FormatLoader} from '../../store/format-loader';\nimport {DialogComponentProps} from '../dialogs.types';\nimport {StoryDetailsDialogStats} from './story-stats';\n\nexport interface StoryDetailsDialogProps extends DialogComponentProps {\n\tstoryId: string;\n}\n\nexport const StoryDetailsDialog: React.FC<StoryDetailsDialogProps> = props => {\n\tconst {storyId, ...other} = props;\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst {formats} = useStoryFormatsContext();\n\tconst story = storyWithId(stories, storyId);\n\tconst {t} = useTranslation();\n\n\tfunction handleFormatChange(event: React.ChangeEvent<HTMLSelectElement>) {\n\t\tconst newFormat = formatWithId(formats, event.target.value);\n\n\t\tdispatch(\n\t\t\tupdateStory(stories, story, {\n\t\t\t\tstoryFormat: newFormat.name,\n\t\t\t\tstoryFormatVersion: newFormat.version\n\t\t\t})\n\t\t);\n\t}\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...other}\n\t\t\tclassName=\"story-details-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={story.name}\n\t\t>\n\t\t\t<div className=\"story-format\">\n\t\t\t\t<FormatLoader block={false} />\n\t\t\t\t<StoryFormatSelect\n\t\t\t\t\tformats={formats}\n\t\t\t\t\tonChange={handleFormatChange}\n\t\t\t\t\tselectedFormat={formatWithNameAndVersion(\n\t\t\t\t\t\tformats,\n\t\t\t\t\t\tstory.storyFormat,\n\t\t\t\t\t\tstory.storyFormatVersion\n\t\t\t\t\t)}\n\t\t\t\t>\n\t\t\t\t\t{t('common.storyFormat')}\n\t\t\t\t</StoryFormatSelect>\n\t\t\t\t<a\n\t\t\t\t\thref=\"https://twinery.org/2storyformats\"\n\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\trel=\"noreferrer\"\n\t\t\t\t>\n\t\t\t\t\t{t('dialogs.storyDetails.storyFormatExplanation')}\n\t\t\t\t</a>\n\t\t\t</div>\n\t\t\t<ButtonBar>\n\t\t\t\t<CheckboxButton\n\t\t\t\t\tlabel={t('dialogs.storyDetails.snapToGrid')}\n\t\t\t\t\tonChange={value =>\n\t\t\t\t\t\tdispatch(updateStory(stories, story, {snapToGrid: value}))\n\t\t\t\t\t}\n\t\t\t\t\tvalue={story.snapToGrid}\n\t\t\t\t/>\n\t\t\t</ButtonBar>\n\t\t\t<CardContent>\n\t\t\t\t{!other.collapsed && <StoryDetailsDialogStats story={story} />}\n\t\t\t</CardContent>\n\t\t</DialogCard>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {TextInput} from './text-input';\nimport {TextSelect} from './text-select';\nimport './font-select.css';\n\nconst families = ['var(--font-monospaced)', 'var(--font-system)'];\nconst scales = [0.8, 0.9, 1, 1.25, 1.5, 2];\n\nexport interface FontSelectProps {\n\tfamilyLabel: string;\n\tfontFamily: string;\n\tfontScale: number;\n\tonChangeFamily: (value: string) => void;\n\tonChangeScale: (value: number) => void;\n\tscaleLabel: string;\n}\n\nexport const FontSelect: React.FC<FontSelectProps> = props => {\n\tconst {\n\t\tfamilyLabel,\n\t\tfontFamily,\n\t\tfontScale,\n\t\tonChangeFamily,\n\t\tonChangeScale,\n\t\tscaleLabel\n\t} = props;\n\tconst [customScaleVisible, setCustomScaleVisible] = React.useState(\n\t\t!scales.includes(fontScale)\n\t);\n\tconst [customFamilyVisible, setCustomFamilyVisible] = React.useState(\n\t\t!families.includes(fontFamily)\n\t);\n\tconst [customFamily, setCustomFamily] = React.useState(fontFamily);\n\tconst [customScale, setCustomScale] = React.useState(\n\t\t(fontScale * 100).toString()\n\t);\n\tconst {t} = useTranslation();\n\n\tfunction handleFamilyChange(event: React.ChangeEvent<HTMLSelectElement>) {\n\t\tif (event.target.value === 'custom') {\n\t\t\tsetCustomFamilyVisible(true);\n\t\t\tif (families.includes(customFamily)) {\n\t\t\t\tsetCustomFamily('');\n\t\t\t}\n\t\t} else {\n\t\t\tsetCustomFamilyVisible(false);\n\t\t\tonChangeFamily(event.target.value);\n\t\t}\n\t}\n\n\tfunction handleScaleChange(event: React.ChangeEvent<HTMLSelectElement>) {\n\t\tif (event.target.value === 'custom') {\n\t\t\tsetCustomScaleVisible(true);\n\t\t} else {\n\t\t\tsetCustomScaleVisible(false);\n\t\t\tonChangeScale(parseFloat(event.target.value));\n\t\t}\n\t}\n\n\tfunction handleCustomFamilyChange(\n\t\tevent: React.ChangeEvent<HTMLInputElement>\n\t) {\n\t\tsetCustomFamily(event.target.value);\n\n\t\tif (event.target.value.trim() !== '') {\n\t\t\tonChangeFamily(event.target.value);\n\t\t}\n\t}\n\n\tfunction handleCustomScaleChange(event: React.ChangeEvent<HTMLInputElement>) {\n\t\tsetCustomScale(event.target.value);\n\n\t\tconst value = parseInt(event.target.value);\n\n\t\tif (Number.isFinite(value)) {\n\t\t\tonChangeScale(value / 100);\n\t\t}\n\t}\n\n\treturn (\n\t\t<div className=\"font-select\">\n\t\t\t<TextSelect\n\t\t\t\tonChange={handleFamilyChange}\n\t\t\t\toptions={[\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: t('components.fontSelect.fonts.system'),\n\t\t\t\t\t\tvalue: 'var(--font-system)'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: t('components.fontSelect.fonts.monospaced'),\n\t\t\t\t\t\tvalue: 'var(--font-monospaced)'\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: t('common.custom'),\n\t\t\t\t\t\tvalue: 'custom'\n\t\t\t\t\t}\n\t\t\t\t]}\n\t\t\t\tvalue={customFamilyVisible ? 'custom' : fontFamily}\n\t\t\t>\n\t\t\t\t{familyLabel}\n\t\t\t</TextSelect>\n\t\t\t{customFamilyVisible && (\n\t\t\t\t<TextInput\n\t\t\t\t\tonChange={handleCustomFamilyChange}\n\t\t\t\t\torientation=\"vertical\"\n\t\t\t\t\tvalue={customFamily}\n\t\t\t\t>\n\t\t\t\t\t{t('components.fontSelect.customFamilyDetail')}\n\t\t\t\t</TextInput>\n\t\t\t)}\n\t\t\t<TextSelect\n\t\t\t\tonChange={handleScaleChange}\n\t\t\t\toptions={[\n\t\t\t\t\t...scales.map(scale => ({\n\t\t\t\t\t\tlabel: t('components.fontSelect.percentage', {\n\t\t\t\t\t\t\tpercent: scale * 100\n\t\t\t\t\t\t}),\n\t\t\t\t\t\tvalue: scale.toString()\n\t\t\t\t\t})),\n\t\t\t\t\t{label: t('common.custom'), value: 'custom'}\n\t\t\t\t]}\n\t\t\t\tvalue={customScaleVisible ? 'custom' : fontScale.toString()}\n\t\t\t>\n\t\t\t\t{scaleLabel}\n\t\t\t</TextSelect>\n\t\t\t{customScaleVisible && (\n\t\t\t\t<TextInput\n\t\t\t\t\tonChange={handleCustomScaleChange}\n\t\t\t\t\torientation=\"vertical\"\n\t\t\t\t\tvalue={customScale}\n\t\t\t\t>\n\t\t\t\t\t{t('components.fontSelect.customScaleDetail')}\n\t\t\t\t</TextInput>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n","/**\n * Locales supported in the app.\n * @see https://en.wikipedia.org/wiki/List_of_ISO_639-1_codes\n */\nexport const locales = [\n\t{code: 'ca', name: 'Catal'},\n\t{code: 'cs', name: 'etina'},\n\t{code: 'da', name: 'Dansk'},\n\t{code: 'de', name: 'Deutsch'},\n\t{code: 'en', name: 'English'},\n\t{code: 'es', name: 'Castellano'},\n\t{code: 'fi', name: 'Suomi'},\n\t{code: 'fr', name: 'Franais'},\n\t{code: 'it', name: 'Italiano'},\n\t{code: 'ms', name: 'Bahasa Melayu'},\n\t{code: 'nb', name: 'Norsk bokml'},\n\t{code: 'nl', name: 'Nederlands'},\n\t{code: 'pt-br', name: 'Portugus Brasileiro'},\n\t{code: 'pt-pt', name: 'Portugus'},\n\t{code: 'ru', name: ''},\n\t{code: 'sv', name: 'Svenska'},\n\t{code: 'tr', name: 'Trke'},\n\t{code: 'zh-cn', name: '()'}\n];\n\n/**\n * Finds the closest match for a locale in app-supported locales, for example\n * mapping `en-US` to `en`. If none are plausible, this returns `en` as a\n * default.\n */\nexport function closestAppLocale(code: string) {\n\t// Exact match? \n\n\tif (locales.some(locale => locale.code === code)) {\n\t\treturn code;\n\t}\n\n\tif (code.includes('-')) {\n\t\tconst roughCode = code.replace(/-.+/, '');\n\t\tconst roughMatch = locales.find(locale => locale.code === roughCode || locale.code.replace(/-.+/, '') === roughCode);\n\n\t\tif (roughMatch) {\n\t\t\treturn roughMatch.code;\n\t\t}\n\t}\n\n\treturn 'en';\n}","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {CardContent} from '../components/container/card';\nimport {DialogCard, DialogCardProps} from '../components/container/dialog-card';\nimport {CheckboxButton} from '../components/control/checkbox-button';\nimport {FontSelect} from '../components/control/font-select';\nimport {TextSelect} from '../components/control/text-select';\nimport {setPref, usePrefsContext} from '../store/prefs';\nimport {closestAppLocale, locales} from '../util/locales';\nimport './app-prefs.css';\n\nexport const AppPrefsDialog: React.FC<\n\tOmit<DialogCardProps, 'headerLabel'>\n> = props => {\n\tconst {dispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...props}\n\t\t\tclassName=\"app-prefs-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={t('dialogs.appPrefs.title')}\n\t\t>\n\t\t\t<CardContent>\n\t\t\t\t<TextSelect\n\t\t\t\t\tonChange={e => dispatch(setPref('locale', e.target.value))}\n\t\t\t\t\toptions={locales.map(locale => ({\n\t\t\t\t\t\tlabel: locale.name,\n\t\t\t\t\t\tvalue: locale.code\n\t\t\t\t\t}))}\n\t\t\t\t\tvalue={closestAppLocale(prefs.locale)}\n\t\t\t\t>\n\t\t\t\t\t{t('dialogs.appPrefs.language')}\n\t\t\t\t</TextSelect>\n\t\t\t\t<TextSelect\n\t\t\t\t\tonChange={e => dispatch(setPref('appTheme', e.target.value))}\n\t\t\t\t\toptions={[\n\t\t\t\t\t\t{label: t('dialogs.appPrefs.themeSystem'), value: 'system'},\n\t\t\t\t\t\t{label: t('dialogs.appPrefs.themeLight'), value: 'light'},\n\t\t\t\t\t\t{label: t('dialogs.appPrefs.themeDark'), value: 'dark'}\n\t\t\t\t\t]}\n\t\t\t\t\tvalue={prefs.appTheme}\n\t\t\t\t>\n\t\t\t\t\t{t('dialogs.appPrefs.theme')}\n\t\t\t\t</TextSelect>\n\t\t\t\t<CheckboxButton\n\t\t\t\t\tlabel={t('dialogs.appPrefs.editorCursorBlinks')}\n\t\t\t\t\tonChange={value => dispatch(setPref('editorCursorBlinks', value))}\n\t\t\t\t\tvalue={prefs.editorCursorBlinks}\n\t\t\t\t/>\n\t\t\t\t<p className=\"font-explanation\">\n\t\t\t\t\t{t('dialogs.appPrefs.fontExplanation')}\n\t\t\t\t</p>\n\t\t\t\t<FontSelect\n\t\t\t\t\tfamilyLabel={t('dialogs.appPrefs.passageEditorFont')}\n\t\t\t\t\tfontFamily={prefs.passageEditorFontFamily}\n\t\t\t\t\tfontScale={prefs.passageEditorFontScale}\n\t\t\t\t\tonChangeFamily={value =>\n\t\t\t\t\t\tdispatch(setPref('passageEditorFontFamily', value))\n\t\t\t\t\t}\n\t\t\t\t\tonChangeScale={value =>\n\t\t\t\t\t\tdispatch(setPref('passageEditorFontScale', value))\n\t\t\t\t\t}\n\t\t\t\t\tscaleLabel={t('dialogs.appPrefs.passageEditorFontScale')}\n\t\t\t\t/>\n\t\t\t\t<FontSelect\n\t\t\t\t\tfamilyLabel={t('dialogs.appPrefs.codeEditorFont')}\n\t\t\t\t\tfontFamily={prefs.codeEditorFontFamily}\n\t\t\t\t\tfontScale={prefs.codeEditorFontScale}\n\t\t\t\t\tonChangeFamily={value =>\n\t\t\t\t\t\tdispatch(setPref('codeEditorFontFamily', value))\n\t\t\t\t\t}\n\t\t\t\t\tonChangeScale={value =>\n\t\t\t\t\t\tdispatch(setPref('codeEditorFontScale', value))\n\t\t\t\t\t}\n\t\t\t\t\tscaleLabel={t('dialogs.appPrefs.codeEditorFontScale')}\n\t\t\t\t/>\n\t\t\t</CardContent>\n\t\t</DialogCard>\n\t);\n};\n","import * as React from 'react';\nimport {usePersistence} from '../persistence/use-persistence';\nimport {useStoreErrorReporter} from '../use-store-error-reporter';\nimport {defaults} from './defaults';\nimport {PrefsAction, PrefsContextProps, PrefsState} from './prefs.types';\nimport {reducer} from './reducer';\n\nexport const PrefsContext = React.createContext<PrefsContextProps>({\n\tdispatch: () => {},\n\tprefs: defaults()\n});\n\nPrefsContext.displayName = 'Prefs';\n\nexport const usePrefsContext = () => React.useContext(PrefsContext);\n\nexport const PrefsContextProvider: React.FC = props => {\n\tconst {prefs} = usePersistence();\n\tconst {reportError} = useStoreErrorReporter();\n\tconst persistedReducer: React.Reducer<\n\t\tPrefsState,\n\t\tPrefsAction\n\t> = React.useCallback(\n\t\t(state, action) => {\n\t\t\tconst newState = reducer(state, action);\n\n\t\t\ttry {\n\t\t\t\tprefs.saveMiddleware(newState, action);\n\t\t\t} catch (error) {\n\t\t\t\treportError(error, 'store.errors.cantPersistPrefs');\n\t\t\t}\n\n\t\t\treturn newState;\n\t\t},\n\t\t[prefs, reportError]\n\t);\n\n\tconst [state, dispatch] = React.useReducer(persistedReducer, defaults());\n\n\treturn (\n\t\t<PrefsContext.Provider\n\t\t\tvalue={{\n\t\t\t\tdispatch,\n\t\t\t\tprefs: state\n\t\t\t}}\n\t\t>\n\t\t\t{props.children}\n\t\t</PrefsContext.Provider>\n\t);\n};\n","import {PrefsAction, PrefsState} from './prefs.types';\nimport {defaults} from './defaults';\nimport {formatWithNameAndVersion, newestFormatNamed} from '../story-formats';\n\nexport const reducer: React.Reducer<PrefsState, PrefsAction> = (\n\tstate,\n\taction\n) => {\n\tswitch (action.type) {\n\t\tcase 'init':\n\t\t\treturn {...state, ...action.state};\n\n\t\tcase 'repair':\n\t\t\tconst defs = defaults();\n\n\t\t\t// Type check values.\n\n\t\t\tlet changes: Partial<PrefsState> = Object.entries(defs).reduce(\n\t\t\t\t(result, [key, value]) => {\n\t\t\t\t\tconst prefKey = key as keyof PrefsState;\n\n\t\t\t\t\tif (\n\t\t\t\t\t\t(typeof value === 'number' && !Number.isFinite(state[prefKey])) ||\n\t\t\t\t\t\ttypeof value !== typeof state[prefKey]\n\t\t\t\t\t) {\n\t\t\t\t\t\tconsole.info(\n\t\t\t\t\t\t\t`Repairing preference \"${key}\" by setting it to ${value}, ` +\n\t\t\t\t\t\t\t\t`was ${state[prefKey]} (bad type)`\n\t\t\t\t\t\t);\n\t\t\t\t\t\treturn {...result, [prefKey]: value};\n\t\t\t\t\t}\n\n\t\t\t\t\treturn result;\n\t\t\t\t},\n\t\t\t\t{}\n\t\t\t);\n\n\t\t\t// If the proofing or story format don't match an existing format, repair\n\t\t\t// them to the most recent version with the same name. If none exist with\n\t\t\t// that name, repair to the default.\n\n\t\t\tconst {proofingFormat, storyFormat} = state;\n\t\t\tconst {allFormats} = action;\n\n\t\t\ttry {\n\t\t\t\tformatWithNameAndVersion(\n\t\t\t\t\tallFormats,\n\t\t\t\t\tproofingFormat.name,\n\t\t\t\t\tproofingFormat.version\n\t\t\t\t);\n\t\t\t} catch {\n\t\t\t\tconst format = newestFormatNamed(allFormats, proofingFormat.name);\n\n\t\t\t\tif (format) {\n\t\t\t\t\tconsole.info(\n\t\t\t\t\t\t`Repairing proofing format preference (version doesn't exist) by setting to ${format.name} ${format.version}, was ${proofingFormat.name} ${proofingFormat.version}`\n\t\t\t\t\t);\n\t\t\t\t\tchanges.proofingFormat = {name: format.name, version: format.version};\n\t\t\t\t} else {\n\t\t\t\t\tconsole.info(\n\t\t\t\t\t\t`Repairing proofing format preference (format doesn't exist at all) by setting to default ${defs.proofingFormat.name} ${defs.proofingFormat.version}, was ${proofingFormat.name} ${proofingFormat.version}`\n\t\t\t\t\t);\n\t\t\t\t\tchanges.proofingFormat = {\n\t\t\t\t\t\tname: defs.proofingFormat.name,\n\t\t\t\t\t\tversion: defs.proofingFormat.version\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tformatWithNameAndVersion(\n\t\t\t\t\tallFormats,\n\t\t\t\t\tstoryFormat.name,\n\t\t\t\t\tstoryFormat.version\n\t\t\t\t);\n\t\t\t} catch {\n\t\t\t\tconst format = newestFormatNamed(allFormats, storyFormat.name);\n\n\t\t\t\tif (format) {\n\t\t\t\t\tconsole.info(\n\t\t\t\t\t\t`Repairing story format preference (version doesn't exist) by setting to ${format.name} ${format.version}, was ${storyFormat.name} ${storyFormat.version}`\n\t\t\t\t\t);\n\t\t\t\t\tchanges.storyFormat = {name: format.name, version: format.version};\n\t\t\t\t} else {\n\t\t\t\t\tconsole.info(\n\t\t\t\t\t\t`Repairing story format preference (format doesn't exist at all) by setting to default ${defs.storyFormat.name} ${defs.storyFormat.version}, was ${storyFormat.name} ${proofingFormat.version}`\n\t\t\t\t\t);\n\t\t\t\t\tchanges.storyFormat = {\n\t\t\t\t\t\tname: defs.storyFormat.name,\n\t\t\t\t\t\tversion: defs.storyFormat.version\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn {...state, ...changes};\n\n\t\tcase 'update': {\n\t\t\treturn {...state, [action.name]: action.value};\n\t\t}\n\t}\n};\n","import uuid from 'tiny-uuid';\nimport * as React from 'react';\nimport useThunkReducer from 'react-hook-thunk-reducer';\nimport {usePersistence} from '../persistence/use-persistence';\nimport {builtins} from './defaults';\nimport {\n\tStoryFormat,\n\tStoryFormatsAction,\n\tStoryFormatsContextProps,\n\tStoryFormatsState\n} from './story-formats.types';\nimport {useStoreErrorReporter} from '../use-store-error-reporter';\nimport {reducer} from './reducer';\n\nconst defaultBuiltins: StoryFormat[] = builtins().map(f => ({\n\t...f,\n\tid: uuid(),\n\tloadState: 'unloaded',\n\tselected: false,\n\tuserAdded: false\n}));\n\nexport const StoryFormatsContext = React.createContext<StoryFormatsContextProps>(\n\t{\n\t\tdispatch: () => {},\n\t\tformats: []\n\t}\n);\n\nStoryFormatsContext.displayName = 'StoryFormats';\n\nexport const useStoryFormatsContext = () =>\n\tReact.useContext(StoryFormatsContext);\n\nexport const StoryFormatsContextProvider: React.FC = props => {\n\tconst {storyFormats} = usePersistence();\n\tconst {reportError} = useStoreErrorReporter();\n\tconst persistedReducer: React.Reducer<\n\t\tStoryFormatsState,\n\t\tStoryFormatsAction\n\t> = React.useCallback(\n\t\t(state, action) => {\n\t\t\tconst newState = reducer(state, action);\n\n\t\t\ttry {\n\t\t\t\tstoryFormats.saveMiddleware(newState, action);\n\t\t\t} catch (error) {\n\t\t\t\treportError(error, 'store.errors.cantPersistStoryFormats');\n\t\t\t}\n\t\t\treturn newState;\n\t\t},\n\t\t[reportError, storyFormats]\n\t);\n\n\tconst [state, dispatch] = useThunkReducer(persistedReducer, defaultBuiltins);\n\n\treturn (\n\t\t<StoryFormatsContext.Provider\n\t\t\tvalue={{\n\t\t\t\tdispatch,\n\t\t\t\tformats: state\n\t\t\t}}\n\t\t>\n\t\t\t{props.children}\n\t\t</StoryFormatsContext.Provider>\n\t);\n};\n","import uuid from 'tiny-uuid';\nimport {builtins} from './defaults';\nimport {\n\tStoryFormat,\n\tStoryFormatsAction,\n\tStoryFormatsState\n} from './story-formats.types';\n\nexport const reducer: React.Reducer<StoryFormatsState, StoryFormatsAction> = (\n\tstate,\n\taction\n) => {\n\tswitch (action.type) {\n\t\tcase 'init':\n\t\t\treturn [...action.state];\n\n\t\tcase 'repair':\n\t\t\tconst builtinFormats = builtins();\n\n\t\t\t// Filter out any outdated builtins.\n\n\t\t\tconst result = state.filter(format => {\n\t\t\t\tconst keep =\n\t\t\t\t\tformat.userAdded ||\n\t\t\t\t\tbuiltinFormats.some(\n\t\t\t\t\t\tf => f.name === format.name && f.version === format.version\n\t\t\t\t\t);\n\n\t\t\t\tif (!keep) {\n\t\t\t\t\tconsole.info(\n\t\t\t\t\t\t`Repairing story formats by removing ${format.name} ${format.version} ` +\n\t\t\t\t\t\t\t`(outdated version of built-in format)`\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\treturn keep;\n\t\t\t});\n\n\t\t\t// Add any builtins not present.\n\n\t\t\tbuiltinFormats.forEach(builtinFormat => {\n\t\t\t\tif (\n\t\t\t\t\t!result.some(\n\t\t\t\t\t\tf =>\n\t\t\t\t\t\t\tf.name === builtinFormat.name &&\n\t\t\t\t\t\t\tf.version === builtinFormat.version\n\t\t\t\t\t)\n\t\t\t\t) {\n\t\t\t\t\tconsole.info(\n\t\t\t\t\t\t`Repairing story formats by adding built-in ${builtinFormat.name} ${builtinFormat.version}`\n\t\t\t\t\t);\n\t\t\t\t\tresult.push({\n\t\t\t\t\t\t...builtinFormat,\n\t\t\t\t\t\tid: uuid(),\n\t\t\t\t\t\tloadState: 'unloaded',\n\t\t\t\t\t\tselected: false,\n\t\t\t\t\t\tuserAdded: false\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t\treturn result;\n\n\t\tcase 'create':\n\t\t\tif (\n\t\t\t\tstate.some(\n\t\t\t\t\tformat =>\n\t\t\t\t\t\tformat.name === action.props.name &&\n\t\t\t\t\t\tformat.version === action.props.version\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\treturn state;\n\t\t\t}\n\n\t\t\treturn [...state, {...action.props, id: uuid(), loadState: 'unloaded'}];\n\n\t\tcase 'delete':\n\t\t\treturn state.filter(f => f.id !== action.id);\n\n\t\tcase 'update':\n\t\t\tif (\n\t\t\t\tstate.some(\n\t\t\t\t\tformat =>\n\t\t\t\t\t\tformat.id !== action.id &&\n\t\t\t\t\t\tformat.name === action.props.name &&\n\t\t\t\t\t\tformat.version === action.props.version\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\treturn state;\n\t\t\t}\n\n\t\t\treturn state.map(format => {\n\t\t\t\tif (format.id !== action.id) {\n\t\t\t\t\treturn format;\n\t\t\t\t}\n\n\t\t\t\treturn {...format, ...action.props} as StoryFormat;\n\t\t\t});\n\t}\n\n\treturn state;\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconCode, IconHeart} from '@tabler/icons';\nimport {ButtonBar} from '../../components/container/button-bar';\nimport {DialogCard} from '../../components/container/dialog-card';\nimport {IconLink} from '../../components/control/icon-link';\nimport {getAppInfo} from '../../util/app-info';\nimport {DialogComponentProps} from '../dialogs.types';\nimport credits from './credits.json';\nimport './about-twine.css';\n\nexport const AboutTwineDialog: React.FC<DialogComponentProps> = props => {\n\tconst {t} = useTranslation();\n\tconst info = getAppInfo();\n\n\treturn (\n\t\t<DialogCard\n\t\t\t{...props}\n\t\t\tclassName=\"about-twine-dialog\"\n\t\t\tfixedSize\n\t\t\theaderLabel={t('dialogs.aboutTwine.title', {\n\t\t\t\tversion: info.version\n\t\t\t})}\n\t\t>\n\t\t\t<div className=\"content\">\n\t\t\t\t<p>{t('dialogs.aboutTwine.twineDescription')}</p>\n\t\t\t\t<p\n\t\t\t\t\tdangerouslySetInnerHTML={{\n\t\t\t\t\t\t__html: t('dialogs.aboutTwine.license')\n\t\t\t\t\t}}\n\t\t\t\t/>\n\t\t\t\t<div className=\"credits\">\n\t\t\t\t\t<div className=\"code\">\n\t\t\t\t\t\t<h3>{t('dialogs.aboutTwine.codeHeader')}</h3>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t{credits.code.map(c => (\n\t\t\t\t\t\t\t\t<li key={c}>{c}</li>\n\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div className=\"localizations\">\n\t\t\t\t\t\t<h3>{t('dialogs.aboutTwine.localizationHeader')}</h3>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t{credits.localizations.map(c => (\n\t\t\t\t\t\t\t\t<li key={c}>{c}</li>\n\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<ButtonBar>\n\t\t\t\t\t<IconLink\n\t\t\t\t\t\thref=\"https://twinery.org/donate\"\n\t\t\t\t\t\ticon={<IconHeart />}\n\t\t\t\t\t\tlabel={t('dialogs.aboutTwine.donateToTwine')}\n\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t/>\n\t\t\t\t\t<IconLink\n\t\t\t\t\t\thref=\"https://github.com/klembot/twinejs\"\n\t\t\t\t\t\ticon={<IconCode />}\n\t\t\t\t\t\tlabel={t('dialogs.aboutTwine.codeRepo')}\n\t\t\t\t\t/>\n\t\t\t\t</ButtonBar>\n\t\t\t</div>\n\t\t</DialogCard>\n\t);\n};\n","import * as React from 'react';\nimport {IconLoading} from '../image/icon';\nimport './loading-curtain.css';\n\nexport const LoadingCurtain: React.FC = () => (\n\t<div className=\"loading-curtain\">\n\t\t<IconLoading />\n\t</div>\n);\n","// Listens to changes in the locale preference and changes i18n's language\n// accordingly.\n\nimport * as React from 'react';\nimport {usePrefsContext} from './prefs';\nimport {i18n} from '../util/i18n';\n\nexport const LocaleSwitcher: React.FC = () => {\n\tconst {prefs} = usePrefsContext();\n\n\tReact.useEffect(() => {\n\t\ti18n.changeLanguage(prefs.locale);\n\t}, [prefs.locale]);\n\n\treturn null;\n};\n","import * as React from 'react';\nimport 'element-closest';\n\nexport interface ClickAwayListenerProps {\n\tignoreSelector?: string;\n\tonClickAway: () => void;\n}\n\nexport const ClickAwayListener: React.FC<ClickAwayListenerProps> = props => {\n\tconst {children, ignoreSelector, onClickAway} = props;\n\tconst handleClick: React.MouseEventHandler = event => {\n\t\tif (ignoreSelector) {\n\t\t\tif (!(event.target as HTMLElement)?.closest(ignoreSelector)) {\n\t\t\t\tonClickAway();\n\t\t\t}\n\t\t} else {\n\t\t\tonClickAway();\n\t\t}\n\t};\n\n\treturn <div onClick={handleClick}>{children}</div>;\n};\n","import * as React from 'react';\nimport './card-group.css';\n\nexport type CardGroupProps =\n\t| {columns: number; maxWidth?: string}\n\t| {columnWidth: number | string; maxWidth?: string};\n\nexport const CardGroup: React.FC<CardGroupProps> = props => {\n\tconst style: React.CSSProperties = {\n\t\tgridTemplateColumns:\n\t\t\t'columnWidth' in props\n\t\t\t\t? `repeat(auto-fit, ${\n\t\t\t\t\t\ttypeof props.columnWidth === 'number'\n\t\t\t\t\t\t\t? props.columnWidth + 'px'\n\t\t\t\t\t\t\t: props.columnWidth\n\t\t\t\t  })`\n\t\t\t\t: `repeat(${props.columns}, 1fr)`,\n\t\tmaxWidth: props.maxWidth ?? 'auto'\n\t};\n\n\treturn (\n\t\t<div className=\"card-group\" style={style}>\n\t\t\t{props.children}\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {Helmet} from 'react-helmet';\nimport {isElectronRenderer} from '../../util/is-electron';\n\nexport interface DocumentTitleProps {\n\ttitle: string;\n}\n\n/**\n * Sets the document title. This works around a bug with Electron and may not be\n * needed in later versions.\n */\nexport const DocumentTitle: React.FC<DocumentTitleProps> = ({title}) => {\n\t// Using `history.goBack()` doesn't seem to cause Electron to update the\n\t// window title bar--possibly tied to using a <HashRouter>. If it does in a\n\t// future version, we can just use react-helmet directly.\n\n\tReact.useEffect(() => {\n\t\tif (isElectronRenderer()) {\n\t\t\tconst timeout = window.setTimeout(() => {\n\t\t\t\tdocument.querySelector('title')!.innerHTML = title;\n\t\t\t}, 0);\n\n\t\t\treturn () => window.clearTimeout(timeout);\n\t\t}\n\t}, [title]);\n\n\treturn (\n\t\t<Helmet>\n\t\t\t<title>{title}</title>\n\t\t</Helmet>\n\t);\n};\n","import classNames from 'classnames';\nimport * as React from 'react';\nimport {Point} from '../../util/geometry';\nimport {DocumentTitle} from '../document-title/document-title';\nimport './main-content.css';\n\nexport interface MainContentProps\n\textends React.ComponentPropsWithoutRef<'div'> {\n\tgrabbable?: boolean;\n\tpadded?: boolean;\n\ttitle?: string;\n}\n\nexport const MainContent = React.forwardRef<HTMLDivElement, MainContentProps>(\n\t(props, ref) => {\n\t\tconst {children, grabbable, title} = props;\n\t\tconst containerRef = React.useRef<HTMLDivElement>(null);\n\t\tconst className = classNames('main-content', {\n\t\t\tpadded: props.padded ?? true\n\t\t});\n\n\t\tReact.useImperativeHandle(\n\t\t\tref,\n\t\t\t() => containerRef.current as HTMLDivElement\n\t\t);\n\n\t\tReact.useEffect(() => {\n\t\t\tif (containerRef.current) {\n\t\t\t\tcontainerRef.current.focus();\n\t\t\t}\n\t\t}, []);\n\n\t\tReact.useEffect(() => {\n\t\t\tconst container = containerRef.current;\n\t\t\tlet dragScrollStart: Point;\n\t\t\tlet dragMouseStart: Point;\n\n\t\t\tfunction moveListener(event: PointerEvent) {\n\t\t\t\tif (container) {\n\t\t\t\t\tcontainer.scrollLeft =\n\t\t\t\t\t\tdragScrollStart.left + (dragMouseStart.left - event.clientX);\n\t\t\t\t\tcontainer.scrollTop =\n\t\t\t\t\t\tdragScrollStart.top + (dragMouseStart.top - event.clientY);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfunction upListener(event: PointerEvent) {\n\t\t\t\tif (event.button !== 2 || !container) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tcontainer.releasePointerCapture(event.pointerId);\n\t\t\t\tcontainer.removeEventListener('pointermove', moveListener);\n\t\t\t\tcontainer.style.cursor = '';\n\t\t\t\tevent.preventDefault();\n\t\t\t}\n\n\t\t\tfunction downListener(event: PointerEvent) {\n\t\t\t\tif (event.button !== 2 || !container) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tcontainer.setPointerCapture(event.pointerId);\n\t\t\t\tcontainer.addEventListener('pointermove', moveListener);\n\t\t\t\tcontainer.addEventListener('pointerup', upListener);\n\t\t\t\tcontainer.style.cursor = 'grabbing';\n\t\t\t\tdragScrollStart = {\n\t\t\t\t\tleft: container.scrollLeft,\n\t\t\t\t\ttop: container.scrollTop\n\t\t\t\t};\n\t\t\t\tdragMouseStart = {left: event.clientX, top: event.clientY};\n\t\t\t\tevent.preventDefault();\n\t\t\t}\n\n\t\t\tfunction ignoreContext(event: Event) {\n\t\t\t\tevent.preventDefault();\n\t\t\t}\n\n\t\t\tif (grabbable && container) {\n\t\t\t\tcontainer.addEventListener('pointerdown', downListener);\n\t\t\t\tcontainer.addEventListener('contextmenu', ignoreContext);\n\t\t\t\treturn () => {\n\t\t\t\t\tcontainer.removeEventListener('pointerdown', downListener);\n\t\t\t\t\tcontainer.removeEventListener('contextmenu', ignoreContext);\n\t\t\t\t};\n\t\t\t}\n\t\t}, [grabbable]);\n\n\t\treturn (\n\t\t\t<div className={className} ref={containerRef}>\n\t\t\t\t{title && (\n\t\t\t\t\t<>\n\t\t\t\t\t\t<DocumentTitle title={title} />\n\t\t\t\t\t\t<h1>{title}</h1>\n\t\t\t\t\t</>\n\t\t\t\t)}\n\t\t\t\t{children}\n\t\t\t</div>\n\t\t);\n\t}\n);\n","import * as React from 'react';\nimport './badge.css';\n\nexport interface BadgeProps {\n\tlabel: string;\n}\n\nexport const Badge: React.FC<BadgeProps> = ({label}) => (\n\t<span className=\"badge\">{label}</span>\n);\n","import classNames from 'classnames';\nimport * as React from 'react';\nimport {Card, CardProps} from './card';\nimport './selectable-card.css';\n\nexport interface SelectableCardProps extends CardProps {\n\tlabel: string;\n\tonDoubleClick?: React.MouseEventHandler;\n\tonSelect: (value: boolean, exclusive: boolean) => void;\n\tselected?: boolean;\n}\n\nexport const SelectableCard: React.FC<SelectableCardProps> = props => {\n\tconst {label, onDoubleClick, onSelect, selected, ...other} = props;\n\tconst onClick = React.useCallback(\n\t\t(event: React.MouseEvent) => {\n\t\t\tif (event.ctrlKey || event.shiftKey) {\n\t\t\t\tonSelect(!selected, false);\n\t\t\t} else {\n\t\t\t\tonSelect(true, true);\n\t\t\t}\n\t\t},\n\t\t[onSelect, selected]\n\t);\n\tconst onKeyDown = React.useCallback(\n\t\t(event: React.KeyboardEvent) => {\n\t\t\tif (event.key === ' ' || event.key === 'Enter') {\n\t\t\t\tevent.preventDefault();\n\n\t\t\t\tif (event.ctrlKey || event.shiftKey) {\n\t\t\t\t\tonSelect(!selected, false);\n\t\t\t\t} else {\n\t\t\t\t\tonSelect(true, true);\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\t[onSelect, selected]\n\t);\n\n\treturn (\n\t\t<div\n\t\t\tclassName={classNames('selectable-card', {selected})}\n\t\t\trole=\"button\"\n\t\t\taria-label={label}\n\t\t\taria-pressed={selected}\n\t\t\tonClick={onClick}\n\t\t\tonDoubleClick={onDoubleClick}\n\t\t\tonKeyDown={onKeyDown}\n\t\t\ttabIndex={0}\n\t\t>\n\t\t\t<Card {...other} />\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {StoryFormat} from '../../../store/story-formats';\n\nexport interface StoryFormatCardDetailsProps {\n\tformat: StoryFormat;\n}\n\nexport const StoryFormatCardDetails: React.FC<StoryFormatCardDetailsProps> = ({\n\tformat\n}) => {\n\tconst {t} = useTranslation();\n\n\tif (format.loadState === 'unloaded' || format.loadState === 'loading') {\n\t\treturn (\n\t\t\t<div className=\"story-format-card-details\">\n\t\t\t\t<p>{t('components.storyFormatCard.loadingFormat')}</p>\n\t\t\t</div>\n\t\t);\n\t}\n\n\tif (format.loadState === 'error') {\n\t\treturn (\n\t\t\t<div className=\"story-format-card-details\">\n\t\t\t\t<p>\n\t\t\t\t\t{t('components.storyFormatCard.loadError', {\n\t\t\t\t\t\terrorMessage: format.loadError.message\n\t\t\t\t\t})}\n\t\t\t\t</p>\n\t\t\t</div>\n\t\t);\n\t}\n\n\treturn (\n\t\t<div className=\"story-format-card-details\">\n\t\t\t{format.properties.author && (\n\t\t\t\t<p\n\t\t\t\t\tclassName=\"story-format-card-author\"\n\t\t\t\t\tdangerouslySetInnerHTML={{\n\t\t\t\t\t\t__html: t('components.storyFormatCard.author', {\n\t\t\t\t\t\t\tauthor: format.properties.author\n\t\t\t\t\t\t})\n\t\t\t\t\t}}\n\t\t\t\t/>\n\t\t\t)}\n\t\t\t{format.properties.description && (\n\t\t\t\t<div\n\t\t\t\t\tclassName=\"story-format-card-description\"\n\t\t\t\t\tdangerouslySetInnerHTML={{\n\t\t\t\t\t\t__html: format.properties.description\n\t\t\t\t\t}}\n\t\t\t\t/>\n\t\t\t)}\n\t\t\t{format.properties.license && (\n\t\t\t\t<p className=\"story-format-card-license\">\n\t\t\t\t\t{t('components.storyFormatCard.license', {\n\t\t\t\t\t\tlicense: format.properties.license\n\t\t\t\t\t})}\n\t\t\t\t</p>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n","import {IconAlertTriangle} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {formatImageUrl, StoryFormat} from '../../../store/story-formats';\nimport {Badge} from '../../badge/badge';\nimport {CardContent} from '../../container/card';\nimport {SelectableCard} from '../../container/card/selectable-card';\nimport {IconLoading} from '../../image/icon';\nimport {StoryFormatCardDetails} from './story-format-card-details';\nimport './story-format-card.css';\n\nexport interface StoryFormatCardProps {\n\tdefaultFormat: boolean;\n\teditorExtensionsDisabled: boolean;\n\tformat: StoryFormat;\n\tonSelect: () => void;\n\tproofingFormat: boolean;\n}\n\nexport const StoryFormatCard: React.FC<StoryFormatCardProps> = props => {\n\tconst {\n\t\tdefaultFormat,\n\t\teditorExtensionsDisabled,\n\t\tformat,\n\t\tonSelect,\n\t\tproofingFormat\n\t} = props;\n\tconst {t} = useTranslation();\n\n\tlet image = <></>;\n\n\tif (format.loadState === 'error') {\n\t\timage = <IconAlertTriangle />;\n\t} else if (\n\t\tformat.loadState === 'unloaded' ||\n\t\tformat.loadState === 'loading'\n\t) {\n\t\timage = <IconLoading />;\n\t} else if (format.loadState === 'loaded' && format.properties.image) {\n\t\timage = <img src={formatImageUrl(format)} alt=\"\" />;\n\t}\n\n\treturn (\n\t\t<div className=\"story-format-card\">\n\t\t\t<SelectableCard\n\t\t\t\tlabel={t('components.storyFormatCard.name', {\n\t\t\t\t\tname: format.name,\n\t\t\t\t\tversion: format.version\n\t\t\t\t})}\n\t\t\t\tonSelect={onSelect}\n\t\t\t\tselected={format.selected}\n\t\t\t>\n\t\t\t\t<CardContent>\n\t\t\t\t\t<div className=\"story-format-image\">{image}</div>\n\t\t\t\t\t<div className=\"story-format-description\">\n\t\t\t\t\t\t<h2>\n\t\t\t\t\t\t\t{t('components.storyFormatCard.name', {\n\t\t\t\t\t\t\t\tname: format.name,\n\t\t\t\t\t\t\t\tversion: format.version\n\t\t\t\t\t\t\t})}\n\t\t\t\t\t\t</h2>\n\t\t\t\t\t\t<StoryFormatCardDetails format={format} />\n\t\t\t\t\t</div>\n\t\t\t\t\t<div className=\"story-format-badges\">\n\t\t\t\t\t\t{!format.userAdded && (\n\t\t\t\t\t\t\t<Badge label={t('components.storyFormatCard.builtIn')} />\n\t\t\t\t\t\t)}\n\t\t\t\t\t\t{defaultFormat && (\n\t\t\t\t\t\t\t<Badge label={t('components.storyFormatCard.defaultFormat')} />\n\t\t\t\t\t\t)}\n\t\t\t\t\t\t{editorExtensionsDisabled && (\n\t\t\t\t\t\t\t<Badge\n\t\t\t\t\t\t\t\tlabel={t('components.storyFormatCard.editorExtensionsDisabled')}\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t)}\n\t\t\t\t\t\t{format.loadState === 'loaded' && format.properties.proofing && (\n\t\t\t\t\t\t\t<Badge label={t('components.storyFormatCard.proofing')} />\n\t\t\t\t\t\t)}\n\t\t\t\t\t\t{proofingFormat && (\n\t\t\t\t\t\t\t<Badge label={t('components.storyFormatCard.proofingFormat')} />\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\t\t\t\t</CardContent>\n\t\t\t</SelectableCard>\n\t\t</div>\n\t);\n};\n","import {IconArrowLeft} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {useHistory} from 'react-router-dom';\nimport {IconButton} from '../control/icon-button';\n\nexport const BackButton: React.FC = () => {\n\tconst history = useHistory();\n\tconst {t} = useTranslation();\n\n\tif (['/', '/stories'].includes(history.location.pathname)) {\n\t\treturn null;\n\t}\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconArrowLeft />}\n\t\t\tvariant=\"primary\"\n\t\t\tlabel={\n\t\t\t\thistory.length > 1\n\t\t\t\t\t? t('common.back')\n\t\t\t\t\t: t('routes.storyList.titleGeneric')\n\t\t\t}\n\t\t\tonClick={() =>\n\t\t\t\thistory.length > 1 ? history.goBack() : history.push('/')\n\t\t\t}\n\t\t/>\n\t);\n};\n","import {IconHelp} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {Tab, TabList, TabPanel, Tabs} from 'react-tabs';\nimport {IconButton} from '../control/icon-button';\nimport {BackButton} from './back-button';\nimport './route-toolbar.css';\n\nexport interface RouteToolbarProps {\n\thelpUrl?: string;\n\tpinnedControls?: React.ReactNode;\n\ttabs: Record<string, React.ReactNode>;\n}\n\nexport const RouteToolbar: React.FC<RouteToolbarProps> = props => {\n\tconst {helpUrl = 'https://twinery.org/2guide', pinnedControls, tabs} = props;\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<div className=\"route-toolbar\">\n\t\t\t<Tabs selectedTabClassName=\"selected\">\n\t\t\t\t<div className=\"route-toolbar-top\">\n\t\t\t\t\t<BackButton />\n\t\t\t\t\t<TabList className=\"route-toolbar-tablist\">\n\t\t\t\t\t\t{Object.keys(tabs).map(tabName => (\n\t\t\t\t\t\t\t<Tab className=\"route-toolbar-tab\" key={tabName}>\n\t\t\t\t\t\t\t\t{tabName}\n\t\t\t\t\t\t\t</Tab>\n\t\t\t\t\t\t))}\n\t\t\t\t\t</TabList>\n\t\t\t\t\t<div className=\"route-toolbar-pinned-controls\">\n\t\t\t\t\t\t{pinnedControls}\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\ticon={<IconHelp />}\n\t\t\t\t\t\t\tlabel={t('common.help')}\n\t\t\t\t\t\t\tonClick={() => window.open(helpUrl, '_blank')}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div>\n\t\t\t\t\t{Object.entries(tabs).map(([tabName, tabContent]) => (\n\t\t\t\t\t\t<TabPanel key={tabName}>{tabContent}</TabPanel>\n\t\t\t\t\t))}\n\t\t\t\t</div>\n\t\t\t</Tabs>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {\n\tpublishArchive,\n\tpublishStory,\n\tpublishStoryWithFormat,\n\tPublishOptions\n} from '../util/publish';\nimport {usePrefsContext} from './prefs';\nimport {\n\tformatWithNameAndVersion,\n\tloadFormatProperties,\n\tuseStoryFormatsContext\n} from './story-formats';\nimport {storyWithId, useStoriesContext} from './stories';\nimport {getAppInfo} from '../util/app-info';\n\nexport interface UsePublishingProps {\n\tproofStory: (storyId: string) => Promise<string>;\n\tpublishArchive: (storyIds?: string[]) => Promise<string>;\n\tpublishStory: (\n\t\tstoryId: string,\n\t\tpublishOptions?: PublishOptions\n\t) => Promise<string>;\n\tpublishStoryData: (storyId: string) => string;\n}\n\n/**\n * A React hook publish stories from context. You probably want to use\n * `useStoryLaunch` instead--this is for doing the actual binding of the story\n * and story format.\n */\nexport function usePublishing(): UsePublishingProps {\n\t// As little logic as possible should live here--instead it should be in\n\t// util/publish.ts.\n\n\tconst {prefs} = usePrefsContext();\n\tconst {dispatch: storyFormatsDispatch, formats} = useStoryFormatsContext();\n\tconst {stories} = useStoriesContext();\n\n\treturn {\n\t\tpublishArchive: React.useCallback(\n\t\t\tasync () => publishArchive(stories, getAppInfo()),\n\t\t\t[stories]\n\t\t),\n\t\tproofStory: React.useCallback(\n\t\t\tasync storyId => {\n\t\t\t\tconst story = storyWithId(stories, storyId);\n\t\t\t\tconst format = formatWithNameAndVersion(\n\t\t\t\t\tformats,\n\t\t\t\t\tprefs.proofingFormat.name,\n\t\t\t\t\tprefs.proofingFormat.version\n\t\t\t\t);\n\t\t\t\tconst formatProperties = await loadFormatProperties(format)(\n\t\t\t\t\tstoryFormatsDispatch\n\t\t\t\t);\n\n\t\t\t\tif (!formatProperties) {\n\t\t\t\t\tthrow new Error(`Couldn't load story format properties`);\n\t\t\t\t}\n\n\t\t\t\treturn publishStoryWithFormat(\n\t\t\t\t\tstory,\n\t\t\t\t\tformatProperties.source,\n\t\t\t\t\tgetAppInfo()\n\t\t\t\t);\n\t\t\t},\n\t\t\t[\n\t\t\t\tformats,\n\t\t\t\tprefs.proofingFormat.name,\n\t\t\t\tprefs.proofingFormat.version,\n\t\t\t\tstories,\n\t\t\t\tstoryFormatsDispatch\n\t\t\t]\n\t\t),\n\t\tpublishStory: React.useCallback(\n\t\t\tasync (storyId, publishOptions) => {\n\t\t\t\tconst story = storyWithId(stories, storyId);\n\t\t\t\tconst format = formatWithNameAndVersion(\n\t\t\t\t\tformats,\n\t\t\t\t\tstory.storyFormat,\n\t\t\t\t\tstory.storyFormatVersion\n\t\t\t\t);\n\t\t\t\tconst formatProperties = await loadFormatProperties(format)(\n\t\t\t\t\tstoryFormatsDispatch\n\t\t\t\t);\n\n\t\t\t\tif (!formatProperties) {\n\t\t\t\t\tthrow new Error(`Couldn't load story format properties`);\n\t\t\t\t}\n\n\t\t\t\treturn publishStoryWithFormat(\n\t\t\t\t\tstory,\n\t\t\t\t\tformatProperties.source,\n\t\t\t\t\tgetAppInfo(),\n\t\t\t\t\tpublishOptions\n\t\t\t\t);\n\t\t\t},\n\t\t\t[formats, stories, storyFormatsDispatch]\n\t\t),\n\t\tpublishStoryData: React.useCallback(\n\t\t\t(storyId: string) => {\n\t\t\t\tconst story = storyWithId(stories, storyId);\n\n\t\t\t\treturn publishStory(story, getAppInfo(), {startOptional: true});\n\t\t\t},\n\t\t\t[stories]\n\t\t)\n\t};\n}\n","import {usePublishing} from './use-publishing';\nimport {isElectronRenderer} from '../util/is-electron';\nimport {TwineElectronWindow} from '../electron/shared';\n\nexport interface UseStoryLaunchProps {\n\tplayStory: (storyId: string) => Promise<void>;\n\tproofStory: (storyId: string) => Promise<void>;\n\ttestStory: (storyId: string, startPassageId?: string) => Promise<void>;\n}\n\n/**\n * Provides functions to launch a story that include the correct handling for\n * both web and Electron contexts.\n */\nexport function useStoryLaunch(): UseStoryLaunchProps {\n\tconst {proofStory, publishStory} = usePublishing();\n\n\tif (isElectronRenderer()) {\n\t\tconst {twineElectron} = window as TwineElectronWindow;\n\n\t\tif (!twineElectron) {\n\t\t\tthrow new Error('Electron bridge is not present on window.');\n\t\t}\n\n\t\treturn {\n\t\t\tplayStory: async storyId => {\n\t\t\t\ttwineElectron.ipcRenderer.send(\n\t\t\t\t\t'open-with-temp-file',\n\t\t\t\t\tawait publishStory(storyId),\n\t\t\t\t\t'.html'\n\t\t\t\t);\n\t\t\t},\n\t\t\tproofStory: async storyId => {\n\t\t\t\ttwineElectron.ipcRenderer.send(\n\t\t\t\t\t'open-with-temp-file',\n\t\t\t\t\tawait proofStory(storyId),\n\t\t\t\t\t'.html'\n\t\t\t\t);\n\t\t\t},\n\t\t\ttestStory: async (storyId, startPassageId) => {\n\t\t\t\ttwineElectron.ipcRenderer.send(\n\t\t\t\t\t'open-with-temp-file',\n\t\t\t\t\tawait publishStory(storyId, {\n\t\t\t\t\t\tformatOptions: 'debug',\n\t\t\t\t\t\tstartId: startPassageId\n\t\t\t\t\t}),\n\t\t\t\t\t'.html'\n\t\t\t\t);\n\t\t\t}\n\t\t};\n\t}\n\n\treturn {\n\t\tplayStory: async storyId => {\n\t\t\twindow.open(`#/stories/${storyId}/play`, '_blank');\n\t\t},\n\t\tproofStory: async storyId => {\n\t\t\twindow.open(`#/stories/${storyId}/proof`, '_blank');\n\t\t},\n\t\ttestStory: async (storyId, startPassageId) => {\n\t\t\twindow.open(\n\t\t\t\tstartPassageId\n\t\t\t\t\t? `#/stories/${storyId}/test/${startPassageId}`\n\t\t\t\t\t: `#/stories/${storyId}/test`,\n\t\t\t\t'_blank'\n\t\t\t);\n\t\t}\n\t};\n}\n","import {saveAs} from 'file-saver';\n\n/**\n * Saves text to a file. This works in either a browser or Electron context.\n */\nexport function saveHtml(source: string, filename: string) {\n\tconst data = new Blob([source], {type: 'text/html;charset=utf-8'});\n\n\tsaveAs(data, filename);\n}\n","import {IconEye, IconFileText, IconPlayerPlay, IconTool} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next/';\nimport {ButtonBar} from '../components/container/button-bar';\nimport {IconButton} from '../components/control/icon-button';\nimport {storyFileName} from '../electron/shared';\nimport {Story} from '../store/stories';\nimport {usePublishing} from '../store/use-publishing';\nimport {useStoryLaunch} from '../store/use-story-launch';\nimport {saveHtml} from '../util/save-html';\n\nexport interface BuildActionsProps {\n\tstory?: Story;\n}\n\nexport const BuildActions: React.FC<BuildActionsProps> = ({story}) => {\n\tconst {publishStory} = usePublishing();\n\tconst {playStory, proofStory, testStory} = useStoryLaunch();\n\tconst {t} = useTranslation();\n\n\tasync function handlePublishFile() {\n\t\tif (!story) {\n\t\t\tthrow new Error('No story provided to publish');\n\t\t}\n\n\t\tsaveHtml(await publishStory(story.id), storyFileName(story));\n\t}\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t<IconButton\n\t\t\t\tdisabled={!story}\n\t\t\t\ticon={<IconTool />}\n\t\t\t\tlabel={t('routeActions.build.test')}\n\t\t\t\tonClick={story ? () => testStory(story.id) : () => {}}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\tdisabled={!story}\n\t\t\t\ticon={<IconPlayerPlay />}\n\t\t\t\tlabel={t('routeActions.build.play')}\n\t\t\t\tonClick={story ? () => playStory(story.id) : () => {}}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\tdisabled={!story}\n\t\t\t\ticon={<IconEye />}\n\t\t\t\tlabel={t('routeActions.build.proof')}\n\t\t\t\tonClick={story ? () => proofStory(story?.id) : () => {}}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\tdisabled={!story}\n\t\t\t\ticon={<IconFileText />}\n\t\t\t\tlabel={t('routeActions.build.publishToFile')}\n\t\t\t\tonClick={handlePublishFile}\n\t\t\t/>\n\t\t</ButtonBar>\n\t);\n};\n","import {IconAward, IconBug, IconFileCode, IconSettings} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {useHistory} from 'react-router-dom';\nimport {ButtonBar} from '../components/container/button-bar';\nimport {IconButton} from '../components/control/icon-button';\nimport {AboutTwineDialog, AppPrefsDialog, useDialogsContext} from '../dialogs';\n\nexport const AppActions: React.FC = () => {\n\tconst {dispatch} = useDialogsContext();\n\tconst history = useHistory();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t<IconButton\n\t\t\t\ticon={<IconSettings />}\n\t\t\t\tlabel={t('routeActions.app.preferences')}\n\t\t\t\tonClick={() => dispatch({type: 'addDialog', component: AppPrefsDialog})}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\tdisabled={history.location.pathname === '/story-formats'}\n\t\t\t\ticon={<IconFileCode />}\n\t\t\t\tlabel={t('routeActions.app.storyFormats')}\n\t\t\t\tonClick={() => history.push('/story-formats')}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\ticon={<IconAward />}\n\t\t\t\tlabel={t('routeActions.app.aboutApp')}\n\t\t\t\tonClick={() =>\n\t\t\t\t\tdispatch({type: 'addDialog', component: AboutTwineDialog})\n\t\t\t\t}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\ticon={<IconBug />}\n\t\t\t\tlabel={t('routeActions.app.reportBug')}\n\t\t\t\tonClick={() => window.open('https://twinery.org/2bugs', '_blank')}\n\t\t\t/>\n\t\t</ButtonBar>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconPlus} from '@tabler/icons';\nimport {\n\tcreateFromProperties,\n\tuseStoryFormatsContext\n} from '../../../../store/story-formats';\nimport {\n\tPromptButton,\n\tPromptButtonValidator\n} from '../../../../components/control/prompt-button';\nimport {fetchStoryFormatProperties} from '../../../../util/story-format';\nimport './add-story-format-button.css';\n\nfunction isValidUrl(value: string) {\n\ttry {\n\t\tnew URL(value);\n\t\treturn true;\n\t} catch (e) {}\n\n\treturn false;\n}\n\nexport const AddStoryFormatButton: React.FC = () => {\n\tconst {dispatch, formats} = useStoryFormatsContext();\n\tconst [newFormatUrl, setNewFormatUrl] = React.useState('');\n\tconst {t} = useTranslation();\n\n\tasync function handleSubmit() {\n\t\tdispatch(\n\t\t\tcreateFromProperties(\n\t\t\t\tnewFormatUrl,\n\t\t\t\tawait fetchStoryFormatProperties(newFormatUrl)\n\t\t\t)\n\t\t);\n\t}\n\n\tconst validate: PromptButtonValidator = async (value: string) => {\n\t\tif (newFormatUrl.trim() === '') {\n\t\t\treturn {valid: false};\n\t\t}\n\n\t\tif (!isValidUrl(newFormatUrl)) {\n\t\t\treturn {\n\t\t\t\tmessage: t(\n\t\t\t\t\t'routes.storyFormatList.toolbar.addStoryFormatButton.invalidUrl'\n\t\t\t\t),\n\t\t\t\tvalid: false\n\t\t\t};\n\t\t}\n\n\t\ttry {\n\t\t\tconst properties = await fetchStoryFormatProperties(newFormatUrl);\n\n\t\t\tif (\n\t\t\t\tformats.some(\n\t\t\t\t\tformat =>\n\t\t\t\t\t\tformat.name === properties.name &&\n\t\t\t\t\t\tformat.version === properties.version\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\treturn {\n\t\t\t\t\tmessage: t(\n\t\t\t\t\t\t'routes.storyFormatList.toolbar.addStoryFormatButton.alreadyAdded',\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tstoryFormatName: properties.name,\n\t\t\t\t\t\t\tstoryFormatVersion: properties.version\n\t\t\t\t\t\t}\n\t\t\t\t\t),\n\t\t\t\t\tvalid: false\n\t\t\t\t};\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tmessage: t(\n\t\t\t\t\t'routes.storyFormatList.toolbar.addStoryFormatButton.addPreview',\n\t\t\t\t\t{\n\t\t\t\t\t\tstoryFormatName: properties.name,\n\t\t\t\t\t\tstoryFormatVersion: properties.version\n\t\t\t\t\t}\n\t\t\t\t),\n\t\t\t\tvalid: true\n\t\t\t};\n\t\t} catch (error) {\n\t\t\treturn {\n\t\t\t\tmessage: t(\n\t\t\t\t\t'routes.storyFormatList.toolbar.addStoryFormatButton.fetchError',\n\t\t\t\t\t{\n\t\t\t\t\t\terrorMessage: error.message\n\t\t\t\t\t}\n\t\t\t\t),\n\t\t\t\tvalid: false\n\t\t\t};\n\t\t}\n\t};\n\n\treturn (\n\t\t<span className=\"add-format-button\">\n\t\t\t<PromptButton\n\t\t\t\ticon={<IconPlus />}\n\t\t\t\tlabel={t('common.add')}\n\t\t\t\tonChange={event => setNewFormatUrl(event.target.value)}\n\t\t\t\tonSubmit={handleSubmit}\n\t\t\t\tprompt={t('routes.storyFormatList.toolbar.addStoryFormatButton.prompt')}\n\t\t\t\tsubmitIcon={<IconPlus />}\n\t\t\t\tsubmitLabel={t('common.add')}\n\t\t\t\tsubmitVariant=\"create\"\n\t\t\t\tvalidate={validate}\n\t\t\t\tvalue={newFormatUrl}\n\t\t\t/>\n\t\t</span>\n\t);\n};\n","import {IconStar} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {usePrefsContext} from '../../../../store/prefs';\nimport {StoryFormat} from '../../../../store/story-formats';\n\nexport interface DefaultStoryFormatButtonProps {\n\tformat?: StoryFormat;\n}\n\nexport const DefaultStoryFormatButton: React.FC<DefaultStoryFormatButtonProps> = props => {\n\tconst {format} = props;\n\tconst {dispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tconst disabled =\n\t\tformat?.loadState !== 'loaded' ||\n\t\tformat.properties.proofing ||\n\t\t(prefs.storyFormat.name === format.name &&\n\t\t\tprefs.storyFormat.version === format.version);\n\tconst handleClick: React.MouseEventHandler = () => {\n\t\tif (!format) {\n\t\t\tthrow new Error(\"Can't set undefined format as default\");\n\t\t}\n\n\t\tdispatch({\n\t\t\ttype: 'update',\n\t\t\tname: 'storyFormat',\n\t\t\tvalue: {name: format.name, version: format.version}\n\t\t});\n\t};\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={disabled}\n\t\t\ticon={<IconStar />}\n\t\t\tlabel={t('routes.storyFormatList.toolbar.useAsDefaultFormat')}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import {IconEye} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {usePrefsContext} from '../../../../store/prefs';\nimport {StoryFormat} from '../../../../store/story-formats';\n\nexport interface ProofingStoryFormatButtonProps {\n\tformat?: StoryFormat;\n}\n\nexport const ProofingStoryFormatButton: React.FC<ProofingStoryFormatButtonProps> = props => {\n\tconst {format} = props;\n\tconst {dispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tconst disabled =\n\t\tformat?.loadState !== 'loaded' ||\n\t\t!format.properties.proofing ||\n\t\t(prefs.proofingFormat.name === format.name &&\n\t\t\tprefs.proofingFormat.version === format.version);\n\tconst handleClick: React.MouseEventHandler = () => {\n\t\tif (!format) {\n\t\t\tthrow new Error(\"Can't set undefined format as proofing\");\n\t\t}\n\n\t\tdispatch({\n\t\t\ttype: 'update',\n\t\t\tname: 'proofingFormat',\n\t\t\tvalue: {name: format.name, version: format.version}\n\t\t});\n\t};\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={disabled}\n\t\t\ticon={<IconEye />}\n\t\t\tlabel={t('routes.storyFormatList.toolbar.useAsProofingFormat')}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import {IconTrash} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {usePrefsContext} from '../../../../store/prefs';\nimport {\n\tdeleteFormat,\n\tStoryFormat,\n\tuseStoryFormatsContext\n} from '../../../../store/story-formats';\n\nexport interface RemoveStoryFormatButtonProps {\n\tformat?: StoryFormat;\n}\n\nexport const RemoveStoryFormatButton: React.FC<RemoveStoryFormatButtonProps> = props => {\n\tconst {format} = props;\n\tconst {dispatch} = useStoryFormatsContext();\n\tconst {prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tconst isDefault =\n\t\tformat?.name === prefs.storyFormat.name &&\n\t\tformat?.version === prefs.storyFormat.version;\n\tconst isProofing =\n\t\tformat?.name === prefs.proofingFormat.name &&\n\t\tformat?.version === prefs.proofingFormat.version;\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={!format || !format.userAdded || isDefault || isProofing}\n\t\t\ticon={<IconTrash />}\n\t\t\tlabel={t('common.remove')}\n\t\t\tonClick={() => format && dispatch(deleteFormat(format))}\n\t\t/>\n\t);\n};\n","import {IconPuzzle} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {setPref, usePrefsContext} from '../../../../store/prefs';\nimport {StoryFormat} from '../../../../store/story-formats';\n\nexport interface StoryFormatExtensionsButtonProps {\n\tformat?: StoryFormat;\n}\n\nexport const StoryFormatExtensionsButton: React.FC<StoryFormatExtensionsButtonProps> = props => {\n\tconst {format} = props;\n\tconst {dispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tconst extensionsDisabled = prefs.disabledStoryFormatEditorExtensions.some(\n\t\tother => other.name === format?.name && other.version === format?.version\n\t);\n\n\tfunction handleClick() {\n\t\tif (!format) {\n\t\t\tthrow new Error('Format is not set');\n\t\t}\n\n\t\t// This logic is a little backwards--the user is setting whether to use the\n\t\t// extensions but our preferences track disabled ones.\n\n\t\tif (extensionsDisabled) {\n\t\t\tdispatch(\n\t\t\t\tsetPref(\n\t\t\t\t\t'disabledStoryFormatEditorExtensions',\n\t\t\t\t\tprefs.disabledStoryFormatEditorExtensions.filter(\n\t\t\t\t\t\tf => f.name !== format.name || f.version !== format.version\n\t\t\t\t\t)\n\t\t\t\t)\n\t\t\t);\n\t\t} else {\n\t\t\tdispatch(\n\t\t\t\tsetPref('disabledStoryFormatEditorExtensions', [\n\t\t\t\t\t...prefs.disabledStoryFormatEditorExtensions,\n\t\t\t\t\t{name: format.name, version: format.version}\n\t\t\t\t])\n\t\t\t);\n\t\t}\n\t}\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={!format}\n\t\t\ticon={<IconPuzzle />}\n\t\t\tlabel={t(\n\t\t\t\t`routes.storyFormatList.toolbar.${\n\t\t\t\t\textensionsDisabled ? 'enable' : 'disable'\n\t\t\t\t}FormatExtensions`\n\t\t\t)}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {ButtonBar} from '../../../../components/container/button-bar';\nimport {StoryFormat} from '../../../../store/story-formats';\nimport {AddStoryFormatButton} from './add-story-format-button';\nimport {DefaultStoryFormatButton} from './default-story-format-button';\nimport {ProofingStoryFormatButton} from './proofing-story-format-button';\nimport {RemoveStoryFormatButton} from './remove-story-format-button';\nimport {StoryFormatExtensionsButton} from './story-format-extensions-button';\n\nexport interface FormatActionsProps {\n\tselectedFormats: StoryFormat[];\n}\n\nexport const FormatActions: React.FC<FormatActionsProps> = props => {\n\tconst {selectedFormats} = props;\n\tconst format = selectedFormats.length === 1 ? selectedFormats[0] : undefined;\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t<AddStoryFormatButton />\n\t\t\t<RemoveStoryFormatButton format={format} />\n\t\t\t<StoryFormatExtensionsButton format={format} />\n\t\t\t<DefaultStoryFormatButton format={format} />\n\t\t\t<ProofingStoryFormatButton format={format} />\n\t\t</ButtonBar>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {CheckboxButton} from '../../../components/control/checkbox-button';\nimport {setPref, usePrefsContext} from '../../../store/prefs';\n\nexport const ViewActions: React.FC = () => {\n\tconst {dispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tfunction setFilter(name: string) {\n\t\tdispatch(setPref('storyFormatListFilter', name));\n\t}\n\n\treturn (\n\t\t<>\n\t\t\t<CheckboxButton\n\t\t\t\tdisabled={prefs.storyFormatListFilter === 'current'}\n\t\t\t\tlabel={t('routes.storyFormatList.title.current')}\n\t\t\t\tonChange={() => setFilter('current')}\n\t\t\t\tvalue={prefs.storyFormatListFilter === 'current'}\n\t\t\t/>\n\t\t\t<CheckboxButton\n\t\t\t\tdisabled={prefs.storyFormatListFilter === 'user'}\n\t\t\t\tlabel={t('routes.storyFormatList.title.user')}\n\t\t\t\tonChange={() => setFilter('user')}\n\t\t\t\tvalue={prefs.storyFormatListFilter === 'user'}\n\t\t\t/>\n\t\t\t<CheckboxButton\n\t\t\t\tdisabled={prefs.storyFormatListFilter === 'all'}\n\t\t\t\tlabel={t('routes.storyFormatList.title.all')}\n\t\t\t\tonChange={() => setFilter('all')}\n\t\t\t\tvalue={prefs.storyFormatListFilter === 'all'}\n\t\t\t/>\n\t\t</>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {RouteToolbar} from '../../../components/route-toolbar';\nimport {AppActions} from '../../../route-actions';\nimport {StoryFormat} from '../../../store/story-formats';\nimport {FormatActions} from './formats/format-actions';\nimport {ViewActions} from './view-actions';\n\nexport interface StoryFormatListToolbarProps {\n\tselectedFormats: StoryFormat[];\n}\n\nexport const StoryFormatListToolbar: React.FC<StoryFormatListToolbarProps> = props => {\n\tconst {selectedFormats} = props;\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<RouteToolbar\n\t\t\ttabs={{\n\t\t\t\t[t('common.storyFormat')]: (\n\t\t\t\t\t<FormatActions selectedFormats={selectedFormats} />\n\t\t\t\t),\n\t\t\t\t[t('common.view')]: <ViewActions />,\n\t\t\t\t[t('common.appName')]: <AppActions />\n\t\t\t}}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {CSSTransition, TransitionGroup} from 'react-transition-group';\nimport {ClickAwayListener} from '../../components/click-away-listener';\nimport {CardGroup} from '../../components/container/card-group';\nimport {MainContent} from '../../components/container/main-content';\nimport {StoryFormatCard} from '../../components/story-format/story-format-card/story-format-card';\nimport {DialogsContextProvider} from '../../dialogs';\nimport {FormatLoader} from '../../store/format-loader';\nimport {usePrefsContext} from '../../store/prefs';\nimport {\n\tdeselectAllFormats,\n\tdeselectFormat,\n\tfilteredFormats,\n\tselectFormat,\n\tsortFormats,\n\tStoryFormat,\n\tuseStoryFormatsContext\n} from '../../store/story-formats';\nimport {StoryFormatListToolbar} from './toolbar';\n\nexport const StoryFormatListRoute: React.FC = () => {\n\tconst {dispatch: formatsDispatch, formats} = useStoryFormatsContext();\n\tconst {dispatch: prefsDispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tconst selectedFormats = formats.filter(format => format.selected);\n\n\tconst visibleFormats = sortFormats(\n\t\tfilteredFormats(formats, prefs.storyFormatListFilter)\n\t);\n\n\t// Any formats no longer visible should be deselected.\n\n\tReact.useEffect(() => {\n\t\tfor (const format of selectedFormats) {\n\t\t\tif (format.selected && !visibleFormats.includes(format)) {\n\t\t\t\tformatsDispatch(deselectFormat(format));\n\t\t\t}\n\t\t}\n\t}, [prefsDispatch, selectedFormats, visibleFormats, formatsDispatch]);\n\n\tfunction handleSelect(format: StoryFormat) {\n\t\tformatsDispatch(selectFormat(format, true));\n\t}\n\n\treturn (\n\t\t<div className=\"story-format-list-route\">\n\t\t\t<DialogsContextProvider>\n\t\t\t\t<StoryFormatListToolbar selectedFormats={selectedFormats} />\n\t\t\t\t<ClickAwayListener\n\t\t\t\t\tignoreSelector=\".story-format-card\"\n\t\t\t\t\tonClickAway={() => formatsDispatch(deselectAllFormats())}\n\t\t\t\t>\n\t\t\t\t\t<MainContent\n\t\t\t\t\t\ttitle={t(\n\t\t\t\t\t\t\t`routes.storyFormatList.title.${prefs.storyFormatListFilter}`\n\t\t\t\t\t\t)}\n\t\t\t\t\t>\n\t\t\t\t\t\t<p>\n\t\t\t\t\t\t\t{t(\n\t\t\t\t\t\t\t\tvisibleFormats.length > 0\n\t\t\t\t\t\t\t\t\t? 'routes.storyFormatList.storyFormatExplanation'\n\t\t\t\t\t\t\t\t\t: 'routes.storyFormatList.noneVisible'\n\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t<FormatLoader>\n\t\t\t\t\t\t\t<CardGroup columnWidth=\"450px\">\n\t\t\t\t\t\t\t\t<TransitionGroup component={null}>\n\t\t\t\t\t\t\t\t\t{visibleFormats.map(format => (\n\t\t\t\t\t\t\t\t\t\t<CSSTransition\n\t\t\t\t\t\t\t\t\t\t\tclassNames=\"pop\"\n\t\t\t\t\t\t\t\t\t\t\tkey={format.id}\n\t\t\t\t\t\t\t\t\t\t\ttimeout={200}\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t<StoryFormatCard\n\t\t\t\t\t\t\t\t\t\t\t\tdefaultFormat={\n\t\t\t\t\t\t\t\t\t\t\t\t\tformat.name === prefs.storyFormat.name &&\n\t\t\t\t\t\t\t\t\t\t\t\t\tformat.version === prefs.storyFormat.version\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\teditorExtensionsDisabled={prefs.disabledStoryFormatEditorExtensions.some(\n\t\t\t\t\t\t\t\t\t\t\t\t\tdisabledFormat =>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat.name === disabledFormat.name &&\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tformat.version === disabledFormat.version\n\t\t\t\t\t\t\t\t\t\t\t\t)}\n\t\t\t\t\t\t\t\t\t\t\t\tformat={format}\n\t\t\t\t\t\t\t\t\t\t\t\tonSelect={() => handleSelect(format)}\n\t\t\t\t\t\t\t\t\t\t\t\tproofingFormat={\n\t\t\t\t\t\t\t\t\t\t\t\t\tformat.name === prefs.proofingFormat.name &&\n\t\t\t\t\t\t\t\t\t\t\t\t\tformat.version === prefs.proofingFormat.version\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t\t</CSSTransition>\n\t\t\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t\t\t</TransitionGroup>\n\t\t\t\t\t\t\t</CardGroup>\n\t\t\t\t\t\t</FormatLoader>\n\t\t\t\t\t</MainContent>\n\t\t\t\t</ClickAwayListener>\n\t\t\t</DialogsContextProvider>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconPlus} from '@tabler/icons';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {createUntitledPassage, Story} from '../../../../store/stories';\nimport {useUndoableStoriesContext} from '../../../../store/undoable-stories';\nimport {Point} from '../../../../util/geometry';\n\nexport interface CreatePassageButtonProps {\n\tgetCenter: () => Point;\n\tstory: Story;\n}\n\nexport const CreatePassageButton: React.FC<CreatePassageButtonProps> = props => {\n\tconst {getCenter, story} = props;\n\tconst {dispatch} = useUndoableStoriesContext();\n\tconst handleClick = React.useCallback(() => {\n\t\tconst {left, top} = getCenter();\n\n\t\tdispatch(createUntitledPassage(story, left, top), 'undoChange.newPassage');\n\t}, [dispatch, getCenter, story]);\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconPlus />}\n\t\t\tlabel={t('common.new')}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import {IconTrash} from '@tabler/icons';\nimport 'element-closest';\nimport * as React from 'react';\nimport {useHotkeys} from 'react-hotkeys-hook';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {deletePassages, Passage, Story} from '../../../../store/stories';\nimport {useUndoableStoriesContext} from '../../../../store/undoable-stories';\n\nexport interface DeletePassagesButtonProps {\n\tpassages: Passage[];\n\tstory: Story;\n}\n\nexport const DeletePassagesButton: React.FC<\n\tDeletePassagesButtonProps\n> = props => {\n\tconst {passages, story} = props;\n\tconst {dispatch} = useUndoableStoriesContext();\n\tconst {t} = useTranslation();\n\tconst handleClick = React.useCallback(() => {\n\t\tif (passages.length === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tdispatch(\n\t\t\tdeletePassages(story, passages),\n\t\t\tpassages.length > 1\n\t\t\t\t? 'undoChange.deletePassages'\n\t\t\t\t: 'undoChange.deletePassage'\n\t\t);\n\t}, [dispatch, passages, story]);\n\n\tuseHotkeys('Backspace,Delete', handleClick, [handleClick]);\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={passages.length === 0}\n\t\t\ticon={<IconTrash />}\n\t\t\tlabel={\n\t\t\t\tpassages.length > 1\n\t\t\t\t\t? t('common.deleteCount', {count: passages.length})\n\t\t\t\t\t: t('common.delete')\n\t\t\t}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import {IconEdit} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {PassageEditDialog, useDialogsContext} from '../../../../dialogs';\nimport {Passage, Story} from '../../../../store/stories';\n\nexport interface EditPassagesButtonProps {\n\tpassages: Passage[];\n\tstory: Story;\n}\n\nexport const EditPassagesButton: React.FC<EditPassagesButtonProps> = props => {\n\tconst {passages, story} = props;\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\tfunction handleClick() {\n\t\tdispatch(dispatch =>\n\t\t\tpassages.forEach(passage =>\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'addDialog',\n\t\t\t\t\tcomponent: PassageEditDialog,\n\t\t\t\t\tprops: {passageId: passage.id, storyId: story.id}\n\t\t\t\t})\n\t\t\t)\n\t\t);\n\t}\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={passages.length === 0}\n\t\t\ticon={<IconEdit />}\n\t\t\tlabel={\n\t\t\t\tpassages.length > 1\n\t\t\t\t\t? t('common.editCount', {count: passages.length})\n\t\t\t\t\t: t('common.edit')\n\t\t\t}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import {IconMarquee} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {\n\tselectAllPassages,\n\tStory,\n\tuseStoriesContext\n} from '../../../../store/stories';\n\nexport interface SelectAllPassagesButtonProps {\n\tstory: Story;\n}\n\nexport const SelectAllPassagesButton: React.FC<SelectAllPassagesButtonProps> = props => {\n\tconst {story} = props;\n\tconst {dispatch} = useStoriesContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconMarquee />}\n\t\t\tlabel={t('common.selectAll')}\n\t\t\tonClick={() => dispatch(selectAllPassages(story))}\n\t\t/>\n\t);\n};\n","import {IconRocket} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {\n\tPassage,\n\tStory,\n\tupdateStory,\n\tuseStoriesContext\n} from '../../../../store/stories';\n\nexport interface StartAtPassageButtonProps {\n\tpassage?: Passage;\n\tstory: Story;\n}\n\nexport const StartAtPassageButton: React.FC<StartAtPassageButtonProps> = props => {\n\tconst {passage, story} = props;\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst {t} = useTranslation();\n\n\tfunction handleClick() {\n\t\tif (!passage) {\n\t\t\tthrow new Error('No passage set');\n\t\t}\n\n\t\tdispatch(updateStory(stories, story, {startPassage: passage.id}));\n\t}\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={!passage || passage.id === story.startPassage}\n\t\t\ticon={<IconRocket />}\n\t\t\tlabel={t('routes.storyEdit.toolbar.startStoryHere')}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import {IconTool} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {Passage, Story} from '../../../../store/stories';\nimport {useStoryLaunch} from '../../../../store/use-story-launch';\n\nexport interface TestPassageButtonProps {\n\tpassage?: Passage;\n\tstory: Story;\n}\n\nexport const TestPassageButton: React.FC<TestPassageButtonProps> = props => {\n\tconst {passage, story} = props;\n\tconst {testStory} = useStoryLaunch();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={!passage}\n\t\t\ticon={<IconTool />}\n\t\t\tlabel={t('routes.storyEdit.toolbar.testFromHere')}\n\t\t\tonClick={() => testStory(story.id, passage?.id)}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {ButtonBar} from '../../../../components/container/button-bar';\nimport {RenamePassageButton} from '../../../../components/passage/rename-passage-button';\nimport {\n\tPassage,\n\tStory,\n\tupdatePassage,\n\tuseStoriesContext\n} from '../../../../store/stories';\nimport {Point} from '../../../../util/geometry';\nimport {CreatePassageButton} from './create-passage-button';\nimport {DeletePassagesButton} from './delete-passages-button';\nimport {EditPassagesButton} from './edit-passages-buttons';\nimport {SelectAllPassagesButton} from './select-all-passages-button';\nimport {StartAtPassageButton} from './start-at-passage-button';\nimport {TestPassageButton} from './test-passage-button';\n\nexport interface PassageActionsProps {\n\tgetCenter: () => Point;\n\tstory: Story;\n}\n\nexport const PassageActions: React.FC<PassageActionsProps> = ({\n\tgetCenter,\n\tstory\n}) => {\n\tconst {dispatch} = useStoriesContext();\n\tconst selectedPassages = React.useMemo(\n\t\t() => story.passages.filter(passage => passage.selected),\n\t\t[story.passages]\n\t);\n\tconst soloSelectedPassage = React.useMemo(\n\t\t() => (selectedPassages.length === 1 ? selectedPassages[0] : undefined),\n\t\t[selectedPassages]\n\t);\n\n\tfunction handleRename(name: string, passage?: Passage) {\n\t\tif (!passage) {\n\t\t\tthrow new Error('Passage is unset');\n\t\t}\n\n\t\t// Don't create newly linked passages here because the update action will\n\t\t// try to recreate the passage as it's been renamed--it sees new links in\n\t\t// existing passages, updates them, but does not see that the passage name\n\t\t// has been updated since that hasn't happened yet.\n\n\t\tdispatch(\n\t\t\tupdatePassage(\n\t\t\t\tstory,\n\t\t\t\tpassage,\n\t\t\t\t{name},\n\t\t\t\t{dontCreateNewlyLinkedPassages: true}\n\t\t\t)\n\t\t);\n\t}\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t<CreatePassageButton getCenter={getCenter} story={story} />\n\t\t\t<EditPassagesButton passages={selectedPassages} story={story} />\n\t\t\t<RenamePassageButton\n\t\t\t\tonRename={name => handleRename(name, soloSelectedPassage)}\n\t\t\t\tpassage={soloSelectedPassage}\n\t\t\t\tstory={story}\n\t\t\t/>\n\t\t\t<DeletePassagesButton passages={selectedPassages} story={story} />\n\t\t\t<TestPassageButton passage={soloSelectedPassage} story={story} />\n\t\t\t<StartAtPassageButton passage={soloSelectedPassage} story={story} />\n\t\t\t<SelectAllPassagesButton story={story} />\n\t\t</ButtonBar>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconWriting} from '@tabler/icons';\nimport {PromptButton} from '../control/prompt-button';\nimport {storyFileName} from '../../electron/shared';\nimport {Story} from '../../store/stories';\nimport {IconButton} from '../control/icon-button';\n\n// This is here because it's used in two places--the story list and the story\n// info dialog.\n\nconst DisabledRenameStoryButton: React.FC = () => {\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton disabled icon={<IconWriting />} label={t('common.rename')} />\n\t);\n};\n\ninterface EnabledRenameStoryButtonProps {\n\texistingStories: Story[];\n\tonRename: (value: string) => void;\n\tstory: Story;\n}\n\nconst EnabledRenameStoryButton: React.FC<EnabledRenameStoryButtonProps> = props => {\n\tconst {existingStories, onRename, story} = props;\n\tconst [newName, setNewName] = React.useState(story.name);\n\tconst {t} = useTranslation();\n\n\tReact.useEffect(() => setNewName(story.name), [story]);\n\n\tfunction validate(name: string) {\n\t\tif (name.trim() === '') {\n\t\t\treturn {\n\t\t\t\tmessage: t('components.renameStoryButton.emptyName'),\n\t\t\t\tvalid: false\n\t\t\t};\n\t\t}\n\n\t\tif (\n\t\t\texistingStories.some(\n\t\t\t\ts =>\n\t\t\t\t\ts.id !== story.id &&\n\t\t\t\t\tstoryFileName(s) === storyFileName({...story, name})\n\t\t\t)\n\t\t) {\n\t\t\treturn {\n\t\t\t\tmessage: t('components.renameStoryButton.nameAlreadyUsed'),\n\t\t\t\tvalid: false\n\t\t\t};\n\t\t}\n\n\t\treturn {valid: true};\n\t}\n\n\treturn (\n\t\t<PromptButton\n\t\t\ticon={<IconWriting />}\n\t\t\tlabel={t('common.rename')}\n\t\t\tonChange={event => setNewName(event.target.value)}\n\t\t\tonSubmit={onRename}\n\t\t\tprompt={t('common.renamePrompt', {name: story.name})}\n\t\t\tvalidate={validate}\n\t\t\tvalue={newName}\n\t\t/>\n\t);\n};\n\nexport interface RenameStoryButtonProps\n\textends Omit<EnabledRenameStoryButtonProps, 'story'> {\n\tstory?: Story;\n}\n\nexport const RenameStoryButton: React.FC<RenameStoryButtonProps> = props => {\n\tif (props.story) {\n\t\treturn (\n\t\t\t<EnabledRenameStoryButton {...(props as EnabledRenameStoryButtonProps)} />\n\t\t);\n\t}\n\n\treturn <DisabledRenameStoryButton />;\n};","import {IconInfoCircle} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {StoryDetailsDialog, useDialogsContext} from '../../../../dialogs';\nimport {Story} from '../../../../store/stories';\n\nexport interface DetailsButtonProps {\n\tstory: Story;\n}\n\nexport const DetailsButton: React.FC<DetailsButtonProps> = props => {\n\tconst {story} = props;\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconInfoCircle />}\n\t\t\tlabel={t('common.details')}\n\t\t\tonClick={() =>\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'addDialog',\n\t\t\t\t\tcomponent: StoryDetailsDialog,\n\t\t\t\t\tprops: {storyId: story.id}\n\t\t\t\t})\n\t\t\t}\n\t\t/>\n\t);\n};\n","import {IconSearch} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {StorySearchDialog, useDialogsContext} from '../../../../dialogs';\nimport {Story} from '../../../../store/stories';\n\nexport interface FindReplaceButtonProps {\n\tstory: Story;\n}\n\nexport const FindReplaceButton: React.FC<FindReplaceButtonProps> = props => {\n\tconst {story} = props;\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconSearch />}\n\t\t\tlabel={t('routes.storyEdit.toolbar.findAndReplace')}\n\t\t\tonClick={() =>\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'addDialog',\n\t\t\t\t\tcomponent: StorySearchDialog,\n\t\t\t\t\tprops: {storyId: story.id}\n\t\t\t\t})\n\t\t\t}\n\t\t/>\n\t);\n};\n","import {IconBraces} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {StoryJavaScriptDialog, useDialogsContext} from '../../../../dialogs';\nimport {Story} from '../../../../store/stories';\n\nexport interface JavaScriptButtonProps {\n\tstory: Story;\n}\n\nexport const JavaScriptButton: React.FC<JavaScriptButtonProps> = props => {\n\tconst {story} = props;\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconBraces />}\n\t\t\tlabel={t('routes.storyEdit.toolbar.javaScript')}\n\t\t\tonClick={() =>\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'addDialog',\n\t\t\t\t\tcomponent: StoryJavaScriptDialog,\n\t\t\t\t\tprops: {storyId: story.id}\n\t\t\t\t})\n\t\t\t}\n\t\t/>\n\t);\n};\n","import {IconTags} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {PassageTagsDialog, useDialogsContext} from '../../../../dialogs';\nimport {Story} from '../../../../store/stories';\n\nexport interface PassageTagsButtonProps {\n\tstory: Story;\n}\n\nexport const PassageTagsButton: React.FC<PassageTagsButtonProps> = props => {\n\tconst {story} = props;\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconTags />}\n\t\t\tlabel={t('routes.storyEdit.toolbar.passageTags')}\n\t\t\tonClick={() =>\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'addDialog',\n\t\t\t\t\tcomponent: PassageTagsDialog,\n\t\t\t\t\tprops: {storyId: story.id}\n\t\t\t\t})\n\t\t\t}\n\t\t/>\n\t);\n};\n","import {IconHash} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {StoryStylesheetDialog, useDialogsContext} from '../../../../dialogs';\nimport {Story} from '../../../../store/stories';\n\nexport interface StylesheetButtonProps {\n\tstory: Story;\n}\n\nexport const StylesheetButton: React.FC<StylesheetButtonProps> = props => {\n\tconst {story} = props;\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconHash />}\n\t\t\tlabel={t('routes.storyEdit.toolbar.stylesheet')}\n\t\t\tonClick={() =>\n\t\t\t\tdispatch({\n\t\t\t\t\ttype: 'addDialog',\n\t\t\t\t\tcomponent: StoryStylesheetDialog,\n\t\t\t\t\tprops: {storyId: story.id}\n\t\t\t\t})\n\t\t\t}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {ButtonBar} from '../../../../components/container/button-bar';\nimport {RenameStoryButton} from '../../../../components/story/rename-story-button';\nimport {Story, updateStory, useStoriesContext} from '../../../../store/stories';\nimport {DetailsButton} from './details-button';\nimport {FindReplaceButton} from './find-replace-button';\nimport {JavaScriptButton} from './javascript-button';\nimport {PassageTagsButton} from './passage-tags-button';\nimport {StylesheetButton} from './stylesheet-button';\n\nexport interface StoryActionsProps {\n\tstory: Story;\n}\n\nexport const StoryActions: React.FC<StoryActionsProps> = props => {\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst {story} = props;\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t<FindReplaceButton story={story} />\n\t\t\t<RenameStoryButton\n\t\t\t\texistingStories={stories}\n\t\t\t\tonRename={name => dispatch(updateStory(stories, story, {name}))}\n\t\t\t\tstory={story}\n\t\t\t/>\n\t\t\t<DetailsButton story={story} />\n\t\t\t<PassageTagsButton story={story} />\n\t\t\t<JavaScriptButton story={story} />\n\t\t\t<StylesheetButton story={story} />\n\t\t</ButtonBar>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconArrowBack, IconArrowForward} from '@tabler/icons';\nimport {useUndoableStoriesContext} from '../../../store/undoable-stories';\nimport {IconButton} from '../../../components/control/icon-button';\n\nexport const UndoRedoButtons: React.FC = () => {\n\tconst {redo, redoLabel, undo, undoLabel} = useUndoableStoriesContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<>\n\t\t\t<IconButton\n\t\t\t\tdisabled={!undo}\n\t\t\t\ticon={<IconArrowBack />}\n\t\t\t\tlabel={undoLabel ?? t('common.undo')}\n\t\t\t\tonClick={undo}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\tdisabled={!redo}\n\t\t\t\ticon={<IconArrowForward />}\n\t\t\t\tlabel={redoLabel ?? t('common.redo')}\n\t\t\t\tonClick={redo}\n\t\t\t/>\n\t\t</>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {RouteToolbar} from '../../../components/route-toolbar';\nimport {AppActions, BuildActions} from '../../../route-actions';\nimport {Story} from '../../../store/stories';\nimport {Point} from '../../../util/geometry';\nimport {PassageActions} from './passage/passage-actions';\nimport {StoryActions} from './story/story-actions';\nimport {UndoRedoButtons} from './undo-redo-buttons';\n\nexport interface StoryEditToolbarProps {\n\tgetCenter: () => Point;\n\tstory: Story;\n}\n\nexport const StoryEditToolbar: React.FC<StoryEditToolbarProps> = props => {\n\tconst {getCenter, story} = props;\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<RouteToolbar\n\t\t\tpinnedControls={<UndoRedoButtons />}\n\t\t\ttabs={{\n\t\t\t\t[t('common.passage')]: (\n\t\t\t\t\t<PassageActions getCenter={getCenter} story={story} />\n\t\t\t\t),\n\t\t\t\t[t('common.story')]: <StoryActions story={story} />,\n\t\t\t\t[t('common.build')]: <BuildActions story={story} />,\n\t\t\t\t[t('common.appName')]: <AppActions />\n\t\t\t}}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconGridDots, IconLayoutGrid, IconSquare} from '@tabler/icons';\nimport {IconButton} from '../../components/control/icon-button';\nimport {updateStory, useStoriesContext, Story} from '../../store/stories';\nimport {ButtonCard} from '../../components/container/button-card';\nimport './zoom-buttons.css';\nimport {useScrollbarSize} from 'react-scrollbar-size';\n\nexport interface ZoomButtonsProps {\n\tstory: Story;\n}\n\nexport const ZoomButtons: React.FC<ZoomButtonsProps> = React.memo(({story}) => {\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst {t} = useTranslation();\n\tconst {height} = useScrollbarSize();\n\n\tconst handleZoomChange = React.useCallback(\n\t\t(zoom: number) => {\n\t\t\tdispatch(updateStory(stories, story, {zoom}));\n\t\t},\n\t\t[dispatch, stories, story]\n\t);\n\n\tconst style: React.CSSProperties = {\n\t\tmarginBottom: height\n\t};\n\n\treturn (\n\t\t<div className=\"zoom-buttons\" style={style}>\n\t\t\t<ButtonCard>\n\t\t\t\t<IconButton\n\t\t\t\t\ticon={<IconSquare />}\n\t\t\t\t\ticonOnly\n\t\t\t\t\tlabel={t('routes.storyEdit.zoomButtons.passageNamesAndExcerpts')}\n\t\t\t\t\tonClick={() => handleZoomChange(1)}\n\t\t\t\t\tselectable\n\t\t\t\t\tselected={story.zoom === 1}\n\t\t\t\t\ttooltipPosition=\"right\"\n\t\t\t\t/>\n\t\t\t\t<IconButton\n\t\t\t\t\ticon={<IconLayoutGrid />}\n\t\t\t\t\ticonOnly\n\t\t\t\t\tlabel={t('routes.storyEdit.zoomButtons.passageNames')}\n\t\t\t\t\tonClick={() => handleZoomChange(0.6)}\n\t\t\t\t\tselectable\n\t\t\t\t\tselected={story.zoom === 0.6}\n\t\t\t\t\ttooltipPosition=\"right\"\n\t\t\t\t/>\n\t\t\t\t<IconButton\n\t\t\t\t\ticon={<IconGridDots />}\n\t\t\t\t\ticonOnly\n\t\t\t\t\tlabel={t('routes.storyEdit.zoomButtons.storyStructure')}\n\t\t\t\t\tonClick={() => handleZoomChange(0.3)}\n\t\t\t\t\tselectable\n\t\t\t\t\tselected={story.zoom === 0.3}\n\t\t\t\t\ttooltipPosition=\"right\"\n\t\t\t\t/>\n\t\t\t</ButtonCard>\n\t\t</div>\n\t);\n});\n\nZoomButtons.displayName = 'ZoomButtons';","import * as React from 'react';\nimport {quadOut} from 'eases';\nimport {Point} from '../../util/geometry';\n\n/**\n * Information about a single zoom transition.\n */\ninterface ZoomTransition {\n\t/**\n\t * How much time has elapsed, in seconds.\n\t */\n\telapsed: number;\n\t/**\n\t * The last timestamp an update was done, in seconds.\n\t */\n\tlastTimestamp?: number;\n\t/**\n\t * The point the scrollTarget was centered on when the transition began,\n\t * normalized for zoom level. e.g. if it was centered on (100, 100) but the\n\t * story zoom was 0.5, this is (200, 200).\n\t */\n\tscrollNormalizedCenter: Point;\n\t/**\n\t * The current point the scrollTarget is centered on.\n\t */\n\tscrollCenter: {\n\t\theight: number;\n\t\twidth: number;\n\t};\n\t/**\n\t * The element whose scroll position is being maintained.\n\t */\n\tscrollTarget: HTMLElement;\n\t/**\n\t * How the zoom is changing during this transition.\n\t */\n\tzoom: {\n\t\tstart: number;\n\t\tchange: number;\n\t};\n}\n\n/**\n * Runs a single step of the zoom transition. This is outside the effect to\n * avoid dependencies.\n * @param setter Setter function for the zoom value\n * @param start Value of the zoom when the transition began\n * @param change Change in zoom value for the entire transition\n * @param time Elapsed time in seconds--assumes total time is 1 second\n * \n * @return transitioned value of zoom\n */\nfunction transitionStep(\n\tsetter: React.Dispatch<React.SetStateAction<number>>,\n\tstart: number,\n\tchange: number,\n\ttime: number\n) {\n\tlet value: number;\n\n\tif (time < 1) {\n\t\t// Step toward the change.\n\n\t\tvalue = start + change * quadOut(time);\n\t\tsetter(value);\n\t\treturn value;\n\t}\n\n\t// We're done.\n\n\tsetter(start + change);\n}\n\n/**\n * Manages transitioning zoom level of a story while maintaining the scroll\n * position's focus. This is meant to be called repeatedly with different\n * values, and returns the _visible_ zoom--what the user should see as zoom\n * value, which gradually changes over time.\n *\n * @param target Zoom value to transition towrds\n * @param scrollTarget DOM element whose scroll position should be manipulated\n * to match the returned value\n */\nexport function useZoomTransition(\n\ttarget: number,\n\tscrollTarget: HTMLElement | null\n) {\n\tconst [current, setCurrent] = React.useState(target);\n\tconst transition = React.useRef<ZoomTransition>();\n\n\t// This queues a single transition step using requestAnimationFrame. It's\n\t// crucial that this callback have no dependencies; otherwise things could get\n\t// confused in the middle of a transition.\n\n\tconst step = React.useCallback(() => {\n\t\tif (!transition.current) {\n\t\t\treturn;\n\t\t}\n\n\t\twindow.requestAnimationFrame(timestamp => {\n\t\t\tconst t = transition.current as ZoomTransition;\n\n\t\t\tif (t.lastTimestamp) {\n\t\t\t\t// Complete the transition in 0.5 seconds, not 1.\n\t\t\t\tt.elapsed += (timestamp - t.lastTimestamp) / 500;\n\t\t\t\tt.lastTimestamp = timestamp;\n\n\t\t\t\tconst value = transitionStep(\n\t\t\t\t\tsetCurrent,\n\t\t\t\t\tt.zoom.start,\n\t\t\t\t\tt.zoom.change,\n\t\t\t\t\tt.elapsed\n\t\t\t\t);\n\n\t\t\t\tif (value) {\n\t\t\t\t\t// Sync scroll position and request a new animation step.\n\n\t\t\t\t\tconst newLeft =\n\t\t\t\t\t\tt.scrollNormalizedCenter.left * value - t.scrollCenter.width;\n\t\t\t\t\tconst newTop =\n\t\t\t\t\t\tt.scrollNormalizedCenter.top * value - t.scrollCenter.height;\n\n\t\t\t\t\tif (newLeft >= 0 && newTop >= 0) {\n\t\t\t\t\t\tt.scrollTarget.scrollLeft = newLeft;\n\t\t\t\t\t\tt.scrollTarget.scrollTop = newTop;\n\t\t\t\t\t}\n\n\t\t\t\t\tstep();\n\t\t\t\t} else {\n\t\t\t\t\t// We've reached the end.\n\t\t\t\t\ttransition.current = undefined;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// This is the first time we've been called in a transition. Record the\n\t\t\t\t// timestamp and try again.\n\n\t\t\t\tt.lastTimestamp = timestamp;\n\t\t\t\tstep();\n\t\t\t}\n\t\t});\n\t}, []);\n\n\t// Start a new transition.\n\n\tReact.useEffect(() => {\n\t\tif (!transition.current && current !== target && scrollTarget) {\n\t\t\ttransition.current = {\n\t\t\t\tscrollTarget,\n\t\t\t\telapsed: 0,\n\t\t\t\tscrollNormalizedCenter: {\n\t\t\t\t\tleft:\n\t\t\t\t\t\t(scrollTarget.scrollLeft + scrollTarget.clientWidth / 2) / current,\n\t\t\t\t\ttop:\n\t\t\t\t\t\t(scrollTarget.scrollTop + scrollTarget.clientHeight / 2) / current\n\t\t\t\t},\n\t\t\t\tscrollCenter: {\n\t\t\t\t\theight: scrollTarget.clientHeight / 2,\n\t\t\t\t\twidth: scrollTarget.clientWidth / 2\n\t\t\t\t},\n\t\t\t\tzoom: {\n\t\t\t\t\tstart: current,\n\t\t\t\t\tchange: target - current\n\t\t\t\t}\n\t\t\t};\n\t\t\twindow.requestAnimationFrame(step);\n\t\t}\n\t}, [current, scrollTarget, step, target]);\n\n\treturn current;\n}\n","import * as React from 'react';\nimport 'element-closest';\nimport {rectFromPoints, Point, Rect} from '../../util/geometry';\nimport './marquee-selection.css';\n\nexport interface MarqueeSelectionProps {\n\t/**\n\t * Container DOM element to attach events to.\n\t */\n\tcontainer: React.RefObject<HTMLElement>;\n\t/**\n\t * Ignores click events on any element matching this selector. This is so that\n\t * drags beginning on a passage card can be ignored.\n\t */\n\tignoreEventsOnSelector?: string;\n\t/**\n\t * Callback for when selection is finalized by the user letting go of the\n\t * mouse button.\n\t */\n\tonSelectRect: (rect: Rect, additive: boolean) => void;\n\t/**\n\t * Callback for when the user is altering the selection by dragging the mouse.\n\t */\n\tonTemporarySelectRect: (rect: Rect, additive: boolean) => void;\n}\n\nexport const MarqueeSelection: React.FC<MarqueeSelectionProps> = props => {\n\tconst {\n\t\tcontainer,\n\t\tignoreEventsOnSelector,\n\t\tonSelectRect,\n\t\tonTemporarySelectRect\n\t} = props;\n\tconst [additive, setAdditive] = React.useState(false);\n\tconst [dragging, setDragging] = React.useState(false);\n\tconst [start, setStart] = React.useState<Point>();\n\tconst [current, setCurrent] = React.useState<Point>();\n\n\t// There are two effects here to prevent unnecesary cleanup of event\n\t// listeners. One listens to DOM events on the container, the other handles\n\t// calling onSelectRect.\n\n\tReact.useEffect(() => {\n\t\tconst currentContainer = container.current;\n\t\tlet currentContainerRect: DOMRect;\n\n\t\tfunction relativePointerPos(event: PointerEvent) {\n\t\t\treturn {\n\t\t\t\tleft:\n\t\t\t\t\tevent.clientX -\n\t\t\t\t\tcurrentContainerRect.left +\n\t\t\t\t\tcurrentContainer!.scrollLeft,\n\t\t\t\ttop:\n\t\t\t\t\tevent.clientY - currentContainerRect.top + currentContainer!.scrollTop\n\t\t\t};\n\t\t}\n\n\t\tfunction upListener(event: PointerEvent) {\n\t\t\tif (currentContainer) {\n\t\t\t\tcurrentContainer.releasePointerCapture(event.pointerId);\n\t\t\t\tcurrentContainer.removeEventListener('pointermove', moveListener);\n\t\t\t\tcurrentContainer.removeEventListener('pointerup', upListener);\n\t\t\t\tsetDragging(false);\n\t\t\t\t// See the second effect for how callbacks are invoked.\n\t\t\t}\n\t\t}\n\n\t\tfunction moveListener(event: PointerEvent) {\n\t\t\tsetCurrent(relativePointerPos(event));\n\t\t}\n\n\t\tfunction downListener(event: PointerEvent) {\n\t\t\tif (\n\t\t\t\tevent.pointerType === 'touch' ||\n\t\t\t\tevent.button !== 0 ||\n\t\t\t\t!currentContainer\n\t\t\t) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\tignoreEventsOnSelector &&\n\t\t\t\t(event.target as HTMLElement).closest(ignoreEventsOnSelector)\n\t\t\t) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tcurrentContainerRect = currentContainer.getBoundingClientRect();\n\t\t\tcurrentContainer.setPointerCapture(event.pointerId);\n\t\t\tcurrentContainer.addEventListener('pointermove', moveListener);\n\t\t\tcurrentContainer.addEventListener('pointerup', upListener);\n\t\t\tsetAdditive(!!(event.shiftKey || event.ctrlKey));\n\t\t\tsetDragging(true);\n\t\t\tsetStart(relativePointerPos(event));\n\t\t\tsetCurrent(relativePointerPos(event));\n\t\t}\n\n\t\tif (currentContainer) {\n\t\t\tcurrentContainer.addEventListener('pointerdown', downListener);\n\t\t\treturn () =>\n\t\t\t\tcurrentContainer.removeEventListener('pointerdown', downListener);\n\t\t}\n\t}, [container, ignoreEventsOnSelector]);\n\n\tReact.useEffect(() => {\n\t\t// This effect will trigger constantly if the on* callbacks aren't memoized\n\t\t// outside the component.\n\n\t\tif (start && current) {\n\t\t\tif (dragging) {\n\t\t\t\tonTemporarySelectRect(rectFromPoints(start, current), additive);\n\t\t\t} else {\n\t\t\t\tonSelectRect(rectFromPoints(start, current), additive);\n\t\t\t\tsetStart(undefined);\n\t\t\t\tsetCurrent(undefined);\n\t\t\t}\n\t\t}\n\t}, [additive, current, dragging, onSelectRect, onTemporarySelectRect, start]);\n\n\tconst style = React.useMemo(() => {\n\t\tif (!start || !current) {\n\t\t\treturn {};\n\t\t}\n\n\t\tconst rect = rectFromPoints(start, current);\n\n\t\t// This relies on the static dimensions of the div being set at 100x100 in\n\t\t// CSS. The point of this is to allow the browser to resize the marquee\n\t\t// using GPU only (hopefully), which is more performant than setting bounds\n\t\t// directly.\n\n\t\treturn {\n\t\t\ttransform: `translate(${rect.left}px, ${rect.top}px) scale(${\n\t\t\t\trect.width / 100\n\t\t\t}, ${rect.height / 100})`\n\t\t};\n\t}, [current, start]);\n\n\tif (!start || !current) {\n\t\treturn null;\n\t}\n\n\treturn <div className=\"marquee-selection\" style={style} />;\n};\n","import * as React from 'react';\nimport {Passage} from '../../../store/stories';\nimport {Point} from '../../../util/geometry';\nimport './broken-connection.css';\n\nexport interface BrokenConnectionProps {\n\toffset: Point;\n\tpassage: Passage;\n}\n\n// Making this equal in length to <StartConnector>.\nconst lineOffset = 25 * Math.sqrt(2);\n\nexport const BrokenConnection: React.FC<BrokenConnectionProps> = props => {\n\tconst {offset, passage} = props;\n\tconst start: Point = {left: passage.left, top: passage.top};\n\n\tif (passage.selected) {\n\t\tstart.left += offset.left;\n\t\tstart.top += offset.top;\n\t}\n\n\treturn (\n\t\t<line\n\t\t\tclassName=\"broken-connection\"\n\t\t\tx1={start.left + passage.width}\n\t\t\ty1={start.top + passage.height}\n\t\t\tx2={start.left + passage.width + lineOffset}\n\t\t\ty2={start.top + passage.height + lineOffset}\n\t\t\tstyle={{markerEnd: 'url(#link-broken)'}}\n\t\t/>\n\t);\n};\n","import {Point} from './geometry';\n\nexport interface ArcProps {\n\tend: Point;\n\tlargeArc?: boolean;\n\tradius: Point;\n\trotation?: number;\n\tstart: Point;\n\tsweep?: boolean;\n}\n\n/**\n * Returns an SVG path string between two points.\n * @see https://developer.mozilla.org/en-US/docs/Web/SVG/Tutorial/Paths#arcs\n */\nexport function arc({start, end, radius, largeArc, sweep, rotation}: ArcProps) {\n\treturn (\n\t\t'M' +\n\t\tstart.left +\n\t\t',' +\n\t\tstart.top +\n\t\t' A' +\n\t\tradius.left +\n\t\t',' +\n\t\tradius.top +\n\t\t' ' +\n\t\t(rotation ?? '0') +\n\t\t(largeArc ? ' 1' : ' 0') +\n\t\t(sweep ? ' 1 ' : ' 0 ') +\n\t\tend.left +\n\t\t',' +\n\t\tend.top\n\t);\n}\n","import * as React from 'react';\nimport {arc} from '../../../util/svg';\nimport {\n\tlineAngle,\n\tlineDistance,\n\trectCenter,\n\trectIntersectionWithLine,\n\tPoint\n} from '../../../util/geometry';\nimport {Passage} from '../../../store/stories';\nimport './passage-connection.css';\n\nexport interface PassageConnectionProps {\n\tend: Passage;\n\toffset: Point;\n\tstart: Passage;\n\tvariant: 'link' | 'reference';\n}\n\nexport const PassageConnection: React.FC<PassageConnectionProps> = props => {\n\tconst {end, offset, start, variant} = props;\n\tconst path = React.useMemo(() => {\n\t\t// If either passage is selected, offset it. We need to take care not to\n\t\t// overwrite the passage information.\n\n\t\tlet offsetStart = start;\n\t\tlet offsetEnd = end;\n\n\t\tif (start.selected) {\n\t\t\toffsetStart = {\n\t\t\t\t...start,\n\t\t\t\tleft: start.left + offset.left,\n\t\t\t\ttop: start.top + offset.top\n\t\t\t};\n\t\t}\n\n\t\tif (end.selected) {\n\t\t\toffsetEnd = {\n\t\t\t\t...end,\n\t\t\t\tleft: end.left + offset.left,\n\t\t\t\ttop: end.top + offset.top\n\t\t\t};\n\t\t}\n\n\t\t// Start at the center of both passages.\n\n\t\tlet startPoint: Point | null = rectCenter(offsetStart);\n\t\tlet endPoint: Point | null = rectCenter(offsetEnd);\n\n\t\t// Move both points to where they intersect with the edges of their passages.\n\n\t\tstartPoint = rectIntersectionWithLine(offsetStart, startPoint, endPoint);\n\n\t\tif (!startPoint) {\n\t\t\treturn '';\n\t\t}\n\n\t\tendPoint = rectIntersectionWithLine(offsetEnd, startPoint, endPoint);\n\n\t\tif (!endPoint) {\n\t\t\treturn '';\n\t\t}\n\n\t\t// Draw a flattened arc, to make it easier to distinguish between links\n\t\t// between passages with the same horizontal or vertical position (which\n\t\t// would otherwise be overlapping flat lines).\n\t\t//\n\t\t// The horizontal radius of our arc is proportional to the distance\n\t\t// the line will travel.\n\n\t\tconst distance = lineDistance(startPoint, endPoint);\n\n\t\t// Rotate the arc so that its underside will always face downward. We cheat\n\t\t// vertical lines so that their undersides face right--an aesthetic choice,\n\t\t// and so that bidirectional links line up.\n\n\t\tlet sweep = startPoint.left < endPoint.left;\n\n\t\tif (startPoint.left === endPoint.left && startPoint.top < endPoint.top) {\n\t\t\tsweep = true;\n\t\t}\n\n\t\tconst angle = lineAngle(startPoint, endPoint);\n\n\t\t// The Y radius is another aesthetic choice. The lower the ratio, the less\n\t\t// curved the lines become.\n\n\t\treturn arc({\n\t\t\tstart: startPoint,\n\t\t\tend: endPoint,\n\t\t\tradius: {left: distance, top: distance * 0.75},\n\t\t\trotation: angle,\n\t\t\tsweep\n\t\t});\n\t}, [end, offset.left, offset.top, start]);\n\n\treturn (\n\t\t<path\n\t\t\td={path}\n\t\t\tclassName={`passage-connection variant-${variant}`}\n\t\t\tstyle={{markerEnd: 'url(#link-arrowhead)'}}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {Passage} from '../../../store/stories';\nimport {Point} from '../../../util/geometry';\nimport {arc} from '../../../util/svg';\nimport './self-connection.css';\n\nexport interface SelfConnectionProps {\n\toffset: Point;\n\tpassage: Passage;\n\tvariant: 'link' | 'reference';\n}\n\nexport const SelfConnection: React.FC<SelfConnectionProps> = props => {\n\tconst {offset, passage, variant} = props;\n\tconst start: Point = {left: passage.left, top: passage.top};\n\n\tif (passage.selected) {\n\t\tstart.left += offset.left;\n\t\tstart.top += offset.top;\n\t}\n\n\tconst radius = React.useMemo(\n\t\t() => 0.4 * Math.min(passage.width, passage.height),\n\t\t[passage.height, passage.width]\n\t);\n\n\tconst path = React.useMemo(\n\t\t() =>\n\t\t\tarc({\n\t\t\t\tstart: {\n\t\t\t\t\tleft: start.left,\n\t\t\t\t\ttop: start.top + passage.height / 2\n\t\t\t\t},\n\t\t\t\tend: {\n\t\t\t\t\tleft: start.left,\n\t\t\t\t\ttop: start.top\n\t\t\t\t},\n\t\t\t\tradius: {\n\t\t\t\t\tleft: radius,\n\t\t\t\t\ttop: radius\n\t\t\t\t},\n\t\t\t\tsweep: true,\n\t\t\t\tlargeArc: true\n\t\t\t}),\n\t\t[passage.height, radius, start.left, start.top]\n\t);\n\n\treturn (\n\t\t<path\n\t\t\tclassName={`self-connection variant-${variant}`}\n\t\t\td={path}\n\t\t\tstyle={{markerEnd: 'url(#link-arrowhead)'}}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {Passage} from '../../../store/stories';\nimport {BrokenConnection} from './broken-connection';\nimport {PassageConnection} from './passage-connection';\nimport {SelfConnection} from './self-connection';\nimport {Point} from '../../../util/geometry';\n\nexport interface PassageConnectionGroupProps {\n\tbroken: Set<Passage>;\n\tconnections: Map<Passage, Set<Passage>>;\n\toffset: Point;\n\tself: Set<Passage>;\n\tvariant?: 'link' | 'reference';\n}\n\nexport const PassageConnectionGroup: React.FC<PassageConnectionGroupProps> = React.memo(\n\tprops => {\n\t\tconst {broken, connections, offset, self, variant = 'link'} = props;\n\n\t\treturn (\n\t\t\t<>\n\t\t\t\t{Array.from(connections).map(connection =>\n\t\t\t\t\tArray.from(connection[1]).map(end => (\n\t\t\t\t\t\t<PassageConnection\n\t\t\t\t\t\t\tend={end}\n\t\t\t\t\t\t\toffset={offset}\n\t\t\t\t\t\t\tkey={connection[0].name + end.name}\n\t\t\t\t\t\t\tstart={connection[0]}\n\t\t\t\t\t\t\tvariant={variant}\n\t\t\t\t\t\t/>\n\t\t\t\t\t))\n\t\t\t\t)}\n\t\t\t\t{Array.from(self).map(passage => (\n\t\t\t\t\t<SelfConnection\n\t\t\t\t\t\tkey={passage.name}\n\t\t\t\t\t\toffset={offset}\n\t\t\t\t\t\tpassage={passage}\n\t\t\t\t\t\tvariant={variant}\n\t\t\t\t\t/>\n\t\t\t\t))}\n\t\t\t\t{Array.from(broken).map(passage => (\n\t\t\t\t\t<BrokenConnection\n\t\t\t\t\t\tkey={passage.name}\n\t\t\t\t\t\toffset={offset}\n\t\t\t\t\t\tpassage={passage}\n\t\t\t\t\t/>\n\t\t\t\t))}\n\t\t\t</>\n\t\t);\n\t}\n);\n\nPassageConnectionGroup.displayName = 'PassageConnectionGroup';","import * as React from 'react';\nimport './link-markers.css';\n\n/**\n * Arrowheads used on connectors. Arrowheads must be applied by an inline style.\n * There seems to be disagreement on the proper way to implement this, but it\n * does not work in an external stylesheet in Firefox.\n * @see https://developer.mozilla.org/en-US/docs/Web/SVG/Element/marker\n */\nexport const LinkMarkers: React.FC = () => (\n\t<defs>\n\t\t<marker\n\t\t\tid=\"link-arrowhead\"\n\t\t\trefX=\"6\"\n\t\t\trefY=\"4\"\n\t\t\tmarkerWidth=\"8\"\n\t\t\tmarkerHeight=\"8\"\n\t\t\torient=\"auto\"\n\t\t>\n\t\t\t<path d=\"M 1,1 7,4 1,7 Z\" />\n\t\t</marker>\n\t\t<marker\n\t\t\tid=\"link-broken\"\n\t\t\trefX=\"7.5\"\n\t\t\trefY=\"7.5\"\n\t\t\tmarkerWidth=\"15\"\n\t\t\tmarkerHeight=\"15\"\n\t\t>\n\t\t\t<circle cx=\"7.5\" cy=\"7.5\" r=\"7.5\" />\n\t\t\t<path d=\"M4.5 7.5h 6z\" />\n\t\t</marker>\n\t\t<marker\n\t\t\tid=\"link-start\"\n\t\t\tmarkerWidth=\"15\"\n\t\t\tmarkerHeight=\"15\"\n\t\t\trefX=\"16\"\n\t\t\trefY=\"16\"\n\t\t\tviewBox=\"0 0 32 32\"\n\t\t>\n\t\t\t<circle cx=\"16\" cy=\"16\" r=\"16\" />\n\t\t\t<path d=\"M8 17a8 8 0 0 1 7 7a6 6 0 0 0 3 -5a9 9 0 0 0 6 -8a3 3 0 0 0 -3 -3a9 9 0 0 0 -8 6a6 6 0 0 0 -5 3\" />\n\t\t\t<path d=\"M11 18a6 6 0 0 0 -3 6a6 6 0 0 0 6 -3\" />\n\t\t\t<circle className=\"fill-white\" cx=\"19\" cy=\"13\" r=\"1\" />\n\t\t</marker>\n\t</defs>\n);\n","import * as React from 'react';\nimport {Passage} from '../../../store/stories';\nimport {Point} from '../../../util/geometry';\nimport './start-connection.css';\n\nexport interface StartConnectionProps {\n\toffset: Point;\n\tpassage: Passage;\n}\n\nexport const StartConnection: React.FC<StartConnectionProps> = React.memo(\n\tprops => {\n\t\tconst {offset, passage} = props;\n\t\tconst start: Point = {left: passage.left, top: passage.top};\n\n\t\tif (passage.selected) {\n\t\t\tstart.left += offset.left;\n\t\t\tstart.top += offset.top;\n\t\t}\n\n\t\treturn (\n\t\t\t<line\n\t\t\t\tclassName=\"start-connection\"\n\t\t\t\tx1={start.left - 50}\n\t\t\t\ty1={start.top + passage.height / 2}\n\t\t\t\tx2={start.left}\n\t\t\t\ty2={start.top + passage.height / 2}\n\t\t\t\tstyle={{markerStart: 'url(#link-start)'}}\n\t\t\t/>\n\t\t);\n\t}\n);\n\nStartConnection.displayName = 'StartConnection';","import * as React from 'react';\nimport {version as twineVersion} from '../../package.json';\nimport {formatEditorExtensions} from '../util/story-format';\nimport {\n\tformatWithNameAndVersion,\n\tloadFormatProperties,\n\tuseStoryFormatsContext\n} from './story-formats';\nimport {formatEditorExtensionsDisabled, usePrefsContext} from './prefs';\n\nconst emptyFunc = () => [];\n\nexport function useFormatReferenceParser(\n\tformatName: string,\n\tformatVersion: string\n) {\n\tconst {prefs} = usePrefsContext();\n\tconst {dispatch, formats} = useStoryFormatsContext();\n\tconst format = formatWithNameAndVersion(formats, formatName, formatVersion);\n\tconst [editorExtensions, setEditorExtensions] = React.useState<\n\t\tReturnType<typeof formatEditorExtensions>\n\t>();\n\tconst extensionsDisabled = formatEditorExtensionsDisabled(\n\t\tprefs,\n\t\tformatName,\n\t\tformatVersion\n\t);\n\n\tReact.useEffect(() => {\n\t\tif (extensionsDisabled) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (format.loadState === 'unloaded') {\n\t\t\tdispatch(loadFormatProperties(format));\n\t\t} else if (format.loadState === 'loaded') {\n\t\t\tsetEditorExtensions(formatEditorExtensions(format, twineVersion));\n\t\t}\n\t}, [dispatch, extensionsDisabled, format]);\n\n\tif (extensionsDisabled) {\n\t\treturn emptyFunc;\n\t}\n\n\treturn editorExtensions?.references?.parsePassageText ?? emptyFunc;\n}\n","import * as React from 'react';\nimport {Passage, passageConnections} from '../../../store/stories';\nimport {Point} from '../../../util/geometry';\nimport {PassageConnectionGroup} from './passage-connection-group';\nimport {LinkMarkers} from './link-markers';\nimport {StartConnection} from './start-connection';\nimport {useFormatReferenceParser} from '../../../store/use-format-reference-parser';\n\nexport interface PassageConnectionsProps {\n\tformatName: string;\n\tformatVersion: string;\n\toffset: Point;\n\tpassages: Passage[];\n\tstartPassageId: string;\n}\n\nconst emptySet = new Set<Passage>();\nconst noOffset: Point = {left: 0, top: 0};\n\nexport const PassageConnections: React.FC<PassageConnectionsProps> = props => {\n\tconst {formatName, formatVersion, offset, passages, startPassageId} = props;\n\tconst referenceParser = useFormatReferenceParser(formatName, formatVersion);\n\tconst {draggable: draggableLinks, fixed: fixedLinks} = React.useMemo(\n\t\t() => passageConnections(passages),\n\t\t[passages]\n\t);\n\tconst {\n\t\tdraggable: draggableReferences,\n\t\tfixed: fixedReferences\n\t} = React.useMemo(() => passageConnections(passages, referenceParser), [\n\t\tpassages,\n\t\treferenceParser\n\t]);\n\n\tconst startPassage = React.useMemo(\n\t\t() => passages.find(passage => passage.id === startPassageId),\n\t\t[passages, startPassageId]\n\t);\n\n\t// References only show existing connections.\n\n\treturn (\n\t\t<svg className=\"link-connectors\">\n\t\t\t<LinkMarkers />\n\t\t\t{startPassage && (\n\t\t\t\t<StartConnection offset={offset} passage={startPassage} />\n\t\t\t)}\n\t\t\t<PassageConnectionGroup {...draggableLinks} offset={offset} />\n\t\t\t<PassageConnectionGroup {...fixedLinks} offset={noOffset} />\n\t\t\t<PassageConnectionGroup\n\t\t\t\tbroken={emptySet}\n\t\t\t\tconnections={draggableReferences.connections}\n\t\t\t\toffset={offset}\n\t\t\t\tself={emptySet}\n\t\t\t\tvariant=\"reference\"\n\t\t\t/>\n\t\t\t<PassageConnectionGroup\n\t\t\t\tbroken={emptySet}\n\t\t\t\tconnections={fixedReferences.connections}\n\t\t\t\toffset={noOffset}\n\t\t\t\tself={emptySet}\n\t\t\t\tvariant=\"reference\"\n\t\t\t/>\n\t\t</svg>\n\t);\n};\n","import classNames from 'classnames';\nimport {deviceType} from 'detect-it';\nimport * as React from 'react';\nimport {DraggableCore, DraggableCoreProps} from 'react-draggable';\nimport {useTranslation} from 'react-i18next';\nimport {Passage, TagColors} from '../../store/stories';\nimport {CardContent} from '../container/card';\nimport {SelectableCard} from '../container/card/selectable-card';\nimport {TagStripe} from '../tag/tag-stripe';\nimport './passage-card.css';\n\nexport interface PassageCardProps {\n\tonEdit: (passage: Passage) => void;\n\tonDeselect: (passage: Passage) => void;\n\tonDragStart?: DraggableCoreProps['onStart'];\n\tonDrag?: DraggableCoreProps['onDrag'];\n\tonDragStop?: DraggableCoreProps['onStop'];\n\tonSelect: (passage: Passage, exclusive: boolean) => void;\n\tpassage: Passage;\n\ttagColors: TagColors;\n}\n\n// Needs to fill a large-sized passage card.\nconst excerptLength = 400;\n\nexport const PassageCard: React.FC<PassageCardProps> = React.memo(props => {\n\tconst {\n\t\tonDeselect,\n\t\tonDrag,\n\t\tonDragStart,\n\t\tonDragStop,\n\t\tonEdit,\n\t\tonSelect,\n\t\tpassage,\n\t\ttagColors\n\t} = props;\n\tconst {t} = useTranslation();\n\tconst className = React.useMemo(\n\t\t() => classNames('passage-card', {selected: passage.selected}),\n\t\t[passage.selected]\n\t);\n\tconst container = React.useRef<HTMLDivElement>(null);\n\tconst excerpt = React.useMemo(() => {\n\t\tif (passage.text.length > 0) {\n\t\t\treturn passage.text.substring(0, excerptLength);\n\t\t}\n\n\t\treturn (\n\t\t\t<span className=\"placeholder\">\n\t\t\t\t{t(\n\t\t\t\t\tdeviceType === 'touchOnly'\n\t\t\t\t\t\t? 'components.passageCard.placeholderTouch'\n\t\t\t\t\t\t: 'components.passageCard.placeholderClick'\n\t\t\t\t)}\n\t\t\t</span>\n\t\t);\n\t}, [passage.text, t]);\n\tconst style = React.useMemo(\n\t\t() => ({\n\t\t\theight: passage.height,\n\t\t\tleft: passage.left,\n\t\t\ttop: passage.top,\n\t\t\twidth: passage.width\n\t\t}),\n\t\t[passage.height, passage.left, passage.top, passage.width]\n\t);\n\tconst handleMouseDown = React.useCallback(\n\t\t(event: MouseEvent) => {\n\t\t\t// Shift- or control-clicking toggles our selected status, but doesn't\n\t\t\t// affect any other passage's selected status. If the shift or control key\n\t\t\t// was not held down and we were not already selected, we know the user\n\t\t\t// wants to select only this passage.\n\n\t\t\tif (event.shiftKey || event.ctrlKey) {\n\t\t\t\tif (passage.selected) {\n\t\t\t\t\tonDeselect(passage);\n\t\t\t\t} else {\n\t\t\t\t\tonSelect(passage, false);\n\t\t\t\t}\n\t\t\t} else if (!passage.selected) {\n\t\t\t\tonSelect(passage, true);\n\t\t\t}\n\t\t},\n\t\t[onDeselect, onSelect, passage]\n\t);\n\tconst handleEdit = React.useCallback(\n\t\t() => onEdit(passage),\n\t\t[onEdit, passage]\n\t);\n\tconst handleSelect = React.useCallback(\n\t\t(value: boolean, exclusive: boolean) => {\n\t\t\tonSelect(passage, exclusive);\n\t\t},\n\t\t[onSelect, passage]\n\t);\n\n\treturn (\n\t\t<DraggableCore\n\t\t\tnodeRef={container}\n\t\t\tonMouseDown={handleMouseDown}\n\t\t\tonStart={onDragStart}\n\t\t\tonDrag={onDrag}\n\t\t\tonStop={onDragStop}\n\t\t>\n\t\t\t<div className={className} ref={container} style={style}>\n\t\t\t\t<SelectableCard\n\t\t\t\t\thighlighted={passage.highlighted}\n\t\t\t\t\tlabel={passage.name}\n\t\t\t\t\tonDoubleClick={handleEdit}\n\t\t\t\t\tonSelect={handleSelect}\n\t\t\t\t\tselected={passage.selected}\n\t\t\t\t>\n\t\t\t\t\t<TagStripe tagColors={tagColors} tags={passage.tags} />\n\t\t\t\t\t<h2>{passage.name}</h2>\n\t\t\t\t\t<CardContent>{excerpt}</CardContent>\n\t\t\t\t</SelectableCard>\n\t\t\t</div>\n\t\t</DraggableCore>\n\t);\n});\n\nPassageCard.displayName = 'PassageCard';","import * as React from 'react';\nimport {CSSTransition, TransitionGroup} from 'react-transition-group';\nimport {Passage} from '../../store/stories';\nimport {PassageCard, PassageCardProps} from './passage-card';\nimport '../../styles/animations.css';\n\nexport interface PassageCardGroupProps\n\textends Omit<PassageCardProps, 'passage'> {\n\tpassages: Passage[];\n}\n\nexport const PassageCardGroup: React.FC<PassageCardGroupProps> = React.memo(\n\tprops => {\n\t\tconst {passages} = props;\n\n\t\t// Passages must be sorted so that tabbing around follows a logical pattern.\n\n\t\tconst sortedPassages = React.useMemo(\n\t\t\t() =>\n\t\t\t\t[...passages].sort((a, b) => {\n\t\t\t\t\tif (a.top !== b.top) {\n\t\t\t\t\t\treturn a.top - b.top;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn a.left - b.left;\n\t\t\t\t}),\n\t\t\t[passages]\n\t\t);\n\n\t\treturn (\n\t\t\t<TransitionGroup component={null}>\n\t\t\t\t{sortedPassages.map(passage => (\n\t\t\t\t\t<CSSTransition classNames=\"pop\" key={passage.id} timeout={200}>\n\t\t\t\t\t\t<PassageCard passage={passage} {...props} />\n\t\t\t\t\t</CSSTransition>\n\t\t\t\t))}\n\t\t\t</TransitionGroup>\n\t\t);\n\t}\n);\n\nPassageCardGroup.displayName = 'PassageCardGroup';","import * as React from 'react';\nimport {DraggableData} from 'react-draggable';\nimport {Passage, Story} from '../../../store/stories';\nimport {boundingRect, Point} from '../../../util/geometry';\nimport {PassageConnections} from '../passage-connections';\nimport {PassageCardGroup} from '../passage-card-group';\nimport './passage-map.css';\nimport classnames from 'classnames';\n\nexport interface PassageMapProps {\n\tformatName: string;\n\tformatVersion: string;\n\tonDeselect: (passage: Passage) => void;\n\tonDrag: (change: Point) => void;\n\tonEdit: (passage: Passage) => void;\n\tonMiddleClick: (position: Point) => void;\n\tonSelect: (passage: Passage, exclusive: boolean) => void;\n\tpassages: Passage[];\n\tstartPassageId: string;\n\ttagColors: Story['tagColors'];\n\tvisibleZoom: number;\n\tzoom: number;\n}\n\ninterface DragState {\n\tdragging: boolean;\n\tdragX: number;\n\tdragY: number;\n\tstartX: number;\n\tstartY: number;\n}\n\ntype DragAction =\n\t| {type: 'start'; x: number; y: number}\n\t| {type: 'move'; x: number; y: number}\n\t| {type: 'stop'; callback: (change: Point) => void};\n\nfunction dragReducer(state: DragState, action: DragAction) {\n\tswitch (action.type) {\n\t\tcase 'start':\n\t\t\treturn {\n\t\t\t\tdragging: true,\n\t\t\t\tdragX: action.x,\n\t\t\t\tdragY: action.y,\n\t\t\t\tstartX: action.x,\n\t\t\t\tstartY: action.y\n\t\t\t};\n\n\t\tcase 'move':\n\t\t\treturn {...state, dragX: action.x, dragY: action.y};\n\n\t\tcase 'stop':\n\t\t\t// This is bad reducer practice, probablythis dispatch causes a side\n\t\t\t// effect. However, it allows us to avoid re-renders as state\n\t\t\t// changes--otherwise state becomes a dependency of the handleDragStop\n\t\t\t// callback below--which have a large performance impact.\n\t\t\t//\n\t\t\t// This also must be deferred to avoid changing state mid-render through\n\t\t\t// the callback.\n\n\t\t\tPromise.resolve().then(() =>\n\t\t\t\taction.callback({\n\t\t\t\t\tleft: state.dragX - state.startX,\n\t\t\t\t\ttop: state.dragY - state.startY\n\t\t\t\t})\n\t\t\t);\n\t\t\treturn {dragging: false, dragX: 0, dragY: 0, startX: 0, startY: 0};\n\t}\n}\n\nconst compactCardZoom = 0.6;\n\nexport const PassageMap: React.FC<PassageMapProps> = props => {\n\tconst {\n\t\tformatName,\n\t\tformatVersion,\n\t\tonDeselect,\n\t\tonDrag,\n\t\tonEdit,\n\t\tonMiddleClick,\n\t\tonSelect,\n\t\tpassages,\n\t\tstartPassageId,\n\t\ttagColors,\n\t\tvisibleZoom,\n\t\tzoom\n\t} = props;\n\tconst [compactCards, setCompactCards] = React.useState(\n\t\tvisibleZoom <= compactCardZoom\n\t);\n\tconst container = React.useRef<HTMLDivElement>(null);\n\tconst passageBounds = React.useMemo(() => {\n\t\t// Need to inject a fake rect at the very top-left corner to anchor the\n\t\t// bounds there.\n\n\t\treturn boundingRect([...passages, {top: 0, left: 0, width: 0, height: 0}]);\n\t}, [passages]);\n\n\t// This is a separate memo so that there's less work when visibleZoom changes\n\t// during a zoom transition.\n\n\tconst style = React.useMemo(() => {\n\t\treturn {\n\t\t\theight: `calc(${passageBounds.height}px + 50vh)`,\n\t\t\twidth: `calc(${passageBounds.width}px + 50vw)`,\n\t\t\ttransform: `scale(${visibleZoom})`\n\t\t};\n\t}, [passageBounds.height, passageBounds.width, visibleZoom]);\n\n\tconst [state, dispatch] = React.useReducer(dragReducer, {\n\t\tdragging: false,\n\t\tdragX: 0,\n\t\tdragY: 0,\n\t\tstartX: 0,\n\t\tstartY: 0\n\t});\n\n\t// Only update the compact card state when visibleZoom and zoom are the same.\n\t// This avoids re-rendering the cards in the middle of a zoom transition\n\t// (which causes jank).\n\n\tReact.useEffect(() => {\n\t\tif (zoom === visibleZoom) {\n\t\t\tsetCompactCards(zoom <= compactCardZoom);\n\t\t}\n\t}, [visibleZoom, zoom]);\n\n\t// Set CSS variables on the container for drag offsets.\n\n\tReact.useEffect(() => {\n\t\tif (!container.current) {\n\t\t\treturn;\n\t\t}\n\n\t\tcontainer.current.style.setProperty(\n\t\t\t'--drag-offset-left',\n\t\t\t`${(state.dragX - state.startX) / visibleZoom}px`\n\t\t);\n\t\tcontainer.current.style.setProperty(\n\t\t\t'--drag-offset-top',\n\t\t\t`${(state.dragY - state.startY) / visibleZoom}px`\n\t\t);\n\t}, [state.dragX, state.dragY, state.startX, state.startY, visibleZoom]);\n\n\tconst handleDragStart = React.useCallback((event, data: DraggableData) => {\n\t\tdocument.body.classList.add('dragging-passages');\n\t\tdispatch({type: 'start', x: data.x, y: data.y});\n\t}, []);\n\tconst handleDrag = React.useCallback(\n\t\t(event, data: DraggableData) =>\n\t\t\tdispatch({type: 'move', x: data.x, y: data.y}),\n\t\t[]\n\t);\n\tconst handleDragStop = React.useCallback(() => {\n\t\t// We use a timeout to delay this execution until after the click handler on\n\t\t// <SelectableCard> runs and triggers handleSelect below, so that function\n\t\t// can see that a drag has just finished (and should be ignored as part of\n\t\t// the drag interaction).\n\t\t//\n\t\t// Promise.resolve() doesn't appear to give us the timing we need.\n\n\t\twindow.setTimeout(() => {\n\t\t\tdocument.body.classList.remove('dragging-passages');\n\t\t\tdispatch({type: 'stop', callback: onDrag});\n\t\t}, 0);\n\t}, [onDrag]);\n\tconst handleSelect = React.useCallback(\n\t\t(passage: Passage, exclusive: boolean) => {\n\t\t\t// See comments in handleDragStop above.\n\n\t\t\tif (!state.dragging) {\n\t\t\t\tonSelect(passage, exclusive);\n\t\t\t}\n\t\t},\n\t\t[onSelect, state.dragging]\n\t);\n\tconst handleMouseUp = React.useCallback(\n\t\t(event: React.MouseEvent) => {\n\t\t\t// Listen for middle clicks outside of interactible elements. We can't use\n\t\t\t// onClick for this because middle buttons don't seem to generate those\n\t\t\t// events.\n\n\t\t\tif (\n\t\t\t\t!container.current ||\n\t\t\t\tevent.button !== 1 ||\n\t\t\t\t(event.target as HTMLElement).closest('.passage-card')\n\t\t\t) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Adjust the click position for the container's position onscreen.\n\n\t\t\tconst containerRect = container.current.getBoundingClientRect();\n\n\t\t\tonMiddleClick({\n\t\t\t\tleft: event.clientX - containerRect.left,\n\t\t\t\ttop: event.clientY - containerRect.top\n\t\t\t});\n\t\t},\n\t\t[onMiddleClick]\n\t);\n\n\treturn (\n\t\t<div\n\t\t\tclassName={classnames('passage-map', {\n\t\t\t\t'compact-passage-cards': compactCards\n\t\t\t})}\n\t\t\tonMouseUp={handleMouseUp}\n\t\t\tref={container}\n\t\t\tstyle={style}\n\t\t>\n\t\t\t<PassageConnections\n\t\t\t\tformatName={formatName}\n\t\t\t\tformatVersion={formatVersion}\n\t\t\t\toffset={{\n\t\t\t\t\tleft: (state.dragX - state.startX) / zoom,\n\t\t\t\t\ttop: (state.dragY - state.startY) / zoom\n\t\t\t\t}}\n\t\t\t\tpassages={passages}\n\t\t\t\tstartPassageId={startPassageId}\n\t\t\t/>\n\t\t\t<PassageCardGroup\n\t\t\t\tonDeselect={onDeselect}\n\t\t\t\tonDragStart={handleDragStart}\n\t\t\t\tonDrag={handleDrag}\n\t\t\t\tonDragStop={handleDragStop}\n\t\t\t\tonEdit={onEdit}\n\t\t\t\tonSelect={handleSelect}\n\t\t\t\tpassages={passages}\n\t\t\t\ttagColors={tagColors}\n\t\t\t/>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {\n\tMarqueeSelection,\n\tMarqueeSelectionProps\n} from '../../components/marquee-selection';\nimport {\n\tPassageMap,\n\tPassageMapProps\n} from '../../components/passage/passage-map';\nimport {Rect, rectsIntersect} from '../../util/geometry';\n\nexport interface MarqueeablePassageMapProps\n\textends PassageMapProps,\n\t\tOmit<\n\t\t\tMarqueeSelectionProps,\n\t\t\t'ignoreEventsOnSelector' | 'onTemporarySelectRect'\n\t\t> {}\n\n/**\n * Marries a MarqueeSelection with a PassageMap. This handles displaying a\n * temporary selection while the user drags around the marquee selection\n * *without* persisting the change, for performance.\n */\nexport const MarqueeablePassageMap: React.FC<\n\tMarqueeablePassageMapProps\n> = props => {\n\tconst {container, onSelectRect, ...other} = props;\n\tconst [temporaryRect, setTemporaryRect] = React.useState<Rect>();\n\tconst [temporaryAdditive, setTemporaryAdditive] = React.useState<boolean>();\n\tconst innerPassages = React.useMemo(() => {\n\t\tif (!temporaryRect) {\n\t\t\treturn props.passages;\n\t\t}\n\n\t\treturn props.passages.map(passage => {\n\t\t\tif (temporaryAdditive && passage.selected) {\n\t\t\t\treturn passage;\n\t\t\t}\n\n\t\t\tconst selected = rectsIntersect(temporaryRect, passage);\n\n\t\t\tif (selected === passage.selected) {\n\t\t\t\treturn passage;\n\t\t\t}\n\n\t\t\treturn {...passage, selected};\n\t\t});\n\t}, [props.passages, temporaryAdditive, temporaryRect]);\n\n\tconst handleTemporarySelectRect = React.useCallback(\n\t\t(rect: Rect, additive: boolean) => {\n\t\t\tsetTemporaryRect({\n\t\t\t\theight: rect.height / props.zoom,\n\t\t\t\tleft: rect.left / props.zoom,\n\t\t\t\ttop: rect.top / props.zoom,\n\t\t\t\twidth: rect.width / props.zoom\n\t\t\t});\n\t\t\tsetTemporaryAdditive(additive);\n\t\t},\n\t\t[props.zoom]\n\t);\n\n\tconst handleSelectRect = React.useCallback(\n\t\t(rect: Rect, additive: boolean) => {\n\t\t\tsetTemporaryRect(undefined);\n\t\t\tsetTemporaryAdditive(undefined);\n\t\t\tonSelectRect(rect, additive);\n\t\t},\n\t\t[onSelectRect]\n\t);\n\n\treturn (\n\t\t<>\n\t\t\t<MarqueeSelection\n\t\t\t\tcontainer={container}\n\t\t\t\tignoreEventsOnSelector=\".passage-card, .zoom-buttons\"\n\t\t\t\tonSelectRect={handleSelectRect}\n\t\t\t\tonTemporarySelectRect={handleTemporarySelectRect}\n\t\t\t/>\n\t\t\t<PassageMap {...other} passages={innerPassages} />\n\t\t</>\n\t);\n};\n","import * as React from 'react';\nimport {useParams} from 'react-router-dom';\nimport {MainContent} from '../../components/container/main-content';\nimport {\n\tDialogsContextProvider,\n\tPassageEditDialog,\n\tuseDialogsContext\n} from '../../dialogs';\nimport {\n\tcreateUntitledPassage,\n\tdeselectPassage,\n\tmovePassages,\n\tPassage,\n\tselectPassage,\n\tselectPassagesInRect,\n\tstoryWithId\n} from '../../store/stories';\nimport {\n\tUndoableStoriesContextProvider,\n\tuseUndoableStoriesContext\n} from '../../store/undoable-stories';\nimport {Point, Rect} from '../../util/geometry';\nimport {StoryEditToolbar} from './toolbar';\nimport './story-edit-route.css';\nimport {ZoomButtons} from './zoom-buttons';\nimport {DocumentTitle} from '../../components/document-title/document-title';\nimport {useZoomTransition} from './use-zoom-transition';\nimport {useZoomShortcuts} from './use-zoom-shortcuts';\nimport {MarqueeablePassageMap} from './marqueeable-passage-map';\n\nexport const InnerStoryEditRoute: React.FC = () => {\n\tconst [inited, setInited] = React.useState(false);\n\tconst {dispatch: dialogsDispatch} = useDialogsContext();\n\tconst mainContent = React.useRef<HTMLDivElement>(null);\n\tconst {storyId} = useParams<{storyId: string}>();\n\tconst {dispatch: undoableStoriesDispatch, stories} =\n\t\tuseUndoableStoriesContext();\n\tconst story = storyWithId(stories, storyId);\n\tuseZoomShortcuts(story);\n\n\tconst selectedPassages = React.useMemo(\n\t\t() => story.passages.filter(passage => passage.selected),\n\t\t[story.passages]\n\t);\n\n\tconst getCenter = React.useCallback(() => {\n\t\tif (!mainContent.current) {\n\t\t\tthrow new Error(\n\t\t\t\t'Asked for the center of the main content, but it does not exist in the DOM yet'\n\t\t\t);\n\t\t}\n\n\t\treturn {\n\t\t\tleft:\n\t\t\t\t(mainContent.current.scrollLeft + mainContent.current.clientWidth / 2) /\n\t\t\t\tstory.zoom,\n\t\t\ttop:\n\t\t\t\t(mainContent.current.scrollTop + mainContent.current.clientHeight / 2) /\n\t\t\t\tstory.zoom\n\t\t};\n\t}, [story.zoom]);\n\n\tconst handleMiddleClick = React.useCallback(\n\t\t(position: Point) => {\n\t\t\tundoableStoriesDispatch(\n\t\t\t\tcreateUntitledPassage(\n\t\t\t\t\tstory,\n\t\t\t\t\tposition.left / story.zoom,\n\t\t\t\t\tposition.top / story.zoom\n\t\t\t\t),\n\t\t\t\t'undoChange.newPassage'\n\t\t\t);\n\t\t},\n\t\t[story, undoableStoriesDispatch]\n\t);\n\n\tconst handleDeselectPassage = React.useCallback(\n\t\t(passage: Passage) =>\n\t\t\tundoableStoriesDispatch(deselectPassage(story, passage)),\n\t\t[story, undoableStoriesDispatch]\n\t);\n\n\tconst handleDragPassages = React.useCallback(\n\t\t(change: Point) => {\n\t\t\t// Ignore tiny drags--they're probably caused by the user moving their\n\t\t\t// mouse slightly during double-clicking.\n\n\t\t\tif (Math.abs(change.left) < 1 && Math.abs(change.top) < 1) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tundoableStoriesDispatch(\n\t\t\t\tmovePassages(\n\t\t\t\t\tstory,\n\t\t\t\t\tstory.passages.reduce<string[]>(\n\t\t\t\t\t\t(result, current) =>\n\t\t\t\t\t\t\tcurrent.selected ? [...result, current.id] : result,\n\t\t\t\t\t\t[]\n\t\t\t\t\t),\n\t\t\t\t\tchange.left / story.zoom,\n\t\t\t\t\tchange.top / story.zoom\n\t\t\t\t),\n\t\t\t\tselectedPassages.length > 1\n\t\t\t\t\t? 'undoChange.movePassages'\n\t\t\t\t\t: 'undoChange.movePassages'\n\t\t\t);\n\t\t},\n\t\t[selectedPassages.length, story, undoableStoriesDispatch]\n\t);\n\n\tconst handleEditPassage = React.useCallback(\n\t\t(passage: Passage) =>\n\t\t\tdialogsDispatch({\n\t\t\t\ttype: 'addDialog',\n\t\t\t\tcomponent: PassageEditDialog,\n\t\t\t\tprops: {passageId: passage.id, storyId: story.id}\n\t\t\t}),\n\t\t[dialogsDispatch, story.id]\n\t);\n\n\tconst handleSelectPassage = React.useCallback(\n\t\t(passage: Passage, exclusive: boolean) =>\n\t\t\tundoableStoriesDispatch(selectPassage(story, passage, exclusive)),\n\t\t[story, undoableStoriesDispatch]\n\t);\n\n\tconst handleSelectRect = React.useCallback(\n\t\t(rect: Rect, exclusive: boolean) => {\n\t\t\t// The rect we receive is in screen coordinates--we need to convert to\n\t\t\t// logical ones.\n\t\t\tconst logicalRect: Rect = {\n\t\t\t\theight: rect.height / story.zoom,\n\t\t\t\tleft: rect.left / story.zoom,\n\t\t\t\ttop: rect.top / story.zoom,\n\t\t\t\twidth: rect.width / story.zoom\n\t\t\t};\n\t\t\t// This should not be undoable.\n\t\t\tundoableStoriesDispatch(\n\t\t\t\tselectPassagesInRect(\n\t\t\t\t\tstory,\n\t\t\t\t\tlogicalRect,\n\t\t\t\t\texclusive ? selectedPassages.map(passage => passage.id) : []\n\t\t\t\t)\n\t\t\t);\n\t\t},\n\t\t[selectedPassages, story, undoableStoriesDispatch]\n\t);\n\n\t// If we have just mounted and the story has no passages, create one for the\n\t// user (and skip undo history, since it was an automatic action).\n\n\tReact.useEffect(() => {\n\t\tif (!inited) {\n\t\t\tsetInited(true);\n\n\t\t\tif (story.passages.length === 0) {\n\t\t\t\tconst center = getCenter();\n\n\t\t\t\tundoableStoriesDispatch(\n\t\t\t\t\tcreateUntitledPassage(story, center.left, center.top)\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t}, [getCenter, inited, story, undoableStoriesDispatch]);\n\n\tconst visibleZoom = useZoomTransition(story.zoom, mainContent.current);\n\n\treturn (\n\t\t<div className=\"story-edit-route\">\n\t\t\t<DocumentTitle title={story.name} />\n\t\t\t<StoryEditToolbar getCenter={getCenter} story={story} />\n\t\t\t<MainContent grabbable padded={false} ref={mainContent}>\n\t\t\t\t<MarqueeablePassageMap\n\t\t\t\t\tcontainer={mainContent}\n\t\t\t\t\tformatName={story.storyFormat}\n\t\t\t\t\tformatVersion={story.storyFormatVersion}\n\t\t\t\t\tonDeselect={handleDeselectPassage}\n\t\t\t\t\tonDrag={handleDragPassages}\n\t\t\t\t\tonEdit={handleEditPassage}\n\t\t\t\t\tonMiddleClick={handleMiddleClick}\n\t\t\t\t\tonSelect={handleSelectPassage}\n\t\t\t\t\tonSelectRect={handleSelectRect}\n\t\t\t\t\tpassages={story.passages}\n\t\t\t\t\tstartPassageId={story.startPassage}\n\t\t\t\t\ttagColors={story.tagColors}\n\t\t\t\t\tvisibleZoom={visibleZoom}\n\t\t\t\t\tzoom={story.zoom}\n\t\t\t\t/>\n\t\t\t\t<ZoomButtons story={story} />\n\t\t\t</MainContent>\n\t\t</div>\n\t);\n};;\n\n// This is a separate component so that the inner one can use\n// `useEditorsContext()` and `useUndoableStoriesContext()` inside it.\n\nexport const StoryEditRoute: React.FC = () => (\n\t<UndoableStoriesContextProvider>\n\t\t<DialogsContextProvider>\n\t\t\t<InnerStoryEditRoute />\n\t\t</DialogsContextProvider>\n\t</UndoableStoriesContextProvider>\n);\n","import {useHotkeys} from 'react-hotkeys-hook';\nimport {Story, updateStory, useStoriesContext} from '../../store/stories';\n\nexport function useZoomShortcuts(story: Story) {\n\tconst {dispatch, stories} = useStoriesContext();\n\n\tuseHotkeys(\n\t\t'-',\n\t\t() => {\n\t\t\tswitch (story.zoom) {\n\t\t\t\tcase 1:\n\t\t\t\t\tdispatch(updateStory(stories, story, {zoom: 0.6}));\n\t\t\t\t\tbreak;\n\t\t\t\tcase 0.6:\n\t\t\t\t\tdispatch(updateStory(stories, story, {zoom: 0.3}));\n\t\t\t\t\tbreak;\n\t\t\t\t// Do nothing if zoom is 0.3\n\t\t\t}\n\t\t},\n\t\t{keydown: false, keyup: true},\n\t\t[dispatch, stories, story]\n\t);\n\tuseHotkeys(\n\t\t'=',\n\t\t() => {\n\t\t\tswitch (story.zoom) {\n\t\t\t\tcase 0.3:\n\t\t\t\t\tdispatch(updateStory(stories, story, {zoom: 0.6}));\n\t\t\t\t\tbreak;\n\t\t\t\tcase 0.6:\n\t\t\t\t\tdispatch(updateStory(stories, story, {zoom: 1}));\n\t\t\t\t\tbreak;\n\t\t\t\t// Do nothing if zoom is 1\n\t\t\t}\n\t\t},\n\t\t{keydown: false, keyup: true},\n\t\t[dispatch, stories, story]\n\t);\n}\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {isElectronRenderer} from '../../util/is-electron';\nimport './storage-quota.css';\n\nexport interface StorageQuotaProps {\n\twatch: any;\n}\n\nexport const StorageQuota: React.FC<StorageQuotaProps> = props => {\n\tconst {watch} = props;\n\tconst [lastWatch, setLastWatch] = React.useState<any>();\n\tconst [working, setWorking] = React.useState(false);\n\tconst [percentFree, setPercentFree] = React.useState<string>();\n\n\t// This is set to -1 so that we can hide the percentage while doing the\n\t// initial calculation. Later ones will show the same percentage but with a\n\t// loading icon beside it until finishes.\n\n\tconst {t} = useTranslation();\n\n\tconst hide = isElectronRenderer() || !navigator.storage?.estimate;\n\n\t// When the watch prop changes, start calculating space.\n\n\tReact.useEffect(() => {\n\t\tasync function run() {\n\t\t\tsetWorking(true);\n\n\t\t\tconst {quota, usage} = await navigator.storage.estimate();\n\n\t\t\tif (quota !== undefined && usage !== undefined) {\n\t\t\t\tsetPercentFree(((1 - usage / quota) * 100).toFixed(0));\n\t\t\t}\n\n\t\t\tsetLastWatch(watch);\n\t\t\tsetWorking(false);\n\t\t}\n\n\t\tif (!hide && !working && lastWatch !== watch) {\n\t\t\trun();\n\t\t}\n\t}, [hide, lastWatch, watch, working]);\n\n\tif (hide) {\n\t\treturn null;\n\t}\n\n\treturn (\n\t\t<span className=\"storage-quota\">\n\t\t\t{percentFree &&\n\t\t\t\tt('components.storageQuota.freeSpace', {\n\t\t\t\t\tpercent: percentFree\n\t\t\t\t})}\n\t\t</span>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconPackage} from '@tabler/icons';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {useStoriesContext} from '../../../../store/stories';\nimport {archiveFilename, publishArchive} from '../../../../util/publish';\nimport {saveHtml} from '../../../../util/save-html';\nimport {getAppInfo} from '../../../../util/app-info';\n\nexport const ArchiveButton: React.FC = () => {\n\tconst {stories} = useStoriesContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconPackage />}\n\t\t\tlabel={t('routes.storyList.toolbar.archive')}\n\t\t\tonClick={() =>\n\t\t\t\tsaveHtml(publishArchive(stories, getAppInfo()), archiveFilename())\n\t\t\t}\n\t\t/>\n\t);\n};\n","import {IconFileImport} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {StoryImportDialog, useDialogsContext} from '../../../../dialogs';\n\nexport const ImportStoryButton: React.FC = () => {\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconFileImport />}\n\t\t\tlabel={t('common.import')}\n\t\t\tonClick={() =>\n\t\t\t\tdispatch({type: 'addDialog', component: StoryImportDialog})\n\t\t\t}\n\t\t/>\n\t);\n};\n","import {IconTags} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {StoryTagsDialog, useDialogsContext} from '../../../../dialogs';\n\nexport const StoryTagsButton: React.FC = () => {\n\tconst {dispatch} = useDialogsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\ticon={<IconTags />}\n\t\t\tlabel={t('routes.storyList.toolbar.storyTags')}\n\t\t\tonClick={() => {\n\t\t\t\tdispatch({type: 'addDialog', component: StoryTagsDialog});\n\t\t\t}}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {ButtonBar} from '../../../../components/container/button-bar';\nimport {ArchiveButton} from './archive-button';\nimport {ImportStoryButton} from './import-story-button';\nimport {StoryTagsButton} from './story-tags-button';\n\nexport const LibraryActions: React.FC = () => (\n\t<ButtonBar>\n\t\t<StoryTagsButton />\n\t\t<ImportStoryButton />\n\t\t<ArchiveButton />\n\t</ButtonBar>\n);\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {useHistory} from 'react-router-dom';\nimport {IconPlus} from '@tabler/icons';\nimport {usePrefsContext} from '../../../../store/prefs';\nimport {\n\tcreateStory,\n\tstoryDefaults,\n\tuseStoriesContext\n} from '../../../../store/stories';\nimport {PromptButton} from '../../../../components/control/prompt-button';\nimport {unusedName} from '../../../../util/unused-name';\n\nexport const CreateStoryButton: React.FC = () => {\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst [newName, setNewName] = React.useState(\n\t\tunusedName(\n\t\t\tstoryDefaults().name,\n\t\t\tstories.map(story => story.name)\n\t\t)\n\t);\n\tconst history = useHistory();\n\tconst {prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\tfunction validateName(value: string) {\n\t\tif (value.trim() === '') {\n\t\t\treturn {\n\t\t\t\tvalid: false,\n\t\t\t\tmessage: t('routes.storyList.toolbar.createStoryButton.emptyName')\n\t\t\t};\n\t\t}\n\n\t\tif (\n\t\t\tstories.some(story => story.name.toLowerCase() === value.toLowerCase())\n\t\t) {\n\t\t\treturn {\n\t\t\t\tvalid: false,\n\t\t\t\tmessage: t('routes.storyList.toolbar.createStoryButton.nameConflict')\n\t\t\t};\n\t\t}\n\n\t\treturn {valid: true};\n\t}\n\n\tfunction handleSubmit() {\n\t\tconst id = createStory(stories, prefs, {name: newName})(\n\t\t\tdispatch,\n\t\t\t() => stories\n\t\t);\n\n\t\thistory.push(`/stories/${id}`);\n\t}\n\n\treturn (\n\t\t<PromptButton\n\t\t\ticon={<IconPlus />}\n\t\t\tlabel={t('common.new')}\n\t\t\tsubmitLabel={t('common.create')}\n\t\t\tsubmitVariant=\"create\"\n\t\t\tonChange={e => setNewName(e.target.value)}\n\t\t\tonSubmit={handleSubmit}\n\t\t\tprompt={t('routes.storyList.toolbar.createStoryButton.prompt')}\n\t\t\tvalidate={validateName}\n\t\t\tvalue={newName}\n\t\t/>\n\t);\n};\n","import {IconCheck, IconX} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {ButtonBar} from '../container/button-bar';\nimport {CardContent} from '../container/card';\nimport {CardButton, CardButtonProps} from './card-button';\nimport {IconButton, IconButtonProps} from './icon-button';\nimport './confirm-button.css';\n\nexport interface ConfirmButtonProps\n\textends Omit<CardButtonProps, 'ariaLabel' | 'open' | 'onChangeOpen'> {\n\tcancelIcon?: React.ReactNode;\n\tcancelLabel?: string;\n\tconfirmIcon?: React.ReactNode;\n\tconfirmLabel?: string;\n\tconfirmVariant?: IconButtonProps['variant'];\n\tonConfirm: () => void;\n\tprompt: string;\n}\n\nexport const ConfirmButton: React.FC<ConfirmButtonProps> = props => {\n\tconst {\n\t\tcancelIcon,\n\t\tcancelLabel,\n\t\tconfirmIcon,\n\t\tconfirmLabel,\n\t\tconfirmVariant,\n\t\tonConfirm,\n\t\tprompt,\n\t\t...other\n\t} = props;\n\tconst [open, setOpen] = React.useState(false);\n\tconst {t} = useTranslation();\n\n\tfunction handleConfirm() {\n\t\tsetOpen(false);\n\t\tonConfirm();\n\t}\n\n\treturn (\n\t\t<span className=\"confirm-button\">\n\t\t\t<CardButton\n\t\t\t\tariaLabel={prompt}\n\t\t\t\tfocusSelector=\"button:nth-child(2)\"\n\t\t\t\tonChangeOpen={setOpen}\n\t\t\t\topen={open}\n\t\t\t\t{...other}\n\t\t\t>\n\t\t\t\t<div>\n\t\t\t\t\t<CardContent>{prompt}</CardContent>\n\t\t\t\t\t<ButtonBar>\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\ticon={confirmIcon ?? <IconCheck />}\n\t\t\t\t\t\t\tlabel={confirmLabel ?? t('common.ok')}\n\t\t\t\t\t\t\tonClick={handleConfirm}\n\t\t\t\t\t\t\tvariant={confirmVariant ?? 'primary'}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\ticon={cancelIcon ?? <IconX />}\n\t\t\t\t\t\t\tlabel={cancelLabel ?? t('common.cancel')}\n\t\t\t\t\t\t\tonClick={() => setOpen(false)}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</ButtonBar>\n\t\t\t\t</div>\n\t\t\t</CardButton>\n\t\t</span>\n\t);\n};\n","import {IconTrash} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {ConfirmButton} from '../../../../components/control/confirm-button';\nimport {deleteStory, Story, useStoriesContext} from '../../../../store/stories';\nimport {isElectronRenderer} from '../../../../util/is-electron';\n\nexport interface DeleteStoryButtonProps {\n\tstory?: Story;\n}\n\nexport const DeleteStoryButton: React.FC<DeleteStoryButtonProps> = ({\n\tstory\n}) => {\n\t// We need to store a local copy of the story name so that after it's deleted,\n\t// the prompt doesn't change as it transitions out.\n\tconst [storyName, setStoryName] = React.useState(story?.name);\n\tconst {dispatch} = useStoriesContext();\n\tconst {t} = useTranslation();\n\n\tReact.useEffect(() => {\n\t\tif (story?.name) {\n\t\t\tsetStoryName(story.name);\n\t\t}\n\t}, [story?.name]);\n\n\treturn (\n\t\t<ConfirmButton\n\t\t\tconfirmIcon={<IconTrash />}\n\t\t\tconfirmLabel={t('common.delete')}\n\t\t\tconfirmVariant=\"danger\"\n\t\t\tdisabled={!story}\n\t\t\ticon={<IconTrash />}\n\t\t\tlabel={t('common.delete')}\n\t\t\tonConfirm={story ? () => dispatch(deleteStory(story)) : () => {}}\n\t\t\tprompt={t(\n\t\t\t\t`routes.storyList.toolbar.deleteStoryButton.warning.${\n\t\t\t\t\tisElectronRenderer() ? 'electron' : 'web'\n\t\t\t\t}`,\n\t\t\t\t{storyName}\n\t\t\t)}\n\t\t/>\n\t);\n};\n","import {IconCopy} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {\n\tduplicateStory,\n\tStory,\n\tuseStoriesContext\n} from '../../../../store/stories';\n\nexport interface DuplicateStoryButtonProps {\n\tstory?: Story;\n}\n\nexport const DuplicateStoryButton: React.FC<DuplicateStoryButtonProps> = ({\n\tstory\n}) => {\n\tconst {dispatch, stories} = useStoriesContext();\n\tconst {t} = useTranslation();\n\n\tfunction handleClick() {\n\t\tif (!story) {\n\t\t\tthrow new Error('No story set');\n\t\t}\n\n\t\tdispatch(duplicateStory(story, stories));\n\t}\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={!story}\n\t\t\ticon={<IconCopy />}\n\t\t\tlabel={t('common.duplicate')}\n\t\t\tonClick={handleClick}\n\t\t/>\n\t);\n};\n","import {IconEdit} from '@tabler/icons';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {useHistory} from 'react-router-dom';\nimport {IconButton} from '../../../../components/control/icon-button';\nimport {Story} from '../../../../store/stories';\n\nexport interface EditStoryButtonProps {\n\tstory?: Story;\n}\n\nexport const EditStoryButton: React.FC<EditStoryButtonProps> = ({story}) => {\n\tconst history = useHistory();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<IconButton\n\t\t\tdisabled={!story}\n\t\t\ticon={<IconEdit />}\n\t\t\tlabel={t('common.edit')}\n\t\t\tonClick={() => history.push(`/stories/${story?.id}`)}\n\t\t/>\n\t);\n};\n","import {IconTag} from '@tabler/icons';\nimport * as React from 'react';\nimport {AddTagButton} from '../../../../components/tag';\nimport {setPref, usePrefsContext} from '../../../../store/prefs';\nimport {\n\tStory,\n\tstoryTags,\n\tupdateStory,\n\tuseStoriesContext\n} from '../../../../store/stories';\n\nexport interface TagStoryButtonProps {\n\tstory?: Story;\n}\n\nexport const TagStoryButton: React.FC<TagStoryButtonProps> = props => {\n\tconst {story} = props;\n\tconst {dispatch: prefsDispatch, prefs} = usePrefsContext();\n\tconst {dispatch: storiesDispatch, stories} = useStoriesContext();\n\n\tfunction handleAddTag(tagName: string, tagColor?: string) {\n\t\tif (!story) {\n\t\t\tthrow new Error('Story is unset');\n\t\t}\n\n\t\tstoriesDispatch(\n\t\t\tupdateStory(stories, story, {\n\t\t\t\ttags: story.tags ? [...story.tags, tagName] : [tagName]\n\t\t\t})\n\t\t);\n\n\t\tif (tagColor) {\n\t\t\tprefsDispatch(\n\t\t\t\tsetPref('storyTagColors', {\n\t\t\t\t\t...prefs.storyTagColors,\n\t\t\t\t\t[tagName]: tagColor\n\t\t\t\t})\n\t\t\t);\n\t\t}\n\t}\n\n\treturn (\n\t\t<AddTagButton\n\t\t\tassignedTags={story?.tags ?? []}\n\t\t\tdisabled={!story}\n\t\t\texistingTags={storyTags(stories)}\n\t\t\ticon={<IconTag />}\n\t\t\tonAdd={handleAddTag}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {ButtonBar} from '../../../../components/container/button-bar';\nimport {RenameStoryButton} from '../../../../components/story/rename-story-button';\nimport {Story, updateStory, useStoriesContext} from '../../../../store/stories';\nimport {CreateStoryButton} from './create-story-button';\nimport {DeleteStoryButton} from './delete-story-button';\nimport {DuplicateStoryButton} from './duplicate-story-button';\nimport {EditStoryButton} from './edit-story-button';\nimport {TagStoryButton} from './tag-story-button';\n\nexport interface StoryActionsProps {\n\tselectedStory?: Story;\n}\n\nexport const StoryActions: React.FC<StoryActionsProps> = props => {\n\tconst {selectedStory} = props;\n\tconst {dispatch, stories} = useStoriesContext();\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t<CreateStoryButton />\n\t\t\t<EditStoryButton story={selectedStory} />\n\t\t\t<TagStoryButton story={selectedStory} />\n\t\t\t<RenameStoryButton\n\t\t\t\texistingStories={stories}\n\t\t\t\tonRename={name =>\n\t\t\t\t\tdispatch(updateStory(stories, selectedStory!, {name}))\n\t\t\t\t}\n\t\t\t\tstory={selectedStory}\n\t\t\t/>\n\t\t\t<DuplicateStoryButton story={selectedStory} />\n\t\t\t<DeleteStoryButton story={selectedStory} />\n\t\t</ButtonBar>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconArrowsSort} from '@tabler/icons';\nimport {MenuButton} from '../../../../components/control/menu-button';\nimport {setPref, usePrefsContext} from '../../../../store/prefs';\n\nexport const SortByButton: React.FC = () => {\n\tconst {t} = useTranslation();\n\tconst {dispatch, prefs} = usePrefsContext();\n\n\treturn (\n\t\t<MenuButton\n\t\t\ticon={<IconArrowsSort />}\n\t\t\titems={[\n\t\t\t\t{\n\t\t\t\t\tcheckable: true,\n\t\t\t\t\tchecked: prefs.storyListSort === 'date',\n\t\t\t\t\tlabel: t('routes.storyList.toolbar.sortByDate'),\n\t\t\t\t\tonClick: () => dispatch(setPref('storyListSort', 'date'))\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tcheckable: true,\n\t\t\t\t\tchecked: prefs.storyListSort === 'name',\n\t\t\t\t\tlabel: t('routes.storyList.toolbar.sortByName'),\n\t\t\t\t\tonClick: () => dispatch(setPref('storyListSort', 'name'))\n\t\t\t\t}\n\t\t\t]}\n\t\t\tlabel={t('routes.storyList.toolbar.sort')}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconTag} from '@tabler/icons';\nimport {MenuButton} from '../../../../components/control/menu-button';\nimport {usePrefsContext} from '../../../../store/prefs';\n\nexport interface TagFilterButtonProps {\n\ttags: string[];\n}\n\nexport const TagFilterButton: React.FC<TagFilterButtonProps> = props => {\n\tconst {dispatch, prefs} = usePrefsContext();\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<MenuButton\n\t\t\tdisabled={props.tags.length === 0}\n\t\t\ticon={<IconTag />}\n\t\t\titems={[\n\t\t\t\t{\n\t\t\t\t\tcheckable: true,\n\t\t\t\t\tchecked: prefs.storyListTagFilter.length === 0,\n\t\t\t\t\tlabel: t('routes.storyList.toolbar.showAllStories'),\n\t\t\t\t\tonClick: () =>\n\t\t\t\t\t\tdispatch({type: 'update', name: 'storyListTagFilter', value: []})\n\t\t\t\t},\n\t\t\t\t{separator: true},\n\t\t\t\t...props.tags.map(tag => ({\n\t\t\t\t\tcheckable: true,\n\t\t\t\t\tchecked: prefs.storyListTagFilter.includes(tag),\n\t\t\t\t\tlabel: tag,\n\t\t\t\t\tonClick: () =>\n\t\t\t\t\t\tdispatch({\n\t\t\t\t\t\t\ttype: 'update',\n\t\t\t\t\t\t\tname: 'storyListTagFilter',\n\t\t\t\t\t\t\tvalue: prefs.storyListTagFilter.includes(tag)\n\t\t\t\t\t\t\t\t? prefs.storyListTagFilter.filter(t => t !== tag)\n\t\t\t\t\t\t\t\t: [...prefs.storyListTagFilter, tag]\n\t\t\t\t\t\t})\n\t\t\t\t}))\n\t\t\t]}\n\t\t\tlabel={t('routes.storyList.toolbar.showTags')}\n\t\t/>\n\t);\n};\n","import * as React from 'react';\nimport {ButtonBar} from '../../../../components/container/button-bar';\nimport {storyTags, useStoriesContext} from '../../../../store/stories';\nimport {SortByButton} from './sort-by-button';\nimport {TagFilterButton} from './tag-filter-button';\n\nexport const ViewActions: React.FC = () => {\n\tconst {stories} = useStoriesContext();\n\n\treturn (\n\t\t<ButtonBar>\n\t\t\t<SortByButton />\n\t\t\t<TagFilterButton tags={storyTags(stories)} />\n\t\t</ButtonBar>\n\t);\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {RouteToolbar} from '../../../components/route-toolbar';\nimport {StorageQuota} from '../../../components/storage-quota/storage-quota';\nimport {BuildActions, AppActions} from '../../../route-actions';\nimport {Story, useStoriesContext} from '../../../store/stories';\nimport {LibraryActions} from './library/library-actions';\nimport {StoryActions} from './story/story-actions';\nimport {ViewActions} from './view/view-actions';\n\nexport interface StoryListToolbarProps {\n\tselectedStories: Story[];\n}\n\nexport const StoryListToolbar: React.FC<StoryListToolbarProps> = props => {\n\tconst {selectedStories} = props;\n\tconst {stories} = useStoriesContext();\n\tconst {t} = useTranslation();\n\tconst selectedStory =\n\t\tselectedStories.length === 1 ? selectedStories[0] : undefined;\n\n\treturn (\n\t\t<RouteToolbar\n\t\t\tpinnedControls={<StorageQuota watch={stories} />}\n\t\t\ttabs={{\n\t\t\t\t[t('common.story')]: <StoryActions selectedStory={selectedStory} />,\n\t\t\t\t[t('routes.storyList.library')]: <LibraryActions />,\n\t\t\t\t[t('common.build')]: <BuildActions story={selectedStory} />,\n\t\t\t\t[t('common.view')]: <ViewActions />,\n\t\t\t\t[t('common.appName')]: <AppActions />\n\t\t\t}}\n\t\t/>\n\t);\n};\n","/**\n * Generates a hue (as in the HSL colorspace) for a string.\n */\nexport function hueString(value: string): number {\n\tlet result = 0;\n\n\tfor (let i = 0; i < value.length; i++) {\n\t\tresult += value.charCodeAt(i);\n\t}\n\n\treturn result % 360;\n}\n","import * as React from 'react';\nimport {Story} from '../../store/stories';\nimport {hueString} from '../../util/hue-string';\nimport './story-preview.css';\n\nexport interface StoryPreviewProps {\n\tstory: Story;\n}\n\nexport const StoryPreview: React.FC<StoryPreviewProps> = React.memo(props => {\n\tconst {story} = props;\n\tconst hues = [hueString(story.name)];\n\n\thues.push((hues[0] + 15) % 360);\n\thues.push((hues[0] - 15) % 360);\n\thues.push((hues[0] + 30) % 360);\n\thues.push((hues[0] - 30) % 360);\n\thues.push((hues[0] + 60) % 360);\n\n\tlet minX = Number.POSITIVE_INFINITY;\n\tlet minY = Number.POSITIVE_INFINITY;\n\tlet maxX = Number.NEGATIVE_INFINITY;\n\tlet maxY = Number.NEGATIVE_INFINITY;\n\n\tconst circles = story.passages.map(passage => ({\n\t\tkey: passage.name,\n\t\tx: passage.left + passage.width / 2,\n\t\ty: passage.top + passage.height / 2,\n\t\tradius: Math.max(passage.width, passage.height)\n\t}));\n\n\tconst svg = circles\n\t\t.reduce<[React.ReactNode[], React.ReactNode[]]>(\n\t\t\t(result, circle, index) => {\n\t\t\t\t// We reduce the circles to an array with two elements so that the\n\t\t\t\t// larger, faded circles appear below the smaller, more solid ones.\n\n\t\t\t\tconst bgRadius = circle.radius + 200;\n\n\t\t\t\t// Kind of gross to do side effects in a reduce(), but it saves an O(n).\n\n\t\t\t\tminX = Math.min(minX, circle.x - bgRadius);\n\t\t\t\tminY = Math.min(minY, circle.y - bgRadius);\n\t\t\t\tmaxX = Math.max(maxX, circle.x + bgRadius);\n\t\t\t\tmaxY = Math.max(maxY, circle.y + bgRadius);\n\n\t\t\t\tresult[0].push(\n\t\t\t\t\t<circle\n\t\t\t\t\t\tcx={circle.x}\n\t\t\t\t\t\tcy={circle.y}\n\t\t\t\t\t\tkey={`${circle.key}-bg`}\n\t\t\t\t\t\tr={bgRadius}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tfill: `hsl(${hues[index % hues.length]}, 80%, 80%)`\n\t\t\t\t\t\t}}\n\t\t\t\t\t/>\n\t\t\t\t);\n\n\t\t\t\tresult[1].push(\n\t\t\t\t\t<circle\n\t\t\t\t\t\tcx={circle.x}\n\t\t\t\t\t\tcy={circle.y}\n\t\t\t\t\t\tkey={`${circle.key}-fg`}\n\t\t\t\t\t\tr={circle.radius}\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tfill: `hsl(${hues[index % hues.length]}, 80%, 60%)`\n\t\t\t\t\t\t}}\n\t\t\t\t\t/>\n\t\t\t\t);\n\n\t\t\t\treturn result;\n\t\t\t},\n\t\t\t[[], []]\n\t\t)\n\t\t.map((nodes, index) => (\n\t\t\t<g className={`story-preview-${index === 0 ? 'bg' : 'fg'}`} key={index}>\n\t\t\t\t{nodes}\n\t\t\t</g>\n\t\t));\n\n\tconst viewBox = `${minX} ${minY} ${maxX - minX} ${maxY - minY}`;\n\n\treturn (\n\t\t<svg\n\t\t\tclassName=\"story-preview\"\n\t\t\tviewBox={viewBox}\n\t\t\txmlns=\"http://www.w3.org/2000/svg\"\n\t\t>\n\t\t\t{svg}\n\t\t</svg>\n\t);\n});\n\nStoryPreview.displayName = 'StoryPreview';","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {Story} from '../../store/stories';\nimport {Color} from '../../util/color';\nimport {CardContent, CardProps} from '../container/card';\nimport {SelectableCard} from '../container/card/selectable-card';\nimport {TagButton} from '../tag';\nimport './story-card.css';\nimport {StoryPreview} from './story-preview';\n\nconst dateFormatter = new Intl.DateTimeFormat([]);\n\nexport interface StoryCardProps extends CardProps {\n\tonChangeTagColor: (name: string, color: Color) => void;\n\tonRemoveTag: (name: string) => void;\n\tonEdit: () => void;\n\tonSelect: () => void;\n\tstory: Story;\n\tstoryTagColors: Record<string, Color>;\n}\n\nexport const StoryCard: React.FC<StoryCardProps> = props => {\n\tconst {\n\t\tonChangeTagColor,\n\t\tonEdit,\n\t\tonRemoveTag,\n\t\tonSelect,\n\t\tstory,\n\t\tstoryTagColors,\n\t\t...otherProps\n\t} = props;\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<div className=\"story-card\">\n\t\t\t<SelectableCard\n\t\t\t\t{...otherProps}\n\t\t\t\tlabel={story.name}\n\t\t\t\tonDoubleClick={onEdit}\n\t\t\t\tonSelect={onSelect}\n\t\t\t\tselected={story.selected}\n\t\t\t>\n\t\t\t\t<CardContent>\n\t\t\t\t\t<div className=\"story-card-summary\">\n\t\t\t\t\t\t<div className=\"story-card-summary-preview\">\n\t\t\t\t\t\t\t<StoryPreview story={story} />\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div className=\"story-card-summary-text\">\n\t\t\t\t\t\t\t<h2>{story.name}</h2>\n\t\t\t\t\t\t\t<p>\n\t\t\t\t\t\t\t\t{t('components.storyCard.lastUpdated', {\n\t\t\t\t\t\t\t\t\tdate: dateFormatter.format(story.lastUpdate)\n\t\t\t\t\t\t\t\t})}\n\t\t\t\t\t\t\t\t<br />\n\t\t\t\t\t\t\t\t{t('components.storyCard.passageCount', {\n\t\t\t\t\t\t\t\t\tcount: story.passages.length\n\t\t\t\t\t\t\t\t})}\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t{story.tags && (\n\t\t\t\t\t\t<div className=\"tags\">\n\t\t\t\t\t\t\t{story.tags.map(tag => (\n\t\t\t\t\t\t\t\t<TagButton\n\t\t\t\t\t\t\t\t\tcolor={storyTagColors[tag]}\n\t\t\t\t\t\t\t\t\tkey={tag}\n\t\t\t\t\t\t\t\t\tname={tag}\n\t\t\t\t\t\t\t\t\tonChangeColor={color => onChangeTagColor(tag, color)}\n\t\t\t\t\t\t\t\t\tonRemove={() => onRemoveTag(tag)}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t))}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t)}\n\t\t\t\t</CardContent>\n\t\t\t</SelectableCard>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {useHistory} from 'react-router-dom';\nimport {CSSTransition, TransitionGroup} from 'react-transition-group';\nimport {CardGroup} from '../../components/container/card-group';\nimport {StoryCard} from '../../components/story/story-card';\nimport {setPref, usePrefsContext} from '../../store/prefs';\nimport {Story, updateStory} from '../../store/stories';\nimport {useUndoableStoriesContext} from '../../store/undoable-stories';\nimport {Color} from '../../util/color';\n\n/**\n * How wide a story card should render onscreen as.\n */\nconst cardWidth = '360px';\n\nexport interface StoryCardsProps {\n\tonSelectStory: (story: Story) => void;\n\tstories: Story[];\n}\n\nexport const StoryCards: React.FC<StoryCardsProps> = props => {\n\tconst {onSelectStory, stories} = props;\n\tconst {dispatch: prefsDispatch, prefs} = usePrefsContext();\n\tconst {dispatch: storiesDispatch} = useUndoableStoriesContext();\n\tconst history = useHistory();\n\n\tfunction handleChangeTagColor(tagName: string, color: Color) {\n\t\tprefsDispatch(\n\t\t\tsetPref('storyTagColors', {\n\t\t\t\t...prefs.storyTagColors,\n\t\t\t\t[tagName]: color\n\t\t\t})\n\t\t);\n\t}\n\n\tfunction handleRemoveTag(story: Story, tagName: string) {\n\t\tstoriesDispatch(\n\t\t\tupdateStory(stories, story, {\n\t\t\t\ttags: story.tags.filter(tag => tag !== tagName)\n\t\t\t})\n\t\t);\n\t}\n\n\treturn (\n\t\t<>\n\t\t\t<CardGroup columnWidth={cardWidth}>\n\t\t\t\t<TransitionGroup component={null}>\n\t\t\t\t\t{stories.map(story => (\n\t\t\t\t\t\t<CSSTransition classNames=\"pop\" key={story.id} timeout={200}>\n\t\t\t\t\t\t\t<StoryCard\n\t\t\t\t\t\t\t\tonChangeTagColor={handleChangeTagColor}\n\t\t\t\t\t\t\t\tonEdit={() => history.push(`/stories/${story.id}`)}\n\t\t\t\t\t\t\t\tonRemoveTag={name => handleRemoveTag(story, name)}\n\t\t\t\t\t\t\t\tonSelect={() => onSelectStory(story)}\n\t\t\t\t\t\t\t\tstory={story}\n\t\t\t\t\t\t\t\tstoryTagColors={prefs.storyTagColors}\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t</CSSTransition>\n\t\t\t\t\t))}\n\t\t\t\t</TransitionGroup>\n\t\t\t</CardGroup>\n\t\t</>\n\t);\n};\n","import sortBy from 'lodash/sortBy';\nimport * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {MainContent} from '../../components/container/main-content';\nimport {SafariWarningCard} from '../../components/error';\nimport {\n\tAppDonationDialog,\n\tDialogsContextProvider,\n\tuseDialogsContext\n} from '../../dialogs';\nimport {usePrefsContext} from '../../store/prefs';\nimport {useDonationCheck} from '../../store/prefs/use-donation-check';\nimport {\n\tdeselectAllStories,\n\tdeselectStory,\n\tselectStory,\n\tuseStoriesContext\n} from '../../store/stories';\nimport {UndoableStoriesContextProvider} from '../../store/undoable-stories';\nimport {StoryListToolbar} from './toolbar/story-list-toolbar';\nimport {StoryCards} from './story-cards';\nimport {ClickAwayListener} from '../../components/click-away-listener';\n\nexport const InnerStoryListRoute: React.FC = () => {\n\tconst {dispatch: dialogsDispatch} = useDialogsContext();\n\tconst {dispatch: storiesDispatch, stories} = useStoriesContext();\n\tconst {prefs} = usePrefsContext();\n\tconst {shouldShowDonationPrompt} = useDonationCheck();\n\tconst {t} = useTranslation();\n\n\tconst selectedStories = React.useMemo(\n\t\t() => stories.filter(story => story.selected),\n\t\t[stories]\n\t);\n\n\tconst visibleStories = React.useMemo(() => {\n\t\tconst filteredStories =\n\t\t\tprefs.storyListTagFilter.length > 0\n\t\t\t\t? stories.filter(story =>\n\t\t\t\t\t\tstory.tags.some(tag => prefs.storyListTagFilter.includes(tag))\n\t\t\t\t  )\n\t\t\t\t: stories;\n\n\t\tswitch (prefs.storyListSort) {\n\t\t\tcase 'date':\n\t\t\t\treturn sortBy(filteredStories, 'lastUpdated');\n\t\t\tcase 'name':\n\t\t\t\treturn sortBy(filteredStories, 'name');\n\t\t}\n\t}, [prefs.storyListSort, prefs.storyListTagFilter, stories]);\n\n\t// Any stories no longer visible should be deselected.\n\n\tReact.useEffect(() => {\n\t\tfor (const story of selectedStories) {\n\t\t\tif (story.selected && !visibleStories.includes(story)) {\n\t\t\t\tstoriesDispatch(deselectStory(story));\n\t\t\t}\n\t\t}\n\t}, [selectedStories, stories, storiesDispatch, visibleStories]);\n\n\tReact.useEffect(() => {\n\t\tif (shouldShowDonationPrompt()) {\n\t\t\tdialogsDispatch({type: 'addDialog', component: AppDonationDialog});\n\t\t}\n\t}, [dialogsDispatch, shouldShowDonationPrompt]);\n\n\treturn (\n\t\t<div className=\"story-list-route\">\n\t\t\t<StoryListToolbar selectedStories={selectedStories} />\n\t\t\t<ClickAwayListener\n\t\t\t\tignoreSelector=\".story-card\"\n\t\t\t\tonClickAway={() => storiesDispatch(deselectAllStories())}\n\t\t\t>\n\t\t\t\t<MainContent\n\t\t\t\t\ttitle={t(\n\t\t\t\t\t\tprefs.storyListTagFilter.length > 0\n\t\t\t\t\t\t\t? 'routes.storyList.taggedTitleCount'\n\t\t\t\t\t\t\t: 'routes.storyList.titleCount',\n\t\t\t\t\t\t{count: visibleStories.length}\n\t\t\t\t\t)}\n\t\t\t\t>\n\t\t\t\t\t<SafariWarningCard />\n\t\t\t\t\t<div className=\"stories\">\n\t\t\t\t\t\t{stories.length === 0 ? (\n\t\t\t\t\t\t\t<p>{t('routes.storyList.noStories')}</p>\n\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t<StoryCards\n\t\t\t\t\t\t\t\tonSelectStory={story =>\n\t\t\t\t\t\t\t\t\tstoriesDispatch(selectStory(story, true))\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tstories={visibleStories}\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\t\t\t\t</MainContent>\n\t\t\t</ClickAwayListener>\n\t\t</div>\n\t);\n};\n\nexport const StoryListRoute: React.FC = () => (\n\t<UndoableStoriesContextProvider>\n\t\t<DialogsContextProvider>\n\t\t\t<InnerStoryListRoute />\n\t\t</DialogsContextProvider>\n\t</UndoableStoriesContextProvider>\n);\n","import * as React from 'react';\nimport {usePrefsContext} from '.';\n\n/**\n * How long since the user began using Twine to show a donation prompt. It's set\n * to 14 days.\n */\nexport const donationDelay = 1000 * 60 * 60 * 24 * 14;\n\nexport function useDonationCheck() {\n\tconst {prefs} = usePrefsContext();\n\n\tconst shouldShowDonationPrompt = React.useCallback(() => {\n\t\tif (prefs.donateShown) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn Date.now() > prefs.firstRunTime + donationDelay;\n\t}, [prefs.donateShown, prefs.firstRunTime]);\n\n\treturn {shouldShowDonationPrompt};\n}\n","export function replaceDom(html: string) {\n\t// Blast JS globals.\n\n\tdelete (window as any).CodeMirror;\n\tdelete (window as any).SVG;\n\tdelete (window as any).Store;\n\tdelete (window as any).StoryFormat;\n\tdelete (window as any).amdDefine;\n\tdelete (window as any).app;\n\tdelete (window as any).jQuery;\n\n\t// Rewrite the document.\n\n\tdocument.open();\n\tdocument.write(html);\n\tdocument.close();\n}\n","import * as React from 'react';\nimport {useParams} from 'react-router-dom';\nimport {replaceDom} from '../../util/replace-dom';\nimport {usePublishing} from '../../store/use-publishing';\n\nexport const StoryPlayRoute: React.FC = () => {\n\tconst [inited, setInited] = React.useState(false);\n\tconst {storyId} = useParams<{storyId: string}>();\n\tconst {publishStory} = usePublishing();\n\n\tReact.useEffect(() => {\n\t\tasync function load() {\n\t\t\treplaceDom(await publishStory(storyId));\n\t\t}\n\n\t\tif (!inited) {\n\t\t\tsetInited(true);\n\t\t\tload();\n\t\t}\n\t}, [inited, publishStory, storyId]);\n\n\treturn null;\n};\n","import * as React from 'react';\nimport {useParams} from 'react-router-dom';\nimport {replaceDom} from '../../util/replace-dom';\nimport {usePublishing} from '../../store/use-publishing';\n\nexport const StoryProofRoute: React.FC = () => {\n\tconst [inited, setInited] = React.useState(false);\n\tconst {storyId} = useParams<{storyId: string}>();\n\tconst {proofStory} = usePublishing();\n\n\tReact.useEffect(() => {\n\t\tasync function load() {\n\t\t\treplaceDom(await proofStory(storyId));\n\t\t}\n\n\t\tif (!inited) {\n\t\t\tsetInited(true);\n\t\t\tload();\n\t\t}\n\t}, [inited, proofStory, storyId]);\n\n\treturn null;\n};\n","import * as React from 'react';\nimport {useParams} from 'react-router-dom';\nimport {replaceDom} from '../../util/replace-dom';\nimport {usePublishing} from '../../store/use-publishing';\n\nexport const StoryTestRoute: React.FC = () => {\n\tconst [inited, setInited] = React.useState(false);\n\tconst {passageId, storyId} = useParams<{\n\t\tpassageId: string;\n\t\tstoryId: string;\n\t}>();\n\tconst {publishStory} = usePublishing();\n\n\tReact.useEffect(() => {\n\t\tasync function load() {\n\t\t\treplaceDom(\n\t\t\t\tawait publishStory(storyId, {\n\t\t\t\t\tformatOptions: 'debug',\n\t\t\t\t\tstartId: passageId\n\t\t\t\t})\n\t\t\t);\n\t\t}\n\n\t\tif (!inited) {\n\t\t\tsetInited(true);\n\t\t\tload();\n\t\t}\n\t}, [inited, passageId, publishStory, storyId]);\n\n\treturn null;\n};\n","import * as React from 'react';\nimport {useTranslation} from 'react-i18next';\nimport {IconArrowRight, IconArrowBarToRight} from '@tabler/icons';\nimport {ButtonBar} from '../container/button-bar';\nimport {Card, CardContent, CardProps} from '../container/card';\nimport {IconButton} from '../control/icon-button';\nimport './welcome-card.css';\n\nexport interface WelcomeCardProps extends CardProps {\n\timage?: React.ReactNode;\n\tnextLabel: string;\n\tonNext: () => void;\n\tonSkip: () => void;\n\tshowSkip: boolean;\n\ttitle: string;\n}\n\nexport const WelcomeCard: React.FC<WelcomeCardProps> = props => {\n\tconst {\n\t\tchildren,\n\t\timage,\n\t\tnextLabel,\n\t\tonNext,\n\t\tonSkip,\n\t\tshowSkip,\n\t\ttitle,\n\t\t...otherProps\n\t} = props;\n\tconst {t} = useTranslation();\n\n\treturn (\n\t\t<div className=\"welcome-card\">\n\t\t\t<Card {...otherProps}>\n\t\t\t\t<div className=\"welcome-card-image\">{image}</div>\n\t\t\t\t<CardContent>\n\t\t\t\t\t<h2>{title}</h2>\n\t\t\t\t\t{children}\n\t\t\t\t</CardContent>\n\t\t\t\t<ButtonBar>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon={<IconArrowRight />}\n\t\t\t\t\t\tvariant=\"primary\"\n\t\t\t\t\t\tonClick={onNext}\n\t\t\t\t\t\tlabel={nextLabel}\n\t\t\t\t\t/>\n\t\t\t\t\t{showSkip && (\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\ticon={<IconArrowBarToRight />}\n\t\t\t\t\t\t\tlabel={t('common.skip')}\n\t\t\t\t\t\t\tonClick={onSkip}\n\t\t\t\t\t\t/>\n\t\t\t\t\t)}\n\t\t\t\t</ButtonBar>\n\t\t\t</Card>\n\t\t</div>\n\t);\n};\n","import {IconDeviceFloppy, IconHelp, IconMoodSmile} from '@tabler/icons';\nimport {IconTwine} from '../../components/image/icon';\nimport {isElectronRenderer} from '../../util/is-electron';\n\nexport const content = () => [\n\t{\n\t\thtml: 'routes.welcome.greeting',\n\t\timage: <IconTwine />,\n\t\tnextLabel: 'routes.welcome.tellMeMore',\n\t\ttitle: 'routes.welcome.greetingTitle'\n\t},\n\t{\n\t\thtml: 'routes.welcome.help',\n\t\timage: <IconHelp />,\n\t\ttitle: 'routes.welcome.helpTitle'\n\t},\n\tisElectronRenderer()\n\t\t? {\n\t\t\t\thtml: 'routes.welcome.autosave',\n\t\t\t\timage: <IconDeviceFloppy />,\n\t\t\t\ttitle: 'routes.welcome.autosaveTitle'\n\t\t  }\n\t\t: {\n\t\t\t\thtml: 'routes.welcome.browserStorage',\n\t\t\t\timage: <IconDeviceFloppy />,\n\t\t\t\ttitle: 'routes.welcome.browserStorageTitle'\n\t\t  },\n\t{\n\t\thtml: 'routes.welcome.done',\n\t\timage: <IconMoodSmile />,\n\t\tnextLabel: 'routes.welcome.gotoStoryList',\n\t\ttitle: 'routes.welcome.doneTitle'\n\t}\n];\n","import * as React from 'react';\nimport {Helmet} from 'react-helmet';\nimport {useTranslation} from 'react-i18next';\nimport {useHistory} from 'react-router-dom';\nimport {CSSTransition, TransitionGroup} from 'react-transition-group';\nimport scroll from 'scroll';\nimport {WelcomeCard} from '../../components/welcome/welcome-card';\nimport {setPref, usePrefsContext} from '../../store/prefs';\nimport {content} from './content';\nimport './welcome-route.css';\n\nexport const WelcomeRoute: React.FC = () => {\n\tconst containerEl = React.useRef<HTMLDivElement>(null);\n\tconst {dispatch} = usePrefsContext();\n\tconst history = useHistory();\n\tconst [shown, setShown] = React.useState(1);\n\tconst allCards = React.useMemo(content, []);\n\tconst visibleCards = React.useMemo(() => allCards.slice(0, shown), [\n\t\tallCards,\n\t\tshown\n\t]);\n\tconst {t} = useTranslation();\n\n\tReact.useEffect(() => {\n\t\tif (containerEl.current) {\n\t\t\tconst lastCard = containerEl.current.querySelector(\n\t\t\t\t'.welcome-card:last-of-type'\n\t\t\t);\n\n\t\t\tif (lastCard) {\n\t\t\t\tscroll.top(\n\t\t\t\t\tdocument.documentElement ?? document.body,\n\t\t\t\t\t(lastCard as HTMLElement).offsetTop,\n\t\t\t\t\t{duration: 400}\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t}, [shown]);\n\n\tconst finish = () => {\n\t\tdispatch(setPref('welcomeSeen', true));\n\t\thistory.push('/');\n\t};\n\n\tconst showNext = () => setShown(shown => shown + 1);\n\n\treturn (\n\t\t<div className=\"welcome-route\" ref={containerEl}>\n\t\t\t<Helmet>\n\t\t\t\t<title>{t('routes.welcome.greetingTitle')}</title>\n\t\t\t</Helmet>\n\t\t\t<div className=\"cards\">\n\t\t\t\t<TransitionGroup component={null}>\n\t\t\t\t\t{visibleCards.map((card, index) => (\n\t\t\t\t\t\t<CSSTransition classNames=\"pop\" key={card.title} timeout={200}>\n\t\t\t\t\t\t\t<WelcomeCard\n\t\t\t\t\t\t\t\timage={card.image}\n\t\t\t\t\t\t\t\tnextLabel={\n\t\t\t\t\t\t\t\t\tcard.nextLabel ? t(card.nextLabel) : t('common.next')\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tonNext={index === allCards.length - 1 ? finish : showNext}\n\t\t\t\t\t\t\t\tonSkip={finish}\n\t\t\t\t\t\t\t\tshowSkip={index === 0}\n\t\t\t\t\t\t\t\ttitle={t(card.title)}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<div dangerouslySetInnerHTML={{__html: t(card.html)}} />\n\t\t\t\t\t\t\t</WelcomeCard>\n\t\t\t\t\t\t</CSSTransition>\n\t\t\t\t\t))}\n\t\t\t\t</TransitionGroup>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n","import * as React from 'react';\nimport {HashRouter, Route, Switch} from 'react-router-dom';\nimport {usePrefsContext} from '../store/prefs';\nimport {StoryFormatListRoute} from './story-format-list';\nimport {StoryEditRoute} from './story-edit';\nimport {StoryListRoute} from './story-list';\nimport {StoryPlayRoute} from './story-play';\nimport {StoryProofRoute} from './story-proof';\nimport {StoryTestRoute} from './story-test';\nimport {WelcomeRoute} from './welcome';\n\nexport const Routes: React.FC = () => {\n\tconst {prefs} = usePrefsContext();\n\n\t// A <HashRouter> is used to make our lives easier--to load local story\n\t// formats, we need the document HREF to reflect where the HTML file is.\n\t// Otherwise we'd have to store the actual location somewhere, which will\n\t// differ between web and Electron contexts.\n\n\treturn (\n\t\t<HashRouter>\n\t\t\t{prefs.welcomeSeen ? (\n\t\t\t\t<Switch>\n\t\t\t\t\t<Route exact path=\"/\">\n\t\t\t\t\t\t<StoryListRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route path=\"/story-formats\">\n\t\t\t\t\t\t<StoryFormatListRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route path=\"/welcome\">\n\t\t\t\t\t\t<WelcomeRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route path=\"/stories/:storyId/play\">\n\t\t\t\t\t\t<StoryPlayRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route path=\"/stories/:storyId/proof\">\n\t\t\t\t\t\t<StoryProofRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route path=\"/stories/:storyId/test/:passageId\">\n\t\t\t\t\t\t<StoryTestRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route path=\"/stories/:storyId/test\">\n\t\t\t\t\t\t<StoryTestRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route path=\"/stories/:storyId\">\n\t\t\t\t\t\t<StoryEditRoute />\n\t\t\t\t\t</Route>\n\t\t\t\t\t<Route\n\t\t\t\t\t\tpath=\"*\"\n\t\t\t\t\t\trender={path => {\n\t\t\t\t\t\t\tconsole.warn(\n\t\t\t\t\t\t\t\t`No route for path \"${path.location.pathname}\", rendering story list`\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\treturn <StoryListRoute />;\n\t\t\t\t\t\t}}\n\t\t\t\t\t></Route>\n\t\t\t\t</Switch>\n\t\t\t) : (\n\t\t\t\t<WelcomeRoute />\n\t\t\t)}\n\t\t</HashRouter>\n\t);\n};\n","import * as React from 'react';\nimport {defaults, usePrefsContext} from './prefs';\nimport {useStoriesContext} from './stories';\nimport {\n\tformatWithNameAndVersion,\n\tStoryFormat,\n\tuseStoryFormatsContext\n} from './story-formats';\nimport {usePersistence} from './persistence/use-persistence';\nimport {LoadingCurtain} from '../components/loading-curtain';\n\nexport const StateLoader: React.FC = ({children}) => {\n\tconst [initing, setIniting] = React.useState(false);\n\tconst [inited, setInited] = React.useState(false);\n\tconst [prefsRepaired, setPrefsRepaired] = React.useState(false);\n\tconst [formatsRepaired, setFormatsRepaired] = React.useState(false);\n\tconst [storiesRepaired, setStoriesRepaired] = React.useState(false);\n\tconst {dispatch: prefsDispatch, prefs: prefsState} = usePrefsContext();\n\tconst {dispatch: storiesDispatch} = useStoriesContext();\n\tconst {dispatch: formatsDispatch, formats: formatsState} =\n\t\tuseStoryFormatsContext();\n\tconst {prefs, stories, storyFormats} = usePersistence();\n\n\t// Done in steps so that the repair action can see the inited state, and then\n\t// each repair action can see the results of the preceding ones.\n\t//\n\t// Repairs must go:\n\t// formats -> prefs (so it can repair bad format preferences) -> stories\n\n\tReact.useEffect(() => {\n\t\tasync function run() {\n\t\t\tif (!initing) {\n\t\t\t\tconst formatsState = await storyFormats.load();\n\t\t\t\tconst prefsState = await prefs.load();\n\t\t\t\tconst storiesState = await stories.load();\n\n\t\t\t\tformatsDispatch({type: 'init', state: formatsState});\n\t\t\t\tprefsDispatch({type: 'init', state: prefsState});\n\t\t\t\tstoriesDispatch({type: 'init', state: storiesState});\n\t\t\t\tsetInited(true);\n\t\t\t}\n\t\t}\n\n\t\trun();\n\t\tsetIniting(true);\n\t}, [\n\t\tformatsDispatch,\n\t\tinited,\n\t\tiniting,\n\t\tprefs,\n\t\tprefsDispatch,\n\t\tstories,\n\t\tstoriesDispatch,\n\t\tstoryFormats\n\t]);\n\n\tReact.useEffect(() => {\n\t\tif (inited && !formatsRepaired) {\n\t\t\tformatsDispatch({type: 'repair'});\n\t\t\tsetFormatsRepaired(true);\n\t\t}\n\t}, [formatsDispatch, formatsRepaired, inited]);\n\n\tReact.useEffect(() => {\n\t\tif (inited && formatsRepaired && !prefsRepaired) {\n\t\t\tprefsDispatch({type: 'repair', allFormats: formatsState});\n\t\t\tsetPrefsRepaired(true);\n\t\t}\n\t}, [formatsRepaired, formatsState, inited, prefsDispatch, prefsRepaired]);\n\n\tReact.useEffect(() => {\n\t\tif (inited && formatsRepaired && prefsRepaired && !storiesRepaired) {\n\t\t\t// We try to repair stories to the user's preferred format, but perhaps\n\t\t\t// their prefs are out of date/corrupted. In that case, we use the default\n\t\t\t// one.\n\n\t\t\tlet safeFormat: StoryFormat | undefined;\n\n\t\t\ttry {\n\t\t\t\tsafeFormat = formatWithNameAndVersion(\n\t\t\t\t\tformatsState,\n\t\t\t\t\tprefsState.storyFormat.name,\n\t\t\t\t\tprefsState.storyFormat.version\n\t\t\t\t);\n\t\t\t} catch {\n\t\t\t\ttry {\n\t\t\t\t\tsafeFormat = formatWithNameAndVersion(\n\t\t\t\t\t\tformatsState,\n\t\t\t\t\t\tdefaults().storyFormat.name,\n\t\t\t\t\t\tdefaults().storyFormat.version\n\t\t\t\t\t);\n\t\t\t\t} catch (error) {\n\t\t\t\t\tconsole.error(\n\t\t\t\t\t\t`Could not locate a safe story format, skipping story repair: ${\n\t\t\t\t\t\t\t(error as Error).message\n\t\t\t\t\t\t}`\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (safeFormat) {\n\t\t\t\tstoriesDispatch({\n\t\t\t\t\ttype: 'repair',\n\t\t\t\t\tallFormats: formatsState,\n\t\t\t\t\tdefaultFormat: safeFormat\n\t\t\t\t});\n\t\t\t}\n\t\t\tsetStoriesRepaired(true);\n\t\t}\n\t}, [\n\t\tformatsDispatch,\n\t\tformatsRepaired,\n\t\tformatsState,\n\t\tinited,\n\t\tprefsDispatch,\n\t\tprefsRepaired,\n\t\tprefsState.storyFormat.name,\n\t\tprefsState.storyFormat.version,\n\t\tstories,\n\t\tstoriesDispatch,\n\t\tstoriesRepaired\n\t]);\n\n\treturn inited && formatsRepaired && prefsRepaired && storiesRepaired ? (\n\t\t<>{children}</>\n\t) : (\n\t\t<LoadingCurtain />\n\t);\n};\n","import * as React from 'react';\nimport {useComputedTheme} from './prefs/use-computed-theme';\n\nexport function ThemeSetter() {\n\tconst computedTheme = useComputedTheme();\n\n\tReact.useEffect(() => {\n\t\tdocument.body.dataset.appTheme = computedTheme;\n\t}, [computedTheme]);\n\n\treturn null;\n}\n","import * as React from 'react';\nimport {GlobalErrorBoundary} from './components/error';\nimport {LoadingCurtain} from './components/loading-curtain/loading-curtain';\nimport {LocaleSwitcher} from './store/locale-switcher';\nimport {PrefsContextProvider} from './store/prefs';\nimport {Routes} from './routes';\nimport {StoriesContextProvider} from './store/stories';\nimport {StoryFormatsContextProvider} from './store/story-formats';\nimport {StateLoader} from './store/state-loader';\nimport {ThemeSetter} from './store/theme-setter';\nimport 'focus-visible';\nimport './styles/typography.css';\nimport './styles/focus-visible-shim.css';\n\nexport const App: React.FC = () => {\n\treturn (\n\t\t<GlobalErrorBoundary>\n\t\t\t<PrefsContextProvider>\n\t\t\t\t<LocaleSwitcher />\n\t\t\t\t<ThemeSetter />\n\t\t\t\t<StoryFormatsContextProvider>\n\t\t\t\t\t<StoriesContextProvider>\n\t\t\t\t\t\t<StateLoader>\n\t\t\t\t\t\t\t<React.Suspense fallback={<LoadingCurtain />}>\n\t\t\t\t\t\t\t\t<Routes />\n\t\t\t\t\t\t\t</React.Suspense>\n\t\t\t\t\t\t</StateLoader>\n\t\t\t\t\t</StoriesContextProvider>\n\t\t\t\t</StoryFormatsContextProvider>\n\t\t\t</PrefsContextProvider>\n\t\t</GlobalErrorBoundary>\n\t);\n};\n","import * as React from 'react';\nimport * as ReactDOM from 'react-dom';\nimport {App} from './app';\nimport './util/i18n';\n\nReactDOM.render(\n\t<React.StrictMode>\n\t\t<App />\n\t</React.StrictMode>,\n\tdocument.getElementById('root')\n);\n"],"sourceRoot":""}